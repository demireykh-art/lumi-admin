<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE CLINIC LUMI - ê´€ë¦¬ì</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=Noto+Sans+KR:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root{--bg:#faf9f7;--card:#fff;--gold:#9a8b7a;--dark:#2c2c2c;--green:#5a7a5a;--red:#a85a5a;--text:#2c2c2c;--muted:#999;--border:#e8e4df}
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
        .login-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;padding:2rem;position:fixed;inset:0;z-index:2000;background:var(--bg)}
        .login-screen.hidden{display:none}
        .login-logo{font-family:'Cormorant Garamond',serif;letter-spacing:4px;color:var(--muted);font-size:.9rem;margin-bottom:.5rem}
        .login-title{font-family:'Cormorant Garamond',serif;font-size:2.5rem;font-weight:500;margin-bottom:.5rem;letter-spacing:2px}
        .login-subtitle{color:var(--muted);margin-bottom:2rem;font-size:.85rem;letter-spacing:1px}
        .login-form{width:100%;max-width:320px}
        .login-input{width:100%;padding:1rem;background:#fff;border:1px solid var(--border);color:var(--text);font-size:1rem;margin-bottom:1rem}
        .login-input:focus{outline:none;border-color:var(--gold)}
        .pw-wrap{position:relative}.pw-toggle{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted);cursor:pointer;font-size:1rem;margin-top:-8px}
        .login-btn{width:100%;padding:1rem;background:var(--dark);border:none;color:#fff;font-size:.9rem;cursor:pointer;letter-spacing:1px}
        .login-error{color:var(--red);font-size:.85rem;text-align:center;margin-bottom:1rem}
        .login-notice{color:var(--gold);font-size:.75rem;text-align:center;margin-top:1.5rem;padding:1rem;background:rgba(154,139,122,.1);border:1px solid var(--border)}
        .header{background:#fff;border-bottom:1px solid var(--border);padding:1rem 2rem;position:sticky;top:0;z-index:100}
        .header-content{display:flex;justify-content:space-between;align-items:center;max-width:1600px;margin:0 auto}
        .logo-sub{font-family:'Cormorant Garamond',serif;font-size:.7rem;letter-spacing:3px;color:var(--muted)}
        .logo-text{font-family:'Cormorant Garamond',serif;font-size:1.5rem;font-weight:500;letter-spacing:2px}
        .header-right{display:flex;align-items:center;gap:1rem}
        .logout-btn{padding:.5rem 1rem;background:transparent;border:1px solid var(--border);color:var(--muted);font-size:.8rem;cursor:pointer}
        .main-nav{display:flex;background:#fff;border-bottom:1px solid var(--border)}
        .nav-btn{padding:1rem 2rem;background:none;border:none;border-bottom:2px solid transparent;color:var(--muted);cursor:pointer;font-size:.85rem}
        .nav-btn:hover,.nav-btn.active{color:var(--text);border-bottom-color:var(--gold)}
        .sub-nav{display:flex;gap:.5rem;padding:1rem 2rem;background:var(--bg);border-bottom:1px solid var(--border);flex-wrap:wrap}
        .sub-btn{padding:.5rem 1rem;background:none;border:1px solid var(--border);color:var(--muted);cursor:pointer;font-size:.8rem}
        .sub-btn:hover,.sub-btn.active{border-color:var(--gold);color:var(--text);background:var(--gold);color:#fff}
        .main{padding:2rem;max-width:1600px;margin:0 auto}
        .section{display:none}.section.active{display:block}
        .app-container{display:none}.app-container.active{display:block}
        .card{background:#fff;padding:1.5rem;border:1px solid var(--border);margin-bottom:1.5rem}
        .card-title{font-size:.9rem;font-weight:600;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;margin-bottom:1.5rem}
        .stat-card{background:#fff;padding:1.25rem;border:1px solid var(--border);border-top:3px solid var(--gold)}
        .stat-label{color:var(--muted);font-size:.75rem;margin-bottom:.5rem}.stat-value{font-size:1.3rem;font-weight:600}
        table{width:100%;border-collapse:collapse}th,td{padding:.75rem;text-align:left;border-bottom:1px solid var(--border)}
        th{color:var(--muted);font-weight:500;font-size:.75rem;text-transform:uppercase}td{font-size:.85rem}
        .btn{padding:.5rem 1rem;border:none;cursor:pointer;font-size:.8rem}.btn-primary{background:var(--dark);color:#fff}
        .btn-danger{background:var(--red);color:#fff}.btn-sm{padding:.4rem .8rem;font-size:.75rem}.btn-group{display:flex;gap:.5rem}
        .form-group{margin-bottom:1rem}.form-label{display:block;margin-bottom:.5rem;color:var(--muted);font-size:.8rem}
        .form-input,.form-select{width:100%;padding:.75rem;background:#fff;border:1px solid var(--border);font-size:.9rem}
        .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem}
        .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center}
        .modal-overlay.active{display:flex}.modal{background:#fff;padding:2rem;width:90%;max-width:600px;max-height:90vh;overflow-y:auto}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid var(--border)}
        .modal-title{font-size:1.1rem;font-weight:600}.modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--muted)}
        .badge{display:inline-flex;padding:.25rem .5rem;font-size:.7rem}.badge-success{background:rgba(90,122,90,.15);color:var(--green)}
        .badge-warning{background:rgba(154,139,122,.15);color:var(--gold)}.badge-info{background:rgba(90,106,122,.15);color:#5a6a7a}
        .text-success{color:var(--green)}.text-danger{color:var(--red)}.text-muted{color:var(--muted)}
        .upload-zone{border:2px dashed var(--border);padding:3rem;text-align:center;cursor:pointer;margin-bottom:1.5rem}
        .upload-zone:hover{border-color:var(--gold);background:rgba(154,139,122,.05)}
        .summary-row{display:flex;justify-content:space-between;padding:1rem;background:var(--bg);margin-top:1rem;font-weight:600}
        .auto-id{background:var(--bg);padding:.75rem;border:1px solid var(--border);margin-top:.5rem;font-family:monospace;color:var(--gold)}
        .flex{display:flex}.justify-between{justify-content:space-between}.items-center{align-items:center}.gap-1{gap:.5rem}.mb-2{margin-bottom:1rem}.mt-2{margin-top:1rem}
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-logo">THE CLINIC</div>
        <div class="login-title">LUMI</div>
        <div class="login-subtitle">ADMINISTRATOR</div>
        <div class="login-form">
            <input type="text" class="login-input" id="adminId" placeholder="ê´€ë¦¬ì ID" autocapitalize="none">
            <div class="pw-wrap">
                <input type="password" class="login-input" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸">
                <button type="button" class="pw-toggle" onclick="togglePw('adminPw',this)">ğŸ‘</button>
            </div>
            <div class="login-error" id="loginError"></div>
            <button class="login-btn" onclick="handleAdminLogin()">ë¡œê·¸ì¸</button>
            <div class="login-notice">âš  ë³´ì•ˆì„ ìœ„í•´ ë¹„ë°€ë²ˆí˜¸ëŠ” 3ê°œì›”ë§ˆë‹¤ ë³€ê²½í•´ì£¼ì„¸ìš”.</div>
        </div>
    </div>
    <div class="app-container" id="appContainer">
        <header class="header">
            <div class="header-content">
                <div><div class="logo-sub">THE CLINIC</div><div class="logo-text">LUMI</div></div>
                <div class="header-right">
                    <select class="form-select" id="selectedYear" style="width:auto" onchange="loadAllData()"><option value="2026">2026</option><option value="2025">2025</option></select>
                    <select class="form-select" id="selectedMonth" style="width:auto" onchange="loadAllData()">
                        <option value="01">1ì›”</option><option value="02">2ì›”</option><option value="03">3ì›”</option><option value="04">4ì›”</option><option value="05">5ì›”</option><option value="06">6ì›”</option>
                        <option value="07">7ì›”</option><option value="08">8ì›”</option><option value="09">9ì›”</option><option value="10">10ì›”</option><option value="11">11ì›”</option><option value="12">12ì›”</option>
                    </select>
                    <button class="logout-btn" onclick="adminLogout()">LOGOUT</button>
                </div>
            </div>
        </header>
        <nav class="main-nav">
            <button class="nav-btn active" data-nav="sales">ë§¤ì¶œ</button>
            <button class="nav-btn" data-nav="staff">ì§ì›ê´€ë¦¬</button>
        </nav>
        <main class="main">
            <!-- ë§¤ì¶œ ì„¹ì…˜ -->
            <div class="section active" id="sales-section">
                <div class="sub-nav">
                    <button class="sub-btn active" data-sub="sales-overview">ë§¤ì¶œ í˜„í™©</button>
                    <button class="sub-btn" data-sub="sales-doctor">ì§„ë£Œì˜ë³„</button>
                    <button class="sub-btn" data-sub="sales-staff">ë‹´ë‹¹ì§ì›ë³„</button>
                    <button class="sub-btn" data-sub="sales-data">ë°ì´í„° ê´€ë¦¬</button>
                </div>
                <div class="section active" id="sales-overview">
                    <div class="stats-grid" style="margin-top:1.5rem">
                        <div class="stat-card"><div class="stat-label">ì´ë²ˆë‹¬ ì´ë§¤ì¶œ</div><div class="stat-value" id="monthlyTotal">â‚©0</div></div>
                        <div class="stat-card"><div class="stat-label">ì¼ë³¸ì¸ ë§¤ì¶œ</div><div class="stat-value" id="japanRevenue">â‚©0</div></div>
                        <div class="stat-card"><div class="stat-label">ê±°ë˜ ê±´ìˆ˜</div><div class="stat-value" id="monthlyTrans">0ê±´</div></div>
                        <div class="stat-card"><div class="stat-label">ì¼ë³¸ì¸ ë‚´ì›</div><div class="stat-value" id="japanVisitors">0ëª…</div></div>
                    </div>
                </div>
                <div class="section" id="sales-doctor">
                    <div class="card" style="margin-top:1.5rem"><div class="card-title">ì§„ë£Œì˜ë³„ ë§¤ì¶œ</div>
                        <table><thead><tr><th>ì§„ë£Œì˜</th><th>ê±´ìˆ˜</th><th>ë§¤ì¶œ</th><th>ë¹„ì¤‘</th></tr></thead>
                            <tbody id="doctorSalesTable"><tr><td colspan="4" class="text-muted" style="text-align:center;padding:2rem">ë°ì´í„° ì—†ìŒ</td></tr></tbody>
                        </table>
                    </div>
                </div>
                <div class="section" id="sales-staff">
                    <div class="card" style="margin-top:1.5rem"><div class="card-title">ë‹´ë‹¹ì§ì›ë³„ ë§¤ì¶œ (ì¸ì„¼í‹°ë¸Œ 1%)</div>
                        <table><thead><tr><th>ë‹´ë‹¹ì§ì›</th><th>ê±´ìˆ˜</th><th>ë§¤ì¶œ</th><th>ì¸ì„¼í‹°ë¸Œ</th></tr></thead>
                            <tbody id="staffSalesTable"><tr><td colspan="4" class="text-muted" style="text-align:center;padding:2rem">ë°ì´í„° ì—†ìŒ</td></tr></tbody>
                        </table>
                    </div>
                </div>
                <div class="section" id="sales-data">
                    <div class="upload-zone" id="uploadZone" style="margin-top:1.5rem">
                        <div style="font-size:2rem;margin-bottom:1rem">ğŸ“</div>
                        <div>ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­</div>
                        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleFileUpload(event)">
                    </div>
                    <div class="card"><div class="card-title">ì›”ë³„ ë§¤ì¶œ ìˆ˜ë™ ì…ë ¥</div>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">ì´ ë§¤ì¶œ</label><input type="text" class="form-input" id="inputTotalRevenue" placeholder="200,000,000"></div>
                            <div class="form-group"><label class="form-label">ì¼ë³¸ì¸ ë§¤ì¶œ</label><input type="text" class="form-input" id="inputJapanRevenue" placeholder="20,000,000"></div>
                            <div class="form-group"><label class="form-label">ì¼ë³¸ì¸ ë‚´ì›ìˆ˜</label><input type="number" class="form-input" id="inputJapanVisitors" placeholder="25"></div>
                            <div class="form-group"><label class="form-label">ê±°ë˜ ê±´ìˆ˜</label><input type="number" class="form-input" id="inputTransactions" placeholder="3000"></div>
                        </div>
                        <button class="btn btn-primary" onclick="saveRevenueData()">ì €ì¥</button>
                    </div>
                </div>
            </div>
            <!-- ì§ì›ê´€ë¦¬ ì„¹ì…˜ -->
            <div class="section" id="staff-section">
                <div class="sub-nav">
                    <button class="sub-btn active" data-sub="staff-list">ì§ì›ëª©ë¡</button>
                    <button class="sub-btn" data-sub="staff-leave">íœ´ê°€ê´€ë¦¬</button>
                    <button class="sub-btn" data-sub="staff-salary">ê¸‰ì—¬</button>
                </div>
                <div class="section active" id="staff-list">
                    <div class="flex justify-between items-center mb-2" style="margin-top:1.5rem">
                        <h2 style="font-weight:500">ì§ì› ê´€ë¦¬</h2>
                        <button class="btn btn-primary" onclick="openEmployeeModal()">+ ì§ì› ì¶”ê°€</button>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-label">ì „ì²´ ì§ì›</div><div class="stat-value" id="totalEmp">0</div></div>
                        <div class="stat-card"><div class="stat-label">ì¬ì§ì¤‘</div><div class="stat-value text-success" id="activeEmp">0</div></div>
                    </div>
                    <div class="card"><table>
                        <thead><tr><th>ì‚¬ë²ˆ</th><th>ì´ë¦„</th><th>ì§ê¸‰</th><th>ì…ì‚¬ì¼</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="employeeTable"><tr><td colspan="6" class="text-muted" style="text-align:center;padding:2rem">ë¡œë”©ì¤‘...</td></tr></tbody>
                    </table></div>
                </div>
                <div class="section" id="staff-leave">
                    <div class="card" style="margin-top:1.5rem"><div class="card-title">íœ´ê°€ ì‹ ì²­ ëª©ë¡</div>
                        <table><thead><tr><th>ì§ì›</th><th>ìœ í˜•</th><th>ê¸°ê°„</th><th>ìƒíƒœ</th><th>ì²˜ë¦¬</th></tr></thead>
                            <tbody id="leaveTable"><tr><td colspan="5" class="text-muted" style="text-align:center;padding:2rem">ì‹ ì²­ ì—†ìŒ</td></tr></tbody>
                        </table>
                    </div>
                </div>
                <div class="section" id="staff-salary">
                    <div class="card" style="margin-top:1.5rem"><div class="card-title">ê¸‰ì—¬ í˜„í™©</div>
                        <table><thead><tr><th>ì§ì›</th><th>ê¸°ë³¸ê¸‰</th><th>ê³ ì •OT</th><th>ì¸ì„¼í‹°ë¸Œ</th><th>ì´ ê¸‰ì—¬</th></tr></thead>
                            <tbody id="salaryTable"><tr><td colspan="5" class="text-muted" style="text-align:center;padding:2rem">ë¡œë”©ì¤‘...</td></tr></tbody>
                        </table>
                        <div class="summary-row"><span>í•©ê³„</span><span class="text-success" id="totalSalary">â‚©0</span></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <!-- ì§ì› ëª¨ë‹¬ -->
    <div class="modal-overlay" id="employeeModal">
        <div class="modal">
            <div class="modal-header"><div class="modal-title" id="empModalTitle">ì§ì› ì¶”ê°€</div><button class="modal-close" onclick="closeEmployeeModal()">&times;</button></div>
            <form id="employeeForm">
                <input type="hidden" id="empEditId">
                <div class="form-row">
                    <div class="form-group"><label class="form-label">ì´ë¦„ *</label><input type="text" class="form-input" id="empName" required oninput="updateAutoId()"></div>
                    <div class="form-group"><label class="form-label">ì…ì‚¬ì¼ *</label><input type="date" class="form-input" id="empJoinDate" required onchange="updateAutoId()"></div>
                </div>
                <div class="form-group"><label class="form-label">ì‚¬ë²ˆ (ìë™ìƒì„±)</label><div class="auto-id" id="autoIdPreview">ì´ë¦„ê³¼ ì…ì‚¬ì¼ ì…ë ¥ì‹œ ìë™ìƒì„±</div></div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">ì§ê¸‰ *</label>
                        <select class="form-select" id="empRole" required><option value="">ì„ íƒ</option><option value="ì‹¤ì¥">ì‹¤ì¥</option><option value="í”¼ë¶€ê´€ë¦¬ì‚¬">í”¼ë¶€ê´€ë¦¬ì‚¬</option><option value="ê°„í˜¸ì‚¬">ê°„í˜¸ì‚¬</option><option value="ì½”ë””">ì½”ë””</option><option value="ë§ˆì¼€íŒ…">ë§ˆì¼€íŒ…</option></select>
                    </div>
                    <div class="form-group"><label class="form-label">ê¸°ë³¸ê¸‰ *</label><input type="number" class="form-input" id="empBaseSalary" required></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">ê³ ì •OTìˆ˜ë‹¹</label><input type="number" class="form-input" id="empFixedOT"></div>
                    <div class="form-group"><label class="form-label">ì‹œê¸‰</label><input type="number" class="form-input" id="empHourlyWage"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">ë§¤ì¹­ì´ë¦„ (ì—‘ì…€)</label><input type="text" class="form-input" id="empMatchName" placeholder="ì˜ˆ: ë°•ë³´ë¯¸"></div>
                    <div class="form-group"><label class="form-label">ìƒíƒœ</label>
                        <select class="form-select" id="empIsActive"><option value="true">ì¬ì§ì¤‘</option><option value="false">í‡´ì‚¬</option></select>
                    </div>
                </div>
                <div class="flex justify-between mt-2">
                    <button type="button" class="btn" style="background:var(--border)" onclick="closeEmployeeModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>
    <script>
        const firebaseConfig={apiKey:"AIzaSyDnkKNXNnDVlcPd5Y1fl59YysdeEZi7uJU",authDomain:"lumiclinic-c1a95.firebaseapp.com",projectId:"lumiclinic-c1a95",storageBucket:"lumiclinic-c1a95.firebasestorage.app",messagingSenderId:"901456209944",appId:"1:901456209944:web:f287418cd0541f324d3b6d"};
        firebase.initializeApp(firebaseConfig);
        const db=firebase.firestore();

        const ADMIN_ID='adminhighgo';
        const ADMIN_PW='gndls-asdk!jd-As';
        const DEFAULT_PW='final12890-';

        let employees=[],leaveRequests=[],revenueData={},salesDetailData={doctorSales:{},staffSales:{}};

        function togglePw(id,btn){
            const inp=document.getElementById(id);
            if(inp.type==='password'){inp.type='text';btn.textContent='ğŸ”’';}
            else{inp.type='password';btn.textContent='ğŸ‘';}
        }

        function handleAdminLogin(){
            const id=document.getElementById('adminId').value.trim();
            const pw=document.getElementById('adminPw').value;
            document.getElementById('loginError').textContent='';
            if(id===ADMIN_ID && pw===ADMIN_PW){
                localStorage.setItem('lumiAdmin','true');
                showApp();
            }else{
                document.getElementById('loginError').textContent='ID ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
            }
        }

        function adminLogout(){
            localStorage.removeItem('lumiAdmin');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appContainer').classList.remove('active');
        }

        function checkAdminLogin(){
            if(localStorage.getItem('lumiAdmin')==='true') showApp();
        }

        function showApp(){
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appContainer').classList.add('active');
            const now=new Date();
            document.getElementById('selectedMonth').value=String(now.getMonth()+1).padStart(2,'0');
            loadAllData();
        }

        function getYM(){
            return document.getElementById('selectedYear').value+'-'+document.getElementById('selectedMonth').value;
        }

        // Navigation
        document.querySelectorAll('.nav-btn').forEach(n=>n.addEventListener('click',()=>{
            document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
            document.querySelectorAll('.section[id$="-section"]').forEach(x=>x.classList.remove('active'));
            n.classList.add('active');
            document.getElementById(n.dataset.nav+'-section').classList.add('active');
        }));
        document.querySelectorAll('.sub-btn').forEach(s=>s.addEventListener('click',()=>{
            const parent=s.closest('.section');
            parent.querySelectorAll('.sub-btn').forEach(x=>x.classList.remove('active'));
            parent.querySelectorAll('.section').forEach(x=>x.classList.remove('active'));
            s.classList.add('active');
            document.getElementById(s.dataset.sub).classList.add('active');
        }));

        async function loadAllData(){
            await loadEmployees();
            await loadLeaveRequests();
            await loadRevenueData();
            await loadSalesDetailData();
            renderAll();
        }

        async function loadEmployees(){
            try{
                const snap=await db.collection('employees').get();
                employees=[];
                snap.forEach(d=>employees.push({id:d.id,...d.data()}));
            }catch(e){console.error(e);}
        }

        async function loadLeaveRequests(){
            try{
                const snap=await db.collection('leaveRequests').orderBy('createdAt','desc').limit(30).get();
                leaveRequests=[];
                snap.forEach(d=>leaveRequests.push({id:d.id,...d.data()}));
            }catch(e){}
        }

        async function loadRevenueData(){
            const ym=getYM();
            try{
                const doc=await db.collection('revenue').doc(ym).get();
                revenueData=doc.exists?doc.data():{total:0,japan:0,japanVisitors:0,transactions:0};
            }catch(e){revenueData={total:0,japan:0,japanVisitors:0,transactions:0};}
        }

        async function loadSalesDetailData(){
            const ym=getYM();
            try{
                const doc=await db.collection('salesDetail').doc(ym).get();
                salesDetailData=doc.exists?doc.data():{doctorSales:{},staffSales:{}};
            }catch(e){salesDetailData={doctorSales:{},staffSales:{}};}
        }

        function formatCurrency(n){return 'â‚©'+new Intl.NumberFormat('ko-KR').format(n||0);}

        function renderAll(){
            renderSales();
            renderEmployees();
            renderLeaves();
            renderSalary();
        }

        function renderSales(){
            const total=revenueData.total||0;
            document.getElementById('monthlyTotal').textContent=formatCurrency(total);
            document.getElementById('japanRevenue').textContent=formatCurrency(revenueData.japan);
            document.getElementById('monthlyTrans').textContent=(revenueData.transactions||0)+'ê±´';
            document.getElementById('japanVisitors').textContent=(revenueData.japanVisitors||0)+'ëª…';

            const doctors=Object.entries(salesDetailData.doctorSales||{});
            document.getElementById('doctorSalesTable').innerHTML=doctors.length===0?
                '<tr><td colspan="4" class="text-muted" style="text-align:center;padding:2rem">ë°ì´í„° ì—†ìŒ</td></tr>':
                doctors.map(([name,data])=>`<tr><td><strong>${name}</strong></td><td>${data.count}ê±´</td><td class="text-success">${formatCurrency(data.amount)}</td><td>${total>0?((data.amount/total)*100).toFixed(1)+'%':'0%'}</td></tr>`).join('');

            const staffs=Object.entries(salesDetailData.staffSales||{});
            document.getElementById('staffSalesTable').innerHTML=staffs.length===0?
                '<tr><td colspan="4" class="text-muted" style="text-align:center;padding:2rem">ë°ì´í„° ì—†ìŒ</td></tr>':
                staffs.map(([name,data])=>`<tr><td><strong>${name}</strong></td><td>${data.count}ê±´</td><td class="text-success">${formatCurrency(data.amount)}</td><td style="color:var(--gold)"><strong>${formatCurrency(Math.round(data.amount*0.01))}</strong></td></tr>`).join('');
        }

        function renderEmployees(){
            const active=employees.filter(e=>e.isActive!==false);
            document.getElementById('totalEmp').textContent=employees.length;
            document.getElementById('activeEmp').textContent=active.length;

            document.getElementById('employeeTable').innerHTML=employees.length===0?
                '<tr><td colspan="6" class="text-muted" style="text-align:center;padding:2rem">ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>':
                employees.map(e=>`<tr>
                    <td><span class="badge badge-info">${e.id}</span></td>
                    <td><strong>${e.name}</strong>${e.matchName?'<br><small class="text-muted">ë§¤ì¹­: '+e.matchName+'</small>':''}</td>
                    <td>${e.role||'-'}</td>
                    <td>${e.joinDate||'-'}</td>
                    <td>${e.isActive!==false?'<span class="badge badge-success">ì¬ì§</span>':'<span class="badge" style="background:rgba(168,90,90,.15);color:var(--red)">í‡´ì‚¬</span>'}</td>
                    <td><div class="btn-group">
                        <button class="btn btn-sm" style="background:var(--border)" onclick="editEmployee('${e.id}')">ìˆ˜ì •</button>
                        <button class="btn btn-sm" style="background:var(--gold);color:#fff" onclick="resetPassword('${e.id}')">ë¹„ë²ˆì´ˆê¸°í™”</button>
                    </div></td>
                </tr>`).join('');
        }

        function renderLeaves(){
            document.getElementById('leaveTable').innerHTML=leaveRequests.length===0?
                '<tr><td colspan="5" class="text-muted" style="text-align:center;padding:2rem">ì‹ ì²­ ì—†ìŒ</td></tr>':
                leaveRequests.slice(0,10).map(l=>{
                    const emp=employees.find(e=>e.id===l.employeeId);
                    const statusBadge=l.status==='pending'?'badge-warning':l.status==='approved'?'badge-success':'';
                    return `<tr>
                        <td>${emp?.name||l.employeeId}</td>
                        <td>${l.type==='annual'?'ì—°ì°¨':l.type==='half'?'ë°˜ì°¨':'ì˜¤í”„'}</td>
                        <td>${l.startDate}~${l.endDate}</td>
                        <td><span class="badge ${statusBadge}">${l.status==='pending'?'ëŒ€ê¸°':l.status==='approved'?'ìŠ¹ì¸':'ë°˜ë ¤'}</span></td>
                        <td>${l.status==='pending'?`<div class="btn-group">
                            <button class="btn btn-sm" style="background:var(--green);color:#fff" onclick="approveLeave('${l.id}')">ìŠ¹ì¸</button>
                            <button class="btn btn-sm btn-danger" onclick="rejectLeave('${l.id}')">ë°˜ë ¤</button>
                        </div>`:'-'}</td>
                    </tr>`;
                }).join('');
        }

        function renderSalary(){
            const active=employees.filter(e=>e.isActive!==false);
            let totalSum=0;
            document.getElementById('salaryTable').innerHTML=active.length===0?
                '<tr><td colspan="5" class="text-muted" style="text-align:center;padding:2rem">ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>':
                active.map(e=>{
                    const staffSales=e.matchName&&salesDetailData.staffSales[e.matchName]?salesDetailData.staffSales[e.matchName].amount:0;
                    const incentive=Math.round(staffSales*0.01);
                    const total=(e.baseSalary||0)+(e.fixedOT||0)+incentive;
                    totalSum+=total;
                    return `<tr>
                        <td><strong>${e.name}</strong></td>
                        <td>${formatCurrency(e.baseSalary)}</td>
                        <td>${formatCurrency(e.fixedOT)}</td>
                        <td style="color:var(--gold)">${formatCurrency(incentive)}</td>
                        <td><strong>${formatCurrency(total)}</strong></td>
                    </tr>`;
                }).join('');
            document.getElementById('totalSalary').textContent=formatCurrency(totalSum);
        }

        // Employee Modal
        function generateEmpId(name,joinDate){
            if(!name||!joinDate)return null;
            const year=joinDate.substring(2,4);
            const initials=getInitials(name);
            return year+initials;
        }

        function getInitials(name){
            const cho=['ã„±','ã„²','ã„´','ã„·','ã„¸','ã„¹','ã…','ã…‚','ã…ƒ','ã……','ã…†','ã…‡','ã…ˆ','ã…‰','ã…Š','ã…‹','ã…Œ','ã…','ã…'];
            const map={'ã„±':'g','ã„²':'kk','ã„´':'n','ã„·':'d','ã„¸':'tt','ã„¹':'r','ã…':'m','ã…‚':'b','ã…ƒ':'pp','ã……':'s','ã…†':'ss','ã…‡':'','ã…ˆ':'j','ã…‰':'jj','ã…Š':'ch','ã…‹':'k','ã…Œ':'t','ã…':'p','ã…':'h'};
            let initials='';
            for(let i=0;i<name.length&&initials.length<3;i++){
                const c=name.charCodeAt(i);
                if(c>=0xAC00&&c<=0xD7A3){const idx=Math.floor((c-0xAC00)/588);initials+=map[cho[idx]]||'';}
                else if(/[a-zA-Z]/.test(name[i])){initials+=name[i].toLowerCase();}
            }
            return initials.substring(0,3).padEnd(3,'x');
        }

        function updateAutoId(){
            const name=document.getElementById('empName').value.trim();
            const joinDate=document.getElementById('empJoinDate').value;
            const preview=document.getElementById('autoIdPreview');
            const editId=document.getElementById('empEditId').value;
            if(editId){preview.textContent=editId+' (ìˆ˜ì •ë¶ˆê°€)';return;}
            if(name&&joinDate){preview.textContent=generateEmpId(name,joinDate);}
            else{preview.textContent='ì´ë¦„ê³¼ ì…ì‚¬ì¼ ì…ë ¥ì‹œ ìë™ìƒì„±';}
        }

        function openEmployeeModal(id=null){
            document.getElementById('employeeModal').classList.add('active');
            document.getElementById('employeeForm').reset();
            document.getElementById('empEditId').value='';
            document.getElementById('autoIdPreview').textContent='ì´ë¦„ê³¼ ì…ì‚¬ì¼ ì…ë ¥ì‹œ ìë™ìƒì„±';
            if(id){
                const e=employees.find(x=>x.id===id);
                if(e){
                    document.getElementById('empModalTitle').textContent='ì§ì› ìˆ˜ì •';
                    document.getElementById('empEditId').value=e.id;
                    document.getElementById('empName').value=e.name;
                    document.getElementById('empJoinDate').value=e.joinDate;
                    document.getElementById('empRole').value=e.role;
                    document.getElementById('empBaseSalary').value=e.baseSalary;
                    document.getElementById('empFixedOT').value=e.fixedOT||'';
                    document.getElementById('empHourlyWage').value=e.hourlyWage||'';
                    document.getElementById('empMatchName').value=e.matchName||'';
                    document.getElementById('empIsActive').value=e.isActive!==false?'true':'false';
                    updateAutoId();
                }
            }else{
                document.getElementById('empModalTitle').textContent='ì§ì› ì¶”ê°€';
            }
        }

        function closeEmployeeModal(){document.getElementById('employeeModal').classList.remove('active');}
        function editEmployee(id){openEmployeeModal(id);}

        document.getElementById('employeeForm').addEventListener('submit',async e=>{
            e.preventDefault();
            const editId=document.getElementById('empEditId').value;
            const data={
                name:document.getElementById('empName').value,
                role:document.getElementById('empRole').value,
                joinDate:document.getElementById('empJoinDate').value,
                baseSalary:parseInt(document.getElementById('empBaseSalary').value)||0,
                fixedOT:parseInt(document.getElementById('empFixedOT').value)||0,
                hourlyWage:parseInt(document.getElementById('empHourlyWage').value)||0,
                matchName:document.getElementById('empMatchName').value||null,
                isActive:document.getElementById('empIsActive').value==='true',
                updatedAt:firebase.firestore.FieldValue.serverTimestamp()
            };
            try{
                if(editId){
                    await db.collection('employees').doc(editId).update(data);
                    alert('ìˆ˜ì • ì™„ë£Œ');
                }else{
                    const newId=generateEmpId(data.name,data.joinDate);
                    if(!newId){alert('ì‚¬ë²ˆ ìƒì„± ì‹¤íŒ¨');return;}
                    data.createdAt=firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('employees').doc(newId).set(data);
                    alert('ì¶”ê°€ ì™„ë£Œ: '+newId);
                }
                closeEmployeeModal();
                await loadEmployees();
                renderAll();
            }catch(err){alert('ì €ì¥ ì‹¤íŒ¨: '+err.message);}
        });

        async function resetPassword(id){
            if(!confirm(id+' ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”?\nì„ì‹œ: '+DEFAULT_PW))return;
            try{
                await db.collection('employees').doc(id).update({password:DEFAULT_PW});
                alert('ì´ˆê¸°í™” ì™„ë£Œ');
            }catch(err){alert(err.message);}
        }

        // Leave
        async function approveLeave(id){
            if(!confirm('ìŠ¹ì¸?'))return;
            try{
                await db.collection('leaveRequests').doc(id).update({status:'approved',approvedAt:firebase.firestore.FieldValue.serverTimestamp()});
                alert('ìŠ¹ì¸ ì™„ë£Œ');
                await loadLeaveRequests();
                renderLeaves();
            }catch(err){alert(err.message);}
        }

        async function rejectLeave(id){
            if(!confirm('ë°˜ë ¤?'))return;
            try{
                await db.collection('leaveRequests').doc(id).update({status:'rejected',rejectedAt:firebase.firestore.FieldValue.serverTimestamp()});
                alert('ë°˜ë ¤ ì™„ë£Œ');
                await loadLeaveRequests();
                renderLeaves();
            }catch(err){alert(err.message);}
        }

        // Revenue
        async function saveRevenueData(){
            const ym=getYM();
            const total=parseInt((document.getElementById('inputTotalRevenue').value||'').replace(/,/g,''))||0;
            const japan=parseInt((document.getElementById('inputJapanRevenue').value||'').replace(/,/g,''))||0;
            const jVis=parseInt(document.getElementById('inputJapanVisitors').value)||0;
            const trans=parseInt(document.getElementById('inputTransactions').value)||0;
            try{
                await db.collection('revenue').doc(ym).set({total,japan,japanVisitors:jVis,transactions:trans,updatedAt:firebase.firestore.FieldValue.serverTimestamp()});
                revenueData={total,japan,japanVisitors:jVis,transactions:trans};
                alert('ì €ì¥ ì™„ë£Œ');
                renderSales();
            }catch(err){alert(err.message);}
        }

        // File Upload
        const uploadZone=document.getElementById('uploadZone');
        uploadZone.addEventListener('click',()=>document.getElementById('fileInput').click());
        uploadZone.addEventListener('dragover',e=>{e.preventDefault();uploadZone.style.borderColor='var(--gold)';});
        uploadZone.addEventListener('dragleave',()=>uploadZone.style.borderColor='var(--border)');
        uploadZone.addEventListener('drop',e=>{e.preventDefault();uploadZone.style.borderColor='var(--border)';if(e.dataTransfer.files[0])processFile(e.dataTransfer.files[0]);});
        function handleFileUpload(e){if(e.target.files[0])processFile(e.target.files[0]);}

        function processFile(file){
            const reader=new FileReader();
            reader.onload=function(e){
                try{
                    const data=new Uint8Array(e.target.result);
                    const wb=XLSX.read(data,{type:'array'});
                    const sheet=wb.Sheets[wb.SheetNames[0]];
                    const json=XLSX.utils.sheet_to_json(sheet);
                    
                    let totalRev=0,japanRev=0,japanCount=0,year='',month='';
                    const doctorSales={},staffSales={};
                    
                    json.forEach(row=>{
                        const amount=parseInt(row['ê¸ˆì•¡'])||0;
                        totalRev+=amount;
                        
                        const doctor=row['ì§„ë£Œì˜ëª…'];
                        if(doctor&&doctor!=='ë¹ ë¥¸ì˜ˆì•½'){
                            if(!doctorSales[doctor])doctorSales[doctor]={count:0,amount:0};
                            doctorSales[doctor].count++;
                            doctorSales[doctor].amount+=amount;
                        }
                        
                        const staff=row['ë‹´ë‹¹ì§ì›'];
                        if(staff){
                            if(!staffSales[staff])staffSales[staff]={count:0,amount:0};
                            staffSales[staff].count++;
                            staffSales[staff].amount+=amount;
                        }
                        
                        const nationality=row['êµ­ì '];
                        if(nationality&&nationality.includes('ì¼ë³¸')){
                            japanRev+=amount;
                            japanCount++;
                        }
                        
                        if(row['ì§„ë£Œì¼']&&!year){
                            const d=String(row['ì§„ë£Œì¼']);
                            if(d.length>=6){year=d.substring(0,4);month=d.substring(4,6);}
                        }
                    });
                    
                    const ym=year+'-'+month;
                    
                    db.collection('revenue').doc(ym).set({
                        total:totalRev,japan:japanRev,japanVisitors:japanCount,transactions:json.length,
                        uploadedAt:firebase.firestore.FieldValue.serverTimestamp()
                    },{merge:true});
                    
                    db.collection('salesDetail').doc(ym).set({
                        doctorSales,staffSales,
                        updatedAt:firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    alert('ì—…ë¡œë“œ ì™„ë£Œ!\n\nì—°ì›”: '+ym+'\nê±´ìˆ˜: '+json.length+'ê±´\nì´ë§¤ì¶œ: '+formatCurrency(totalRev)+'\n\nì§„ë£Œì˜: '+Object.keys(doctorSales).join(', ')+'\në‹´ë‹¹ì§ì›: '+Object.keys(staffSales).join(', ')+'\n\nì¼ë³¸ì¸ë§¤ì¶œ: '+formatCurrency(japanRev)+' ('+japanCount+'ê±´)');
                    
                    if(ym===getYM()){
                        loadRevenueData().then(()=>loadSalesDetailData().then(()=>renderAll()));
                    }
                }catch(err){alert('íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜: '+err.message);}
            };
            reader.readAsArrayBuffer(file);
        }

        // Init
        checkAdminLogin();
    </script>
</body>
</html>
