<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE CLINIC LUMI - ê´€ë¦¬ì</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon.png">
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--bg-primary:#faf9f7;--bg-secondary:#ffffff;--bg-card:#ffffff;--accent-gold:#9a8b7a;--accent-dark:#2c2c2c;--accent-green:#5a7a5a;--accent-red:#a85a5a;--accent-blue:#5a6a7a;--text-primary:#2c2c2c;--text-secondary:#6b6b6b;--text-muted:#999999;--border-color:#e8e4df;--gradient-1:linear-gradient(135deg,#9a8b7a,#c4b5a5)}
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Noto Sans KR',sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh}
        .login-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;padding:2rem;position:fixed;top:0;left:0;right:0;bottom:0;z-index:2000;background:var(--bg-primary)}
        .login-screen.hidden{display:none}
        .login-logo{font-family:'Cormorant Garamond',serif;letter-spacing:4px;color:var(--text-muted);font-size:.9rem;margin-bottom:.5rem}
        .login-title{font-family:'Cormorant Garamond',serif;font-size:2.5rem;font-weight:500;margin-bottom:2rem;color:var(--text-primary);letter-spacing:2px}
        .login-subtitle{color:var(--text-muted);margin-bottom:2rem;font-size:.85rem;letter-spacing:1px}
        .login-form{width:100%;max-width:320px}
        .login-input{width:100%;padding:1rem;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:0;color:var(--text-primary);font-size:1rem;margin-bottom:1rem}
        .login-input:focus{outline:none;border-color:var(--accent-gold)}.login-input::placeholder{color:var(--text-muted)}
        .pw-wrapper{position:relative}.pw-toggle{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1rem;margin-top:-8px}
        .login-btn{width:100%;padding:1rem;background:var(--accent-dark);border:none;color:white;font-size:.9rem;font-weight:500;cursor:pointer;letter-spacing:1px;margin-top:.5rem}
        .login-btn:hover{background:#1a1a1a}
        .login-error{color:var(--accent-red);font-size:.85rem;text-align:center;margin-bottom:1rem}
        .login-notice{color:var(--accent-gold);font-size:.75rem;text-align:center;margin-top:1.5rem;padding:1rem;background:rgba(154,139,122,.1);border:1px solid var(--border-color)}
        .header{background:var(--bg-secondary);border-bottom:1px solid var(--border-color);padding:1.25rem 2rem;position:sticky;top:0;z-index:100}
        .header-content{display:flex;justify-content:space-between;align-items:center;max-width:1800px;margin:0 auto}
        .logo{display:flex;flex-direction:column}.logo-sub{font-family:'Cormorant Garamond',serif;font-size:.7rem;letter-spacing:3px;color:var(--text-muted)}
        .logo-text{font-family:'Cormorant Garamond',serif;font-size:1.5rem;font-weight:500;letter-spacing:2px;color:var(--text-primary)}
        .header-right{display:flex;align-items:center;gap:1rem}
        .logout-btn{padding:.5rem 1rem;background:transparent;border:1px solid var(--border-color);color:var(--text-secondary);font-size:.8rem;cursor:pointer;letter-spacing:1px}
        .logout-btn:hover{border-color:var(--accent-red);color:var(--accent-red)}
        .main-nav{display:flex;gap:0;background:var(--bg-secondary);border-bottom:1px solid var(--border-color)}
        .nav-item{padding:1rem 2rem;background:transparent;border:none;border-bottom:2px solid transparent;color:var(--text-secondary);cursor:pointer;font-size:.85rem;font-weight:500;letter-spacing:1px;transition:all .2s}
        .nav-item:hover{color:var(--text-primary)}.nav-item.active{color:var(--text-primary);border-bottom-color:var(--accent-gold)}
        .sub-nav{display:flex;gap:.5rem;padding:1rem 2rem;background:var(--bg-primary);border-bottom:1px solid var(--border-color);flex-wrap:wrap}
        .sub-nav-item{padding:.5rem 1rem;background:transparent;border:1px solid var(--border-color);color:var(--text-secondary);cursor:pointer;font-size:.8rem;transition:all .2s}
        .sub-nav-item:hover{border-color:var(--accent-gold);color:var(--text-primary)}.sub-nav-item.active{background:var(--accent-gold);border-color:var(--accent-gold);color:white}
        .main{padding:2rem;max-width:1800px;margin:0 auto}.section{display:none}.section.active{display:block}
        .app-container{display:none}.app-container.active{display:block}
        .card{background:var(--bg-card);padding:1.5rem;border:1px solid var(--border-color);margin-bottom:1.5rem}
        .card-title{font-size:.9rem;font-weight:600;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem;color:var(--text-primary);letter-spacing:.5px}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1.5rem}
        .stat-card{background:var(--bg-card);padding:1.5rem;border:1px solid var(--border-color);position:relative}
        .stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--accent-gold)}
        .stat-card.green::before{background:var(--accent-green)}.stat-card.orange::before{background:#c4956a}.stat-card.purple::before{background:#7a6a8a}.stat-card.cyan::before{background:var(--accent-blue)}
        .stat-label{color:var(--text-secondary);font-size:.8rem;margin-bottom:.5rem;letter-spacing:.5px}.stat-value{font-size:1.4rem;font-weight:600}
        .table-wrapper{overflow-x:auto}table{width:100%;border-collapse:collapse}
        th,td{padding:.75rem;text-align:left;border-bottom:1px solid var(--border-color)}th{color:var(--text-secondary);font-weight:500;font-size:.75rem;letter-spacing:.5px;text-transform:uppercase}td{font-size:.85rem}tr:hover{background:rgba(154,139,122,.03)}
        .btn{padding:.5rem 1rem;border:none;cursor:pointer;font-size:.8rem;font-weight:500;transition:all .2s;letter-spacing:.5px}
        .btn-primary{background:var(--accent-dark);color:white}.btn-primary:hover{background:#1a1a1a}
        .btn-success{background:var(--accent-green);color:white}.btn-danger{background:var(--accent-red);color:white}
        .btn-secondary{background:transparent;color:var(--text-primary);border:1px solid var(--border-color)}.btn-secondary:hover{border-color:var(--accent-gold)}
        .btn-warning{background:#c4956a;color:white}
        .btn-sm{padding:.4rem .8rem;font-size:.75rem}.btn-group{display:flex;gap:.5rem}
        .form-group{margin-bottom:1rem}.form-label{display:block;margin-bottom:.5rem;color:var(--text-secondary);font-size:.8rem;letter-spacing:.5px}
        .form-input,.form-select{width:100%;padding:.75rem;background:var(--bg-secondary);border:1px solid var(--border-color);color:var(--text-primary);font-size:.9rem}
        .form-input:focus,.form-select:focus{outline:none;border-color:var(--accent-gold)}
        .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem}
        .modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center}
        .modal-overlay.active{display:flex}.modal{background:var(--bg-card);padding:2rem;width:90%;max-width:700px;max-height:90vh;overflow-y:auto;border:1px solid var(--border-color)}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid var(--border-color)}
        .modal-title{font-size:1.1rem;font-weight:600;letter-spacing:.5px}.modal-close{background:none;border:none;color:var(--text-muted);font-size:1.5rem;cursor:pointer}
        .badge{display:inline-flex;padding:.25rem .75rem;font-size:.7rem;font-weight:500;letter-spacing:.5px}
        .badge-success{background:rgba(90,122,90,.15);color:var(--accent-green)}.badge-danger{background:rgba(168,90,90,.15);color:var(--accent-red)}
        .badge-warning{background:rgba(196,149,106,.15);color:#a07a4a}.badge-info{background:rgba(90,106,122,.15);color:var(--accent-blue)}
        .badge-purple{background:rgba(122,106,138,.15);color:#7a6a8a}
        .chart-container{height:300px;position:relative}.charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:1.5rem}
        .summary-row{display:flex;justify-content:space-between;padding:1rem;background:var(--bg-primary);margin-top:1rem;font-weight:600;border:1px solid var(--border-color)}
        .text-success{color:var(--accent-green)}.text-danger{color:var(--accent-red)}.text-warning{color:#c4956a}.text-purple{color:#7a6a8a}.text-muted{color:var(--text-muted)}.text-right{text-align:right}
        .mb-2{margin-bottom:1rem}.mt-2{margin-top:1rem}.flex{display:flex}.justify-between{justify-content:space-between}.items-center{align-items:center}.gap-1{gap:.5rem}
        .memo-input{background:transparent;border:1px solid var(--border-color);padding:.25rem .5rem;color:var(--text-secondary);font-size:.8rem;width:100%}
        .upload-zone{border:1px dashed var(--border-color);padding:3rem;text-align:center;cursor:pointer;transition:all .3s;margin-bottom:1.5rem;background:var(--bg-secondary)}
        .upload-zone:hover,.upload-zone.dragover{border-color:var(--accent-gold);background:rgba(154,139,122,.05)}
        .upload-icon{font-size:2.5rem;margin-bottom:1rem;opacity:.5}.upload-title{font-size:1rem;font-weight:500;margin-bottom:.5rem}.upload-desc{color:var(--text-muted);font-size:.8rem}
        .emp-chip{display:inline-flex;align-items:center;gap:.25rem;padding:.25rem .5rem;background:var(--bg-primary);border:1px solid var(--border-color);font-size:.75rem;margin:.125rem}
        .incentive-item{background:var(--bg-primary);padding:1rem;margin-bottom:.75rem;border:1px solid var(--border-color)}
        .incentive-item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}
        .incentive-item-name{font-weight:600;font-size:.9rem}
        .doctor-card{background:var(--bg-primary);padding:1.25rem;text-align:center;border:1px solid var(--border-color)}
        .doctor-card .name{font-size:1rem;font-weight:500;margin-bottom:.5rem}
        .doctor-card .amount{font-size:1.3rem;font-weight:600;color:var(--accent-gold)}
        .doctor-card .count{font-size:.8rem;color:var(--text-muted);margin-top:.25rem}
        .auto-id-preview{background:var(--bg-primary);padding:.75rem;border:1px solid var(--border-color);margin-top:.5rem;font-family:monospace;font-size:.9rem;color:var(--accent-gold)}
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-logo">THE CLINIC</div>
        <div class="login-title">LUMI</div>
        <div class="login-subtitle">ADMINISTRATOR</div>
        <div class="login-form">
            <input type="text" class="login-input" id="adminId" placeholder="ê´€ë¦¬ì ID" autocapitalize="none">
            <div class="pw-wrapper">
                <input type="password" class="login-input" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸">
                <button type="button" class="pw-toggle" onclick="togglePw('adminPw',this)">ğŸ‘</button>
            </div>
            <div class="login-error" id="loginError"></div>
            <button class="login-btn" onclick="handleAdminLogin()">ë¡œê·¸ì¸</button>
            <div class="login-notice">ë³´ì•ˆì„ ìœ„í•´ ë¹„ë°€ë²ˆí˜¸ëŠ” 3ê°œì›”ë§ˆë‹¤ ë³€ê²½í•´ì£¼ì„¸ìš”.</div>
        </div>
    </div>
    <div class="app-container" id="appContainer">
        <header class="header">
            <div class="header-content">
                <div class="logo"><div class="logo-sub">THE CLINIC</div><div class="logo-text">LUMI</div></div>
                <div class="header-right">
                    <select class="form-select" id="selectedYear" onchange="loadAllData()" style="width:auto"><option value="2026" selected>2026</option><option value="2025">2025</option><option value="2024">2024</option></select>
                    <select class="form-select" id="selectedMonth" onchange="loadAllData()" style="width:auto">
                        <option value="01" selected>1ì›”</option><option value="02">2ì›”</option><option value="03">3ì›”</option><option value="04">4ì›”</option><option value="05">5ì›”</option><option value="06">6ì›”</option>
                        <option value="07">7ì›”</option><option value="08">8ì›”</option><option value="09">9ì›”</option><option value="10">10ì›”</option><option value="11">11ì›”</option><option value="12">12ì›”</option>
                    </select>
                    <button class="logout-btn" onclick="adminLogout()">LOGOUT</button>
                </div>
            </div>
        </header>
        <nav class="main-nav">
            <button class="nav-item active" data-nav="sales">ë§¤ì¶œ</button>
            <button class="nav-item" data-nav="expense">ì§€ì¶œ</button>
            <button class="nav-item" data-nav="staff">ì§ì›ê´€ë¦¬</button>
        </nav>
        <main class="main">
            <div class="section active" id="sales-section">
                <div class="sub-nav">
                    <button class="sub-nav-item active" data-sub="sales-overview">ë§¤ì¶œ í˜„í™©</button>
                    <button class="sub-nav-item" data-sub="sales-doctor">ì§„ë£Œì˜ë³„</button>
                    <button class="sub-nav-item" data-sub="sales-staff">ë‹´ë‹¹ì§ì›ë³„</button>
                    <button class="sub-nav-item" data-sub="sales-japan">ì¼ë³¸ì¸ ë§¤ì¶œ</button>
                    <button class="sub-nav-item" data-sub="sales-data">ë°ì´í„° ê´€ë¦¬</button>
                </div>
                <div class="section active" id="sales-overview">
                    <div class="stats-grid" style="margin-top:1.5rem">
                        <div class="stat-card"><div class="stat-label">ì´ë²ˆë‹¬ ì´ë§¤ì¶œ</div><div class="stat-value" id="monthlyTotal">â‚©0</div></div>
                        <div class="stat-card green"><div class="stat-label">ì „ë…„ ë™ì›” ëŒ€ë¹„</div><div class="stat-value text-success" id="monthlyGrowth">+â‚©0</div></div>
                        <div class="stat-card orange"><div class="stat-label">ê±°ë˜ ê±´ìˆ˜</div><div class="stat-value text-warning" id="monthlyTrans">0ê±´</div></div>
                        <div class="stat-card purple"><div class="stat-label">í‰ê·  ê°ë‹¨ê°€</div><div class="stat-value text-purple" id="monthlyAvg">â‚©0</div></div>
                    </div>
                    <div class="charts-grid">
                        <div class="card"><div class="card-title">ì›”ë³„ ë§¤ì¶œ ì¶”ì´</div><div class="chart-container"><canvas id="monthlyChart"></canvas></div></div>
                        <div class="card"><div class="card-title">ì—°ë„ë³„ ë¹„êµ</div><div class="chart-container"><canvas id="yearCompareChart"></canvas></div></div>
                    </div>
                </div>
                <div class="section" id="sales-doctor">
                    <h2 class="mb-2" style="margin-top:1.5rem;font-weight:500">ì§„ë£Œì˜ë³„ ë§¤ì¶œ</h2>
                    <div class="stats-grid" id="doctorSalesGrid"><div style="text-align:center;padding:2rem;color:var(--text-muted);grid-column:1/-1">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´ í‘œì‹œë©ë‹ˆë‹¤.</div></div>
                    <div class="card"><div class="card-title">ì§„ë£Œì˜ë³„ ìƒì„¸</div>
                        <div class="table-wrapper"><table><thead><tr><th>ì§„ë£Œì˜</th><th>ê±´ìˆ˜</th><th>ë§¤ì¶œ</th><th>ë¹„ì¤‘</th></tr></thead>
                            <tbody id="doctorSalesTable"><tr><td colspan="4" style="text-align:center;padding:2rem;color:var(--text-muted)">ë°ì´í„° ì—†ìŒ</td></tr></tbody>
                        </table></div>
                    </div>
                </div>
                <div class="section" id="sales-staff">
                    <h2 class="mb-2" style="margin-top:1.5rem;font-weight:500">ë‹´ë‹¹ì§ì›ë³„ ë§¤ì¶œ</h2>
                    <div class="stats-grid" id="staffSalesGrid"><div style="text-align:center;padding:2rem;color:var(--text-muted);grid-column:1/-1">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´ í‘œì‹œë©ë‹ˆë‹¤.</div></div>
                    <div class="card"><div class="card-title">ë‹´ë‹¹ì§ì›ë³„ ìƒì„¸ (ì¸ì„¼í‹°ë¸Œ 1%)</div>
                        <div class="table-wrapper"><table><thead><tr><th>ë‹´ë‹¹ì§ì›</th><th>ê±´ìˆ˜</th><th>ë§¤ì¶œ</th><th>ì¸ì„¼í‹°ë¸Œ (1%)</th></tr></thead>
                            <tbody id="staffSalesTable"><tr><td colspan="4" style="text-align:center;padding:2rem;color:var(--text-muted)">ë°ì´í„° ì—†ìŒ</td></tr></tbody>
                        </table></div>
                    </div>
                </div>
                <div class="section" id="sales-japan">
                    <div class="stats-grid" style="margin-top:1.5rem">
                        <div class="stat-card purple"><div class="stat-label">ì¼ë³¸ì¸ ë§¤ì¶œ</div><div class="stat-value text-purple" id="japanRevenue">â‚©0</div></div>
                        <div class="stat-card cyan"><div class="stat-label">ì¼ë³¸ì¸ ë‚´ì›ìˆ˜</div><div class="stat-value" style="color:var(--accent-blue)" id="japanVisitors">0ëª…</div></div>
                        <div class="stat-card orange"><div class="stat-label">ì¼ë³¸ì¸ ê°ë‹¨ê°€</div><div class="stat-value text-warning" id="japanAvg">â‚©0</div></div>
                        <div class="stat-card"><div class="stat-label">ì „ì²´ ë§¤ì¶œ ë¹„ì¤‘</div><div class="stat-value" id="japanRatio">0%</div></div>
                    </div>
                    <div class="card"><div class="card-title">ë‹´ë‹¹ì§ì›ë³„ ì¼ë³¸ì¸ ë§¤ì¶œ</div>
                        <div class="table-wrapper"><table><thead><tr><th>ë‹´ë‹¹ì§ì›</th><th>ê±´ìˆ˜</th><th>ë§¤ì¶œ</th><th>ì¸ì„¼í‹°ë¸Œ (1%)</th></tr></thead>
                            <tbody id="japanStaffTable"><tr><td colspan="4" style="text-align:center;padding:2rem;color:var(--text-muted)">ë°ì´í„° ì—†ìŒ</td></tr></tbody>
                        </table></div>
                    </div>
                </div>
                <div class="section" id="sales-data">
                    <div class="upload-zone" id="uploadZone" style="margin-top:1.5rem">
                        <div class="upload-icon">ğŸ“</div>
                        <div class="upload-title">ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­</div>
                        <div class="upload-desc">ì§€ì› í˜•ì‹: .xlsx, .xls, .csv</div>
                        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleFileUpload(event)">
                    </div>
                    <div class="card"><div class="card-title">ì›”ë³„ ë§¤ì¶œ ìˆ˜ë™ ì…ë ¥</div>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">ì´ ë§¤ì¶œ</label><input type="text" class="form-input" id="inputTotalRevenue" placeholder="200,000,000"></div>
                            <div class="form-group"><label class="form-label">ì¼ë³¸ì¸ ë§¤ì¶œ</label><input type="text" class="form-input" id="inputJapanRevenue" placeholder="20,000,000"></div>
                            <div class="form-group"><label class="form-label">ì¼ë³¸ì¸ ë‚´ì›ìˆ˜</label><input type="number" class="form-input" id="inputJapanVisitors" placeholder="25"></div>
                            <div class="form-group"><label class="form-label">ê±°ë˜ ê±´ìˆ˜</label><input type="number" class="form-input" id="inputTransactions" placeholder="3000"></div>
                        </div>
                        <button class="btn btn-primary" onclick="saveRevenueData()">ì €ì¥</button>
                    </div>
                </div>
            </div>
            <!-- ì§€ì¶œ ì„¹ì…˜ -->
            <div class="section" id="expense-section">
                <div class="sub-nav">
                    <button class="sub-nav-item active" data-sub="expense-fixed">ê³ ì •ë¹„</button>
                    <button class="sub-nav-item" data-sub="expense-variable">ìœ ë™ë¹„</button>
                </div>
                <div class="section active" id="expense-fixed">
                    <div class="card" style="margin-top:1.5rem">
                        <div class="flex justify-between items-center mb-2"><div class="card-title">ê³ ì •ë¹„ ê´€ë¦¬</div><button class="btn btn-primary btn-sm" onclick="openExpenseModal('fixed')">+ ì¶”ê°€</button></div>
                        <div class="table-wrapper"><table><thead><tr><th>í•­ëª©</th><th>ê¸ˆì•¡</th><th>ì£¼ê¸°</th><th>ë©”ëª¨</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="fixedExpenseTable"><tr><td colspan="5" style="text-align:center;padding:2rem;color:var(--text-muted)">í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr></tbody>
                        </table></div>
                        <div class="summary-row"><span>ì›” ê³ ì •ë¹„ í•©ê³„</span><span class="text-danger" id="fixedExpenseTotal">â‚©0</span></div>
                    </div>
                </div>
                <div class="section" id="expense-variable">
                    <div class="card" style="margin-top:1.5rem">
                        <div class="flex justify-between items-center mb-2"><div class="card-title">ìœ ë™ë¹„ ê´€ë¦¬</div><button class="btn btn-primary btn-sm" onclick="openExpenseModal('variable')">+ ì¶”ê°€</button></div>
                        <div class="table-wrapper"><table><thead><tr><th>ë‚ ì§œ</th><th>í•­ëª©</th><th>ì¹´í…Œê³ ë¦¬</th><th>ê¸ˆì•¡</th><th>ë©”ëª¨</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="variableExpenseTable"><tr><td colspan="6" style="text-align:center;padding:2rem;color:var(--text-muted)">í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr></tbody>
                        </table></div>
                        <div class="summary-row"><span>ì´ë²ˆë‹¬ ìœ ë™ë¹„ í•©ê³„</span><span class="text-warning" id="variableExpenseTotal">â‚©0</span></div>
                    </div>
                </div>
            </div>

            <!-- ì§ì›ê´€ë¦¬ ì„¹ì…˜ -->
            <div class="section" id="staff-section">
                <div class="sub-nav">
                    <button class="sub-nav-item active" data-sub="staff-list">ì§ì›ê´€ë¦¬</button>
                    <button class="sub-nav-item" data-sub="staff-leave">íœ´ê°€ê´€ë¦¬</button>
                    <button class="sub-nav-item" data-sub="staff-attendance">ê·¼íƒœí˜„í™©</button>
                    <button class="sub-nav-item" data-sub="staff-overtime">ì˜¤ë²„íƒ€ì„</button>
                    <button class="sub-nav-item" data-sub="staff-incentive">ì¸ì„¼í‹°ë¸Œ</button>
                    <button class="sub-nav-item" data-sub="staff-salary">ê¸‰ì—¬</button>
                </div>
                <div class="section active" id="staff-list">
                    <div class="flex justify-between items-center mb-2" style="margin-top:1.5rem"><h2 style="font-weight:500">ì§ì› ê´€ë¦¬</h2><button class="btn btn-primary" onclick="openEmployeeModal()">+ ì§ì› ì¶”ê°€</button></div>
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-label">ì „ì²´ ì§ì›</div><div class="stat-value" id="totalEmployees">-</div></div>
                        <div class="stat-card green"><div class="stat-label">ì¬ì§ì¤‘</div><div class="stat-value text-success" id="activeEmployees">-</div></div>
                        <div class="stat-card orange"><div class="stat-label">í‡´ì‚¬</div><div class="stat-value text-danger" id="inactiveEmployees">-</div></div>
                        <div class="stat-card purple"><div class="stat-label">ì´ë²ˆë‹¬ ìƒì¼</div><div class="stat-value text-purple" id="birthdayCount">-</div></div>
                    </div>
                    <div class="card"><div class="table-wrapper"><table>
                        <thead><tr><th>ì‚¬ë²ˆ</th><th>ì´ë¦„</th><th>ë‚˜ì´</th><th>ì§ê¸‰</th><th>ì…ì‚¬ì¼</th><th>ê·¼ì†</th><th>ìƒíƒœ</th><th>ë¹„ë°€ë²ˆí˜¸</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="employeeTableBody"><tr><td colspan="9" style="text-align:center;padding:2rem;color:var(--text-muted)">ë¡œë”©ì¤‘...</td></tr></tbody>
                    </table></div></div>
                </div>
                <div class="section" id="staff-leave">
                    <h2 class="mb-2" style="margin-top:1.5rem;font-weight:500">íœ´ê°€ ê´€ë¦¬</h2>
                    <div class="stats-grid">
                        <div class="stat-card orange"><div class="stat-label">ìŠ¹ì¸ ëŒ€ê¸°</div><div class="stat-value text-warning" id="pendingLeaves">-</div></div>
                        <div class="stat-card green"><div class="stat-label">ì´ë²ˆë‹¬ ìŠ¹ì¸</div><div class="stat-value text-success" id="approvedLeaves">-</div></div>
                    </div>
                    <div class="card"><div class="table-wrapper"><table>
                        <thead><tr><th>ì‹ ì²­ì¼</th><th>ì§ì›</th><th>ìœ í˜•</th><th>ê¸°ê°„</th><th>ì‚¬ìœ </th><th>ìƒíƒœ</th><th>ì²˜ë¦¬</th></tr></thead>
                        <tbody id="leaveTableBody"><tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-muted)">íœ´ê°€ ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr></tbody>
                    </table></div></div>
                </div>
                <div class="section" id="staff-attendance">
                    <h2 class="mb-2" style="margin-top:1.5rem;font-weight:500">ê·¼íƒœ í˜„í™©</h2>
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-label">ì´ë²ˆë‹¬ ê·¼ë¬´ì¼</div><div class="stat-value" id="workDays">-</div></div>
                        <div class="stat-card green"><div class="stat-label">ê¸ˆì¼ ì¶œê·¼</div><div class="stat-value text-success" id="todayPresent">-</div></div>
                    </div>
                    <div class="card"><div class="table-wrapper"><table>
                        <thead><tr><th>ì§ì›</th><th>ì‚¬ë²ˆ</th><th>ê¸ˆì¼ ì¶œê·¼</th><th>ê¸ˆì¼ í‡´ê·¼</th><th>ì¶œê·¼ì¼ìˆ˜</th><th>ì§€ê°</th><th>ì´ OT</th></tr></thead>
                        <tbody id="attendanceTableBody"><tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-muted)">ë¡œë”©ì¤‘...</td></tr></tbody>
                    </table></div></div>
                </div>
                <div class="section" id="staff-overtime">
                    <h2 class="mb-2" style="margin-top:1.5rem;font-weight:500">ì˜¤ë²„íƒ€ì„ í˜„í™©</h2>
                    <div class="stats-grid">
                        <div class="stat-card orange"><div class="stat-label">ì´ë²ˆë‹¬ ì´ OT</div><div class="stat-value text-warning" id="totalOT">-</div></div>
                        <div class="stat-card green"><div class="stat-label">ì´ OT ë¹„ìš© (ì„¸í›„)</div><div class="stat-value text-success" id="totalOTNet">-</div></div>
                    </div>
                    <div class="card"><div class="table-wrapper"><table>
                        <thead><tr><th>ì§ì›</th><th>ì‹œê¸‰</th><th>í‡´ê·¼í›„ OT</th><th>ì ì‹¬ OT</th><th>ì´ OT</th><th>ì„¸í›„</th></tr></thead>
                        <tbody id="overtimeTableBody"><tr><td colspan="6" style="text-align:center;padding:2rem;color:var(--text-muted)">ë¡œë”©ì¤‘...</td></tr></tbody>
                    </table></div>
                    <div class="summary-row"><span>í•©ê³„</span><span><span id="sumOTHours">0H</span> | ì„¸í›„ <span class="text-success" id="sumOTNet">â‚©0</span></span></div>
                    </div>
                </div>
                <div class="section" id="staff-incentive">
                    <h2 class="mb-2" style="margin-top:1.5rem;font-weight:500">ì¸ì„¼í‹°ë¸Œ ê´€ë¦¬</h2>
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-label">ì¸ì„¼í‹°ë¸Œ í•­ëª© ìˆ˜</div><div class="stat-value" id="incentiveItemCount">0ê°œ</div></div>
                        <div class="stat-card green"><div class="stat-label">ì´ë²ˆë‹¬ ì´ ì¸ì„¼í‹°ë¸Œ</div><div class="stat-value text-success" id="totalIncentiveSum">â‚©0</div></div>
                    </div>
                    <div class="card">
                        <div class="flex justify-between items-center mb-2"><div class="card-title">ì¸ì„¼í‹°ë¸Œ í•­ëª© ì„¤ì •</div><button class="btn btn-primary btn-sm" onclick="openIncentiveItemModal()">+ í•­ëª© ì¶”ê°€</button></div>
                        <div id="incentiveItemsList"></div>
                    </div>
                    <div class="card"><div class="card-title">ì§ì›ë³„ ì¸ì„¼í‹°ë¸Œ í˜„í™©</div>
                        <div class="table-wrapper"><table>
                            <thead><tr><th>ì§ì›</th><th>ì ìš© í•­ëª©</th><th>ì‹¤ì </th><th>ì´ë²ˆë‹¬ ì¸ì„¼í‹°ë¸Œ</th></tr></thead>
                            <tbody id="incentiveTableBody"><tr><td colspan="4" style="text-align:center;padding:2rem;color:var(--text-muted)">ë¡œë”©ì¤‘...</td></tr></tbody>
                        </table></div>
                    </div>
                </div>
                <div class="section" id="staff-salary">
                    <h2 class="mb-2" style="margin-top:1.5rem;font-weight:500">ê¸‰ì—¬ í˜„í™©</h2>
                    <div class="card"><div class="table-wrapper"><table>
                        <thead><tr><th>ì§ì›</th><th>ê¸°ë³¸ê¸‰</th><th>ê³ ì •OT</th><th>ì¶”ê°€OT</th><th>ì¸ì„¼í‹°ë¸Œ</th><th>ì´ ê¸‰ì—¬</th><th style="width:150px">ë©”ëª¨</th></tr></thead>
                        <tbody id="salaryTableBody"><tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-muted)">ë¡œë”©ì¤‘...</td></tr></tbody>
                    </table></div>
                    <div class="summary-row"><span>ì´ ê¸‰ì—¬ í•©ê³„</span><span class="text-success" style="font-size:1.1rem" id="totalSalarySum">â‚©0</span></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ì§ì› ëª¨ë‹¬ -->
    <div class="modal-overlay" id="employeeModal">
        <div class="modal">
            <div class="modal-header"><div class="modal-title" id="employeeModalTitle">ì§ì› ì¶”ê°€</div><button class="modal-close" onclick="closeEmployeeModal()">&times;</button></div>
            <form id="employeeForm">
                <input type="hidden" id="empEditId">
                <div class="form-row">
                    <div class="form-group"><label class="form-label">ì´ë¦„ *</label><input type="text" class="form-input" id="empName" required oninput="updateAutoId()"></div>
                    <div class="form-group"><label class="form-label">ì…ì‚¬ì¼ *</label><input type="date" class="form-input" id="empJoinDate" required onchange="updateAutoId()"></div>
                </div>
                <div class="form-group"><label class="form-label">ì‚¬ë²ˆ (ìë™ìƒì„±)</label>
                    <div class="auto-id-preview" id="autoIdPreview">ì´ë¦„ê³¼ ì…ì‚¬ì¼ì„ ì…ë ¥í•˜ë©´ ìë™ ìƒì„±ë©ë‹ˆë‹¤</div>
                    <input type="hidden" id="empId">
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">ìƒë…„ì›”ì¼</label><input type="date" class="form-input" id="empBirthDate"></div>
                    <div class="form-group"><label class="form-label">ì§ê¸‰ *</label>
                        <select class="form-select" id="empRole" required><option value="">ì„ íƒ</option><option value="ì‹¤ì¥">ì‹¤ì¥</option><option value="í”¼ë¶€ê´€ë¦¬ì‚¬">í”¼ë¶€ê´€ë¦¬ì‚¬</option><option value="ê°„í˜¸ì‚¬">ê°„í˜¸ì‚¬</option><option value="ê°„í˜¸ì¡°ë¬´ì‚¬">ê°„í˜¸ì¡°ë¬´ì‚¬</option><option value="ì½”ë””">ì½”ë””</option><option value="ë§ˆì¼€íŒ…">ë§ˆì¼€íŒ…</option></select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">ê¸°ë³¸ê¸‰ *</label><input type="number" class="form-input" id="empBaseSalary" required></div>
                    <div class="form-group"><label class="form-label">ê³ ì •OTìˆ˜ë‹¹</label><input type="number" class="form-input" id="empFixedOT"></div>
                    <div class="form-group"><label class="form-label">ì‹œê¸‰</label><input type="number" class="form-input" id="empHourlyWage"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">ë§¤ì¹­ ì´ë¦„ (ì—‘ì…€ ë‹´ë‹¹ì§ì›)</label><input type="text" class="form-input" id="empMatchName" placeholder="ì˜ˆ: ë°•ë³´ë¯¸"></div>
                    <div class="form-group"><label class="form-label">ì¬ì§ ìƒíƒœ</label>
                        <select class="form-select" id="empIsActive"><option value="true">ì¬ì§ì¤‘</option><option value="false">í‡´ì‚¬</option></select>
                    </div>
                </div>
                <div class="flex justify-between mt-2"><button type="button" class="btn btn-secondary" onclick="closeEmployeeModal()">ì·¨ì†Œ</button><button type="submit" class="btn btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- ì¸ì„¼í‹°ë¸Œ í•­ëª© ëª¨ë‹¬ -->
    <div class="modal-overlay" id="incentiveItemModal">
        <div class="modal">
            <div class="modal-header"><div class="modal-title" id="incentiveItemModalTitle">ì¸ì„¼í‹°ë¸Œ í•­ëª© ì¶”ê°€</div><button class="modal-close" onclick="closeIncentiveItemModal()">&times;</button></div>
            <form id="incentiveItemForm">
                <input type="hidden" id="incItemEditId">
                <div class="form-row">
                    <div class="form-group"><label class="form-label">í•­ëª©ëª… *</label><input type="text" class="form-input" id="incItemName" placeholder="ì˜ˆ: í•˜ì´ë“œë¼ í˜ì´ì…œ" required></div>
                    <div class="form-group"><label class="form-label">ìœ í˜• *</label>
                        <select class="form-select" id="incItemType" required onchange="toggleIncTypeFields()">
                            <option value="per_case">ê±´ë‹¹ (â‚©/ê±´)</option>
                            <option value="revenue_percent">ë§¤ì¶œ ë¹„ìœ¨ (%)</option>
                            <option value="growth_percent">ì„±ì¥ë¶„ ë¹„ìœ¨ (%)</option>
                            <option value="staff_sales">ë‹´ë‹¹ì§ì› ë§¤ì¶œ (%)</option>
                            <option value="japan_visit">ì¼ë³¸ì¸ ë°©ë¬¸ (â‚©/ëª…)</option>
                            <option value="japan_revenue">ì¼ë³¸ì¸ ë§¤ì¶œ (%)</option>
                        </select>
                    </div>
                </div>
                <div class="form-row" id="incPerCaseFields">
                    <div class="form-group"><label class="form-label">ê±´ë‹¹ ê¸ˆì•¡ (ì›)</label><input type="number" class="form-input" id="incPerCaseAmount" placeholder="10000"></div>
                </div>
                <div class="form-row" id="incPercentFields" style="display:none">
                    <div class="form-group"><label class="form-label">ë¹„ìœ¨ (%)</label><input type="number" class="form-input" id="incPercent" placeholder="1" step="0.1"></div>
                    <div class="form-group"><label class="form-label">ìƒí•œ (ì›, ì„ íƒ)</label><input type="number" class="form-input" id="incCap" placeholder="200000"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">ì ìš© ì§ì› ì„ íƒ</label>
                    <div id="incEmployeeCheckboxes" style="display:flex;flex-wrap:wrap;gap:.5rem;background:var(--bg-primary);padding:1rem;border:1px solid var(--border-color);max-height:200px;overflow-y:auto"></div>
                </div>
                <div class="flex justify-between mt-2"><button type="button" class="btn btn-secondary" onclick="closeIncentiveItemModal()">ì·¨ì†Œ</button><button type="submit" class="btn btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- ì§€ì¶œ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="expenseModal">
        <div class="modal">
            <div class="modal-header"><div class="modal-title" id="expenseModalTitle">ì§€ì¶œ ì¶”ê°€</div><button class="modal-close" onclick="closeExpenseModal()">&times;</button></div>
            <form id="expenseForm">
                <input type="hidden" id="expType">
                <div class="form-row">
                    <div class="form-group"><label class="form-label">í•­ëª©ëª… *</label><input type="text" class="form-input" id="expName" required></div>
                    <div class="form-group"><label class="form-label">ê¸ˆì•¡ *</label><input type="number" class="form-input" id="expAmount" required></div>
                </div>
                <div class="form-row" id="expFixedFields"><div class="form-group"><label class="form-label">ì£¼ê¸°</label><select class="form-select" id="expCycle"><option value="monthly">ì›”ê°„</option><option value="yearly">ì—°ê°„</option></select></div></div>
                <div class="form-row" id="expVariableFields" style="display:none">
                    <div class="form-group"><label class="form-label">ë‚ ì§œ</label><input type="date" class="form-input" id="expDate"></div>
                    <div class="form-group"><label class="form-label">ì¹´í…Œê³ ë¦¬</label><select class="form-select" id="expCategory"><option value="ì¬ë£Œë¹„">ì¬ë£Œë¹„</option><option value="ì†Œëª¨í’ˆ">ì†Œëª¨í’ˆ</option><option value="ë§ˆì¼€íŒ…">ë§ˆì¼€íŒ…</option><option value="ê¸°íƒ€">ê¸°íƒ€</option></select></div>
                </div>
                <div class="form-group"><label class="form-label">ë©”ëª¨</label><input type="text" class="form-input" id="expMemo"></div>
                <div class="flex justify-between mt-2"><button type="button" class="btn btn-secondary" onclick="closeExpenseModal()">ì·¨ì†Œ</button><button type="submit" class="btn btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>
    <script>
        // Firebase
        const firebaseConfig={apiKey:"AIzaSyDnkKNXNnDVlcPd5Y1fl59YysdeEZi7uJU",authDomain:"lumiclinic-c1a95.firebaseapp.com",projectId:"lumiclinic-c1a95",storageBucket:"lumiclinic-c1a95.firebasestorage.app",messagingSenderId:"901456209944",appId:"1:901456209944:web:f287418cd0541f324d3b6d"};
        firebase.initializeApp(firebaseConfig);const db=firebase.firestore();

        // ê´€ë¦¬ì ì¸ì¦
        const ADMIN_ID='adminhighgo';
        const ADMIN_PW='gndls-asdk!jd-As';

        function togglePw(id,btn){const inp=document.getElementById(id);if(inp.type==='password'){inp.type='text';btn.textContent='ğŸ”’';}else{inp.type='password';btn.textContent='ğŸ‘';}}
        function handleAdminLogin(){
            const id=document.getElementById('adminId').value.trim();
            const pw=document.getElementById('adminPw').value;
            document.getElementById('loginError').textContent='';
            if(id===ADMIN_ID&&pw===ADMIN_PW){localStorage.setItem('lumiAdmin','true');showApp();}
            else{document.getElementById('loginError').textContent='ID ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';}
        }
        function adminLogout(){localStorage.removeItem('lumiAdmin');document.getElementById('loginScreen').classList.remove('hidden');document.getElementById('appContainer').classList.remove('active');document.getElementById('adminId').value='';document.getElementById('adminPw').value='';}
        function checkAdminLogin(){if(localStorage.getItem('lumiAdmin')==='true'){showApp();}}
        function showApp(){document.getElementById('loginScreen').classList.add('hidden');document.getElementById('appContainer').classList.add('active');loadAllData();}

        let employees=[],attendanceData={},leaveRequests=[],revenueData={},salaryMemos={},lunchOTAllData={},fixedExpenses=[],variableExpenses=[];
        let incentiveItems=[],employeeIncentiveRecords={},salesDetailData={doctorSales:{},staffSales:{},japanStaffSales:{}};
        const overtimeRules={1:'18:30',2:'18:30',3:'18:00',4:'18:00',5:'18:30',6:'15:00'};
        const DEFAULT_PW='final12890-';
        const monthlyData={labels:['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”'],
            data2024:[173111326,156060457,198554450,207124800,193543660,179806116,187612314,157672141,206156505,211217542,243773264,215202565],
            data2025:[243491066,257728622,198946613,209752982,194799262,183098254,169175502,168038894,192032741,185696152,194178322,202146630]};

        // ì‚¬ë²ˆ ìë™ìƒì„±
        function generateEmpId(name,joinDate){
            if(!name||!joinDate)return null;
            const year=joinDate.substring(2,4);
            const initials=getInitials(name);
            return year+initials;
        }
        function getInitials(name){
            const cho=['ã„±','ã„²','ã„´','ã„·','ã„¸','ã„¹','ã…','ã…‚','ã…ƒ','ã……','ã…†','ã…‡','ã…ˆ','ã…‰','ã…Š','ã…‹','ã…Œ','ã…','ã…'];
            const choMap={'ã„±':'g','ã„²':'kk','ã„´':'n','ã„·':'d','ã„¸':'tt','ã„¹':'r','ã…':'m','ã…‚':'b','ã…ƒ':'pp','ã……':'s','ã…†':'ss','ã…‡':'','ã…ˆ':'j','ã…‰':'jj','ã…Š':'ch','ã…‹':'k','ã…Œ':'t','ã…':'p','ã…':'h'};
            let initials='';
            for(let i=0;i<name.length&&initials.length<3;i++){
                const c=name.charCodeAt(i);
                if(c>=0xAC00&&c<=0xD7A3){const idx=Math.floor((c-0xAC00)/588);initials+=choMap[cho[idx]]||cho[idx];}
                else if(/[a-zA-Z]/.test(name[i])){initials+=name[i].toLowerCase();}
            }
            return initials.substring(0,3).padEnd(3,'x');
        }
        function updateAutoId(){
            const name=document.getElementById('empName').value.trim();
            const joinDate=document.getElementById('empJoinDate').value;
            const preview=document.getElementById('autoIdPreview');
            const editId=document.getElementById('empEditId').value;
            if(editId){preview.textContent=editId+' (ìˆ˜ì • ë¶ˆê°€)';return;}
            if(name&&joinDate){const id=generateEmpId(name,joinDate);preview.textContent=id;document.getElementById('empId').value=id;}
            else{preview.textContent='ì´ë¦„ê³¼ ì…ì‚¬ì¼ì„ ì…ë ¥í•˜ë©´ ìë™ ìƒì„±ë©ë‹ˆë‹¤';}
        }

        function getYM(){return document.getElementById('selectedYear').value+'-'+document.getElementById('selectedMonth').value;}

        // Navigation
        document.querySelectorAll('.nav-item').forEach(n=>n.addEventListener('click',()=>{
            document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
            document.querySelectorAll('.section[id$="-section"]').forEach(x=>x.classList.remove('active'));
            n.classList.add('active');document.getElementById(n.dataset.nav+'-section').classList.add('active');
        }));
        document.querySelectorAll('.sub-nav-item').forEach(s=>s.addEventListener('click',()=>{
            const parent=s.closest('.section');parent.querySelectorAll('.sub-nav-item').forEach(x=>x.classList.remove('active'));
            parent.querySelectorAll('.section').forEach(x=>x.classList.remove('active'));s.classList.add('active');document.getElementById(s.dataset.sub).classList.add('active');
        }));

        // Load All
        async function loadAllData(){
            await loadEmployees();await loadAttendance();await loadLeaveRequests();await loadRevenueData();
            await loadSalaryMemos();await loadLunchOTAll();await loadExpenses();await loadIncentiveItems();await loadEmployeeIncentiveRecords();await loadSalesDetailData();
            checkBirthdays();renderAll();initCharts();
        }

        async function loadEmployees(){try{const snap=await db.collection('employees').get();employees=[];snap.forEach(d=>employees.push({id:d.id,...d.data()}));}catch(e){}}
        async function loadAttendance(){
            const ym=getYM();attendanceData={};
            for(const emp of employees){
                try{const snap=await db.collection('attendance').doc(emp.id).collection('records').where(firebase.firestore.FieldPath.documentId(),'>=',ym+'-01').where(firebase.firestore.FieldPath.documentId(),'<=',ym+'-31').get();
                    attendanceData[emp.id]={records:[],summary:{workDays:0,late:0,afterWorkOT:0}};
                    snap.forEach(d=>{const data=d.data(),dow=new Date(d.id).getDay(),ot=calcAfterWorkOT(data.checkOut,dow);
                        attendanceData[emp.id].records.push({date:d.id,...data,afterWorkOT:ot});
                        attendanceData[emp.id].summary.workDays++;if(data.status==='late')attendanceData[emp.id].summary.late++;
                        attendanceData[emp.id].summary.afterWorkOT+=ot;
                    });
                }catch(e){}
            }
        }
        async function loadLeaveRequests(){try{const snap=await db.collection('leaveRequests').orderBy('createdAt','desc').limit(50).get();leaveRequests=[];snap.forEach(d=>leaveRequests.push({id:d.id,...d.data()}));}catch(e){}}
        async function loadRevenueData(){const ym=getYM();try{const doc=await db.collection('revenue').doc(ym).get();revenueData=doc.exists?doc.data():{total:0,japan:0,japanVisitors:0,transactions:0};}catch(e){revenueData={total:0,japan:0,japanVisitors:0,transactions:0};}}
        async function loadSalaryMemos(){const ym=getYM();try{const doc=await db.collection('salaryMemos').doc(ym).get();salaryMemos=doc.exists?doc.data():{};}catch(e){}}
        async function loadLunchOTAll(){
            const ym=getYM();lunchOTAllData={};
            for(const emp of employees){
                try{const doc=await db.collection('lunchOTDaily').doc(emp.id).get();
                    if(doc.exists){const data=doc.data();let total=0;Object.entries(data).forEach(([k,v])=>{if(k.startsWith(ym))total+=v;});lunchOTAllData[emp.id]={total,records:data};}
                    else{lunchOTAllData[emp.id]={total:0,records:{}};}
                }catch(e){lunchOTAllData[emp.id]={total:0,records:{}};}
            }
        }
        async function loadExpenses(){
            try{const fSnap=await db.collection('fixedExpenses').get();fixedExpenses=[];fSnap.forEach(d=>fixedExpenses.push({id:d.id,...d.data()}));}catch(e){}
            const ym=getYM();try{const vSnap=await db.collection('variableExpenses').where('month','==',ym).get();variableExpenses=[];vSnap.forEach(d=>variableExpenses.push({id:d.id,...d.data()}));}catch(e){}
        }
        async function loadIncentiveItems(){try{const snap=await db.collection('incentiveItems').get();incentiveItems=[];snap.forEach(d=>incentiveItems.push({id:d.id,...d.data()}));}catch(e){}}
        async function loadEmployeeIncentiveRecords(){
            const ym=getYM();employeeIncentiveRecords={};
            for(const emp of employees){try{const doc=await db.collection('incentiveRecords').doc(emp.id).collection('monthly').doc(ym).get();employeeIncentiveRecords[emp.id]=doc.exists?doc.data():{};}catch(e){employeeIncentiveRecords[emp.id]={};}}
        }
        async function loadSalesDetailData(){
            const ym=getYM();
            try{const doc=await db.collection('salesDetail').doc(ym).get();salesDetailData=doc.exists?doc.data():{doctorSales:{},staffSales:{},japanStaffSales:{}};}catch(e){salesDetailData={doctorSales:{},staffSales:{},japanStaffSales:{}};}
        }

        // Calculations
        function timeToMin(t){if(!t)return 0;const[h,m]=t.split(':').map(Number);return h*60+m;}
        function calcAfterWorkOT(checkOut,dow){if(!checkOut||dow===0)return 0;const rule=overtimeRules[dow];if(!rule)return 0;return Math.max(0,timeToMin(checkOut)-timeToMin(rule));}
        function calcTenure(jd){if(!jd)return{label:'-'};const j=new Date(jd),n=new Date();let y=n.getFullYear()-j.getFullYear(),m=n.getMonth()-j.getMonth();if(m<0){y--;m+=12;}if(y>0)return{years:y,label:m>0?y+'ë…„ '+m+'ê°œì›”':y+'ë…„ì°¨'};if(m>0)return{years:0,label:m+'ê°œì›”'};return{years:0,label:'ì‹ ì…'};}
        function calcAge(bd){if(!bd)return'-';const b=new Date(bd),n=new Date();let age=n.getFullYear()-b.getFullYear();if(n.getMonth()<b.getMonth()||(n.getMonth()===b.getMonth()&&n.getDate()<b.getDate()))age--;return age+'ì„¸';}
        function formatCurrency(n){return'â‚©'+new Intl.NumberFormat('ko-KR').format(n||0);}
        function calcWorkDays(y,m){let c=0;const d=new Date(y,m,0).getDate();for(let i=1;i<=d;i++)if(new Date(y,m-1,i).getDay()!==0)c++;return c;}

        function getStaffSalesAmount(empId){const emp=employees.find(e=>e.id===empId);if(!emp||!emp.matchName)return 0;return salesDetailData.staffSales[emp.matchName]?.amount||0;}

        function calcEmployeeIncentive(empId){
            let total=0;const details=[];const records=employeeIncentiveRecords[empId]||{};const emp=employees.find(e=>e.id===empId);
            incentiveItems.forEach(item=>{
                if(!item.employees||!item.employees.includes(empId))return;
                let amount=0,desc='';
                switch(item.type){
                    case 'per_case':const count=records[item.id]?.count||0;amount=count*(item.perCaseAmount||0);desc=`${count}ê±´ Ã— ${formatCurrency(item.perCaseAmount)}`;break;
                    case 'revenue_percent':amount=Math.round((revenueData.total||0)*(item.percent||0)/100);if(item.cap&&amount>item.cap)amount=item.cap;desc=`ì´ë§¤ì¶œ Ã— ${item.percent}%`;break;
                    case 'growth_percent':const monthIdx=parseInt(document.getElementById('selectedMonth').value)-1;const prev=monthlyData.data2024[monthIdx]||0;const growth=Math.max(0,(revenueData.total||0)-prev);amount=Math.round(growth*(item.percent||0)/100);if(item.cap&&amount>item.cap)amount=item.cap;desc=`ì„±ì¥ë¶„ Ã— ${item.percent}%`;break;
                    case 'staff_sales':const staffSales=getStaffSalesAmount(empId);amount=Math.round(staffSales*(item.percent||0)/100);desc=`ë‹´ë‹¹ë§¤ì¶œ ${formatCurrency(staffSales)} Ã— ${item.percent}%`;break;
                    case 'japan_visit':amount=(revenueData.japanVisitors||0)*(item.perCaseAmount||0);desc=`${revenueData.japanVisitors||0}ëª… Ã— ${formatCurrency(item.perCaseAmount)}`;break;
                    case 'japan_revenue':const japanSales=emp?.matchName?salesDetailData.japanStaffSales[emp.matchName]?.amount||0:revenueData.japan||0;amount=Math.round(japanSales*(item.percent||0)/100);desc=`ì¼ë³¸ì¸ë§¤ì¶œ ${formatCurrency(japanSales)} Ã— ${item.percent}%`;break;
                }
                if(amount>0||item.type==='per_case'){details.push({item:item.name,amount,desc});}total+=amount;
            });
            return{total,details};
        }

        function checkBirthdays(){
            const today=new Date(),thisMonth=String(today.getMonth()+1).padStart(2,'0');
            let birthdayThisMonth=0;
            employees.forEach(e=>{if(e.birthDate&&e.isActive!==false){const bMD=e.birthDate.substring(5);if(bMD.startsWith(thisMonth))birthdayThisMonth++;}});
            document.getElementById('birthdayCount').textContent=birthdayThisMonth+'ëª…';
        }

        // Render Functions
        function renderAll(){renderSales();renderEmployees();renderAttendance();renderLeaves();renderOvertime();renderIncentive();renderSalary();renderExpenses();}

        function renderSales(){
            const total=revenueData.total||0,japan=revenueData.japan||0,jVis=revenueData.japanVisitors||0,trans=revenueData.transactions||0;
            const monthIdx=parseInt(document.getElementById('selectedMonth').value)-1;const prev=monthlyData.data2024[monthIdx]||0;
            document.getElementById('monthlyTotal').textContent=formatCurrency(total);
            document.getElementById('monthlyGrowth').textContent=(total>=prev?'+':'')+formatCurrency(total-prev);
            document.getElementById('monthlyTrans').textContent=(trans||0).toLocaleString()+'ê±´';
            document.getElementById('monthlyAvg').textContent=trans>0?formatCurrency(Math.round(total/trans)):'â‚©0';
            document.getElementById('japanRevenue').textContent=formatCurrency(japan);
            document.getElementById('japanVisitors').textContent=(jVis||0)+'ëª…';
            document.getElementById('japanAvg').textContent=jVis>0?formatCurrency(Math.round(japan/jVis)):'â‚©0';
            document.getElementById('japanRatio').textContent=total>0?((japan/total)*100).toFixed(1)+'%':'0%';
            
            const doctorGrid=document.getElementById('doctorSalesGrid');const doctorTable=document.getElementById('doctorSalesTable');
            const doctors=Object.entries(salesDetailData.doctorSales||{});
            if(doctors.length===0){doctorGrid.innerHTML='<div style="text-align:center;padding:2rem;color:var(--text-muted);grid-column:1/-1">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´ í‘œì‹œë©ë‹ˆë‹¤.</div>';doctorTable.innerHTML='<tr><td colspan="4" style="text-align:center;padding:2rem;color:var(--text-muted)">ë°ì´í„° ì—†ìŒ</td></tr>';}
            else{doctorGrid.innerHTML=doctors.map(([name,data])=>`<div class="doctor-card"><div class="name">${name}</div><div class="amount">${formatCurrency(data.amount)}</div><div class="count">${data.count}ê±´</div></div>`).join('');doctorTable.innerHTML=doctors.map(([name,data])=>`<tr><td><strong>${name}</strong></td><td>${data.count}ê±´</td><td class="text-success">${formatCurrency(data.amount)}</td><td>${total>0?((data.amount/total)*100).toFixed(1)+'%':'0%'}</td></tr>`).join('');}
            
            const staffGrid=document.getElementById('staffSalesGrid');const staffTable=document.getElementById('staffSalesTable');
            const staffs=Object.entries(salesDetailData.staffSales||{});
            if(staffs.length===0){staffGrid.innerHTML='<div style="text-align:center;padding:2rem;color:var(--text-muted);grid-column:1/-1">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´ í‘œì‹œë©ë‹ˆë‹¤.</div>';staffTable.innerHTML='<tr><td colspan="4" style="text-align:center;padding:2rem;color:var(--text-muted)">ë°ì´í„° ì—†ìŒ</td></tr>';}
            else{staffGrid.innerHTML=staffs.map(([name,data])=>`<div class="doctor-card"><div class="name">${name}</div><div class="amount">${formatCurrency(data.amount)}</div><div class="count">${data.count}ê±´ | ì¸ì„¼ ${formatCurrency(Math.round(data.amount*0.01))}</div></div>`).join('');staffTable.innerHTML=staffs.map(([name,data])=>`<tr><td><strong>${name}</strong></td><td>${data.count}ê±´</td><td class="text-success">${formatCurrency(data.amount)}</td><td class="text-purple"><strong>${formatCurrency(Math.round(data.amount*0.01))}</strong></td></tr>`).join('');}
            
            const japanStaffTable=document.getElementById('japanStaffTable');
            const japanStaffs=Object.entries(salesDetailData.japanStaffSales||{});
            if(japanStaffs.length===0){japanStaffTable.innerHTML='<tr><td colspan="4" style="text-align:center;padding:2rem;color:var(--text-muted)">ë°ì´í„° ì—†ìŒ</td></tr>';}
            else{japanStaffTable.innerHTML=japanStaffs.map(([name,data])=>`<tr><td><strong>${name}</strong></td><td>${data.count}ê±´</td><td class="text-success">${formatCurrency(data.amount)}</td><td class="text-purple"><strong>${formatCurrency(Math.round(data.amount*0.01))}</strong></td></tr>`).join('');}
        }

        function renderEmployees(){
            const active=employees.filter(e=>e.isActive!==false),inactive=employees.filter(e=>e.isActive===false);
            document.getElementById('totalEmployees').textContent=employees.length;document.getElementById('activeEmployees').textContent=active.length;document.getElementById('inactiveEmployees').textContent=inactive.length;
            const tbody=document.getElementById('employeeTableBody');
            if(employees.length===0){tbody.innerHTML='<tr><td colspan="9" style="text-align:center;padding:2rem;color:var(--text-muted)">ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';return;}
            tbody.innerHTML=employees.map(e=>{
                const ten=calcTenure(e.joinDate),age=calcAge(e.birthDate);
                const pwStatus=e.password?'<span class="badge badge-success">ì„¤ì •ë¨</span>':'<span class="badge badge-warning">ë¯¸ì„¤ì •</span>';
                return `<tr><td><span class="badge badge-info">${e.id}</span></td><td><strong>${e.name}</strong>${e.matchName?'<br><small class="text-muted">ë§¤ì¹­: '+e.matchName+'</small>':''}</td><td>${age}</td><td>${e.role||'-'}</td><td>${e.joinDate||'-'}</td><td><span class="badge ${ten.years>=3?'badge-success':ten.years>=1?'badge-info':'badge-warning'}">${ten.label}</span></td><td>${e.isActive!==false?'<span class="badge badge-success">ì¬ì§</span>':'<span class="badge badge-danger">í‡´ì‚¬</span>'}</td><td>${pwStatus}</td><td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="editEmployee('${e.id}')">ìˆ˜ì •</button><button class="btn btn-warning btn-sm" onclick="resetPassword('${e.id}')">ë¹„ë²ˆì´ˆê¸°í™”</button></div></td></tr>`;
            }).join('');
        }

        function renderAttendance(){
            const today=new Date().toISOString().split('T')[0];let todayPresent=0;
            const active=employees.filter(e=>e.isActive!==false);
            active.forEach(e=>{const d=attendanceData[e.id];if(d&&d.records.find(r=>r.date===today)?.checkIn)todayPresent++;});
            const[y,m]=getYM().split('-');
            document.getElementById('workDays').textContent=calcWorkDays(parseInt(y),parseInt(m))+'ì¼';document.getElementById('todayPresent').textContent=todayPresent+'ëª…';
            document.getElementById('attendanceTableBody').innerHTML=active.length===0?'<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-muted)">ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>':active.map(e=>{
                const d=attendanceData[e.id]||{records:[],summary:{workDays:0,late:0,afterWorkOT:0}},tr=d.records.find(r=>r.date===today)||{};
                const lunchOT=lunchOTAllData[e.id]?.total||0;const totalOT=d.summary.afterWorkOT+lunchOT;
                return `<tr><td><strong>${e.name}</strong></td><td><span class="badge badge-info">${e.id}</span></td><td>${tr.checkIn||'-'}</td><td>${tr.checkOut||'-'}</td><td>${d.summary.workDays}ì¼</td><td class="${d.summary.late>0?'text-danger':''}">${d.summary.late}íšŒ</td><td class="text-success">${(totalOT/60).toFixed(1)}H</td></tr>`;
            }).join('');
        }

        function renderLeaves(){
            const pending=leaveRequests.filter(l=>l.status==='pending').length,approved=leaveRequests.filter(l=>l.status==='approved').length;
            document.getElementById('pendingLeaves').textContent=pending;document.getElementById('approvedLeaves').textContent=approved;
            const tbody=document.getElementById('leaveTableBody');
            if(leaveRequests.length===0){tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-muted)">íœ´ê°€ ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';return;}
            tbody.innerHTML=leaveRequests.slice(0,20).map(l=>{
                const emp=employees.find(e=>e.id===l.employeeId),sb={pending:'badge-warning',approved:'badge-success',rejected:'badge-danger'}[l.status]||'',st={pending:'ëŒ€ê¸°',approved:'ìŠ¹ì¸',rejected:'ë°˜ë ¤'}[l.status]||l.status;
                return `<tr><td>${l.createdAt?.toDate?.()?.toLocaleDateString()||'-'}</td><td>${emp?.name||l.employeeId}</td><td>${l.type==='annual'?'ì—°ì°¨':l.type==='half'?'ë°˜ì°¨':'ì˜¤í”„'}</td><td>${l.startDate}~${l.endDate}</td><td>${l.reason||'-'}</td><td><span class="badge ${sb}">${st}</span></td><td>${l.status==='pending'?`<div class="btn-group"><button class="btn btn-success btn-sm" onclick="approveLeave('${l.id}')">ìŠ¹ì¸</button><button class="btn btn-danger btn-sm" onclick="rejectLeave('${l.id}')">ë°˜ë ¤</button></div>`:'-'}</td></tr>`;
            }).join('');
        }

        function renderOvertime(){
            let totalMin=0,totalNet=0;const active=employees.filter(e=>e.isActive!==false);
            active.forEach(e=>{const d=attendanceData[e.id]||{summary:{afterWorkOT:0}};const lunchOT=lunchOTAllData[e.id]?.total||0;const total=d.summary.afterWorkOT+lunchOT;totalMin+=total;totalNet+=(total/60)*(e.hourlyWage||0)*1.5*0.967;});
            document.getElementById('totalOT').textContent=(totalMin/60).toFixed(1)+'H';document.getElementById('totalOTNet').textContent=formatCurrency(Math.round(totalNet));
            document.getElementById('overtimeTableBody').innerHTML=active.length===0?'<tr><td colspan="6" style="text-align:center;padding:2rem;color:var(--text-muted)">ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>':active.map(e=>{
                const d=attendanceData[e.id]||{summary:{afterWorkOT:0}};const lunchOT=lunchOTAllData[e.id]?.total||0;
                const totalOT=d.summary.afterWorkOT+lunchOT;const n=(totalOT/60)*(e.hourlyWage||0)*1.5*0.967;
                return `<tr><td><strong>${e.name}</strong></td><td>${formatCurrency(e.hourlyWage)}</td><td>${(d.summary.afterWorkOT/60).toFixed(1)}H</td><td>${(lunchOT/60).toFixed(1)}H</td><td class="text-warning"><strong>${(totalOT/60).toFixed(1)}H</strong></td><td class="text-success"><strong>${formatCurrency(Math.round(n))}</strong></td></tr>`;
            }).join('');
            document.getElementById('sumOTHours').textContent=(totalMin/60).toFixed(1)+'H';document.getElementById('sumOTNet').textContent=formatCurrency(Math.round(totalNet));
        }

        function renderIncentive(){
            document.getElementById('incentiveItemCount').textContent=incentiveItems.length+'ê°œ';
            const itemsList=document.getElementById('incentiveItemsList');
            if(incentiveItems.length===0){itemsList.innerHTML='<div style="text-align:center;padding:2rem;color:var(--text-muted)">ì¸ì„¼í‹°ë¸Œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';}
            else{
                const typeLabels={per_case:'ê±´ë‹¹',revenue_percent:'ë§¤ì¶œë¹„ìœ¨',growth_percent:'ì„±ì¥ë¶„ë¹„ìœ¨',staff_sales:'ë‹´ë‹¹ë§¤ì¶œ',japan_visit:'ì¼ë³¸ì¸ë°©ë¬¸',japan_revenue:'ì¼ë³¸ì¸ë§¤ì¶œ'};
                itemsList.innerHTML=incentiveItems.map(item=>{
                    const emps=(item.employees||[]).map(id=>{const e=employees.find(x=>x.id===id);return e?`<span class="emp-chip">${e.name}</span>`:'';}).join('');
                    let valueDesc='';if(item.type==='per_case'||item.type==='japan_visit')valueDesc=formatCurrency(item.perCaseAmount)+'/ê±´';else valueDesc=item.percent+'%'+(item.cap?' (ìƒí•œ '+formatCurrency(item.cap)+')':'');
                    return `<div class="incentive-item"><div class="incentive-item-header"><div><span class="incentive-item-name">${item.name}</span><span class="badge badge-info" style="margin-left:.5rem">${typeLabels[item.type]||item.type}</span><span style="margin-left:.5rem;color:var(--accent-gold)">${valueDesc}</span></div><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="editIncentiveItem('${item.id}')">ìˆ˜ì •</button><button class="btn btn-danger btn-sm" onclick="deleteIncentiveItem('${item.id}')">ì‚­ì œ</button></div></div><div class="incentive-item-employees">${emps||'<span class="text-muted">ì ìš© ì§ì› ì—†ìŒ</span>'}</div></div>`;
                }).join('');
            }
            let totalInc=0;const active=employees.filter(e=>e.isActive!==false);
            const tbody=document.getElementById('incentiveTableBody');
            tbody.innerHTML=active.length===0?'<tr><td colspan="4" style="text-align:center;padding:2rem;color:var(--text-muted)">ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>':active.map(e=>{
                const inc=calcEmployeeIncentive(e.id);totalInc+=inc.total;
                const itemNames=inc.details.map(d=>`<div><span class="badge badge-purple">${d.item}</span> <span class="text-muted">${d.desc}</span> = ${formatCurrency(d.amount)}</div>`).join('');
                return `<tr><td><strong>${e.name}</strong></td><td>${itemNames||'<span class="text-muted">-</span>'}</td><td class="text-muted">-</td><td class="text-success"><strong>${formatCurrency(inc.total)}</strong></td></tr>`;
            }).join('');
            document.getElementById('totalIncentiveSum').textContent=formatCurrency(totalInc);
        }

        function renderSalary(){
            let totalSum=0;const active=employees.filter(e=>e.isActive!==false);
            document.getElementById('salaryTableBody').innerHTML=active.length===0?'<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-muted)">ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>':active.map(e=>{
                const d=attendanceData[e.id]||{summary:{afterWorkOT:0}};const lunchOT=lunchOTAllData[e.id]?.total||0;const totalOT=d.summary.afterWorkOT+lunchOT;
                const otPay=Math.round((totalOT/60)*(e.hourlyWage||0)*1.5*0.967);const inc=calcEmployeeIncentive(e.id);
                const total=(e.baseSalary||0)+(e.fixedOT||0)+otPay+inc.total;totalSum+=total;const memo=salaryMemos[e.id]||'';
                return `<tr><td><strong>${e.name}</strong></td><td>${formatCurrency(e.baseSalary)}</td><td>${formatCurrency(e.fixedOT)}</td><td class="text-success">${formatCurrency(otPay)}</td><td class="text-purple">${formatCurrency(inc.total)}</td><td><strong>${formatCurrency(total)}</strong></td><td><input type="text" class="memo-input" value="${memo}" placeholder="ë©”ëª¨" onchange="saveMemo('${e.id}',this.value)"></td></tr>`;
            }).join('');
            document.getElementById('totalSalarySum').textContent=formatCurrency(totalSum);
        }

        function renderExpenses(){
            let fixedTotal=0;
            document.getElementById('fixedExpenseTable').innerHTML=fixedExpenses.length===0?'<tr><td colspan="5" style="text-align:center;padding:2rem;color:var(--text-muted)">í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>':fixedExpenses.map(e=>{fixedTotal+=e.amount;return `<tr><td>${e.name}</td><td>${formatCurrency(e.amount)}</td><td>${e.cycle==='monthly'?'ì›”ê°„':'ì—°ê°„'}</td><td>${e.memo||'-'}</td><td><button class="btn btn-danger btn-sm" onclick="deleteExpense('fixed','${e.id}')">ì‚­ì œ</button></td></tr>`;}).join('');
            document.getElementById('fixedExpenseTotal').textContent=formatCurrency(fixedTotal);
            let varTotal=0;
            document.getElementById('variableExpenseTable').innerHTML=variableExpenses.length===0?'<tr><td colspan="6" style="text-align:center;padding:2rem;color:var(--text-muted)">í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>':variableExpenses.map(e=>{varTotal+=e.amount;return `<tr><td>${e.date||'-'}</td><td>${e.name}</td><td>${e.category||'-'}</td><td>${formatCurrency(e.amount)}</td><td>${e.memo||'-'}</td><td><button class="btn btn-danger btn-sm" onclick="deleteExpense('variable','${e.id}')">ì‚­ì œ</button></td></tr>`;}).join('');
            document.getElementById('variableExpenseTotal').textContent=formatCurrency(varTotal);
        }
}</label>`).join('');
            if(id){const item=incentiveItems.find(x=>x.id===id);if(item){document.getElementById('incentiveItemModalTitle').textContent='ì¸ì„¼í‹°ë¸Œ í•­ëª© ìˆ˜ì •';document.getElementById('incItemEditId').value=item.id;document.getElementById('incItemName').value=item.name;document.getElementById('incItemType').value=item.type;toggleIncTypeFields();if(item.perCaseAmount)document.getElementById('incPerCaseAmount').value=item.perCaseAmount;if(item.percent)document.getElementById('incPercent').value=item.percent;if(item.cap)document.getElementById('incCap').value=item.cap;(item.employees||[]).forEach(empId=>{const cb=container.querySelector(`input[value="${empId}"]`);if(cb)cb.checked=true;});}}else{document.getElementById('incentiveItemModalTitle').textContent='ì¸ì„¼í‹°ë¸Œ í•­ëª© ì¶”ê°€';toggleIncTypeFields();}}
        function closeIncentiveItemModal(){document.getElementById('incentiveItemModal').classList.remove('active');}
        function editIncentiveItem(id){openIncentiveItemModal(id);}
        document.getElementById('incentiveItemForm').addEventListener('submit',async e=>{e.preventDefault();
            const editId=document.getElementById('incItemEditId').value;const type=document.getElementById('incItemType').value;
            const data={name:document.getElementById('incItemName').value,type,employees:[...document.querySelectorAll('.inc-emp-check:checked')].map(cb=>cb.value),updatedAt:firebase.firestore.FieldValue.serverTimestamp()};
            if(type==='per_case'||type==='japan_visit'){data.perCaseAmount=parseInt(document.getElementById('incPerCaseAmount').value)||0;}
            if(type==='revenue_percent'||type==='growth_percent'||type==='japan_revenue'||type==='staff_sales'){data.percent=parseFloat(document.getElementById('incPercent').value)||0;data.cap=parseInt(document.getElementById('incCap').value)||null;}
            try{if(editId){await db.collection('incentiveItems').doc(editId).update(data);alert('ìˆ˜ì • ì™„ë£Œ');}else{data.createdAt=firebase.firestore.FieldValue.serverTimestamp();await db.collection('incentiveItems').add(data);alert('ì¶”ê°€ ì™„ë£Œ');}closeIncentiveItemModal();await loadIncentiveItems();renderIncentive();}catch(err){alert('ì €ì¥ ì‹¤íŒ¨: '+err.message);}});
        async function deleteIncentiveItem(id){if(!confirm('ì‚­ì œ?'))return;try{await db.collection('incentiveItems').doc(id).delete();alert('ì‚­ì œ ì™„ë£Œ');await loadIncentiveItems();renderIncentive();}catch(err){alert(err.message);}}

        // Leave
        async function approveLeave(id){if(!confirm('ìŠ¹ì¸?'))return;try{await db.collection('leaveRequests').doc(id).update({status:'approved',approvedAt:firebase.firestore.FieldValue.serverTimestamp()});alert('ìŠ¹ì¸');await loadLeaveRequests();renderLeaves();}catch(err){alert(err.message);}}
        async function rejectLeave(id){const reason=prompt('ë°˜ë ¤ ì‚¬ìœ :');if(reason===null)return;try{await db.collection('leaveRequests').doc(id).update({status:'rejected',rejectReason:reason,rejectedAt:firebase.firestore.FieldValue.serverTimestamp()});alert('ë°˜ë ¤');await loadLeaveRequests();renderLeaves();}catch(err){alert(err.message);}}

        // Revenue
        async function saveRevenueData(){const ym=getYM(),total=parseNum(document.getElementById('inputTotalRevenue').value),japan=parseNum(document.getElementById('inputJapanRevenue').value),jVis=parseInt(document.getElementById('inputJapanVisitors').value)||0,trans=parseInt(document.getElementById('inputTransactions').value)||0;
            try{await db.collection('revenue').doc(ym).set({total,japan,japanVisitors:jVis,transactions:trans,updatedAt:firebase.firestore.FieldValue.serverTimestamp()});revenueData={total,japan,japanVisitors:jVis,transactions:trans};alert('ì €ì¥ ì™„ë£Œ');renderAll();}catch(err){alert(err.message);}}
        async function saveMemo(id,memo){const ym=getYM();salaryMemos[id]=memo;try{await db.collection('salaryMemos').doc(ym).set(salaryMemos,{merge:true});}catch(e){}}
        function parseNum(s){return s?parseInt(s.replace(/,/g,''))||0:0;}

        // Expense
        function openExpenseModal(type){document.getElementById('expenseModal').classList.add('active');document.getElementById('expenseForm').reset();document.getElementById('expType').value=type;document.getElementById('expenseModalTitle').textContent=(type==='fixed'?'ê³ ì •ë¹„':'ìœ ë™ë¹„')+' ì¶”ê°€';document.getElementById('expFixedFields').style.display=type==='fixed'?'grid':'none';document.getElementById('expVariableFields').style.display=type==='variable'?'grid':'none';}
        function closeExpenseModal(){document.getElementById('expenseModal').classList.remove('active');}
        document.getElementById('expenseForm').addEventListener('submit',async e=>{e.preventDefault();const type=document.getElementById('expType').value,data={name:document.getElementById('expName').value,amount:parseInt(document.getElementById('expAmount').value)||0,memo:document.getElementById('expMemo').value,createdAt:firebase.firestore.FieldValue.serverTimestamp()};if(type==='fixed'){data.cycle=document.getElementById('expCycle').value;try{await db.collection('fixedExpenses').add(data);alert('ì €ì¥');}catch(err){alert(err.message);}}else{data.date=document.getElementById('expDate').value;data.category=document.getElementById('expCategory').value;data.month=getYM();try{await db.collection('variableExpenses').add(data);alert('ì €ì¥');}catch(err){alert(err.message);}}closeExpenseModal();await loadExpenses();renderExpenses();});
        async function deleteExpense(type,id){if(!confirm('ì‚­ì œ?'))return;try{await db.collection(type==='fixed'?'fixedExpenses':'variableExpenses').doc(id).delete();await loadExpenses();renderExpenses();}catch(err){alert(err.message);}}

        // File Upload
        const uploadZone=document.getElementById('uploadZone');
        uploadZone.addEventListener('click',()=>document.getElementById('fileInput').click());
        uploadZone.addEventListener('dragover',e=>{e.preventDefault();uploadZone.classList.add('dragover');});
        uploadZone.addEventListener('dragleave',()=>uploadZone.classList.remove('dragover'));
        uploadZone.addEventListener('drop',e=>{e.preventDefault();uploadZone.classList.remove('dragover');if(e.dataTransfer.files.length>0)processFile(e.dataTransfer.files[0]);});
        function handleFileUpload(e){if(e.target.files[0])processFile(e.target.files[0]);}
        function processFile(file){
            const reader=new FileReader();
            reader.onload=function(e){
                try{const data=new Uint8Array(e.target.result),wb=XLSX.read(data,{type:'array'}),sheet=wb.Sheets[wb.SheetNames[0]],json=XLSX.utils.sheet_to_json(sheet);
                    let totalRev=0,japanRev=0,japanCount=0,year='',month='';
                    const doctorSales={},staffSales={},japanStaffSales={};
                    
                    json.forEach(row=>{
                        const amount=parseInt(row['ê¸ˆì•¡'])||0;totalRev+=amount;
                        const doctor=row['ì§„ë£Œì˜ëª…'];if(doctor&&doctor!=='ë¹ ë¥¸ì˜ˆì•½'){if(!doctorSales[doctor])doctorSales[doctor]={count:0,amount:0};doctorSales[doctor].count++;doctorSales[doctor].amount+=amount;}
                        const staff=row['ë‹´ë‹¹ì§ì›'];if(staff){if(!staffSales[staff])staffSales[staff]={count:0,amount:0};staffSales[staff].count++;staffSales[staff].amount+=amount;}
                        const nationality=row['êµ­ì '];if(nationality&&nationality.includes('ì¼ë³¸')){japanRev+=amount;japanCount++;if(staff){if(!japanStaffSales[staff])japanStaffSales[staff]={count:0,amount:0};japanStaffSales[staff].count++;japanStaffSales[staff].amount+=amount;}}
                        if(row['ì§„ë£Œì¼']&&!year){const d=String(row['ì§„ë£Œì¼']);if(d.length>=6){year=d.substring(0,4);month=d.substring(4,6);}}
                    });
                    
                    const ym=year+'-'+month;
                    db.collection('revenue').doc(ym).set({total:totalRev,japan:japanRev,japanVisitors:japanCount,transactions:json.length,uploadedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
                    db.collection('salesDetail').doc(ym).set({doctorSales,staffSales,japanStaffSales,updatedAt:firebase.firestore.FieldValue.serverTimestamp()});
                    alert(`ì—…ë¡œë“œ ì™„ë£Œ!\n\nì—°ì›”: ${ym}\nê±´ìˆ˜: ${json.length}ê±´\nì´ë§¤ì¶œ: ${formatCurrency(totalRev)}\n\nì§„ë£Œì˜: ${Object.keys(doctorSales).join(', ')}\në‹´ë‹¹ì§ì›: ${Object.keys(staffSales).join(', ')}\n\nì¼ë³¸ì¸ë§¤ì¶œ: ${formatCurrency(japanRev)} (${japanCount}ê±´)`);
                    if(ym===getYM()){loadRevenueData().then(()=>loadSalesDetailData().then(()=>renderAll()));}
                }catch(err){alert('íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜: '+err.message);}
            };
            reader.readAsArrayBuffer(file);
        }

        checkAdminLogin();
    </script>
</body>
</html>
