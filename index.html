<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE CLINIC LUMI - ê´€ë¦¬ì</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--bg-primary:#faf9f7;--bg-secondary:#fff;--bg-card:#fff;--accent-gold:#9a8b7a;--accent-dark:#2c2c2c;--accent-green:#5a7a5a;--accent-red:#a85a5a;--accent-blue:#5a6a7a;--accent-orange:#c4956a;--accent-purple:#7a6a8a;--text-primary:#2c2c2c;--text-secondary:#6b6b6b;--text-muted:#999;--border-color:#e8e4df}
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Noto Sans KR',sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh}
        .login-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;padding:2rem;position:fixed;inset:0;z-index:2000;background:var(--bg-primary)}
        .login-screen.hidden{display:none}.login-logo{font-family:'Cormorant Garamond',serif;letter-spacing:4px;color:var(--text-muted);font-size:.9rem;margin-bottom:.5rem}
        .login-title{font-family:'Cormorant Garamond',serif;font-size:2.5rem;font-weight:500;margin-bottom:.5rem;letter-spacing:2px}
        .login-subtitle{color:var(--text-muted);margin-bottom:2rem;font-size:.85rem;letter-spacing:1px}.login-form{width:100%;max-width:320px}
        .login-input{width:100%;padding:1rem;background:#fff;border:1px solid var(--border-color);color:var(--text-primary);font-size:1rem;margin-bottom:1rem}
        .login-input:focus{outline:none;border-color:var(--accent-gold)}.pw-wrap{position:relative}
        .pw-toggle{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1rem;margin-top:-8px}
        .login-btn{width:100%;padding:1rem;background:var(--accent-dark);border:none;color:#fff;font-size:.9rem;cursor:pointer;letter-spacing:1px;margin-bottom:1rem}
        .login-btn:hover{background:#444}.login-error{color:var(--accent-red);font-size:.85rem;margin-bottom:1rem;text-align:center;min-height:1.2rem}
        .header{background:var(--bg-secondary);border-bottom:1px solid var(--border-color);padding:1rem 2rem;position:sticky;top:0;z-index:100}
        .header-content{display:flex;justify-content:space-between;align-items:center;max-width:1800px;margin:0 auto}
        .logo{display:flex;align-items:center;gap:12px}.logo-text{font-family:'Cormorant Garamond',serif}
        .logo-sub{font-size:.7rem;letter-spacing:3px;color:var(--text-muted)}.logo-main{font-size:1.4rem;font-weight:500;letter-spacing:2px}
        .header-right{display:flex;align-items:center;gap:1rem}.month-selector{display:flex;align-items:center;gap:.5rem;background:var(--bg-primary);padding:.5rem 1rem;border:1px solid var(--border-color)}
        .month-selector select{border:none;background:transparent;font-size:.9rem;cursor:pointer;padding:.25rem}
        .logout-btn{padding:.5rem 1rem;background:none;border:1px solid var(--border-color);cursor:pointer;font-size:.85rem;color:var(--text-secondary)}
        .logout-btn:hover{background:var(--bg-primary)}
        .nav-tabs{display:flex;background:var(--bg-secondary);border-bottom:1px solid var(--border-color);padding:0 2rem;overflow-x:auto}
        .nav-tab{padding:1rem 1.5rem;cursor:pointer;font-size:.9rem;color:var(--text-secondary);border-bottom:2px solid transparent;white-space:nowrap;transition:all .2s}
        .nav-tab:hover{color:var(--text-primary)}.nav-tab.active{color:var(--accent-gold);border-bottom-color:var(--accent-gold);font-weight:500}
        .sub-tabs{display:flex;gap:.5rem;padding:1rem 0;flex-wrap:wrap}
        .sub-tab{padding:.5rem 1rem;background:var(--bg-secondary);border:1px solid var(--border-color);cursor:pointer;font-size:.85rem;color:var(--text-secondary)}
        .sub-tab:hover{border-color:var(--accent-gold)}.sub-tab.active{background:var(--accent-gold);color:#fff;border-color:var(--accent-gold)}
        .content{max-width:1800px;margin:0 auto;padding:1.5rem 2rem}.tab-content{display:none}.tab-content.active{display:block}.sub-content{display:none}.sub-content.active{display:block}
        .cards-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1.5rem}
        .card{background:var(--bg-card);border:1px solid var(--border-color);padding:1.25rem}
        .card-label{font-size:.75rem;color:var(--text-muted);margin-bottom:.5rem;letter-spacing:1px}.card-value{font-size:1.5rem;font-weight:600}
        .card-sub{font-size:.8rem;color:var(--text-secondary);margin-top:.25rem}.card-change{font-size:.8rem;margin-top:.5rem}
        .card-change.positive{color:var(--accent-green)}.card-change.negative{color:var(--accent-red)}
        .table-container{background:var(--bg-card);border:1px solid var(--border-color);overflow-x:auto;margin-bottom:1.5rem}
        table{width:100%;border-collapse:collapse}th,td{padding:.75rem 1rem;text-align:left;border-bottom:1px solid var(--border-color);font-size:.9rem}
        th{background:var(--bg-primary);font-weight:500;color:var(--text-secondary);font-size:.8rem;letter-spacing:.5px}tr:hover{background:var(--bg-primary)}
        .chart-container{background:var(--bg-card);border:1px solid var(--border-color);padding:1.5rem;margin-bottom:1.5rem}
        .chart-title{font-size:.9rem;font-weight:500;margin-bottom:1rem}.chart-wrapper{height:300px;position:relative}
        .upload-zone{border:2px dashed var(--border-color);padding:2rem;text-align:center;cursor:pointer;margin-bottom:1.5rem;background:var(--bg-card);transition:border-color .2s}
        .upload-zone:hover{border-color:var(--accent-gold)}.upload-icon{font-size:2rem;margin-bottom:.5rem}.upload-text{color:var(--text-secondary);font-size:.9rem}
        .badge{display:inline-block;padding:.25rem .5rem;font-size:.75rem;font-weight:500;border-radius:2px}
        .badge-green{background:rgba(90,122,90,.15);color:var(--accent-green)}.badge-red{background:rgba(168,90,90,.15);color:var(--accent-red)}
        .badge-blue{background:rgba(90,106,122,.15);color:var(--accent-blue)}.badge-orange{background:rgba(196,149,106,.15);color:var(--accent-orange)}
        .badge-purple{background:rgba(122,106,138,.15);color:var(--accent-purple)}.badge-gold{background:rgba(154,139,122,.15);color:var(--accent-gold)}
        .btn{padding:.5rem 1rem;border:none;cursor:pointer;font-size:.85rem;transition:all .2s}
        .btn-primary{background:var(--accent-gold);color:#fff}.btn-primary:hover{background:#8a7b6a}
        .btn-secondary{background:var(--bg-primary);border:1px solid var(--border-color);color:var(--text-primary)}.btn-secondary:hover{background:var(--border-color)}
        .btn-danger{background:var(--accent-red);color:#fff}.btn-danger:hover{opacity:.9}.btn-sm{padding:.35rem .75rem;font-size:.8rem}
        .form-group{margin-bottom:1rem}.form-label{display:block;font-size:.85rem;color:var(--text-secondary);margin-bottom:.5rem}
        .form-input,.form-select,.form-textarea{width:100%;padding:.75rem;border:1px solid var(--border-color);font-size:.9rem;background:var(--bg-secondary)}
        .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--accent-gold)}.form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem}
        .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:3000;align-items:center;justify-content:center;padding:1rem}
        .modal.active{display:flex}.modal-content{background:var(--bg-secondary);width:100%;max-width:500px;max-height:90vh;overflow-y:auto}
        .modal-header{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.5rem;border-bottom:1px solid var(--border-color)}
        .modal-title{font-size:1rem;font-weight:500}.modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-muted);line-height:1}
        .modal-body{padding:1.5rem}.modal-footer{display:flex;gap:.5rem;justify-content:flex-end;padding:1rem 1.5rem;border-top:1px solid var(--border-color)}
        .section{margin-bottom:2rem}.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}.section-title{font-size:1rem;font-weight:500}
        .expense-summary{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1.5rem}
        .expense-box{background:var(--bg-card);border:1px solid var(--border-color);padding:1rem;text-align:center}
        .expense-box-label{font-size:.75rem;color:var(--text-muted);margin-bottom:.25rem}.expense-box-value{font-size:1.2rem;font-weight:600}
        .birthday-alert{background:linear-gradient(135deg,#fff5f5,#fffaf0);border:1px solid #f0e0d0;padding:1rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:1rem}
        .birthday-icon{font-size:1.5rem}.birthday-text{flex:1}.birthday-name{font-weight:600;color:var(--accent-orange)}
        .text-right{text-align:right}.text-center{text-align:center}.mt-1{margin-top:1rem}.mb-1{margin-bottom:1rem}
        .app-container{display:none}.app-container.active{display:block}
        @media(max-width:768px){.header{padding:1rem}.content{padding:1rem}.nav-tabs{padding:0 1rem}.nav-tab{padding:.75rem 1rem;font-size:.85rem}.cards-grid{grid-template-columns:repeat(2,1fr)}.expense-summary{grid-template-columns:1fr}.form-row{grid-template-columns:1fr}}
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-logo">THE CLINIC</div>
        <div class="login-title">LUMI</div>
        <div class="login-subtitle">ADMIN PORTAL</div>
        <form class="login-form" onsubmit="handleAdminLogin();return false;">
            <input type="text" class="login-input" id="adminId" placeholder="ê´€ë¦¬ì ID" autocomplete="username">
            <div class="pw-wrap">
                <input type="password" class="login-input" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password">
                <button type="button" class="pw-toggle" onclick="togglePw('adminPw',this)">ğŸ‘</button>
            </div>
            <div class="login-error" id="loginError"></div>
            <button type="submit" class="login-btn">ë¡œê·¸ì¸</button>
        </form>
    </div>
    <div class="app-container" id="appContainer">
        <header class="header">
            <div class="header-content">
                <div class="logo"><div class="logo-text"><div class="logo-sub">THE CLINIC</div><div class="logo-main">LUMI</div></div></div>
                <div class="header-right">
                    <div class="month-selector">
                        <select id="yearSelect" onchange="changeMonth()"></select><span>ë…„</span>
                        <select id="monthSelect" onchange="changeMonth()"></select><span>ì›”</span>
                    </div>
                    <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </header>
        <nav class="nav-tabs">
            <div class="nav-tab active" data-tab="revenue">ë§¤ì¶œ</div>
            <div class="nav-tab" data-tab="expense">ì§€ì¶œ</div>
            <div class="nav-tab" data-tab="employee">ì§ì›ê´€ë¦¬</div>
        </nav>
        <main class="content">
            <div class="tab-content active" id="tab-revenue">
                <div class="sub-tabs">
                    <div class="sub-tab active" data-sub="overview">ë§¤ì¶œ í˜„í™©</div>
                    <div class="sub-tab" data-sub="doctor">ì§„ë£Œì˜ë³„</div>
                    <div class="sub-tab" data-sub="staff">ë‹´ë‹¹ì§ì›ë³„</div>
                    <div class="sub-tab" data-sub="japan">ì¼ë³¸ì¸ ë§¤ì¶œ</div>
                    <div class="sub-tab" data-sub="upload">ë°ì´í„° ì—…ë¡œë“œ</div>
                </div>
                <div class="sub-content active" id="sub-overview">
                    <div id="birthdayAlert"></div>
                    <div class="cards-grid" id="revenueCards"></div>
                    <div class="chart-container"><div class="chart-title">ì›”ë³„ ë§¤ì¶œ ì¶”ì´</div><div class="chart-wrapper"><canvas id="revenueChart"></canvas></div></div>
                    <div class="chart-container"><div class="chart-title">ì—°ë„ë³„ ë¹„êµ (2024 vs 2025)</div><div class="chart-wrapper"><canvas id="compareChart"></canvas></div></div>
                </div>
                <div class="sub-content" id="sub-doctor">
                    <div class="cards-grid" id="doctorCards"></div>
                    <div class="table-container"><table><thead><tr><th>ì§„ë£Œì˜</th><th class="text-right">ê±´ìˆ˜</th><th class="text-right">ë§¤ì¶œ</th><th class="text-right">ì ìœ ìœ¨</th></tr></thead><tbody id="doctorTable"></tbody></table></div>
                </div>
                <div class="sub-content" id="sub-staff">
                    <div class="cards-grid" id="staffSalesCards"></div>
                    <div class="table-container"><table><thead><tr><th>ë‹´ë‹¹ì§ì›</th><th class="text-right">ê±´ìˆ˜</th><th class="text-right">ë§¤ì¶œ</th><th class="text-right">ì¸ì„¼í‹°ë¸Œ(1%)</th></tr></thead><tbody id="staffSalesTable"></tbody></table></div>
                </div>
                <div class="sub-content" id="sub-japan">
                    <div class="cards-grid" id="japanCards"></div>
                    <div class="table-container"><table><thead><tr><th>ì›”</th><th class="text-right">ì¼ë³¸ì¸ ë§¤ì¶œ</th><th class="text-right">ë°©ë¬¸ì ìˆ˜</th><th class="text-right">ê°ë‹¨ê°€</th></tr></thead><tbody id="japanTable"></tbody></table></div>
                </div>
                <div class="sub-content" id="sub-upload">
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">ğŸ“</div>
                        <div class="upload-text">ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ<br><small>ì˜¤ë”íŒë§¤ë‚´ì—­ë°í™˜ìë‚´ì—­_YYYYMMDD_ì˜¤ë”ë³„_.xlsx</small></div>
                        <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none" onchange="handleFileUpload(event)">
                    </div>
                    <div class="section"><div class="section-header"><div class="section-title">ì—…ë¡œë“œ ì´ë ¥</div></div>
                        <div class="table-container"><table><thead><tr><th>ì—°ì›”</th><th class="text-right">ì´ë§¤ì¶œ</th><th class="text-right">ê±´ìˆ˜</th><th>ì—…ë¡œë“œì¼</th></tr></thead><tbody id="uploadHistory"></tbody></table></div>
                    </div>
                </div>
            </div>
            <div class="tab-content" id="tab-expense">
                <div class="sub-tabs">
                    <div class="sub-tab active" data-sub="fixed">ê³ ì •ë¹„</div>
                    <div class="sub-tab" data-sub="variable">ìœ ë™ë¹„</div>
                </div>
                <div class="sub-content active" id="sub-fixed">
                    <div class="expense-summary">
                        <div class="expense-box"><div class="expense-box-label">ì›” ê³ ì •ë¹„ ì´ì•¡</div><div class="expense-box-value" id="fixedTotal">â‚©0</div></div>
                        <div class="expense-box"><div class="expense-box-label">í•­ëª© ìˆ˜</div><div class="expense-box-value" id="fixedCount">0ê°œ</div></div>
                        <div class="expense-box"><div class="expense-box-label">ì—°ê°„ ì˜ˆìƒ</div><div class="expense-box-value" id="fixedYearly">â‚©0</div></div>
                    </div>
                    <div class="section-header"><div class="section-title">ê³ ì •ë¹„ ëª©ë¡</div><button class="btn btn-primary" onclick="openExpenseModal('fixed')">+ í•­ëª© ì¶”ê°€</button></div>
                    <div class="table-container"><table><thead><tr><th>í•­ëª©ëª…</th><th>ì¹´í…Œê³ ë¦¬</th><th class="text-right">ì›” ê¸ˆì•¡</th><th>ë¹„ê³ </th><th>ê´€ë¦¬</th></tr></thead><tbody id="fixedTable"></tbody></table></div>
                </div>
                <div class="sub-content" id="sub-variable">
                    <div class="expense-summary">
                        <div class="expense-box"><div class="expense-box-label">ì´ë²ˆ ë‹¬ ìœ ë™ë¹„</div><div class="expense-box-value" id="variableTotal">â‚©0</div></div>
                        <div class="expense-box"><div class="expense-box-label">ê±´ìˆ˜</div><div class="expense-box-value" id="variableCount">0ê±´</div></div>
                        <div class="expense-box"><div class="expense-box-label">ì „ì›” ëŒ€ë¹„</div><div class="expense-box-value" id="variableChange">-</div></div>
                    </div>
                    <div class="section-header"><div class="section-title">ìœ ë™ë¹„ ëª©ë¡</div><button class="btn btn-primary" onclick="openExpenseModal('variable')">+ í•­ëª© ì¶”ê°€</button></div>
                    <div class="table-container"><table><thead><tr><th>ë‚ ì§œ</th><th>í•­ëª©ëª…</th><th>ì¹´í…Œê³ ë¦¬</th><th class="text-right">ê¸ˆì•¡</th><th>ê´€ë¦¬</th></tr></thead><tbody id="variableTable"></tbody></table></div>
                </div>
            </div>
            <div class="tab-content" id="tab-employee">
                <div class="sub-tabs">
                    <div class="sub-tab active" data-sub="list">ì§ì› ëª©ë¡</div>
                    <div class="sub-tab" data-sub="attendance">ê·¼íƒœ í˜„í™©</div>
                    <div class="sub-tab" data-sub="overtime">ì˜¤ë²„íƒ€ì„</div>
                    <div class="sub-tab" data-sub="incentive">ì¸ì„¼í‹°ë¸Œ</div>
                    <div class="sub-tab" data-sub="salary">ê¸‰ì—¬</div>
                </div>
                <div class="sub-content active" id="sub-list">
                    <div class="section-header"><div class="section-title">ì§ì› ëª©ë¡</div><button class="btn btn-primary" onclick="openEmployeeModal()">+ ì§ì› ë“±ë¡</button></div>
                    <div class="table-container"><table><thead><tr><th>ì‚¬ë²ˆ</th><th>ì´ë¦„</th><th>ë§¤ì¹­ëª…</th><th>ì§ê¸‰</th><th>ì…ì‚¬ì¼</th><th>ê·¼ì†</th><th>ì‹œê¸‰</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead><tbody id="employeeTable"></tbody></table></div>
                </div>
                <div class="sub-content" id="sub-attendance">
                    <div class="cards-grid">
                        <div class="card"><div class="card-label">ì´ë²ˆ ë‹¬ ì¶œê·¼ì¼</div><div class="card-value" id="workDays">0ì¼</div></div>
                        <div class="card"><div class="card-label">ì§€ê°</div><div class="card-value" id="lateDays">0íšŒ</div></div>
                        <div class="card"><div class="card-label">ì¡°í‡´</div><div class="card-value" id="earlyDays">0íšŒ</div></div>
                        <div class="card"><div class="card-label">ê²°ê·¼</div><div class="card-value" id="absentDays">0íšŒ</div></div>
                    </div>
                    <div class="section-header"><div class="section-title">ê·¼íƒœ ê¸°ë¡</div><select class="form-select" id="attendanceFilter" style="width:auto" onchange="renderAttendance()"><option value="all">ì „ì²´ ì§ì›</option></select></div>
                    <div class="table-container"><table><thead><tr><th>ë‚ ì§œ</th><th>ì§ì›</th><th>ì¶œê·¼</th><th>í‡´ê·¼</th><th>ê·¼ë¬´ì‹œê°„</th><th>ìƒíƒœ</th></tr></thead><tbody id="attendanceTable"></tbody></table></div>
                </div>
                <div class="sub-content" id="sub-overtime">
                    <div class="cards-grid">
                        <div class="card"><div class="card-label">ì´ë²ˆ ë‹¬ ì´ ì˜¤ë²„íƒ€ì„</div><div class="card-value" id="totalOT">0ì‹œê°„</div></div>
                        <div class="card"><div class="card-label">ì €ë… OT (ìë™)</div><div class="card-value" id="eveningOT">0ì‹œê°„</div></div>
                        <div class="card"><div class="card-label">ì ì‹¬ OT (ìˆ˜ë™)</div><div class="card-value" id="lunchOTVal">0ì‹œê°„</div></div>
                        <div class="card"><div class="card-label">OT ìˆ˜ë‹¹ í•©ê³„</div><div class="card-value" id="totalOTPay">â‚©0</div></div>
                    </div>
                    <div class="section-header"><div class="section-title">ì ì‹¬ OT ì…ë ¥</div><button class="btn btn-primary" onclick="openOTModal()">+ OT ì…ë ¥</button></div>
                    <div class="table-container"><table><thead><tr><th>ë‚ ì§œ</th><th>ì§ì›</th><th>ì‹œê°„(ë¶„)</th><th>ì‚¬ìœ </th><th>ê´€ë¦¬</th></tr></thead><tbody id="lunchOTTable"></tbody></table></div>
                </div>
                <div class="sub-content" id="sub-incentive">
                    <div class="section-header"><div class="section-title">ì¸ì„¼í‹°ë¸Œ í•­ëª© ê´€ë¦¬</div><button class="btn btn-primary" onclick="openIncentiveItemModal()">+ í•­ëª© ì¶”ê°€</button></div>
                    <div class="table-container"><table><thead><tr><th>í•­ëª©ëª…</th><th>ë‹¨ê°€</th><th>ì ìš© ì§ê¸‰</th><th>ê´€ë¦¬</th></tr></thead><tbody id="incentiveItemTable"></tbody></table></div>
                    <div class="section-header mt-1"><div class="section-title">ì§ì›ë³„ ì¸ì„¼í‹°ë¸Œ í˜„í™©</div></div>
                    <div class="table-container"><table><thead><tr><th>ì§ì›</th><th>ì§ê¸‰</th><th>ë§¤ì¶œ ì¸ì„¼í‹°ë¸Œ</th><th>í•­ëª© ì¸ì„¼í‹°ë¸Œ</th><th>í•©ê³„</th></tr></thead><tbody id="incentiveSummaryTable"></tbody></table></div>
                </div>
                <div class="sub-content" id="sub-salary">
                    <div class="section-header"><div class="section-title">ê¸‰ì—¬ ëª…ì„¸</div><button class="btn btn-secondary" onclick="exportSalary()">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button></div>
                    <div class="table-container"><table><thead><tr><th>ì§ì›</th><th>ì§ê¸‰</th><th class="text-right">ê¸°ë³¸ê¸‰</th><th class="text-right">OTìˆ˜ë‹¹</th><th class="text-right">ì¸ì„¼í‹°ë¸Œ</th><th class="text-right">ê³µì œ</th><th class="text-right">ì‹¤ìˆ˜ë ¹ì•¡</th></tr></thead><tbody id="salaryTable"></tbody></table></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal" id="employeeModal">
        <div class="modal-content">
            <div class="modal-header"><div class="modal-title" id="employeeModalTitle">ì§ì› ë“±ë¡</div><button class="modal-close" onclick="closeModal('employeeModal')">&times;</button></div>
            <div class="modal-body">
                <input type="hidden" id="empEditId">
                <div class="form-row">
                    <div class="form-group"><label class="form-label">ì´ë¦„ *</label><input type="text" class="form-input" id="empName" required></div>
                    <div class="form-group"><label class="form-label">ë§¤ì¹­ ì´ë¦„ (ì—‘ì…€)</label><input type="text" class="form-input" id="empMatchName" placeholder="ì—‘ì…€ ë‹´ë‹¹ì§ì›ëª…"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">ì§ê¸‰ *</label><select class="form-select" id="empRole"><option value="doctor">ì›ì¥</option><option value="nurse">ê°„í˜¸ì‚¬</option><option value="coordinator">ì½”ë””ë„¤ì´í„°</option><option value="marketing">ë§ˆì¼€íŒ…</option><option value="manager">ì‹¤ì¥</option><option value="staff">ìŠ¤íƒœí”„</option></select></div>
                    <div class="form-group"><label class="form-label">ì…ì‚¬ì¼ *</label><input type="date" class="form-input" id="empJoinDate" required></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">ì‹œê¸‰</label><input type="number" class="form-input" id="empHourly" value="12000"></div>
                    <div class="form-group"><label class="form-label">ì¸ì„¼í‹°ë¸Œ ìœ í˜•</label><select class="form-select" id="empIncentiveType"><option value="none">ì—†ìŒ</option><option value="revenue">ë§¤ì¶œ 1%</option><option value="growth">ì„±ì¥ë¶„ 10%</option><option value="japan">ì¼ë³¸ì¸ ë§¤ì¶œ</option><option value="staff_sales">ë‹´ë‹¹ì§ì› ë§¤ì¶œ 1%</option></select></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">ìƒë…„ì›”ì¼</label><input type="date" class="form-input" id="empBirthday"></div>
                    <div class="form-group"><label class="form-label">ìƒíƒœ</label><select class="form-select" id="empStatus"><option value="active">ì¬ì§</option><option value="inactive">í‡´ì‚¬</option></select></div>
                </div>
                <div class="form-group"><label class="form-label">ì‚¬ë²ˆ (ìë™ìƒì„±)</label><input type="text" class="form-input" id="empId" readonly placeholder="ì €ì¥ ì‹œ ìë™ ìƒì„±"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('employeeModal')">ì·¨ì†Œ</button><button class="btn btn-primary" onclick="saveEmployee()">ì €ì¥</button></div>
        </div>
    </div>
    <div class="modal" id="expenseModal">
        <div class="modal-content">
            <div class="modal-header"><div class="modal-title" id="expenseModalTitle">ì§€ì¶œ ì¶”ê°€</div><button class="modal-close" onclick="closeModal('expenseModal')">&times;</button></div>
            <div class="modal-body">
                <input type="hidden" id="expenseEditId"><input type="hidden" id="expenseType">
                <div class="form-group" id="expenseDateGroup"><label class="form-label">ë‚ ì§œ</label><input type="date" class="form-input" id="expenseDate"></div>
                <div class="form-group"><label class="form-label">í•­ëª©ëª… *</label><input type="text" class="form-input" id="expenseName" required></div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">ì¹´í…Œê³ ë¦¬</label><select class="form-select" id="expenseCategory"><option value="ì„ëŒ€ë£Œ">ì„ëŒ€ë£Œ</option><option value="ì¸ê±´ë¹„">ì¸ê±´ë¹„</option><option value="ê³µê³¼ê¸ˆ">ê³µê³¼ê¸ˆ</option><option value="ë³´í—˜ë£Œ">ë³´í—˜ë£Œ</option><option value="ì¥ë¹„">ì¥ë¹„</option><option value="ì†Œëª¨í’ˆ">ì†Œëª¨í’ˆ</option><option value="ë§ˆì¼€íŒ…">ë§ˆì¼€íŒ…</option><option value="ê¸°íƒ€">ê¸°íƒ€</option></select></div>
                    <div class="form-group"><label class="form-label">ê¸ˆì•¡ *</label><input type="number" class="form-input" id="expenseAmount" required></div>
                </div>
                <div class="form-group"><label class="form-label">ë¹„ê³ </label><textarea class="form-textarea" id="expenseNote" rows="2"></textarea></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('expenseModal')">ì·¨ì†Œ</button><button class="btn btn-primary" onclick="saveExpense()">ì €ì¥</button></div>
        </div>
    </div>
    <div class="modal" id="otModal">
        <div class="modal-content">
            <div class="modal-header"><div class="modal-title">ì ì‹¬ OT ì…ë ¥</div><button class="modal-close" onclick="closeModal('otModal')">&times;</button></div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group"><label class="form-label">ë‚ ì§œ</label><input type="date" class="form-input" id="otDate"></div>
                    <div class="form-group"><label class="form-label">ì§ì›</label><select class="form-select" id="otEmployee"></select></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">ì‹œê°„ (ë¶„)</label><input type="number" class="form-input" id="otMinutes" value="30"></div>
                    <div class="form-group"><label class="form-label">ì‚¬ìœ </label><input type="text" class="form-input" id="otReason" placeholder="ì˜ˆ: ì ì‹¬ì‹œê°„ ê·¼ë¬´"></div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('otModal')">ì·¨ì†Œ</button><button class="btn btn-primary" onclick="saveLunchOT()">ì €ì¥</button></div>
        </div>
    </div>
    <div class="modal" id="incentiveItemModal">
        <div class="modal-content">
            <div class="modal-header"><div class="modal-title" id="incentiveItemModalTitle">ì¸ì„¼í‹°ë¸Œ í•­ëª© ì¶”ê°€</div><button class="modal-close" onclick="closeModal('incentiveItemModal')">&times;</button></div>
            <div class="modal-body">
                <input type="hidden" id="incItemEditId">
                <div class="form-group"><label class="form-label">í•­ëª©ëª… *</label><input type="text" class="form-input" id="incItemName" placeholder="ì˜ˆ: ì‹œìˆ  ë³´ì¡°, ìƒë‹´ ì„±ê³µ"></div>
                <div class="form-group"><label class="form-label">ë‹¨ê°€ (ê±´ë‹¹)</label><input type="number" class="form-input" id="incItemPrice" value="10000"></div>
                <div class="form-group"><label class="form-label">ì ìš© ì§ê¸‰</label><select class="form-select" id="incItemRole"><option value="all">ì „ì²´</option><option value="nurse">ê°„í˜¸ì‚¬</option><option value="coordinator">ì½”ë””ë„¤ì´í„°</option><option value="staff">ìŠ¤íƒœí”„</option></select></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('incentiveItemModal')">ì·¨ì†Œ</button><button class="btn btn-primary" onclick="saveIncentiveItem()">ì €ì¥</button></div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig={apiKey:"AIzaSyDnkKNXNnDVlcPd5Y1fl59YysdeEZi7uJU",authDomain:"lumiclinic-c1a95.firebaseapp.com",projectId:"lumiclinic-c1a95",storageBucket:"lumiclinic-c1a95.firebasestorage.app",messagingSenderId:"901456209944",appId:"1:901456209944:web:f287418cd0541f324d3b6d"};
        firebase.initializeApp(firebaseConfig);
        const db=firebase.firestore();

        // Global State
        let currentYear=new Date().getFullYear();
        let currentMonth=new Date().getMonth()+1;
        let employees=[],attendance=[],revenueData={},salesDetail={},fixedExpenses=[],variableExpenses=[],incentiveItems=[],lunchOT=[];
        let revenueChart=null,compareChart=null;

        // 2024ë…„ ë°ì´í„°
        const data2024={1:{total:243000000,japan:48000000,japanVisitors:32},2:{total:258000000,japan:52000000,japanVisitors:35},3:{total:199000000,japan:38000000,japanVisitors:25},4:{total:210000000,japan:42000000,japanVisitors:28},5:{total:195000000,japan:39000000,japanVisitors:26},6:{total:183000000,japan:36000000,japanVisitors:24},7:{total:169000000,japan:34000000,japanVisitors:23},8:{total:168000000,japan:33000000,japanVisitors:22},9:{total:192000000,japan:38000000,japanVisitors:25},10:{total:186000000,japan:37000000,japanVisitors:25},11:{total:194000000,japan:39000000,japanVisitors:26},12:{total:200000000,japan:40000000,japanVisitors:27}};

        // Utility Functions
        function formatCurrency(num){return num?'â‚©'+Math.round(num).toLocaleString():'â‚©0';}
        function formatNumber(num){return num?Math.round(num).toLocaleString():'0';}
        function getYM(){return `${currentYear}-${String(currentMonth).padStart(2,'0')}`;}
        function togglePw(id,btn){const input=document.getElementById(id);if(input.type==='password'){input.type='text';btn.textContent='ğŸ™ˆ';}else{input.type='password';btn.textContent='ğŸ‘';}}
        function closeModal(id){document.getElementById(id).classList.remove('active');}
        function openModal(id){document.getElementById(id).classList.add('active');}

        function generateEmployeeId(name,joinDate){
            const year=joinDate?joinDate.substring(2,4):String(new Date().getFullYear()).substring(2);
            const initials=getKoreanInitials(name).toLowerCase();
            return year+initials;
        }

        function getKoreanInitials(name){
            const CHO=['ã„±','ã„²','ã„´','ã„·','ã„¸','ã„¹','ã…','ã…‚','ã…ƒ','ã……','ã…†','ã…‡','ã…ˆ','ã…‰','ã…Š','ã…‹','ã…Œ','ã…','ã…'];
            const ALPHA=['g','kk','n','d','tt','r','m','b','pp','s','ss','o','j','jj','ch','k','t','p','h'];
            let result='';
            for(let i=0;i<name.length&&result.length<3;i++){
                const code=name.charCodeAt(i);
                if(code>=0xAC00&&code<=0xD7A3){const idx=Math.floor((code-0xAC00)/588);result+=ALPHA[idx];}
                else if(/[a-zA-Z]/.test(name[i])){result+=name[i].toLowerCase();}
            }
            return result.substring(0,3).padEnd(3,'x');
        }

        function getYearsOfService(joinDate){
            if(!joinDate)return'-';
            const join=new Date(joinDate);const now=new Date();
            const years=Math.floor((now-join)/(365.25*24*60*60*1000));
            return years<1?'1ë…„ ë¯¸ë§Œ':`${years+1}ë…„ì°¨`;
        }

        // Authentication
        const ADMIN_CREDENTIALS={id:'admin',pw:'lumi2024!'};
        function handleAdminLogin(){
            const id=document.getElementById('adminId').value.trim();
            const pw=document.getElementById('adminPw').value;
            const errorEl=document.getElementById('loginError');
            if(id===ADMIN_CREDENTIALS.id&&pw===ADMIN_CREDENTIALS.pw){
                localStorage.setItem('lumi_admin_auth','true');
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appContainer').classList.add('active');
                initApp();
            }else{errorEl.textContent='ID ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';}
        }
        function logout(){localStorage.removeItem('lumi_admin_auth');location.reload();}
        function checkAuth(){
            if(localStorage.getItem('lumi_admin_auth')==='true'){
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appContainer').classList.add('active');
                initApp();
            }
        }

        // Tab Navigation
        document.querySelectorAll('.nav-tab').forEach(tab=>{
            tab.addEventListener('click',function(){
                document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('tab-'+this.dataset.tab).classList.add('active');
            });
        });
        document.querySelectorAll('.sub-tab').forEach(tab=>{
            tab.addEventListener('click',function(){
                const parent=this.closest('.tab-content');
                parent.querySelectorAll('.sub-tab').forEach(t=>t.classList.remove('active'));
                parent.querySelectorAll('.sub-content').forEach(c=>c.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('sub-'+this.dataset.sub).classList.add('active');
            });
        });

        // Month Selector
        function initMonthSelector(){
            const yearSelect=document.getElementById('yearSelect');
            const monthSelect=document.getElementById('monthSelect');
            yearSelect.innerHTML='';monthSelect.innerHTML='';
            for(let y=2024;y<=2026;y++){yearSelect.innerHTML+=`<option value="${y}" ${y===currentYear?'selected':''}>${y}</option>`;}
            for(let m=1;m<=12;m++){monthSelect.innerHTML+=`<option value="${m}" ${m===currentMonth?'selected':''}>${m}</option>`;}
        }
        function changeMonth(){
            currentYear=parseInt(document.getElementById('yearSelect').value);
            currentMonth=parseInt(document.getElementById('monthSelect').value);
            loadAllData();
        }

        // Data Loading
        async function loadAllData(){
            await Promise.all([loadEmployees(),loadRevenueData(),loadSalesDetailData(),loadExpenses(),loadAttendance(),loadIncentiveItems(),loadLunchOT()]);
            renderAll();
        }
        async function loadEmployees(){try{const snapshot=await db.collection('employees').get();employees=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));}catch(e){console.error('Load employees error:',e);}}
        async function loadRevenueData(){try{const snapshot=await db.collection('revenue').get();revenueData={};snapshot.docs.forEach(doc=>{revenueData[doc.id]=doc.data();});}catch(e){console.error('Load revenue error:',e);}}
        async function loadSalesDetailData(){try{const snapshot=await db.collection('salesDetail').get();salesDetail={};snapshot.docs.forEach(doc=>{salesDetail[doc.id]=doc.data();});}catch(e){console.error('Load sales detail error:',e);}}
        async function loadExpenses(){
            try{
                let snapshot=await db.collection('fixedExpenses').get();
                fixedExpenses=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));
                snapshot=await db.collection('variableExpenses').where('yearMonth','==',getYM()).get();
                variableExpenses=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));
            }catch(e){console.error('Load expenses error:',e);}
        }
        async function loadAttendance(){
            try{
                const ym=getYM();
                const snapshot=await db.collection('attendance').where('date','>=',ym+'-01').where('date','<=',ym+'-31').get();
                attendance=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));
            }catch(e){console.error('Load attendance error:',e);}
        }
        async function loadIncentiveItems(){try{const snapshot=await db.collection('incentiveItems').get();incentiveItems=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));}catch(e){console.error('Load incentive items error:',e);}}
        async function loadLunchOT(){
            try{
                const ym=getYM();
                const snapshot=await db.collection('lunchOT').where('date','>=',ym+'-01').where('date','<=',ym+'-31').get();
                lunchOT=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));
            }catch(e){console.error('Load lunch OT error:',e);}
        }

        // Render Functions
        function renderAll(){
            renderRevenueOverview();renderDoctorSales();renderStaffSales();renderJapanSales();renderUploadHistory();
            renderExpenses();renderEmployees();renderAttendance();renderOvertime();
            renderIncentiveItems();renderIncentiveSummary();renderSalary();renderCharts();checkBirthdays();
        }

        function renderRevenueOverview(){
            const ym=getYM();
            const data=revenueData[ym]||{total:0,japan:0,transactions:0};
            const prevYM=currentMonth===1?`${currentYear-1}-12`:`${currentYear}-${String(currentMonth-1).padStart(2,'0')}`;
            const prevData=revenueData[prevYM]||{total:0};
            const lastYearData=data2024[currentMonth]||{total:0};
            const growth=data.total-prevData.total;
            const yoyGrowth=data.total-lastYearData.total;
            const avgTransaction=data.transactions?data.total/data.transactions:0;

            document.getElementById('revenueCards').innerHTML=`
                <div class="card"><div class="card-label">ì´ ë§¤ì¶œ</div><div class="card-value">${formatCurrency(data.total)}</div><div class="card-change ${growth>=0?'positive':'negative'}">ì „ì›” ëŒ€ë¹„ ${growth>=0?'+':''}${formatCurrency(growth)}</div></div>
                <div class="card"><div class="card-label">ì¼ë³¸ì¸ ë§¤ì¶œ</div><div class="card-value">${formatCurrency(data.japan)}</div><div class="card-sub">ì „ì²´ì˜ ${data.total?Math.round(data.japan/data.total*100):0}%</div></div>
                <div class="card"><div class="card-label">ê±°ë˜ ê±´ìˆ˜</div><div class="card-value">${formatNumber(data.transactions)}ê±´</div><div class="card-sub">í‰ê·  ê°ë‹¨ê°€ ${formatCurrency(avgTransaction)}</div></div>
                <div class="card"><div class="card-label">ì „ë…„ ë™ì›” ëŒ€ë¹„</div><div class="card-value ${yoyGrowth>=0?'positive':'negative'}">${yoyGrowth>=0?'+':''}${formatCurrency(yoyGrowth)}</div><div class="card-sub">2024ë…„ ${currentMonth}ì›”: ${formatCurrency(lastYearData.total)}</div></div>
            `;
        }

        function renderDoctorSales(){
            const ym=getYM();const detail=salesDetail[ym]||{};const doctorSales=detail.doctorSales||{};
            const total=Object.values(doctorSales).reduce((sum,d)=>sum+(d.amount||0),0);
            const sorted=Object.entries(doctorSales).sort((a,b)=>b[1].amount-a[1].amount);
            const top=sorted[0];
            document.getElementById('doctorCards').innerHTML=`
                <div class="card"><div class="card-label">ì§„ë£Œì˜ ìˆ˜</div><div class="card-value">${sorted.length}ëª…</div></div>
                <div class="card"><div class="card-label">ì´ ë§¤ì¶œ</div><div class="card-value">${formatCurrency(total)}</div></div>
                <div class="card"><div class="card-label">1ìœ„</div><div class="card-value">${top?top[0]:'-'}</div><div class="card-sub">${top?formatCurrency(top[1].amount):''}</div></div>
            `;
            document.getElementById('doctorTable').innerHTML=sorted.map(([name,data])=>`<tr><td><strong>${name}</strong></td><td class="text-right">${formatNumber(data.count)}ê±´</td><td class="text-right">${formatCurrency(data.amount)}</td><td class="text-right">${total?Math.round(data.amount/total*100):0}%</td></tr>`).join('')||'<tr><td colspan="4" class="text-center">ë°ì´í„° ì—†ìŒ</td></tr>';
        }

        function renderStaffSales(){
            const ym=getYM();const detail=salesDetail[ym]||{};const staffSales=detail.staffSales||{};
            const total=Object.values(staffSales).reduce((sum,d)=>sum+(d.amount||0),0);
            const sorted=Object.entries(staffSales).sort((a,b)=>b[1].amount-a[1].amount);
            document.getElementById('staffSalesCards').innerHTML=`
                <div class="card"><div class="card-label">ë‹´ë‹¹ì§ì› ìˆ˜</div><div class="card-value">${sorted.length}ëª…</div></div>
                <div class="card"><div class="card-label">ì´ ë§¤ì¶œ</div><div class="card-value">${formatCurrency(total)}</div></div>
                <div class="card"><div class="card-label">ì¸ì„¼í‹°ë¸Œ ì´ì•¡ (1%)</div><div class="card-value">${formatCurrency(total*0.01)}</div></div>
            `;
            document.getElementById('staffSalesTable').innerHTML=sorted.map(([name,data])=>`<tr><td><strong>${name}</strong></td><td class="text-right">${formatNumber(data.count)}ê±´</td><td class="text-right">${formatCurrency(data.amount)}</td><td class="text-right"><span class="badge badge-green">${formatCurrency(data.amount*0.01)}</span></td></tr>`).join('')||'<tr><td colspan="4" class="text-center">ë°ì´í„° ì—†ìŒ</td></tr>';
        }

        function renderJapanSales(){
            const months=[];
            for(let m=1;m<=12;m++){
                const ym=`${currentYear}-${String(m).padStart(2,'0')}`;
                const data=revenueData[ym]||(currentYear===2024?data2024[m]:{japan:0,japanVisitors:0});
                months.push({month:m,...data});
            }
            const currentData=months[currentMonth-1];
            const totalJapan=months.reduce((sum,m)=>sum+(m.japan||0),0);
            const totalVisitors=months.reduce((sum,m)=>sum+(m.japanVisitors||0),0);
            document.getElementById('japanCards').innerHTML=`
                <div class="card"><div class="card-label">${currentMonth}ì›” ì¼ë³¸ì¸ ë§¤ì¶œ</div><div class="card-value">${formatCurrency(currentData.japan)}</div></div>
                <div class="card"><div class="card-label">${currentMonth}ì›” ë°©ë¬¸ì</div><div class="card-value">${currentData.japanVisitors||0}ëª…</div></div>
                <div class="card"><div class="card-label">ì—°ê°„ ëˆ„ì </div><div class="card-value">${formatCurrency(totalJapan)}</div><div class="card-sub">${totalVisitors}ëª… ë°©ë¬¸</div></div>
            `;
            document.getElementById('japanTable').innerHTML=months.map(m=>`<tr><td>${m.month}ì›”</td><td class="text-right">${formatCurrency(m.japan)}</td><td class="text-right">${m.japanVisitors||0}ëª…</td><td class="text-right">${m.japanVisitors?formatCurrency(m.japan/m.japanVisitors):'-'}</td></tr>`).join('');
        }

        function renderUploadHistory(){
            const sorted=Object.entries(revenueData).sort((a,b)=>b[0].localeCompare(a[0])).slice(0,12);
            document.getElementById('uploadHistory').innerHTML=sorted.map(([ym,data])=>`<tr><td>${ym}</td><td class="text-right">${formatCurrency(data.total)}</td><td class="text-right">${data.transactions||0}ê±´</td><td>${data.uploadedAt?new Date(data.uploadedAt.toDate()).toLocaleDateString():'-'}</td></tr>`).join('')||'<tr><td colspan="4" class="text-center">ì—…ë¡œë“œëœ ë°ì´í„° ì—†ìŒ</td></tr>';
        }

        function renderExpenses(){
            const fixedTotal=fixedExpenses.reduce((sum,e)=>sum+(e.amount||0),0);
            document.getElementById('fixedTotal').textContent=formatCurrency(fixedTotal);
            document.getElementById('fixedCount').textContent=fixedExpenses.length+'ê°œ';
            document.getElementById('fixedYearly').textContent=formatCurrency(fixedTotal*12);
            document.getElementById('fixedTable').innerHTML=fixedExpenses.map(e=>`<tr><td><strong>${e.name}</strong></td><td><span class="badge badge-blue">${e.category}</span></td><td class="text-right">${formatCurrency(e.amount)}</td><td>${e.note||'-'}</td><td><button class="btn btn-sm btn-secondary" onclick="editExpense('fixed','${e.id}')">ìˆ˜ì •</button> <button class="btn btn-sm btn-danger" onclick="deleteExpense('fixed','${e.id}')">ì‚­ì œ</button></td></tr>`).join('')||'<tr><td colspan="5" class="text-center">ë“±ë¡ëœ ê³ ì •ë¹„ ì—†ìŒ</td></tr>';

            const variableTotal=variableExpenses.reduce((sum,e)=>sum+(e.amount||0),0);
            document.getElementById('variableTotal').textContent=formatCurrency(variableTotal);
            document.getElementById('variableCount').textContent=variableExpenses.length+'ê±´';
            document.getElementById('variableTable').innerHTML=variableExpenses.map(e=>`<tr><td>${e.date}</td><td><strong>${e.name}</strong></td><td><span class="badge badge-orange">${e.category}</span></td><td class="text-right">${formatCurrency(e.amount)}</td><td><button class="btn btn-sm btn-secondary" onclick="editExpense('variable','${e.id}')">ìˆ˜ì •</button> <button class="btn btn-sm btn-danger" onclick="deleteExpense('variable','${e.id}')">ì‚­ì œ</button></td></tr>`).join('')||'<tr><td colspan="5" class="text-center">ë“±ë¡ëœ ìœ ë™ë¹„ ì—†ìŒ</td></tr>';
        }

        function renderEmployees(){
            const roleLabels={doctor:'ì›ì¥',nurse:'ê°„í˜¸ì‚¬',coordinator:'ì½”ë””ë„¤ì´í„°',marketing:'ë§ˆì¼€íŒ…',manager:'ì‹¤ì¥',staff:'ìŠ¤íƒœí”„'};
            const filter=document.getElementById('attendanceFilter');
            filter.innerHTML='<option value="all">ì „ì²´ ì§ì›</option>'+employees.filter(e=>e.status==='active').map(e=>`<option value="${e.id}">${e.name}</option>`).join('');
            const otSelect=document.getElementById('otEmployee');
            otSelect.innerHTML=employees.filter(e=>e.status==='active').map(e=>`<option value="${e.id}">${e.name}</option>`).join('');
            document.getElementById('employeeTable').innerHTML=employees.map(e=>`<tr><td><span class="badge badge-gold">${e.id}</span></td><td><strong>${e.name}</strong></td><td>${e.matchName||'-'}</td><td>${roleLabels[e.role]||e.role}</td><td>${e.joinDate||'-'}</td><td>${getYearsOfService(e.joinDate)}</td><td>${formatCurrency(e.hourly)}</td><td><span class="badge ${e.status==='active'?'badge-green':'badge-red'}">${e.status==='active'?'ì¬ì§':'í‡´ì‚¬'}</span></td><td><button class="btn btn-sm btn-secondary" onclick="editEmployee('${e.id}')">ìˆ˜ì •</button> <button class="btn btn-sm btn-danger" onclick="deleteEmployee('${e.id}')">ì‚­ì œ</button></td></tr>`).join('')||'<tr><td colspan="9" class="text-center">ë“±ë¡ëœ ì§ì› ì—†ìŒ</td></tr>';
        }

        function renderAttendance(){
            const filter=document.getElementById('attendanceFilter').value;
            let filtered=attendance;
            if(filter!=='all'){filtered=attendance.filter(a=>a.employeeId===filter);}
            const workDays=filtered.filter(a=>a.checkIn).length;
            const lateDays=filtered.filter(a=>a.status==='late').length;
            const earlyDays=filtered.filter(a=>a.status==='early').length;
            const absentDays=filtered.filter(a=>a.status==='absent').length;
            document.getElementById('workDays').textContent=workDays+'ì¼';
            document.getElementById('lateDays').textContent=lateDays+'íšŒ';
            document.getElementById('earlyDays').textContent=earlyDays+'íšŒ';
            document.getElementById('absentDays').textContent=absentDays+'íšŒ';
            const sorted=filtered.sort((a,b)=>b.date.localeCompare(a.date));
            document.getElementById('attendanceTable').innerHTML=sorted.slice(0,50).map(a=>{
                const emp=employees.find(e=>e.id===a.employeeId);
                const workHours=a.checkIn&&a.checkOut?calculateWorkHours(a.checkIn,a.checkOut):'-';
                const statusBadge={normal:'<span class="badge badge-green">ì •ìƒ</span>',late:'<span class="badge badge-orange">ì§€ê°</span>',early:'<span class="badge badge-blue">ì¡°í‡´</span>',absent:'<span class="badge badge-red">ê²°ê·¼</span>'};
                return `<tr><td>${a.date}</td><td>${emp?emp.name:a.employeeId}</td><td>${a.checkIn||'-'}</td><td>${a.checkOut||'-'}</td><td>${workHours}</td><td>${statusBadge[a.status]||'-'}</td></tr>`;
            }).join('')||'<tr><td colspan="6" class="text-center">ê·¼íƒœ ê¸°ë¡ ì—†ìŒ</td></tr>';
        }

        function calculateWorkHours(checkIn,checkOut){
            const [inH,inM]=checkIn.split(':').map(Number);
            const [outH,outM]=checkOut.split(':').map(Number);
            const minutes=(outH*60+outM)-(inH*60+inM);
            const hours=Math.floor(minutes/60);const mins=minutes%60;
            return `${hours}ì‹œê°„ ${mins}ë¶„`;
        }

        function renderOvertime(){
            let eveningMinutes=0;
            attendance.forEach(a=>{
                if(a.checkOut){
                    const [h,m]=a.checkOut.split(':').map(Number);
                    const totalMinutes=h*60+m;
                    if(totalMinutes>18*60){eveningMinutes+=totalMinutes-18*60;}
                }
            });
            const lunchMinutes=lunchOT.reduce((sum,ot)=>sum+(ot.minutes||0),0);
            const totalMinutes=eveningMinutes+lunchMinutes;
            const avgHourly=employees.length?employees.reduce((sum,e)=>sum+(e.hourly||12000),0)/employees.length:12000;
            const totalPay=Math.round(totalMinutes/60*avgHourly*1.5);
            document.getElementById('totalOT').textContent=Math.round(totalMinutes/60*10)/10+'ì‹œê°„';
            document.getElementById('eveningOT').textContent=Math.round(eveningMinutes/60*10)/10+'ì‹œê°„';
            document.getElementById('lunchOTVal').textContent=Math.round(lunchMinutes/60*10)/10+'ì‹œê°„';
            document.getElementById('totalOTPay').textContent=formatCurrency(totalPay);
            const sorted=lunchOT.sort((a,b)=>b.date.localeCompare(a.date));
            document.getElementById('lunchOTTable').innerHTML=sorted.map(ot=>{
                const emp=employees.find(e=>e.id===ot.employeeId);
                return `<tr><td>${ot.date}</td><td>${emp?emp.name:ot.employeeId}</td><td>${ot.minutes}ë¶„</td><td>${ot.reason||'-'}</td><td><button class="btn btn-sm btn-danger" onclick="deleteLunchOT('${ot.id}')">ì‚­ì œ</button></td></tr>`;
            }).join('')||'<tr><td colspan="5" class="text-center">ì ì‹¬ OT ê¸°ë¡ ì—†ìŒ</td></tr>';
        }

        function renderIncentiveItems(){
            const roleLabels={all:'ì „ì²´',nurse:'ê°„í˜¸ì‚¬',coordinator:'ì½”ë””ë„¤ì´í„°',staff:'ìŠ¤íƒœí”„'};
            document.getElementById('incentiveItemTable').innerHTML=incentiveItems.map(item=>`<tr><td><strong>${item.name}</strong></td><td>${formatCurrency(item.price)}</td><td><span class="badge badge-purple">${roleLabels[item.role]||item.role}</span></td><td><button class="btn btn-sm btn-secondary" onclick="editIncentiveItem('${item.id}')">ìˆ˜ì •</button> <button class="btn btn-sm btn-danger" onclick="deleteIncentiveItem('${item.id}')">ì‚­ì œ</button></td></tr>`).join('')||'<tr><td colspan="4" class="text-center">ë“±ë¡ëœ í•­ëª© ì—†ìŒ</td></tr>';
        }

        function renderIncentiveSummary(){
            const ym=getYM();const detail=salesDetail[ym]||{};const staffSales=detail.staffSales||{};
            const roleLabels={doctor:'ì›ì¥',nurse:'ê°„í˜¸ì‚¬',coordinator:'ì½”ë””ë„¤ì´í„°',marketing:'ë§ˆì¼€íŒ…',manager:'ì‹¤ì¥',staff:'ìŠ¤íƒœí”„'};
            document.getElementById('incentiveSummaryTable').innerHTML=employees.filter(e=>e.status==='active').map(emp=>{
                let salesIncentive=0;
                if(emp.incentiveType==='staff_sales'&&emp.matchName){
                    const sales=staffSales[emp.matchName];
                    if(sales)salesIncentive=Math.round(sales.amount*0.01);
                }
                const itemIncentive=0;const total=salesIncentive+itemIncentive;
                return `<tr><td><strong>${emp.name}</strong></td><td>${roleLabels[emp.role]||emp.role}</td><td class="text-right">${formatCurrency(salesIncentive)}</td><td class="text-right">${formatCurrency(itemIncentive)}</td><td class="text-right"><strong>${formatCurrency(total)}</strong></td></tr>`;
            }).join('')||'<tr><td colspan="5" class="text-center">ì§ì› ì—†ìŒ</td></tr>';
        }

        function renderSalary(){
            const ym=getYM();const detail=salesDetail[ym]||{};const staffSales=detail.staffSales||{};
            document.getElementById('salaryTable').innerHTML=employees.filter(e=>e.status==='active').map(emp=>{
                const baseSalary=(emp.hourly||12000)*209;
                const empAttendance=attendance.filter(a=>a.employeeId===emp.id);
                let otMinutes=0;
                empAttendance.forEach(a=>{if(a.checkOut){const [h,m]=a.checkOut.split(':').map(Number);if(h*60+m>18*60)otMinutes+=(h*60+m)-18*60;}});
                const empLunchOT=lunchOT.filter(ot=>ot.employeeId===emp.id);
                otMinutes+=empLunchOT.reduce((sum,ot)=>sum+(ot.minutes||0),0);
                const otPay=Math.round(otMinutes/60*(emp.hourly||12000)*1.5);
                let incentive=0;
                if(emp.incentiveType==='staff_sales'&&emp.matchName){const sales=staffSales[emp.matchName];if(sales)incentive=Math.round(sales.amount*0.01);}
                const grossPay=baseSalary+otPay+incentive;
                const deductions=Math.round(grossPay*0.09);
                const netPay=grossPay-deductions;
                return `<tr><td><strong>${emp.name}</strong></td><td>${emp.role}</td><td class="text-right">${formatCurrency(baseSalary)}</td><td class="text-right">${formatCurrency(otPay)}</td><td class="text-right">${formatCurrency(incentive)}</td><td class="text-right" style="color:var(--accent-red)">-${formatCurrency(deductions)}</td><td class="text-right"><strong>${formatCurrency(netPay)}</strong></td></tr>`;
            }).join('')||'<tr><td colspan="7" class="text-center">ì§ì› ì—†ìŒ</td></tr>';
        }

        // CRUD Operations - Expense
        function openExpenseModal(type,id=null){
            document.getElementById('expenseModalTitle').textContent=id?'ì§€ì¶œ ìˆ˜ì •':'ì§€ì¶œ ì¶”ê°€';
            document.getElementById('expenseEditId').value=id||'';document.getElementById('expenseType').value=type;
            document.getElementById('expenseName').value='';document.getElementById('expenseCategory').value='ê¸°íƒ€';
            document.getElementById('expenseAmount').value='';document.getElementById('expenseNote').value='';
            document.getElementById('expenseDate').value=new Date().toISOString().split('T')[0];
            document.getElementById('expenseDateGroup').style.display=type==='variable'?'block':'none';
            if(id){const list=type==='fixed'?fixedExpenses:variableExpenses;const item=list.find(e=>e.id===id);if(item){
                document.getElementById('expenseName').value=item.name||'';document.getElementById('expenseCategory').value=item.category||'ê¸°íƒ€';
                document.getElementById('expenseAmount').value=item.amount||'';document.getElementById('expenseNote').value=item.note||'';
                if(type==='variable'){document.getElementById('expenseDate').value=item.date||'';}
            }}
            openModal('expenseModal');
        }
        async function saveExpense(){
            const editId=document.getElementById('expenseEditId').value;
            const type=document.getElementById('expenseType').value;
            const name=document.getElementById('expenseName').value.trim();
            const category=document.getElementById('expenseCategory').value;
            const amount=parseInt(document.getElementById('expenseAmount').value)||0;
            const note=document.getElementById('expenseNote').value.trim();
            const date=document.getElementById('expenseDate').value;
            if(!name||!amount){alert('í•­ëª©ëª…ê³¼ ê¸ˆì•¡ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');return;}
            const collection=type==='fixed'?'fixedExpenses':'variableExpenses';
            const data={name,category,amount,note};
            if(type==='variable'){data.date=date;data.yearMonth=getYM();}
            try{
                if(editId){await db.collection(collection).doc(editId).update(data);}
                else{await db.collection(collection).add(data);}
                closeModal('expenseModal');await loadExpenses();renderExpenses();
            }catch(e){alert('ì €ì¥ ì‹¤íŒ¨: '+e.message);}
        }
        function editExpense(type,id){openExpenseModal(type,id);}
        async function deleteExpense(type,id){
            if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
            try{const collection=type==='fixed'?'fixedExpenses':'variableExpenses';await db.collection(collection).doc(id).delete();await loadExpenses();renderExpenses();}catch(e){alert('ì‚­ì œ ì‹¤íŒ¨: '+e.message);}
        }

        // CRUD Operations - Lunch OT
        function openOTModal(){
            document.getElementById('otDate').value=new Date().toISOString().split('T')[0];
            document.getElementById('otMinutes').value='30';document.getElementById('otReason').value='';
            openModal('otModal');
        }
        async function saveLunchOT(){
            const date=document.getElementById('otDate').value;
            const employeeId=document.getElementById('otEmployee').value;
            const minutes=parseInt(document.getElementById('otMinutes').value)||0;
            const reason=document.getElementById('otReason').value.trim();
            if(!date||!employeeId||!minutes){alert('ë‚ ì§œ, ì§ì›, ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}
            try{await db.collection('lunchOT').add({date,employeeId,minutes,reason,createdAt:firebase.firestore.FieldValue.serverTimestamp()});closeModal('otModal');await loadLunchOT();renderOvertime();}catch(e){alert('ì €ì¥ ì‹¤íŒ¨: '+e.message);}
        }
        async function deleteLunchOT(id){if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;try{await db.collection('lunchOT').doc(id).delete();await loadLunchOT();renderOvertime();}catch(e){alert('ì‚­ì œ ì‹¤íŒ¨: '+e.message);}}

        // CRUD Operations - Incentive Items
        function openIncentiveItemModal(id=null){
            document.getElementById('incentiveItemModalTitle').textContent=id?'ì¸ì„¼í‹°ë¸Œ í•­ëª© ìˆ˜ì •':'ì¸ì„¼í‹°ë¸Œ í•­ëª© ì¶”ê°€';
            document.getElementById('incItemEditId').value=id||'';
            document.getElementById('incItemName').value='';document.getElementById('incItemPrice').value='10000';
            document.getElementById('incItemRole').value='all';
            if(id){const item=incentiveItems.find(i=>i.id===id);if(item){
                document.getElementById('incItemName').value=item.name||'';
                document.getElementById('incItemPrice').value=item.price||10000;
                document.getElementById('incItemRole').value=item.role||'all';
            }}
            openModal('incentiveItemModal');
        }
        async function saveIncentiveItem(){
            const editId=document.getElementById('incItemEditId').value;
            const name=document.getElementById('incItemName').value.trim();
            const price=parseInt(document.getElementById('incItemPrice').value)||0;
            const role=document.getElementById('incItemRole').value;
            if(!name){alert('í•­ëª©ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}
            const data={name,price,role};
            try{
                if(editId){await db.collection('incentiveItems').doc(editId).update(data);}
                else{await db.collection('incentiveItems').add(data);}
                closeModal('incentiveItemModal');await loadIncentiveItems();renderIncentiveItems();
            }catch(e){alert('ì €ì¥ ì‹¤íŒ¨: '+e.message);}
        }
        function editIncentiveItem(id){openIncentiveItemModal(id);}
        async function deleteIncentiveItem(id){if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;try{await db.collection('incentiveItems').doc(id).delete();await loadIncentiveItems();renderIncentiveItems();}catch(e){alert('ì‚­ì œ ì‹¤íŒ¨: '+e.message);}}

        // File Upload
        const uploadZone=document.getElementById('uploadZone');
        uploadZone.addEventListener('click',()=>document.getElementById('fileInput').click());
        uploadZone.addEventListener('dragover',e=>{e.preventDefault();uploadZone.style.borderColor='var(--accent-gold)';});
        uploadZone.addEventListener('dragleave',()=>{uploadZone.style.borderColor='var(--border-color)';});
        uploadZone.addEventListener('drop',e=>{e.preventDefault();uploadZone.style.borderColor='var(--border-color)';if(e.dataTransfer.files[0])processFile(e.dataTransfer.files[0]);});
        function handleFileUpload(e){if(e.target.files[0])processFile(e.target.files[0]);}

        function processFile(file){
            const reader=new FileReader();
            reader.onload=async function(e){
                try{
                    const data=new Uint8Array(e.target.result);
                    const wb=XLSX.read(data,{type:'array'});
                    const sheet=wb.Sheets[wb.SheetNames[0]];
                    const json=XLSX.utils.sheet_to_json(sheet);
                    let totalRev=0,japanRev=0,japanCount=0,year='',month='';
                    const doctorSales={},staffSales={};
                    json.forEach(row=>{
                        const amount=parseInt(row['ê¸ˆì•¡'])||0;totalRev+=amount;
                        const doctor=row['ì§„ë£Œì˜ëª…'];if(doctor&&doctor!=='ë¹ ë¥¸ì˜ˆì•½'){if(!doctorSales[doctor])doctorSales[doctor]={count:0,amount:0};doctorSales[doctor].count++;doctorSales[doctor].amount+=amount;}
                        const staff=row['ë‹´ë‹¹ì§ì›'];if(staff){if(!staffSales[staff])staffSales[staff]={count:0,amount:0};staffSales[staff].count++;staffSales[staff].amount+=amount;}
                        const nationality=row['êµ­ì '];if(nationality&&nationality.includes('ì¼ë³¸')){japanRev+=amount;japanCount++;}
                        if(row['ì§„ë£Œì¼']&&!year){const d=String(row['ì§„ë£Œì¼']);if(d.length>=6){year=d.substring(0,4);month=d.substring(4,6);}}
                    });
                    const ym=year+'-'+month;
                    await db.collection('revenue').doc(ym).set({total:totalRev,japan:japanRev,japanVisitors:japanCount,transactions:json.length,uploadedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
                    await db.collection('salesDetail').doc(ym).set({doctorSales,staffSales,updatedAt:firebase.firestore.FieldValue.serverTimestamp()});
                    alert('ì—…ë¡œë“œ ì™„ë£Œ!\n\nì—°ì›”: '+ym+'\nê±´ìˆ˜: '+json.length+'ê±´\nì´ë§¤ì¶œ: '+formatCurrency(totalRev)+'\n\nì§„ë£Œì˜: '+Object.keys(doctorSales).join(', ')+'\në‹´ë‹¹ì§ì›: '+Object.keys(staffSales).join(', ')+'\n\nì¼ë³¸ì¸ë§¤ì¶œ: '+formatCurrency(japanRev)+' ('+japanCount+'ê±´)');
                    if(ym===getYM()){await loadRevenueData();await loadSalesDetailData();renderAll();}else{await loadRevenueData();renderUploadHistory();}
                }catch(err){alert('íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜: '+err.message);console.error(err);}
            };
            reader.readAsArrayBuffer(file);
        }

        // Export Salary
        function exportSalary(){
            const ym=getYM();const detail=salesDetail[ym]||{};const staffSales=detail.staffSales||{};
            const rows=[['ì§ì›','ì§ê¸‰','ê¸°ë³¸ê¸‰','OTìˆ˜ë‹¹','ì¸ì„¼í‹°ë¸Œ','ê³µì œ','ì‹¤ìˆ˜ë ¹ì•¡']];
            employees.filter(e=>e.status==='active').forEach(emp=>{
                const baseSalary=(emp.hourly||12000)*209;
                const empAttendance=attendance.filter(a=>a.employeeId===emp.id);
                let otMinutes=0;empAttendance.forEach(a=>{if(a.checkOut){const [h,m]=a.checkOut.split(':').map(Number);if(h*60+m>18*60)otMinutes+=(h*60+m)-18*60;}});
                const empLunchOT=lunchOT.filter(ot=>ot.employeeId===emp.id);
                otMinutes+=empLunchOT.reduce((sum,ot)=>sum+(ot.minutes||0),0);
                const otPay=Math.round(otMinutes/60*(emp.hourly||12000)*1.5);
                let incentive=0;if(emp.incentiveType==='staff_sales'&&emp.matchName){const sales=staffSales[emp.matchName];if(sales)incentive=Math.round(sales.amount*0.01);}
                const grossPay=baseSalary+otPay+incentive;const deductions=Math.round(grossPay*0.09);const netPay=grossPay-deductions;
                rows.push([emp.name,emp.role,baseSalary,otPay,incentive,deductions,netPay]);
            });
            const ws=XLSX.utils.aoa_to_sheet(rows);const wb=XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb,ws,'ê¸‰ì—¬ëª…ì„¸');
            XLSX.writeFile(wb,'ê¸‰ì—¬ëª…ì„¸_'+ym+'.xlsx');
        }

        // Initialize
        function initApp(){initMonthSelector();loadAllData();}
        checkAuth();
    </script>
</body>
</html>
