<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë£¨ë¯¸í´ë¦¬ë‹‰ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ v4</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--bg-primary:#0a0f1c;--bg-secondary:#111827;--bg-card:#1a2235;--accent-blue:#3b82f6;--accent-green:#10b981;--accent-red:#ef4444;--accent-orange:#f97316;--accent-purple:#8b5cf6;--accent-pink:#ec4899;--accent-cyan:#06b6d4;--accent-yellow:#fbbf24;--text-primary:#f8fafc;--text-secondary:#94a3b8;--text-muted:#64748b;--border-color:#2d3748;--gradient-1:linear-gradient(135deg,#3b82f6,#8b5cf6)}
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Noto Sans KR',sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh}
        .header{background:rgba(10,15,28,.95);backdrop-filter:blur(20px);border-bottom:1px solid var(--border-color);padding:1rem 2rem;position:sticky;top:0;z-index:100}
        .header-content{display:flex;justify-content:space-between;align-items:center;max-width:1800px;margin:0 auto}
        .logo{display:flex;align-items:center;gap:12px}.logo-icon{width:42px;height:42px;background:var(--gradient-1);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px}
        .logo-text{font-size:1.4rem;font-weight:700;background:var(--gradient-1);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .logo-sub{font-size:.75rem;color:var(--text-muted)}
        .main-nav{display:flex;gap:.5rem;background:var(--bg-secondary);padding:.75rem 2rem;border-bottom:1px solid var(--border-color)}
        .nav-item{padding:.75rem 1.5rem;background:transparent;border:none;color:var(--text-secondary);cursor:pointer;font-size:.9rem;font-weight:500;border-radius:8px;transition:all .2s}
        .nav-item:hover{background:var(--bg-card);color:var(--text-primary)}.nav-item.active{background:var(--accent-blue);color:white}
        .sub-nav{display:flex;gap:.5rem;padding:.75rem 2rem;background:var(--bg-primary);border-bottom:1px solid var(--border-color);flex-wrap:wrap}
        .sub-nav-item{padding:.5rem 1rem;background:transparent;border:1px solid var(--border-color);border-radius:8px;color:var(--text-secondary);cursor:pointer;font-size:.85rem;transition:all .2s}
        .sub-nav-item:hover{border-color:var(--accent-blue);color:var(--text-primary)}.sub-nav-item.active{background:rgba(59,130,246,.2);border-color:var(--accent-blue);color:var(--accent-blue)}
        .main{padding:2rem;max-width:1800px;margin:0 auto}.section{display:none}.section.active{display:block}
        .card{background:var(--bg-card);border-radius:16px;padding:1.5rem;border:1px solid var(--border-color);margin-bottom:1.5rem}
        .card-title{font-size:1rem;font-weight:600;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1.5rem}
        .stat-card{background:var(--bg-card);border-radius:16px;padding:1.5rem;border:1px solid var(--border-color);position:relative;overflow:hidden}
        .stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--gradient-1)}
        .stat-card.green::before{background:linear-gradient(135deg,#10b981,#06b6d4)}.stat-card.orange::before{background:linear-gradient(135deg,#f97316,#fbbf24)}.stat-card.purple::before{background:linear-gradient(135deg,#8b5cf6,#ec4899)}.stat-card.cyan::before{background:linear-gradient(135deg,#06b6d4,#3b82f6)}
        .stat-label{color:var(--text-secondary);font-size:.85rem;margin-bottom:.5rem}.stat-value{font-size:1.5rem;font-weight:700}
        .table-wrapper{overflow-x:auto}table{width:100%;border-collapse:collapse}
        th,td{padding:.75rem;text-align:left;border-bottom:1px solid var(--border-color)}th{color:var(--text-secondary);font-weight:500;font-size:.8rem}td{font-size:.85rem}tr:hover{background:rgba(255,255,255,.02)}
        .btn{padding:.5rem 1rem;border-radius:8px;border:none;cursor:pointer;font-size:.85rem;font-weight:500;transition:all .2s}
        .btn-primary{background:var(--accent-blue);color:white}.btn-success{background:var(--accent-green);color:white}.btn-danger{background:var(--accent-red);color:white}
        .btn-secondary{background:var(--bg-card);color:var(--text-primary);border:1px solid var(--border-color)}.btn-warning{background:var(--accent-orange);color:white}
        .btn-sm{padding:.4rem .8rem;font-size:.75rem}.btn-group{display:flex;gap:.5rem}
        .form-group{margin-bottom:1rem}.form-label{display:block;margin-bottom:.5rem;color:var(--text-secondary);font-size:.85rem}
        .form-input,.form-select{width:100%;padding:.75rem;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-size:.9rem}
        .form-input:focus,.form-select:focus{outline:none;border-color:var(--accent-blue)}
        .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem}
        .modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:1000;align-items:center;justify-content:center}
        .modal-overlay.active{display:flex}.modal{background:var(--bg-card);border-radius:16px;padding:2rem;width:90%;max-width:700px;max-height:90vh;overflow-y:auto;border:1px solid var(--border-color)}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}
        .modal-title{font-size:1.25rem;font-weight:600}.modal-close{background:none;border:none;color:var(--text-secondary);font-size:1.5rem;cursor:pointer}
        .badge{display:inline-flex;padding:.25rem .75rem;border-radius:20px;font-size:.75rem;font-weight:500}
        .badge-success{background:rgba(16,185,129,.2);color:var(--accent-green)}.badge-danger{background:rgba(239,68,68,.2);color:var(--accent-red)}
        .badge-warning{background:rgba(249,115,22,.2);color:var(--accent-orange)}.badge-info{background:rgba(59,130,246,.2);color:var(--accent-blue)}
        .badge-purple{background:rgba(139,92,246,.2);color:var(--accent-purple)}.badge-cyan{background:rgba(6,182,212,.2);color:var(--accent-cyan)}
        .chart-container{height:300px;position:relative}.charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:1.5rem}
        .summary-row{display:flex;justify-content:space-between;padding:1rem;background:var(--bg-secondary);border-radius:8px;margin-top:1rem;font-weight:600}
        .birthday-alert{background:linear-gradient(135deg,#ec4899,#f97316);color:white;padding:.75rem 1.5rem;text-align:center;font-weight:500}
        .text-success{color:var(--accent-green)}.text-danger{color:var(--accent-red)}.text-warning{color:var(--accent-orange)}.text-purple{color:var(--accent-purple)}.text-muted{color:var(--text-muted)}.text-right{text-align:right}
        .mb-2{margin-bottom:1rem}.mt-2{margin-top:1rem}.flex{display:flex}.justify-between{justify-content:space-between}.items-center{align-items:center}.gap-1{gap:.5rem}
        .memo-input{background:transparent;border:1px dashed var(--border-color);padding:.25rem .5rem;border-radius:4px;color:var(--text-secondary);font-size:.8rem;width:100%}
        .upload-zone{border:2px dashed var(--border-color);border-radius:16px;padding:3rem;text-align:center;cursor:pointer;transition:all .3s;margin-bottom:1.5rem}
        .upload-zone:hover,.upload-zone.dragover{border-color:var(--accent-blue);background:rgba(59,130,246,.05)}
        .upload-icon{font-size:3rem;margin-bottom:1rem}.upload-title{font-size:1.1rem;font-weight:500;margin-bottom:.5rem}.upload-desc{color:var(--text-muted);font-size:.85rem}
        .emp-chip{display:inline-flex;align-items:center;gap:.25rem;padding:.25rem .5rem;background:var(--bg-secondary);border-radius:20px;font-size:.75rem;margin:.125rem}
        .emp-chip .remove{cursor:pointer;color:var(--accent-red)}
        .incentive-item{background:var(--bg-secondary);border-radius:12px;padding:1rem;margin-bottom:.75rem;border:1px solid var(--border-color)}
        .incentive-item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}
        .incentive-item-name{font-weight:600;font-size:.95rem}
        .incentive-item-type{font-size:.8rem;color:var(--text-muted)}
        .incentive-item-employees{margin-top:.5rem}
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo"><div class="logo-icon">ğŸ’</div><div><div class="logo-text">LUMI CLINIC</div><div class="logo-sub">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ v4.0</div></div></div>
            <div style="display:flex;align-items:center;gap:1rem">
                <select class="form-select" id="selectedYear" onchange="loadAllData()" style="width:auto"><option value="2026">2026ë…„</option><option value="2025" selected>2025ë…„</option><option value="2024">2024ë…„</option></select>
                <select class="form-select" id="selectedMonth" onchange="loadAllData()" style="width:auto">
                    <option value="01">1ì›”</option><option value="02">2ì›”</option><option value="03">3ì›”</option><option value="04">4ì›”</option><option value="05">5ì›”</option><option value="06">6ì›”</option>
                    <option value="07">7ì›”</option><option value="08">8ì›”</option><option value="09">9ì›”</option><option value="10">10ì›”</option><option value="11">11ì›”</option><option value="12" selected>12ì›”</option>
                </select>
            </div>
        </div>
    </header>
    <nav class="main-nav">
        <button class="nav-item active" data-nav="sales">ğŸ“Š ë§¤ì¶œ</button>
        <button class="nav-item" data-nav="expense">ğŸ’¸ ì§€ì¶œ</button>
        <button class="nav-item" data-nav="staff">ğŸ‘¥ ì§ì›ê´€ë¦¬</button>
    </nav>
    <div class="birthday-alert" id="birthdayAlert" style="display:none">ğŸ‚ <span id="birthdayNames"></span>ë‹˜, ìƒì¼ ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰</div>
    <main class="main">
        <!-- ë§¤ì¶œ ì„¹ì…˜ -->
        <div class="section active" id="sales-section">
            <div class="sub-nav">
                <button class="sub-nav-item active" data-sub="sales-overview">ğŸ“ˆ ë§¤ì¶œ í˜„í™©</button>
                <button class="sub-nav-item" data-sub="sales-japan">ğŸ‡¯ğŸ‡µ ì¼ë³¸ì¸ ë§¤ì¶œ</button>
                <button class="sub-nav-item" data-sub="sales-data">ğŸ“ ë°ì´í„° ê´€ë¦¬</button>
            </div>
            <div class="section active" id="sales-overview">
                <div class="stats-grid" style="margin-top:1.5rem">
                    <div class="stat-card"><div class="stat-label">ì´ë²ˆë‹¬ ì´ë§¤ì¶œ</div><div class="stat-value" style="color:var(--accent-blue)" id="monthlyTotal">â‚©0</div></div>
                    <div class="stat-card green"><div class="stat-label">ì „ë…„ ë™ì›” ëŒ€ë¹„</div><div class="stat-value" style="color:var(--accent-green)" id="monthlyGrowth">+â‚©0</div></div>
                    <div class="stat-card orange"><div class="stat-label">ê±°ë˜ ê±´ìˆ˜</div><div class="stat-value" style="color:var(--accent-orange)" id="monthlyTrans">0ê±´</div></div>
                    <div class="stat-card purple"><div class="stat-label">í‰ê·  ê°ë‹¨ê°€</div><div class="stat-value" style="color:var(--accent-purple)" id="monthlyAvg">â‚©0</div></div>
                </div>
                <div class="charts-grid">
                    <div class="card"><div class="card-title">ğŸ“ˆ ì›”ë³„ ë§¤ì¶œ ì¶”ì´</div><div class="chart-container"><canvas id="monthlyChart"></canvas></div></div>
                    <div class="card"><div class="card-title">ğŸ“Š ì—°ë„ë³„ ë¹„êµ</div><div class="chart-container"><canvas id="yearCompareChart"></canvas></div></div>
                </div>
            </div>
            <!-- ì¼ë³¸ì¸ ë§¤ì¶œ íƒ­ -->
            <div class="section" id="sales-japan">
                <div class="stats-grid" style="margin-top:1.5rem">
                    <div class="stat-card purple"><div class="stat-label">ì¼ë³¸ì¸ ë§¤ì¶œ</div><div class="stat-value" style="color:var(--accent-purple)" id="japanRevenue">â‚©0</div></div>
                    <div class="stat-card cyan"><div class="stat-label">ì¼ë³¸ì¸ ë‚´ì›ìˆ˜</div><div class="stat-value" style="color:var(--accent-cyan)" id="japanVisitors">0ëª…</div></div>
                    <div class="stat-card orange"><div class="stat-label">ì¼ë³¸ì¸ ê°ë‹¨ê°€</div><div class="stat-value" style="color:var(--accent-orange)" id="japanAvg">â‚©0</div></div>
                    <div class="stat-card"><div class="stat-label">ì „ì²´ ë§¤ì¶œ ë¹„ì¤‘</div><div class="stat-value" style="color:var(--accent-blue)" id="japanRatio">0%</div></div>
                </div>
                <div class="card"><div class="card-title">ğŸ“‹ ì¼ë³¸ì¸ ê´€ë ¨ ì¸ì„¼í‹°ë¸Œ ëŒ€ìƒì</div>
                    <div class="table-wrapper"><table>
                        <thead><tr><th>ì§ì›</th><th>ì¸ì„¼í‹°ë¸Œ í•­ëª©</th><th>ì´ë²ˆë‹¬ ì¸ì„¼í‹°ë¸Œ</th></tr></thead>
                        <tbody id="japanIncentiveTable"><tr><td colspan="3" style="text-align:center;padding:2rem;color:var(--text-muted)">ëŒ€ìƒìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr></tbody>
                    </table></div>
                </div>
            </div>
            <div class="section" id="sales-data">
                <div class="upload-zone" id="uploadZone" style="margin-top:1.5rem">
                    <div class="upload-icon">ğŸ“</div>
                    <div class="upload-title">ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</div>
                    <div class="upload-desc">ì§€ì› í˜•ì‹: .xlsx, .xls, .csv | ì˜¤ë”íŒë§¤ë‚´ì—­ íŒŒì¼</div>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleFileUpload(event)">
                </div>
                <div class="card"><div class="card-title">ğŸ“ ì›”ë³„ ë§¤ì¶œ ìˆ˜ë™ ì…ë ¥</div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">ì´ ë§¤ì¶œ</label><input type="text" class="form-input" id="inputTotalRevenue" placeholder="200,000,000"></div>
                        <div class="form-group"><label class="form-label">ì¼ë³¸ì¸ ë§¤ì¶œ</label><input type="text" class="form-input" id="inputJapanRevenue" placeholder="20,000,000"></div>
                        <div class="form-group"><label class="form-label">ì¼ë³¸ì¸ ë‚´ì›ìˆ˜</label><input type="number" class="form-input" id="inputJapanVisitors" placeholder="25"></div>
                        <div class="form-group"><label class="form-label">ê±°ë˜ ê±´ìˆ˜</label><input type="number" class="form-input" id="inputTransactions" placeholder="3000"></div>
                    </div>
                    <button class="btn btn-primary" onclick="saveRevenueData()">ì €ì¥</button>
                </div>
            </div>
        </div>

        <!-- ì§€ì¶œ ì„¹ì…˜ -->
        <div class="section" id="expense-section">
            <div class="sub-nav">
                <button class="sub-nav-item active" data-sub="expense-fixed">ğŸ¢ ê³ ì •ë¹„</button>
                <button class="sub-nav-item" data-sub="expense-variable">ğŸ“¦ ìœ ë™ë¹„</button>
            </div>
            <div class="section active" id="expense-fixed">
                <div class="card" style="margin-top:1.5rem">
                    <div class="flex justify-between items-center mb-2"><div class="card-title">ğŸ¢ ê³ ì •ë¹„ ê´€ë¦¬</div><button class="btn btn-primary btn-sm" onclick="openExpenseModal('fixed')">+ ì¶”ê°€</button></div>
                    <div class="table-wrapper"><table><thead><tr><th>í•­ëª©</th><th>ê¸ˆì•¡</th><th>ì£¼ê¸°</th><th>ë©”ëª¨</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="fixedExpenseTable"><tr><td colspan="5" style="text-align:center;padding:2rem;color:var(--text-muted)">ê³ ì •ë¹„ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr></tbody>
                    </table></div>
                    <div class="summary-row"><span>ì›” ê³ ì •ë¹„ í•©ê³„</span><span style="color:var(--accent-red)" id="fixedExpenseTotal">â‚©0</span></div>
                </div>
            </div>
            <div class="section" id="expense-variable">
                <div class="card" style="margin-top:1.5rem">
                    <div class="flex justify-between items-center mb-2"><div class="card-title">ğŸ“¦ ìœ ë™ë¹„ ê´€ë¦¬</div><button class="btn btn-primary btn-sm" onclick="openExpenseModal('variable')">+ ì¶”ê°€</button></div>
                    <div class="table-wrapper"><table><thead><tr><th>ë‚ ì§œ</th><th>í•­ëª©</th><th>ì¹´í…Œê³ ë¦¬</th><th>ê¸ˆì•¡</th><th>ë©”ëª¨</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="variableExpenseTable"><tr><td colspan="6" style="text-align:center;padding:2rem;color:var(--text-muted)">ìœ ë™ë¹„ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr></tbody>
                    </table></div>
                    <div class="summary-row"><span>ì´ë²ˆë‹¬ ìœ ë™ë¹„ í•©ê³„</span><span style="color:var(--accent-orange)" id="variableExpenseTotal">â‚©0</span></div>
                </div>
            </div>
        </div>
        <!-- ì§ì›ê´€ë¦¬ ì„¹ì…˜ -->
        <div class="section" id="staff-section">
            <div class="sub-nav">
                <button class="sub-nav-item active" data-sub="staff-list">ğŸ‘¥ ì§ì›ê´€ë¦¬</button>
                <button class="sub-nav-item" data-sub="staff-leave">ğŸ–ï¸ íœ´ê°€ê´€ë¦¬</button>
                <button class="sub-nav-item" data-sub="staff-attendance">ğŸ“… ê·¼íƒœí˜„í™©</button>
                <button class="sub-nav-item" data-sub="staff-overtime">â° ì˜¤ë²„íƒ€ì„</button>
                <button class="sub-nav-item" data-sub="staff-incentive">ğŸ¯ ì¸ì„¼í‹°ë¸Œ</button>
                <button class="sub-nav-item" data-sub="staff-salary">ğŸ’° ê¸‰ì—¬</button>
            </div>

            <!-- ì§ì›ê´€ë¦¬ -->
            <div class="section active" id="staff-list">
                <div class="flex justify-between items-center mb-2" style="margin-top:1.5rem"><h2>ğŸ‘¥ ì§ì› ê´€ë¦¬</h2><button class="btn btn-primary" onclick="openEmployeeModal()">+ ì§ì› ì¶”ê°€</button></div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-label">ì „ì²´ ì§ì›</div><div class="stat-value" style="color:var(--accent-blue)" id="totalEmployees">-</div></div>
                    <div class="stat-card green"><div class="stat-label">ì¬ì§ì¤‘</div><div class="stat-value" style="color:var(--accent-green)" id="activeEmployees">-</div></div>
                    <div class="stat-card orange"><div class="stat-label">í‡´ì‚¬</div><div class="stat-value" style="color:var(--accent-red)" id="inactiveEmployees">-</div></div>
                    <div class="stat-card purple"><div class="stat-label">ì´ë²ˆë‹¬ ìƒì¼</div><div class="stat-value" style="color:var(--accent-pink)" id="birthdayCount">-</div></div>
                </div>
                <div class="card"><div class="table-wrapper"><table>
                    <thead><tr><th>ì‚¬ë²ˆ</th><th>ì´ë¦„</th><th>ë‚˜ì´</th><th>ì§ê¸‰</th><th>ì…ì‚¬ì¼</th><th>ê·¼ì†</th><th>ìƒíƒœ</th><th>ë¹„ë°€ë²ˆí˜¸</th><th>ê´€ë¦¬</th></tr></thead>
                    <tbody id="employeeTableBody"><tr><td colspan="9" style="text-align:center;padding:2rem;color:var(--text-muted)">ë¡œë”©ì¤‘...</td></tr></tbody>
                </table></div></div>
            </div>

            <!-- íœ´ê°€ê´€ë¦¬ -->
            <div class="section" id="staff-leave">
                <h2 class="mb-2" style="margin-top:1.5rem">ğŸ–ï¸ íœ´ê°€ ê´€ë¦¬</h2>
                <div class="stats-grid">
                    <div class="stat-card orange"><div class="stat-label">ìŠ¹ì¸ ëŒ€ê¸°</div><div class="stat-value" style="color:var(--accent-orange)" id="pendingLeaves">-</div></div>
                    <div class="stat-card green"><div class="stat-label">ì´ë²ˆë‹¬ ìŠ¹ì¸</div><div class="stat-value" style="color:var(--accent-green)" id="approvedLeaves">-</div></div>
                </div>
                <div class="card"><div class="table-wrapper"><table>
                    <thead><tr><th>ì‹ ì²­ì¼</th><th>ì§ì›</th><th>ìœ í˜•</th><th>ê¸°ê°„</th><th>ì‚¬ìœ </th><th>ìƒíƒœ</th><th>ì²˜ë¦¬</th></tr></thead>
                    <tbody id="leaveTableBody"><tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-muted)">íœ´ê°€ ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr></tbody>
                </table></div></div>
            </div>

            <!-- ê·¼íƒœí˜„í™© -->
            <div class="section" id="staff-attendance">
                <h2 class="mb-2" style="margin-top:1.5rem">ğŸ“… ê·¼íƒœ í˜„í™©</h2>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-label">ì´ë²ˆë‹¬ ê·¼ë¬´ì¼</div><div class="stat-value" style="color:var(--accent-blue)" id="workDays">-</div></div>
                    <div class="stat-card green"><div class="stat-label">ê¸ˆì¼ ì¶œê·¼</div><div class="stat-value" style="color:var(--accent-green)" id="todayPresent">-</div></div>
                </div>
                <div class="card"><div class="table-wrapper"><table>
                    <thead><tr><th>ì§ì›</th><th>ì‚¬ë²ˆ</th><th>ê¸ˆì¼ ì¶œê·¼</th><th>ê¸ˆì¼ í‡´ê·¼</th><th>ì¶œê·¼ì¼ìˆ˜</th><th>ì§€ê°</th><th>ì´ OT</th></tr></thead>
                    <tbody id="attendanceTableBody"><tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-muted)">ë¡œë”©ì¤‘...</td></tr></tbody>
                </table></div></div>
            </div>

            <!-- ì˜¤ë²„íƒ€ì„ -->
            <div class="section" id="staff-overtime">
                <h2 class="mb-2" style="margin-top:1.5rem">â° ì˜¤ë²„íƒ€ì„ í˜„í™©</h2>
                <div class="stats-grid">
                    <div class="stat-card orange"><div class="stat-label">ì´ë²ˆë‹¬ ì´ OT</div><div class="stat-value" style="color:var(--accent-orange)" id="totalOT">-</div></div>
                    <div class="stat-card green"><div class="stat-label">ì´ OT ë¹„ìš© (ì„¸í›„)</div><div class="stat-value" style="color:var(--accent-green)" id="totalOTNet">-</div></div>
                </div>
                <div class="card"><div class="table-wrapper"><table>
                    <thead><tr><th>ì§ì›</th><th>ì‹œê¸‰</th><th>í‡´ê·¼í›„ OT</th><th>ì ì‹¬ OT</th><th>ì´ OT</th><th>ì„¸í›„</th></tr></thead>
                    <tbody id="overtimeTableBody"><tr><td colspan="6" style="text-align:center;padding:2rem;color:var(--text-muted)">ë¡œë”©ì¤‘...</td></tr></tbody>
                </table></div>
                <div class="summary-row"><span>í•©ê³„</span><span><span id="sumOTHours">0H</span> | ì„¸í›„ <span style="color:var(--accent-green)" id="sumOTNet">â‚©0</span></span></div>
                </div>
            </div>

            <!-- ì¸ì„¼í‹°ë¸Œ (ì™„ì „ ê°œí¸) -->
            <div class="section" id="staff-incentive">
                <h2 class="mb-2" style="margin-top:1.5rem">ğŸ¯ ì¸ì„¼í‹°ë¸Œ ê´€ë¦¬</h2>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-label">ì¸ì„¼í‹°ë¸Œ í•­ëª© ìˆ˜</div><div class="stat-value" style="color:var(--accent-blue)" id="incentiveItemCount">0ê°œ</div></div>
                    <div class="stat-card green"><div class="stat-label">ì´ë²ˆë‹¬ ì´ ì¸ì„¼í‹°ë¸Œ</div><div class="stat-value" style="color:var(--accent-green)" id="totalIncentiveSum">â‚©0</div></div>
                </div>
                
                <!-- ì¸ì„¼í‹°ë¸Œ í•­ëª© ê´€ë¦¬ -->
                <div class="card">
                    <div class="flex justify-between items-center mb-2"><div class="card-title">âš™ï¸ ì¸ì„¼í‹°ë¸Œ í•­ëª© ì„¤ì •</div><button class="btn btn-primary btn-sm" onclick="openIncentiveItemModal()">+ í•­ëª© ì¶”ê°€</button></div>
                    <div id="incentiveItemsList"></div>
                </div>

                <!-- ì§ì›ë³„ ì¸ì„¼í‹°ë¸Œ í˜„í™© -->
                <div class="card"><div class="card-title">ğŸ“Š ì§ì›ë³„ ì¸ì„¼í‹°ë¸Œ í˜„í™©</div>
                    <div class="table-wrapper"><table>
                        <thead><tr><th>ì§ì›</th><th>ì ìš© í•­ëª©</th><th>ì‹¤ì </th><th>ì´ë²ˆë‹¬ ì¸ì„¼í‹°ë¸Œ</th></tr></thead>
                        <tbody id="incentiveTableBody"><tr><td colspan="4" style="text-align:center;padding:2rem;color:var(--text-muted)">ë¡œë”©ì¤‘...</td></tr></tbody>
                    </table></div>
                </div>
            </div>

            <!-- ê¸‰ì—¬ -->
            <div class="section" id="staff-salary">
                <h2 class="mb-2" style="margin-top:1.5rem">ğŸ’° ê¸‰ì—¬ í˜„í™©</h2>
                <div class="card"><div class="table-wrapper"><table>
                    <thead><tr><th>ì§ì›</th><th>ê¸°ë³¸ê¸‰</th><th>ê³ ì •OT</th><th>ì¶”ê°€OT</th><th>ì¸ì„¼í‹°ë¸Œ</th><th>ì´ ê¸‰ì—¬</th><th style="width:150px">ë©”ëª¨</th></tr></thead>
                    <tbody id="salaryTableBody"><tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-muted)">ë¡œë”©ì¤‘...</td></tr></tbody>
                </table></div>
                <div class="summary-row"><span>ì´ ê¸‰ì—¬ í•©ê³„</span><span style="color:var(--accent-green);font-size:1.2rem" id="totalSalarySum">â‚©0</span></div>
                </div>
            </div>
        </div>
    </main>

    <!-- ì§ì› ëª¨ë‹¬ -->
    <div class="modal-overlay" id="employeeModal">
        <div class="modal">
            <div class="modal-header"><div class="modal-title" id="employeeModalTitle">ì§ì› ì¶”ê°€</div><button class="modal-close" onclick="closeEmployeeModal()">&times;</button></div>
            <form id="employeeForm">
                <input type="hidden" id="empEditId">
                <div class="form-row">
                    <div class="form-group"><label class="form-label">ì´ë¦„ *</label><input type="text" class="form-input" id="empName" required></div>
                    <div class="form-group"><label class="form-label">ì‚¬ë²ˆ * (ì†Œë¬¸ì)</label><input type="text" class="form-input" id="empId" placeholder="ì˜ˆ: 20kok" required style="text-transform:lowercase"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">ìƒë…„ì›”ì¼</label><input type="date" class="form-input" id="empBirthDate"></div>
                    <div class="form-group"><label class="form-label">ì§ê¸‰ *</label>
                        <select class="form-select" id="empRole" required><option value="">ì„ íƒ</option><option value="ì‹¤ì¥">ì‹¤ì¥</option><option value="í”¼ë¶€ê´€ë¦¬ì‚¬">í”¼ë¶€ê´€ë¦¬ì‚¬</option><option value="ê°„í˜¸ì‚¬">ê°„í˜¸ì‚¬</option><option value="ê°„í˜¸ì¡°ë¬´ì‚¬">ê°„í˜¸ì¡°ë¬´ì‚¬</option><option value="ì½”ë””">ì½”ë””</option><option value="ë§ˆì¼€íŒ…">ë§ˆì¼€íŒ…</option></select>
                    </div>
                    <div class="form-group"><label class="form-label">ì…ì‚¬ì¼ *</label><input type="date" class="form-input" id="empJoinDate" required></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">ê¸°ë³¸ê¸‰ *</label><input type="number" class="form-input" id="empBaseSalary" required></div>
                    <div class="form-group"><label class="form-label">ê³ ì •OTìˆ˜ë‹¹</label><input type="number" class="form-input" id="empFixedOT"></div>
                    <div class="form-group"><label class="form-label">ì‹œê¸‰</label><input type="number" class="form-input" id="empHourlyWage"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">ì¬ì§ ìƒíƒœ</label>
                        <select class="form-select" id="empIsActive"><option value="true">ì¬ì§ì¤‘</option><option value="false">í‡´ì‚¬</option></select>
                    </div>
                </div>
                <div class="flex justify-between mt-2"><button type="button" class="btn btn-secondary" onclick="closeEmployeeModal()">ì·¨ì†Œ</button><button type="submit" class="btn btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- ì¸ì„¼í‹°ë¸Œ í•­ëª© ëª¨ë‹¬ -->
    <div class="modal-overlay" id="incentiveItemModal">
        <div class="modal">
            <div class="modal-header"><div class="modal-title" id="incentiveItemModalTitle">ì¸ì„¼í‹°ë¸Œ í•­ëª© ì¶”ê°€</div><button class="modal-close" onclick="closeIncentiveItemModal()">&times;</button></div>
            <form id="incentiveItemForm">
                <input type="hidden" id="incItemEditId">
                <div class="form-row">
                    <div class="form-group"><label class="form-label">í•­ëª©ëª… *</label><input type="text" class="form-input" id="incItemName" placeholder="ì˜ˆ: í•˜ì´ë“œë¼ í˜ì´ì…œ" required></div>
                    <div class="form-group"><label class="form-label">ìœ í˜• *</label>
                        <select class="form-select" id="incItemType" required onchange="toggleIncTypeFields()">
                            <option value="per_case">ê±´ë‹¹ (â‚©/ê±´)</option>
                            <option value="revenue_percent">ë§¤ì¶œ ë¹„ìœ¨ (%)</option>
                            <option value="growth_percent">ì„±ì¥ë¶„ ë¹„ìœ¨ (%)</option>
                            <option value="japan_visit">ì¼ë³¸ì¸ ë°©ë¬¸ (â‚©/ëª…)</option>
                            <option value="japan_revenue">ì¼ë³¸ì¸ ë§¤ì¶œ (%)</option>
                        </select>
                    </div>
                </div>
                <div class="form-row" id="incPerCaseFields">
                    <div class="form-group"><label class="form-label">ê±´ë‹¹ ê¸ˆì•¡ (ì›)</label><input type="number" class="form-input" id="incPerCaseAmount" placeholder="10000"></div>
                </div>
                <div class="form-row" id="incPercentFields" style="display:none">
                    <div class="form-group"><label class="form-label">ë¹„ìœ¨ (%)</label><input type="number" class="form-input" id="incPercent" placeholder="1" step="0.1"></div>
                    <div class="form-group"><label class="form-label">ìƒí•œ (ì›, ì„ íƒ)</label><input type="number" class="form-input" id="incCap" placeholder="200000"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">ì ìš© ì§ì› ì„ íƒ</label>
                    <div id="incEmployeeCheckboxes" style="display:flex;flex-wrap:wrap;gap:.5rem;background:var(--bg-secondary);padding:1rem;border-radius:8px;max-height:200px;overflow-y:auto"></div>
                </div>
                <div class="flex justify-between mt-2"><button type="button" class="btn btn-secondary" onclick="closeIncentiveItemModal()">ì·¨ì†Œ</button><button type="submit" class="btn btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- ì§€ì¶œ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="expenseModal">
        <div class="modal">
            <div class="modal-header"><div class="modal-title" id="expenseModalTitle">ì§€ì¶œ ì¶”ê°€</div><button class="modal-close" onclick="closeExpenseModal()">&times;</button></div>
            <form id="expenseForm">
                <input type="hidden" id="expType">
                <div class="form-row">
                    <div class="form-group"><label class="form-label">í•­ëª©ëª… *</label><input type="text" class="form-input" id="expName" required></div>
                    <div class="form-group"><label class="form-label">ê¸ˆì•¡ *</label><input type="number" class="form-input" id="expAmount" required></div>
                </div>
                <div class="form-row" id="expFixedFields"><div class="form-group"><label class="form-label">ì£¼ê¸°</label><select class="form-select" id="expCycle"><option value="monthly">ì›”ê°„</option><option value="yearly">ì—°ê°„</option></select></div></div>
                <div class="form-row" id="expVariableFields" style="display:none">
                    <div class="form-group"><label class="form-label">ë‚ ì§œ</label><input type="date" class="form-input" id="expDate"></div>
                    <div class="form-group"><label class="form-label">ì¹´í…Œê³ ë¦¬</label><select class="form-select" id="expCategory"><option value="ì¬ë£Œë¹„">ì¬ë£Œë¹„</option><option value="ì†Œëª¨í’ˆ">ì†Œëª¨í’ˆ</option><option value="ë§ˆì¼€íŒ…">ë§ˆì¼€íŒ…</option><option value="ê¸°íƒ€">ê¸°íƒ€</option></select></div>
                </div>
                <div class="form-group"><label class="form-label">ë©”ëª¨</label><input type="text" class="form-input" id="expMemo"></div>
                <div class="flex justify-between mt-2"><button type="button" class="btn btn-secondary" onclick="closeExpenseModal()">ì·¨ì†Œ</button><button type="submit" class="btn btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>
    <script>
        // Firebase
        const firebaseConfig={apiKey:"AIzaSyDnkKNXNnDVlcPd5Y1fl59YysdeEZi7uJU",authDomain:"lumiclinic-c1a95.firebaseapp.com",projectId:"lumiclinic-c1a95",storageBucket:"lumiclinic-c1a95.firebasestorage.app",messagingSenderId:"901456209944",appId:"1:901456209944:web:f287418cd0541f324d3b6d"};
        firebase.initializeApp(firebaseConfig);const db=firebase.firestore();

        let employees=[],attendanceData={},leaveRequests=[],revenueData={},salaryMemos={},lunchOTAllData={},fixedExpenses=[],variableExpenses=[];
        let incentiveItems=[],employeeIncentiveRecords={};
        const overtimeRules={1:'18:30',2:'18:30',3:'18:00',4:'18:00',5:'18:30',6:'15:00'};
        const DEFAULT_PW='final12890-';
        const monthlyData={labels:['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”'],
            data2024:[173111326,156060457,198554450,207124800,193543660,179806116,187612314,157672141,206156505,211217542,243773264,215202565],
            data2025:[243491066,257728622,198946613,209752982,194799262,183098254,169175502,168038894,192032741,185696152,194178322,202146630]};

        function getYM(){return document.getElementById('selectedYear').value+'-'+document.getElementById('selectedMonth').value;}

        // Navigation
        document.querySelectorAll('.nav-item').forEach(n=>n.addEventListener('click',()=>{
            document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
            document.querySelectorAll('.section[id$="-section"]').forEach(x=>x.classList.remove('active'));
            n.classList.add('active');document.getElementById(n.dataset.nav+'-section').classList.add('active');
        }));
        document.querySelectorAll('.sub-nav-item').forEach(s=>s.addEventListener('click',()=>{
            const parent=s.closest('.section');parent.querySelectorAll('.sub-nav-item').forEach(x=>x.classList.remove('active'));
            parent.querySelectorAll('.section').forEach(x=>x.classList.remove('active'));s.classList.add('active');document.getElementById(s.dataset.sub).classList.add('active');
        }));

        // Load All
        async function loadAllData(){
            await loadEmployees();await loadAttendance();await loadLeaveRequests();await loadRevenueData();
            await loadSalaryMemos();await loadLunchOTAll();await loadExpenses();await loadIncentiveItems();await loadEmployeeIncentiveRecords();
            checkBirthdays();renderAll();initCharts();
        }

        async function loadEmployees(){
            try{const snap=await db.collection('employees').get();employees=[];snap.forEach(d=>employees.push({id:d.id,...d.data()}));}
            catch(e){generateDemoEmployees();}
        }
        function generateDemoEmployees(){
            employees=[
                {id:'20kok',name:'ê¹€ì˜¥ê²½',birthDate:'1985-03-15',role:'ì‹¤ì¥',joinDate:'2020-03-01',baseSalary:3050590,fixedOT:760540,hourlyWage:15553,isActive:true},
                {id:'21yyn',name:'ì–‘ì˜ˆë‚˜',birthDate:'1992-01-17',role:'í”¼ë¶€ê´€ë¦¬ì‚¬',joinDate:'2021-05-15',baseSalary:2633103,fixedOT:733050,hourlyWage:13687,isActive:true},
                {id:'22ysy',name:'ìœ¤ì†Œì˜',birthDate:'1990-07-22',role:'í”¼ë¶€ê´€ë¦¬ì‚¬',joinDate:'2022-02-01',baseSalary:2393730,fixedOT:666975,hourlyWage:12442,isActive:true},
                {id:'22lsy',name:'ì´ì„œì˜',birthDate:'1994-11-08',role:'í”¼ë¶€ê´€ë¦¬ì‚¬',joinDate:'2022-08-01',baseSalary:2154357,fixedOT:600061,hourlyWage:11198,isActive:true},
                {id:'23jsr',name:'ì •ì†Œë¼',birthDate:'1996-05-30',role:'ê°„í˜¸ì¡°ë¬´ì‚¬',joinDate:'2023-03-01',baseSalary:2154357,fixedOT:600061,hourlyWage:11198,isActive:true},
                {id:'25sih',name:'ì‹ ì¸í•´',birthDate:'1998-09-12',role:'ì½”ë””',joinDate:'2025-01-02',baseSalary:2034732,fixedOT:566745,hourlyWage:10576,isActive:true},
                {id:'22pjy',name:'ë°•ì§€ìœ¤',birthDate:'1993-04-25',role:'ì½”ë””',joinDate:'2022-06-01',baseSalary:2274105,fixedOT:633506,hourlyWage:11820,isActive:true},
                {id:'22pbm',name:'ë°•ë³´ë¯¸',birthDate:'1991-12-03',role:'ì½”ë””',joinDate:'2022-09-01',baseSalary:2274105,fixedOT:633506,hourlyWage:11820,isActive:true}
            ];
        }
        async function loadAttendance(){
            const ym=getYM();attendanceData={};
            for(const emp of employees){
                try{const snap=await db.collection('attendance').doc(emp.id).collection('records').where(firebase.firestore.FieldPath.documentId(),'>=',ym+'-01').where(firebase.firestore.FieldPath.documentId(),'<=',ym+'-31').get();
                    attendanceData[emp.id]={records:[],summary:{workDays:0,late:0,afterWorkOT:0}};
                    snap.forEach(d=>{const data=d.data(),dow=new Date(d.id).getDay(),ot=calcAfterWorkOT(data.checkOut,dow);
                        attendanceData[emp.id].records.push({date:d.id,...data,afterWorkOT:ot});
                        attendanceData[emp.id].summary.workDays++;if(data.status==='late')attendanceData[emp.id].summary.late++;
                        attendanceData[emp.id].summary.afterWorkOT+=ot;
                    });
                }catch(e){}
            }
        }
        async function loadLeaveRequests(){try{const snap=await db.collection('leaveRequests').orderBy('createdAt','desc').limit(50).get();leaveRequests=[];snap.forEach(d=>leaveRequests.push({id:d.id,...d.data()}));}catch(e){}}
        async function loadRevenueData(){const ym=getYM();try{const doc=await db.collection('revenue').doc(ym).get();revenueData=doc.exists?doc.data():{total:0,japan:0,japanVisitors:0,transactions:0};}catch(e){revenueData={total:0,japan:0,japanVisitors:0,transactions:0};}}
        async function loadSalaryMemos(){const ym=getYM();try{const doc=await db.collection('salaryMemos').doc(ym).get();salaryMemos=doc.exists?doc.data():{};}catch(e){}}
        async function loadLunchOTAll(){
            const ym=getYM();lunchOTAllData={};
            for(const emp of employees){
                try{const doc=await db.collection('lunchOTDaily').doc(emp.id).get();
                    if(doc.exists){const data=doc.data();let total=0;Object.entries(data).forEach(([k,v])=>{if(k.startsWith(ym))total+=v;});lunchOTAllData[emp.id]={total,records:data};}
                    else{lunchOTAllData[emp.id]={total:0,records:{}};}
                }catch(e){lunchOTAllData[emp.id]={total:0,records:{}};}
            }
        }
        async function loadExpenses(){
            try{const fSnap=await db.collection('fixedExpenses').get();fixedExpenses=[];fSnap.forEach(d=>fixedExpenses.push({id:d.id,...d.data()}));}catch(e){}
            const ym=getYM();try{const vSnap=await db.collection('variableExpenses').where('month','==',ym).get();variableExpenses=[];vSnap.forEach(d=>variableExpenses.push({id:d.id,...d.data()}));}catch(e){}
        }
        async function loadIncentiveItems(){
            try{const snap=await db.collection('incentiveItems').get();incentiveItems=[];snap.forEach(d=>incentiveItems.push({id:d.id,...d.data()}));}catch(e){}
        }
        async function loadEmployeeIncentiveRecords(){
            const ym=getYM();employeeIncentiveRecords={};
            for(const emp of employees){
                try{const doc=await db.collection('incentiveRecords').doc(emp.id).collection('monthly').doc(ym).get();
                    employeeIncentiveRecords[emp.id]=doc.exists?doc.data():{};
                }catch(e){employeeIncentiveRecords[emp.id]={};}
            }
        }

        // Calculations
        function timeToMin(t){if(!t)return 0;const[h,m]=t.split(':').map(Number);return h*60+m;}
        function calcAfterWorkOT(checkOut,dow){if(!checkOut||dow===0)return 0;const rule=overtimeRules[dow];if(!rule)return 0;return Math.max(0,timeToMin(checkOut)-timeToMin(rule));}
        function calcTenure(jd){if(!jd)return{label:'-'};const j=new Date(jd),n=new Date();let y=n.getFullYear()-j.getFullYear(),m=n.getMonth()-j.getMonth();if(m<0){y--;m+=12;}if(y>0)return{years:y,label:m>0?y+'ë…„ '+m+'ê°œì›”':y+'ë…„ì°¨'};if(m>0)return{years:0,label:m+'ê°œì›”'};return{years:0,label:'ì‹ ì…'};}
        function calcAge(bd){if(!bd)return'-';const b=new Date(bd),n=new Date();let age=n.getFullYear()-b.getFullYear();if(n.getMonth()<b.getMonth()||(n.getMonth()===b.getMonth()&&n.getDate()<b.getDate()))age--;return age+'ì„¸';}
        function formatCurrency(n){return'â‚©'+new Intl.NumberFormat('ko-KR').format(n||0);}
        function calcWorkDays(y,m){let c=0;const d=new Date(y,m,0).getDate();for(let i=1;i<=d;i++)if(new Date(y,m-1,i).getDay()!==0)c++;return c;}

        // ì§ì›ë³„ ì¸ì„¼í‹°ë¸Œ ê³„ì‚°
        function calcEmployeeIncentive(empId){
            let total=0;const details=[];
            const records=employeeIncentiveRecords[empId]||{};
            incentiveItems.forEach(item=>{
                if(!item.employees||!item.employees.includes(empId))return;
                let amount=0,desc='';
                switch(item.type){
                    case 'per_case':
                        const count=records[item.id]?.count||0;
                        amount=count*(item.perCaseAmount||0);
                        desc=`${count}ê±´ Ã— ${formatCurrency(item.perCaseAmount)}`;
                        break;
                    case 'revenue_percent':
                        amount=Math.round((revenueData.total||0)*(item.percent||0)/100);
                        if(item.cap&&amount>item.cap)amount=item.cap;
                        desc=`ì´ë§¤ì¶œ Ã— ${item.percent}%`;
                        break;
                    case 'growth_percent':
                        const monthIdx=parseInt(document.getElementById('selectedMonth').value)-1;
                        const prev=monthlyData.data2024[monthIdx]||0;
                        const growth=Math.max(0,(revenueData.total||0)-prev);
                        amount=Math.round(growth*(item.percent||0)/100);
                        if(item.cap&&amount>item.cap)amount=item.cap;
                        desc=`ì„±ì¥ë¶„ Ã— ${item.percent}%${item.cap?' (ìƒí•œ '+formatCurrency(item.cap)+')':''}`;
                        break;
                    case 'japan_visit':
                        amount=(revenueData.japanVisitors||0)*(item.perCaseAmount||0);
                        desc=`${revenueData.japanVisitors||0}ëª… Ã— ${formatCurrency(item.perCaseAmount)}`;
                        break;
                    case 'japan_revenue':
                        amount=Math.round((revenueData.japan||0)*(item.percent||0)/100);
                        desc=`ì¼ë³¸ì¸ë§¤ì¶œ Ã— ${item.percent}%`;
                        break;
                }
                if(amount>0||item.type==='per_case'){details.push({item:item.name,amount,desc});}
                total+=amount;
            });
            return{total,details};
        }

        function checkBirthdays(){
            const today=new Date(),todayMD=String(today.getMonth()+1).padStart(2,'0')+'-'+String(today.getDate()).padStart(2,'0'),thisMonth=String(today.getMonth()+1).padStart(2,'0');
            let birthdayToday=[],birthdayThisMonth=0;
            employees.forEach(e=>{if(e.birthDate&&e.isActive!==false){const bMD=e.birthDate.substring(5);if(bMD===todayMD)birthdayToday.push(e.name);if(bMD.startsWith(thisMonth))birthdayThisMonth++;}});
            document.getElementById('birthdayCount').textContent=birthdayThisMonth+'ëª…';
            if(birthdayToday.length>0){document.getElementById('birthdayAlert').style.display='block';document.getElementById('birthdayNames').textContent=birthdayToday.join(', ');}
            else{document.getElementById('birthdayAlert').style.display='none';}
        }
        // Render Functions
        function renderAll(){renderSales();renderEmployees();renderAttendance();renderLeaves();renderOvertime();renderIncentive();renderSalary();renderExpenses();}

        function renderSales(){
            const total=revenueData.total||0,japan=revenueData.japan||0,jVis=revenueData.japanVisitors||0,trans=revenueData.transactions||0;
            const monthIdx=parseInt(document.getElementById('selectedMonth').value)-1;
            const prev=monthlyData.data2024[monthIdx]||0;
            document.getElementById('monthlyTotal').textContent=formatCurrency(total);
            document.getElementById('monthlyGrowth').textContent=(total>=prev?'+':'')+formatCurrency(total-prev);
            document.getElementById('monthlyTrans').textContent=(trans||0).toLocaleString()+'ê±´';
            document.getElementById('monthlyAvg').textContent=trans>0?formatCurrency(Math.round(total/trans)):'â‚©0';
            // Japan stats
            document.getElementById('japanRevenue').textContent=formatCurrency(japan);
            document.getElementById('japanVisitors').textContent=(jVis||0)+'ëª…';
            document.getElementById('japanAvg').textContent=jVis>0?formatCurrency(Math.round(japan/jVis)):'â‚©0';
            document.getElementById('japanRatio').textContent=total>0?((japan/total)*100).toFixed(1)+'%':'0%';
            // Japan incentive table
            const japanItems=incentiveItems.filter(i=>i.type==='japan_visit'||i.type==='japan_revenue');
            const japanEmps=new Set();
            japanItems.forEach(i=>(i.employees||[]).forEach(e=>japanEmps.add(e)));
            const tbody=document.getElementById('japanIncentiveTable');
            if(japanEmps.size===0){tbody.innerHTML='<tr><td colspan="3" style="text-align:center;padding:2rem;color:var(--text-muted)">ëŒ€ìƒìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';}
            else{
                tbody.innerHTML=[...japanEmps].map(empId=>{
                    const emp=employees.find(e=>e.id===empId);
                    const items=japanItems.filter(i=>(i.employees||[]).includes(empId)).map(i=>i.name).join(', ');
                    const inc=calcEmployeeIncentive(empId);
                    return `<tr><td><strong>${emp?.name||empId}</strong></td><td>${items}</td><td class="text-success"><strong>${formatCurrency(inc.total)}</strong></td></tr>`;
                }).join('');
            }
        }

        function renderEmployees(){
            const active=employees.filter(e=>e.isActive!==false),inactive=employees.filter(e=>e.isActive===false);
            document.getElementById('totalEmployees').textContent=employees.length;document.getElementById('activeEmployees').textContent=active.length;document.getElementById('inactiveEmployees').textContent=inactive.length;
            const tbody=document.getElementById('employeeTableBody');
            if(employees.length===0){tbody.innerHTML='<tr><td colspan="9" style="text-align:center;padding:2rem;color:var(--text-muted)">ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';return;}
            tbody.innerHTML=employees.map(e=>{
                const ten=calcTenure(e.joinDate),age=calcAge(e.birthDate);
                const pwStatus=e.password?'<span class="badge badge-success">ì„¤ì •ë¨</span>':'<span class="badge badge-warning">ë¯¸ì„¤ì •</span>';
                return `<tr><td><span class="badge badge-info">${e.id}</span></td><td><strong>${e.name}</strong></td><td>${age}</td><td>${e.role||'-'}</td><td>${e.joinDate||'-'}</td><td><span class="badge ${ten.years>=3?'badge-success':ten.years>=1?'badge-info':'badge-warning'}">${ten.label}</span></td><td>${e.isActive!==false?'<span class="badge badge-success">ì¬ì§</span>':'<span class="badge badge-danger">í‡´ì‚¬</span>'}</td><td>${pwStatus}</td><td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="editEmployee('${e.id}')">ìˆ˜ì •</button><button class="btn btn-warning btn-sm" onclick="resetPassword('${e.id}')">ë¹„ë²ˆì´ˆê¸°í™”</button></div></td></tr>`;
            }).join('');
        }

        function renderAttendance(){
            const today=new Date().toISOString().split('T')[0];let todayPresent=0;
            const active=employees.filter(e=>e.isActive!==false);
            active.forEach(e=>{const d=attendanceData[e.id];if(d&&d.records.find(r=>r.date===today)?.checkIn)todayPresent++;});
            const[y,m]=getYM().split('-');
            document.getElementById('workDays').textContent=calcWorkDays(parseInt(y),parseInt(m))+'ì¼';document.getElementById('todayPresent').textContent=todayPresent+'ëª…';
            document.getElementById('attendanceTableBody').innerHTML=active.map(e=>{
                const d=attendanceData[e.id]||{records:[],summary:{workDays:0,late:0,afterWorkOT:0}},tr=d.records.find(r=>r.date===today)||{};
                const lunchOT=lunchOTAllData[e.id]?.total||0;const totalOT=d.summary.afterWorkOT+lunchOT;
                return `<tr><td><strong>${e.name}</strong></td><td><span class="badge badge-info">${e.id}</span></td><td>${tr.checkIn||'-'}</td><td>${tr.checkOut||'-'}</td><td>${d.summary.workDays}ì¼</td><td class="${d.summary.late>0?'text-danger':''}">${d.summary.late}íšŒ</td><td class="text-success">${(totalOT/60).toFixed(1)}H</td></tr>`;
            }).join('');
        }

        function renderLeaves(){
            const pending=leaveRequests.filter(l=>l.status==='pending').length,approved=leaveRequests.filter(l=>l.status==='approved').length;
            document.getElementById('pendingLeaves').textContent=pending;document.getElementById('approvedLeaves').textContent=approved;
            const tbody=document.getElementById('leaveTableBody');
            if(leaveRequests.length===0){tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-muted)">íœ´ê°€ ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';return;}
            tbody.innerHTML=leaveRequests.slice(0,20).map(l=>{
                const emp=employees.find(e=>e.id===l.employeeId),sb={pending:'badge-warning',approved:'badge-success',rejected:'badge-danger'}[l.status]||'',st={pending:'ëŒ€ê¸°',approved:'ìŠ¹ì¸',rejected:'ë°˜ë ¤'}[l.status]||l.status;
                return `<tr><td>${l.createdAt?.toDate?.()?.toLocaleDateString()||'-'}</td><td>${emp?.name||l.employeeId}</td><td>${l.type==='annual'?'ì—°ì°¨':l.type==='half'?'ë°˜ì°¨':'ì˜¤í”„'}</td><td>${l.startDate}~${l.endDate}</td><td>${l.reason||'-'}</td><td><span class="badge ${sb}">${st}</span></td><td>${l.status==='pending'?`<div class="btn-group"><button class="btn btn-success btn-sm" onclick="approveLeave('${l.id}')">ìŠ¹ì¸</button><button class="btn btn-danger btn-sm" onclick="rejectLeave('${l.id}')">ë°˜ë ¤</button></div>`:'-'}</td></tr>`;
            }).join('');
        }

        function renderOvertime(){
            let totalMin=0,totalNet=0;const active=employees.filter(e=>e.isActive!==false);
            active.forEach(e=>{const d=attendanceData[e.id]||{summary:{afterWorkOT:0}};const lunchOT=lunchOTAllData[e.id]?.total||0;const total=d.summary.afterWorkOT+lunchOT;totalMin+=total;totalNet+=(total/60)*e.hourlyWage*1.5*0.967;});
            document.getElementById('totalOT').textContent=(totalMin/60).toFixed(1)+'H';document.getElementById('totalOTNet').textContent=formatCurrency(Math.round(totalNet));
            document.getElementById('overtimeTableBody').innerHTML=active.map(e=>{
                const d=attendanceData[e.id]||{summary:{afterWorkOT:0}};const lunchOT=lunchOTAllData[e.id]?.total||0;
                const totalOT=d.summary.afterWorkOT+lunchOT;const n=(totalOT/60)*e.hourlyWage*1.5*0.967;
                return `<tr><td><strong>${e.name}</strong></td><td>${formatCurrency(e.hourlyWage)}</td><td>${(d.summary.afterWorkOT/60).toFixed(1)}H</td><td>${(lunchOT/60).toFixed(1)}H</td><td class="text-warning"><strong>${(totalOT/60).toFixed(1)}H</strong></td><td class="text-success"><strong>${formatCurrency(Math.round(n))}</strong></td></tr>`;
            }).join('');
            document.getElementById('sumOTHours').textContent=(totalMin/60).toFixed(1)+'H';document.getElementById('sumOTNet').textContent=formatCurrency(Math.round(totalNet));
        }

        function renderIncentive(){
            document.getElementById('incentiveItemCount').textContent=incentiveItems.length+'ê°œ';
            // Render incentive items list
            const itemsList=document.getElementById('incentiveItemsList');
            if(incentiveItems.length===0){itemsList.innerHTML='<div style="text-align:center;padding:2rem;color:var(--text-muted)">ì¸ì„¼í‹°ë¸Œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. í•­ëª©ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.</div>';}
            else{
                itemsList.innerHTML=incentiveItems.map(item=>{
                    const typeLabels={per_case:'ê±´ë‹¹',revenue_percent:'ë§¤ì¶œë¹„ìœ¨',growth_percent:'ì„±ì¥ë¶„ë¹„ìœ¨',japan_visit:'ì¼ë³¸ì¸ë°©ë¬¸',japan_revenue:'ì¼ë³¸ì¸ë§¤ì¶œ'};
                    const emps=(item.employees||[]).map(id=>{const e=employees.find(x=>x.id===id);return e?`<span class="emp-chip">${e.name}</span>`:'';}).join('');
                    let valueDesc='';
                    if(item.type==='per_case'||item.type==='japan_visit')valueDesc=formatCurrency(item.perCaseAmount)+'/ê±´';
                    else valueDesc=item.percent+'%'+(item.cap?' (ìƒí•œ '+formatCurrency(item.cap)+')':'');
                    return `<div class="incentive-item"><div class="incentive-item-header"><div><span class="incentive-item-name">${item.name}</span><span class="badge badge-info" style="margin-left:.5rem">${typeLabels[item.type]||item.type}</span><span style="margin-left:.5rem;color:var(--accent-purple)">${valueDesc}</span></div><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="editIncentiveItem('${item.id}')">ìˆ˜ì •</button><button class="btn btn-danger btn-sm" onclick="deleteIncentiveItem('${item.id}')">ì‚­ì œ</button></div></div><div class="incentive-item-employees">${emps||'<span class="text-muted">ì ìš© ì§ì› ì—†ìŒ</span>'}</div></div>`;
                }).join('');
            }
            // Render employee incentive table
            let totalInc=0;const active=employees.filter(e=>e.isActive!==false);
            const tbody=document.getElementById('incentiveTableBody');
            tbody.innerHTML=active.map(e=>{
                const inc=calcEmployeeIncentive(e.id);totalInc+=inc.total;
                const itemNames=inc.details.map(d=>`<div><span class="badge badge-purple">${d.item}</span> <span class="text-muted">${d.desc}</span> = ${formatCurrency(d.amount)}</div>`).join('');
                const recordsHtml=inc.details.filter(d=>d.item).map(d=>{
                    const item=incentiveItems.find(i=>i.name===d.item);
                    if(item?.type==='per_case'){
                        const count=employeeIncentiveRecords[e.id]?.[item.id]?.count||0;
                        return `${count}ê±´`;
                    }
                    return d.desc;
                }).join(', ');
                return `<tr><td><strong>${e.name}</strong></td><td>${itemNames||'<span class="text-muted">-</span>'}</td><td class="text-muted">${recordsHtml||'-'}</td><td class="text-success"><strong>${formatCurrency(inc.total)}</strong></td></tr>`;
            }).join('');
            document.getElementById('totalIncentiveSum').textContent=formatCurrency(totalInc);
        }

        function renderSalary(){
            let totalSum=0;const active=employees.filter(e=>e.isActive!==false);
            document.getElementById('salaryTableBody').innerHTML=active.map(e=>{
                const d=attendanceData[e.id]||{summary:{afterWorkOT:0}};const lunchOT=lunchOTAllData[e.id]?.total||0;const totalOT=d.summary.afterWorkOT+lunchOT;
                const otPay=Math.round((totalOT/60)*e.hourlyWage*1.5*0.967);
                const inc=calcEmployeeIncentive(e.id);
                const total=(e.baseSalary||0)+(e.fixedOT||0)+otPay+inc.total;
                totalSum+=total;const memo=salaryMemos[e.id]||'';
                return `<tr><td><strong>${e.name}</strong></td><td>${formatCurrency(e.baseSalary)}</td><td>${formatCurrency(e.fixedOT)}</td><td class="text-success">${formatCurrency(otPay)}</td><td class="text-purple">${formatCurrency(inc.total)}</td><td><strong>${formatCurrency(total)}</strong></td><td><input type="text" class="memo-input" value="${memo}" placeholder="ë©”ëª¨" onchange="saveMemo('${e.id}',this.value)"></td></tr>`;
            }).join('');
            document.getElementById('totalSalarySum').textContent=formatCurrency(totalSum);
        }

        function renderExpenses(){
            let fixedTotal=0;
            document.getElementById('fixedExpenseTable').innerHTML=fixedExpenses.length===0?'<tr><td colspan="5" style="text-align:center;padding:2rem;color:var(--text-muted)">ê³ ì •ë¹„ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>':
                fixedExpenses.map(e=>{fixedTotal+=e.amount;return `<tr><td>${e.name}</td><td>${formatCurrency(e.amount)}</td><td>${e.cycle==='monthly'?'ì›”ê°„':'ì—°ê°„'}</td><td>${e.memo||'-'}</td><td><button class="btn btn-danger btn-sm" onclick="deleteExpense('fixed','${e.id}')">ì‚­ì œ</button></td></tr>`;}).join('');
            document.getElementById('fixedExpenseTotal').textContent=formatCurrency(fixedTotal);
            let varTotal=0;
            document.getElementById('variableExpenseTable').innerHTML=variableExpenses.length===0?'<tr><td colspan="6" style="text-align:center;padding:2rem;color:var(--text-muted)">ìœ ë™ë¹„ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>':
                variableExpenses.map(e=>{varTotal+=e.amount;return `<tr><td>${e.date||'-'}</td><td>${e.name}</td><td>${e.category||'-'}</td><td>${formatCurrency(e.amount)}</td><td>${e.memo||'-'}</td><td><button class="btn btn-danger btn-sm" onclick="deleteExpense('variable','${e.id}')">ì‚­ì œ</button></td></tr>`;}).join('');
            document.getElementById('variableExpenseTotal').textContent=formatCurrency(varTotal);
        }
        // Charts
        let charts={};
        function initCharts(){
            const opts={responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#94a3b8'}}},scales:{x:{ticks:{color:'#64748b'},grid:{color:'rgba(45,55,72,.5)'}},y:{ticks:{color:'#64748b',callback:v=>(v/100000000).toFixed(1)+'ì–µ'},grid:{color:'rgba(45,55,72,.5)'}}}};
            if(charts.monthly)charts.monthly.destroy();
            charts.monthly=new Chart(document.getElementById('monthlyChart'),{type:'line',data:{labels:monthlyData.labels,datasets:[{label:'2025ë…„',data:monthlyData.data2025,borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,.1)',fill:true,tension:.4},{label:'2024ë…„',data:monthlyData.data2024,borderColor:'#64748b',borderDash:[5,5],tension:.4}]},options:opts});
            if(charts.yearCompare)charts.yearCompare.destroy();
            charts.yearCompare=new Chart(document.getElementById('yearCompareChart'),{type:'bar',data:{labels:monthlyData.labels,datasets:[{label:'2024ë…„',data:monthlyData.data2024,backgroundColor:'rgba(100,116,139,.7)',borderRadius:4},{label:'2025ë…„',data:monthlyData.data2025,backgroundColor:'rgba(59,130,246,.7)',borderRadius:4}]},options:opts});
        }

        // Employee CRUD
        function openEmployeeModal(id=null){document.getElementById('employeeModal').classList.add('active');document.getElementById('employeeForm').reset();
            if(id){const e=employees.find(x=>x.id===id);if(e){document.getElementById('employeeModalTitle').textContent='ì§ì› ìˆ˜ì •';document.getElementById('empEditId').value=e.id;document.getElementById('empName').value=e.name;document.getElementById('empId').value=e.id;document.getElementById('empId').disabled=true;document.getElementById('empBirthDate').value=e.birthDate||'';document.getElementById('empRole').value=e.role;document.getElementById('empJoinDate').value=e.joinDate;document.getElementById('empBaseSalary').value=e.baseSalary;document.getElementById('empFixedOT').value=e.fixedOT||'';document.getElementById('empHourlyWage').value=e.hourlyWage||'';document.getElementById('empIsActive').value=e.isActive!==false?'true':'false';}}
            else{document.getElementById('employeeModalTitle').textContent='ì§ì› ì¶”ê°€';document.getElementById('empId').disabled=false;}}
        function closeEmployeeModal(){document.getElementById('employeeModal').classList.remove('active');}
        function editEmployee(id){openEmployeeModal(id);}
        document.getElementById('employeeForm').addEventListener('submit',async e=>{e.preventDefault();
            const editId=document.getElementById('empEditId').value,data={name:document.getElementById('empName').value,birthDate:document.getElementById('empBirthDate').value||null,role:document.getElementById('empRole').value,joinDate:document.getElementById('empJoinDate').value,baseSalary:parseInt(document.getElementById('empBaseSalary').value)||0,fixedOT:parseInt(document.getElementById('empFixedOT').value)||0,hourlyWage:parseInt(document.getElementById('empHourlyWage').value)||0,isActive:document.getElementById('empIsActive').value==='true',updatedAt:firebase.firestore.FieldValue.serverTimestamp()};
            try{if(editId){await db.collection('employees').doc(editId).update(data);alert('ìˆ˜ì • ì™„ë£Œ');}else{const newId=document.getElementById('empId').value.toLowerCase();data.createdAt=firebase.firestore.FieldValue.serverTimestamp();await db.collection('employees').doc(newId).set(data);alert('ì¶”ê°€ ì™„ë£Œ');}closeEmployeeModal();await loadEmployees();renderAll();}catch(err){alert('ì €ì¥ ì‹¤íŒ¨: '+err.message);}});
        async function resetPassword(id){if(!confirm(`${id} ë¹„ë°€ë²ˆí˜¸ë¥¼ ì´ˆê¸°í™”?\nì„ì‹œ: ${DEFAULT_PW}`))return;try{await db.collection('employees').doc(id).update({password:DEFAULT_PW});alert('ì´ˆê¸°í™” ì™„ë£Œ');await loadEmployees();renderEmployees();}catch(err){alert(err.message);}}

        // Incentive Item CRUD
        function toggleIncTypeFields(){
            const type=document.getElementById('incItemType').value;
            document.getElementById('incPerCaseFields').style.display=(type==='per_case'||type==='japan_visit')?'grid':'none';
            document.getElementById('incPercentFields').style.display=(type==='revenue_percent'||type==='growth_percent'||type==='japan_revenue')?'grid':'none';
        }
        function openIncentiveItemModal(id=null){
            document.getElementById('incentiveItemModal').classList.add('active');document.getElementById('incentiveItemForm').reset();
            // Render employee checkboxes
            const container=document.getElementById('incEmployeeCheckboxes');
            const active=employees.filter(e=>e.isActive!==false);
            container.innerHTML=active.map(e=>`<label style="display:flex;align-items:center;gap:.25rem;padding:.5rem;background:var(--bg-card);border-radius:8px;cursor:pointer"><input type="checkbox" value="${e.id}" class="inc-emp-check"> ${e.name}</label>`).join('');
            if(id){
                const item=incentiveItems.find(x=>x.id===id);
                if(item){
                    document.getElementById('incentiveItemModalTitle').textContent='ì¸ì„¼í‹°ë¸Œ í•­ëª© ìˆ˜ì •';
                    document.getElementById('incItemEditId').value=item.id;
                    document.getElementById('incItemName').value=item.name;
                    document.getElementById('incItemType').value=item.type;
                    toggleIncTypeFields();
                    if(item.perCaseAmount)document.getElementById('incPerCaseAmount').value=item.perCaseAmount;
                    if(item.percent)document.getElementById('incPercent').value=item.percent;
                    if(item.cap)document.getElementById('incCap').value=item.cap;
                    (item.employees||[]).forEach(empId=>{const cb=container.querySelector(`input[value="${empId}"]`);if(cb)cb.checked=true;});
                }
            }else{document.getElementById('incentiveItemModalTitle').textContent='ì¸ì„¼í‹°ë¸Œ í•­ëª© ì¶”ê°€';toggleIncTypeFields();}
        }
        function closeIncentiveItemModal(){document.getElementById('incentiveItemModal').classList.remove('active');}
        function editIncentiveItem(id){openIncentiveItemModal(id);}
        document.getElementById('incentiveItemForm').addEventListener('submit',async e=>{e.preventDefault();
            const editId=document.getElementById('incItemEditId').value;
            const type=document.getElementById('incItemType').value;
            const data={name:document.getElementById('incItemName').value,type,employees:[...document.querySelectorAll('.inc-emp-check:checked')].map(cb=>cb.value),updatedAt:firebase.firestore.FieldValue.serverTimestamp()};
            if(type==='per_case'||type==='japan_visit'){data.perCaseAmount=parseInt(document.getElementById('incPerCaseAmount').value)||0;}
            if(type==='revenue_percent'||type==='growth_percent'||type==='japan_revenue'){data.percent=parseFloat(document.getElementById('incPercent').value)||0;data.cap=parseInt(document.getElementById('incCap').value)||null;}
            try{
                if(editId){await db.collection('incentiveItems').doc(editId).update(data);alert('ìˆ˜ì • ì™„ë£Œ');}
                else{data.createdAt=firebase.firestore.FieldValue.serverTimestamp();await db.collection('incentiveItems').add(data);alert('ì¶”ê°€ ì™„ë£Œ');}
                closeIncentiveItemModal();await loadIncentiveItems();renderIncentive();
            }catch(err){alert('ì €ì¥ ì‹¤íŒ¨: '+err.message);}
        });
        async function deleteIncentiveItem(id){if(!confirm('ì‚­ì œ?'))return;try{await db.collection('incentiveItems').doc(id).delete();alert('ì‚­ì œ ì™„ë£Œ');await loadIncentiveItems();renderIncentive();}catch(err){alert(err.message);}}

        // Leave
        async function approveLeave(id){if(!confirm('ìŠ¹ì¸?'))return;try{await db.collection('leaveRequests').doc(id).update({status:'approved',approvedAt:firebase.firestore.FieldValue.serverTimestamp()});alert('ìŠ¹ì¸');await loadLeaveRequests();renderLeaves();}catch(err){alert(err.message);}}
        async function rejectLeave(id){const reason=prompt('ë°˜ë ¤ ì‚¬ìœ :');if(reason===null)return;try{await db.collection('leaveRequests').doc(id).update({status:'rejected',rejectReason:reason,rejectedAt:firebase.firestore.FieldValue.serverTimestamp()});alert('ë°˜ë ¤');await loadLeaveRequests();renderLeaves();}catch(err){alert(err.message);}}

        // Revenue
        async function saveRevenueData(){const ym=getYM(),total=parseNum(document.getElementById('inputTotalRevenue').value),japan=parseNum(document.getElementById('inputJapanRevenue').value),jVis=parseInt(document.getElementById('inputJapanVisitors').value)||0,trans=parseInt(document.getElementById('inputTransactions').value)||0;
            try{await db.collection('revenue').doc(ym).set({total,japan,japanVisitors:jVis,transactions:trans,updatedAt:firebase.firestore.FieldValue.serverTimestamp()});revenueData={total,japan,japanVisitors:jVis,transactions:trans};alert('ì €ì¥ ì™„ë£Œ');renderAll();}catch(err){alert(err.message);}}
        async function saveMemo(id,memo){const ym=getYM();salaryMemos[id]=memo;try{await db.collection('salaryMemos').doc(ym).set(salaryMemos,{merge:true});}catch(e){}}
        function parseNum(s){return s?parseInt(s.replace(/,/g,''))||0:0;}

        // Expense
        function openExpenseModal(type){document.getElementById('expenseModal').classList.add('active');document.getElementById('expenseForm').reset();document.getElementById('expType').value=type;document.getElementById('expenseModalTitle').textContent=(type==='fixed'?'ê³ ì •ë¹„':'ìœ ë™ë¹„')+' ì¶”ê°€';document.getElementById('expFixedFields').style.display=type==='fixed'?'grid':'none';document.getElementById('expVariableFields').style.display=type==='variable'?'grid':'none';}
        function closeExpenseModal(){document.getElementById('expenseModal').classList.remove('active');}
        document.getElementById('expenseForm').addEventListener('submit',async e=>{e.preventDefault();const type=document.getElementById('expType').value,data={name:document.getElementById('expName').value,amount:parseInt(document.getElementById('expAmount').value)||0,memo:document.getElementById('expMemo').value,createdAt:firebase.firestore.FieldValue.serverTimestamp()};if(type==='fixed'){data.cycle=document.getElementById('expCycle').value;try{await db.collection('fixedExpenses').add(data);alert('ì €ì¥');}catch(err){alert(err.message);}}else{data.date=document.getElementById('expDate').value;data.category=document.getElementById('expCategory').value;data.month=getYM();try{await db.collection('variableExpenses').add(data);alert('ì €ì¥');}catch(err){alert(err.message);}}closeExpenseModal();await loadExpenses();renderExpenses();});
        async function deleteExpense(type,id){if(!confirm('ì‚­ì œ?'))return;try{await db.collection(type==='fixed'?'fixedExpenses':'variableExpenses').doc(id).delete();await loadExpenses();renderExpenses();}catch(err){alert(err.message);}}

        // File Upload
        const uploadZone=document.getElementById('uploadZone');
        uploadZone.addEventListener('click',()=>document.getElementById('fileInput').click());
        uploadZone.addEventListener('dragover',e=>{e.preventDefault();uploadZone.classList.add('dragover');});
        uploadZone.addEventListener('dragleave',()=>uploadZone.classList.remove('dragover'));
        uploadZone.addEventListener('drop',e=>{e.preventDefault();uploadZone.classList.remove('dragover');if(e.dataTransfer.files.length>0)processFile(e.dataTransfer.files[0]);});
        function handleFileUpload(e){if(e.target.files[0])processFile(e.target.files[0]);}
        function processFile(file){
            const reader=new FileReader();
            reader.onload=function(e){
                try{
                    const data=new Uint8Array(e.target.result),wb=XLSX.read(data,{type:'array'}),sheet=wb.Sheets[wb.SheetNames[0]],json=XLSX.utils.sheet_to_json(sheet);
                    let totalRev=0,japanRev=0,japanCount=0,year='',month='';
                    json.forEach(row=>{
                        if(row['ê¸ˆì•¡'])totalRev+=parseInt(row['ê¸ˆì•¡'])||0;
                        if(row['êµ­ì ']&&row['êµ­ì '].includes('ì¼ë³¸')){japanRev+=parseInt(row['ê¸ˆì•¡'])||0;japanCount++;}
                        if(row['ì§„ë£Œì¼']&&!year){const d=String(row['ì§„ë£Œì¼']);if(d.length>=6){year=d.substring(0,4);month=d.substring(4,6);}}
                    });
                    const ym=year+'-'+month;
                    db.collection('revenue').doc(ym).set({total:totalRev,japan:japanRev,japanVisitors:japanCount,transactions:json.length,uploadedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
                    alert(`ì—…ë¡œë“œ ì™„ë£Œ!\n\nì—°ì›”: ${ym}\nê±´ìˆ˜: ${json.length}ê±´\nì´ë§¤ì¶œ: ${formatCurrency(totalRev)}\nì¼ë³¸ì¸ë§¤ì¶œ: ${formatCurrency(japanRev)}\nì¼ë³¸ì¸ìˆ˜: ${japanCount}ëª…`);
                    if(ym===getYM()){loadRevenueData().then(()=>renderAll());}
                }catch(err){alert('íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜: '+err.message);}
            };
            reader.readAsArrayBuffer(file);
        }

        // Init
        loadAllData();
    </script>
</body>
</html>
