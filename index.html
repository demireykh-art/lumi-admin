<!DOCTYPE html>

<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE CLINIC LUMI - ê´€ë¦¬ì</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--bg-primary:#faf9f7;--bg-secondary:#fff;--bg-card:#fff;--accent-gold:#9a8b7a;--accent-dark:#2c2c2c;--accent-green:#5a7a5a;--accent-red:#a85a5a;--accent-blue:#5a6a7a;--accent-orange:#c4956a;--accent-purple:#7a6a8a;--text-primary:#2c2c2c;--text-secondary:#6b6b6b;--text-muted:#999;--border-color:#e8e4df}
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Noto Sans KR',sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh}
        .login-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;padding:2rem;position:fixed;inset:0;z-index:2000;background:var(--bg-primary)}
        .login-screen.hidden{display:none}.login-logo{font-family:'Cormorant Garamond',serif;letter-spacing:4px;color:var(--text-muted);font-size:.9rem;margin-bottom:.5rem}
        .login-title{font-family:'Cormorant Garamond',serif;font-size:2.5rem;font-weight:500;margin-bottom:.5rem;letter-spacing:2px}
        .login-subtitle{color:var(--text-muted);margin-bottom:2rem;font-size:.85rem;letter-spacing:1px}.login-form{width:100%;max-width:320px}
        .login-input{width:100%;padding:1rem;background:#fff;border:1px solid var(--border-color);color:var(--text-primary);font-size:1rem;margin-bottom:1rem}
        .login-input:focus{outline:none;border-color:var(--accent-gold)}.pw-wrap{position:relative}
        .pw-toggle{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1rem;margin-top:-8px}
        .login-btn{width:100%;padding:1rem;background:var(--accent-dark);border:none;color:#fff;font-size:.9rem;cursor:pointer;letter-spacing:1px;margin-bottom:1rem}
        .login-btn:hover{background:#444}.login-error{color:var(--accent-red);font-size:.85rem;margin-bottom:1rem;text-align:center;min-height:1.2rem}
        .header{background:var(--bg-secondary);border-bottom:1px solid var(--border-color);padding:1rem 2rem;position:sticky;top:0;z-index:100}
        .header-content{display:flex;justify-content:space-between;align-items:center;max-width:1800px;margin:0 auto}
        .logo{display:flex;align-items:center;gap:12px}.logo-text{font-family:'Cormorant Garamond',serif}
        .logo-sub{font-size:.7rem;letter-spacing:3px;color:var(--text-muted)}.logo-main{font-size:1.4rem;font-weight:500;letter-spacing:2px}
        .header-right{display:flex;align-items:center;gap:1rem}.month-selector{display:flex;align-items:center;gap:.5rem;background:var(--bg-primary);padding:.5rem 1rem;border:1px solid var(--border-color)}
        .month-selector select{border:none;background:transparent;font-size:.9rem;cursor:pointer;padding:.25rem}
        .month-arrow{width:28px;height:28px;display:flex;align-items:center;justify-content:center;background:#fff;border:1px solid var(--border-color);cursor:pointer;font-size:.8rem;color:var(--text-muted);transition:all .2s}.month-arrow:hover{border-color:var(--accent-gold);color:var(--accent-gold)}
        .logout-btn{padding:.5rem 1rem;background:none;border:1px solid var(--border-color);cursor:pointer;font-size:.85rem;color:var(--text-secondary)}
        .logout-btn:hover{background:var(--bg-primary)}
        .nav-tabs{display:flex;background:var(--bg-secondary);border-bottom:1px solid var(--border-color);padding:0 2rem;overflow-x:auto}
        .nav-tab{padding:1rem 1.5rem;cursor:pointer;font-size:.9rem;color:var(--text-secondary);border-bottom:2px solid transparent;white-space:nowrap;transition:all .2s}
        .nav-tab:hover{color:var(--text-primary)}.nav-tab.active{color:var(--accent-gold);border-bottom-color:var(--accent-gold);font-weight:500}
        .sub-tabs{display:flex;gap:.5rem;padding:1rem 0;flex-wrap:wrap}
        .sub-tab{padding:.5rem 1rem;background:var(--bg-secondary);border:1px solid var(--border-color);cursor:pointer;font-size:.85rem;color:var(--text-secondary)}
        .sub-tab:hover{border-color:var(--accent-gold)}.sub-tab.active{background:var(--accent-gold);color:#fff;border-color:var(--accent-gold)}
        .content{max-width:1800px;margin:0 auto;padding:1.5rem 2rem}.tab-content{display:none}.tab-content.active{display:block}.sub-content{display:none}.sub-content.active{display:block}
        .cards-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1.5rem}
        .card{background:var(--bg-card);border:1px solid var(--border-color);padding:1.25rem}
        .card-label{font-size:.75rem;color:var(--text-muted);margin-bottom:.5rem;letter-spacing:1px}.card-value{font-size:1.5rem;font-weight:600}
        .card-sub{font-size:.8rem;color:var(--text-secondary);margin-top:.25rem}.card-change{font-size:.8rem;margin-top:.5rem}
        .card-change.positive{color:var(--accent-green)}.card-change.negative{color:var(--accent-red)}
        .table-container{background:var(--bg-card);border:1px solid var(--border-color);overflow-x:auto;margin-bottom:1.5rem}
        table{width:100%;border-collapse:collapse}th,td{padding:.75rem 1rem;text-align:left;border-bottom:1px solid var(--border-color);font-size:.9rem}
        th{background:var(--bg-primary);font-weight:500;color:var(--text-secondary);font-size:.8rem;letter-spacing:.5px}tr:hover{background:var(--bg-primary)}
        .chart-container{background:var(--bg-card);border:1px solid var(--border-color);padding:1.5rem;margin-bottom:1.5rem}
        .chart-title{font-size:.9rem;font-weight:500;margin-bottom:1rem}.chart-wrapper{height:300px;position:relative}
        .upload-zone{border:2px dashed var(--border-color);padding:2rem;text-align:center;cursor:pointer;margin-bottom:1.5rem;background:var(--bg-card);transition:border-color .2s}
        .upload-zone:hover{border-color:var(--accent-gold)}.upload-icon{font-size:2rem;margin-bottom:.5rem}.upload-text{color:var(--text-secondary);font-size:.9rem}
        .badge{display:inline-block;padding:.25rem .5rem;font-size:.75rem;font-weight:500;border-radius:2px}
        .badge-green{background:rgba(90,122,90,.15);color:var(--accent-green)}.badge-red{background:rgba(168,90,90,.15);color:var(--accent-red)}
        .badge-blue{background:rgba(90,106,122,.15);color:var(--accent-blue)}.badge-orange{background:rgba(196,149,106,.15);color:var(--accent-orange)}
        .badge-purple{background:rgba(122,106,138,.15);color:var(--accent-purple)}.badge-gold{background:rgba(154,139,122,.15);color:var(--accent-gold)}
        .badge-green{background:rgba(90,122,90,.15);color:var(--accent-green)}
        .holiday-card{background:linear-gradient(135deg,#fff9f0,#fff);border:1px solid var(--border-color);border-radius:8px;padding:1rem;position:relative}
        .holiday-card.golden{border-left:4px solid var(--accent-gold)}
        .holiday-card.sandwich{border-left:4px solid var(--accent-orange)}
        .holiday-card .holiday-month{font-size:.7rem;color:var(--text-muted);margin-bottom:.25rem;font-weight:600}
        .holiday-card .holiday-name{font-size:.95rem;font-weight:600;color:var(--text-primary);margin-bottom:.25rem}
        .holiday-card .holiday-dates{font-size:.8rem;color:var(--accent-gold);font-weight:500}
        .holiday-card .holiday-tip{font-size:.75rem;color:var(--text-secondary);margin-top:.5rem;padding-top:.5rem;border-top:1px dashed var(--border-color)}
        .holiday-card .holiday-badge{position:absolute;top:.75rem;right:.75rem;font-size:.65rem;padding:.2rem .5rem;border-radius:10px;font-weight:600}
        .holiday-card .holiday-badge.golden{background:var(--accent-gold);color:#fff}
        .holiday-card .holiday-badge.sandwich{background:var(--accent-orange);color:#fff}
        .leave-bar{height:8px;background:var(--border-color);border-radius:4px;overflow:hidden;margin-top:.5rem}
        .leave-bar-fill{height:100%;background:linear-gradient(90deg,var(--accent-green),var(--accent-gold));border-radius:4px;transition:width .3s}
        .leave-bar-fill.warning{background:linear-gradient(90deg,var(--accent-orange),var(--accent-red))}
        .btn{padding:.5rem 1rem;border:none;cursor:pointer;font-size:.85rem;transition:all .2s}
        .btn-primary{background:var(--accent-gold);color:#fff}.btn-primary:hover{background:#8a7b6a}
        .btn-secondary{background:var(--bg-primary);border:1px solid var(--border-color);color:var(--text-primary)}.btn-secondary:hover{background:var(--border-color)}
        .btn-danger{background:var(--accent-red);color:#fff}.btn-danger:hover{opacity:.9}.btn-sm{padding:.35rem .75rem;font-size:.8rem}
        .btn-gold{background:var(--accent-gold);color:#fff}.btn-gold:hover{background:#8a7b6a}
        .form-group{margin-bottom:1rem}.form-label{display:block;font-size:.85rem;color:var(--text-secondary);margin-bottom:.5rem}
        .form-input,.form-select,.form-textarea{width:100%;padding:.75rem;border:1px solid var(--border-color);font-size:.9rem;background:var(--bg-secondary)}
        .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--accent-gold)}.form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem}
        .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:3000;align-items:center;justify-content:center;padding:1rem}
        .modal.active{display:flex}.modal-content{background:var(--bg-secondary);width:100%;max-width:500px;max-height:90vh;overflow-y:auto}
        .modal-header{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.5rem;border-bottom:1px solid var(--border-color)}
        .modal-title{font-size:1rem;font-weight:500}.modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-muted);line-height:1}
        .modal-body{padding:1.5rem}.modal-footer{display:flex;gap:.5rem;justify-content:flex-end;padding:1rem 1.5rem;border-top:1px solid var(--border-color)}
        .section{margin-bottom:2rem}.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}.section-title{font-size:1rem;font-weight:500}
        .expense-summary{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1.5rem}
        .expense-box{background:var(--bg-card);border:1px solid var(--border-color);padding:1rem;text-align:center}
        .expense-box-label{font-size:.75rem;color:var(--text-muted);margin-bottom:.25rem}.expense-box-value{font-size:1.2rem;font-weight:600}
        .birthday-alert{background:linear-gradient(135deg,#fff5f5,#fffaf0);border:1px solid #f0e0d0;padding:1rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:1rem}
        .birthday-icon{font-size:1.5rem}.birthday-text{flex:1}.birthday-name{font-weight:600;color:var(--accent-orange)}
        .text-right{text-align:right}.text-center{text-align:center}.mt-1{margin-top:1rem}.mb-1{margin-bottom:1rem}
        .app-container{display:none}.app-container.active{display:block}
        @media(max-width:768px){.header{padding:1rem}.content{padding:1rem}.nav-tabs{padding:0 1rem}.nav-tab{padding:.75rem 1rem;font-size:.85rem}.cards-grid{grid-template-columns:repeat(2,1fr)}.expense-summary{grid-template-columns:1fr}.form-row{grid-template-columns:1fr}}
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-logo">THE CLINIC</div>
        <div class="login-title">LUMI</div>
        <div class="login-subtitle">ADMIN PORTAL</div>
        <form class="login-form" onsubmit="handleAdminLogin();return false;">
            <input type="text" class="login-input" id="adminId" placeholder="ê´€ë¦¬ì ID" autocomplete="username">
            <div class="pw-wrap">
                <input type="password" class="login-input" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password">
                <button type="button" class="pw-toggle" onclick="togglePw('adminPw',this)">ğŸ‘</button>
            </div>
            <div class="login-error" id="loginError"></div>
            <button type="submit" class="login-btn">ë¡œê·¸ì¸</button>
        </form>
    </div>
    <div class="app-container" id="appContainer">
        <header class="header">
            <div class="header-content">
                <div class="logo"><div class="logo-text"><div class="logo-sub">THE CLINIC</div><div class="logo-main">LUMI</div></div></div>
                <div class="header-right">
                    <div class="month-selector">
                        <button class="month-arrow" onclick="changeMonth(-1)">â—€</button>
                        <select id="yearSelect" onchange="loadData()"></select><span>ë…„</span>
                        <select id="monthSelect" onchange="loadData()"></select><span>ì›”</span>
                        <button class="month-arrow" onclick="changeMonth(1)">â–¶</button>
                    </div>
                    <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </header>
        <nav class="nav-tabs">
            <div class="nav-tab active" data-tab="revenue">ë§¤ì¶œ</div>
            <div class="nav-tab" data-tab="expense">ì§€ì¶œ</div>
            <div class="nav-tab" data-tab="employee">ì§ì›ê´€ë¦¬</div>
        </nav>
        <main class="content">
            <div class="tab-content active" id="tab-revenue">
                <div class="sub-tabs">
                    <div class="sub-tab active" data-sub="overview">ë§¤ì¶œ í˜„í™©</div>
                    <div class="sub-tab" data-sub="doctor">ì§„ë£Œì˜ë³„</div>
                    <div class="sub-tab" data-sub="staff">ë‹´ë‹¹ì§ì›ë³„</div>
                    <div class="sub-tab" data-sub="japan">ì¼ë³¸ì¸ ë§¤ì¶œ</div>
                    <div class="sub-tab" data-sub="upload">ë°ì´í„° ì—…ë¡œë“œ</div>
                </div>
                <div class="sub-content active" id="sub-overview">
                    <div id="birthdayAlert"></div>
                    <div class="cards-grid" id="revenueCards"></div>
                    <div class="chart-container"><div class="chart-title">ì›”ë³„ ë§¤ì¶œ ì¶”ì´</div><div class="chart-wrapper"><canvas id="revenueChart"></canvas></div></div>
                    <div class="chart-container"><div class="chart-title">ì—°ë„ë³„ ë¹„êµ (2024 vs 2025)</div><div class="chart-wrapper"><canvas id="compareChart"></canvas></div></div>
                </div>
                <div class="sub-content" id="sub-doctor">
                    <div class="cards-grid" id="doctorCards"></div>
                    <div class="table-container"><table><thead><tr><th>ì§„ë£Œì˜</th><th class="text-right">í™˜ì ìˆ˜</th><th class="text-right">ë§¤ì¶œ</th><th class="text-right">ê°ë‹¨ê°€</th><th class="text-right">ì ìœ ìœ¨</th></tr></thead><tbody id="doctorTable"></tbody></table></div>
                </div>
                <div class="sub-content" id="sub-staff">
                    <div class="cards-grid" id="staffSalesCards"></div>
                    <div class="table-container"><table><thead><tr><th>ë‹´ë‹¹ì§ì›</th><th class="text-right">í™˜ì ìˆ˜</th><th class="text-right">ë§¤ì¶œ</th><th class="text-right">ê°ë‹¨ê°€</th><th class="text-right">ì¸ì„¼í‹°ë¸Œ(1%)</th></tr></thead><tbody id="staffSalesTable"></tbody></table></div>
                </div>
                <div class="sub-content" id="sub-japan">
                    <div class="cards-grid" id="japanCards"></div>
                    <div class="section"><div class="section-header"><div class="section-title">ë‹´ë‹¹ì§ì›ë³„ ì¼ë³¸ì¸ ë§¤ì¶œ</div></div>
                        <div class="table-container"><table><thead><tr><th>ë‹´ë‹¹ì§ì›</th><th class="text-right">í™˜ì ìˆ˜</th><th class="text-right">ë§¤ì¶œ</th><th class="text-right">ê°ë‹¨ê°€</th><th class="text-right">ì ìœ ìœ¨</th></tr></thead><tbody id="japanStaffTable"></tbody></table></div>
                    </div>
                    <div class="section"><div class="section-header"><div class="section-title">ì›”ë³„ ì¼ë³¸ì¸ ë§¤ì¶œ</div></div>
                        <div class="table-container"><table><thead><tr><th>ì›”</th><th class="text-right">ì¼ë³¸ì¸ ë§¤ì¶œ</th><th class="text-right">í™˜ì ìˆ˜</th><th class="text-right">ê°ë‹¨ê°€</th></tr></thead><tbody id="japanTable"></tbody></table></div>
                    </div>
                </div>
                <div class="sub-content" id="sub-upload">
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">ğŸ“</div>
                        <div class="upload-text">ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ<br><small>ì˜¤ë”íŒë§¤ë‚´ì—­ë°í™˜ìë‚´ì—­_YYYYMMDD_ì˜¤ë”ë³„_.xlsx</small></div>
                        <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none" onchange="handleFileUpload(event)">
                    </div>
                    <div class="section"><div class="section-header"><div class="section-title">ì—…ë¡œë“œ ì´ë ¥</div></div>
                        <div class="table-container"><table><thead><tr><th>ì—°ì›”</th><th class="text-right">ì´ë§¤ì¶œ</th><th class="text-right">ê±´ìˆ˜</th><th>ì—…ë¡œë“œì¼</th><th>ê´€ë¦¬</th></tr></thead><tbody id="uploadHistory"></tbody></table></div>
                    </div>
                </div>
            </div>
            <div class="tab-content" id="tab-expense">
                <div class="sub-tabs">
                    <div class="sub-tab active" data-sub="fixed">ê³ ì •ë¹„</div>
                    <div class="sub-tab" data-sub="variable">ìœ ë™ë¹„</div>
                    <div class="sub-tab" data-sub="payroll">ì¸ê±´ë¹„</div>
                    <div class="sub-tab" data-sub="tax">ì„¸ê¸ˆ</div>
                    <div class="sub-tab" data-sub="expense-summary">ì§€ì¶œ ë¶„ì„</div>
                </div>
                <div class="sub-content active" id="sub-fixed">
                    <div class="expense-summary">
                        <div class="expense-box"><div class="expense-box-label">ì›” ê³ ì •ë¹„ ì´ì•¡</div><div class="expense-box-value" id="fixedTotal">â‚©0</div></div>
                        <div class="expense-box"><div class="expense-box-label">í•­ëª© ìˆ˜</div><div class="expense-box-value" id="fixedCount">0ê°œ</div></div>
                        <div class="expense-box"><div class="expense-box-label">ì—°ê°„ ì˜ˆìƒ</div><div class="expense-box-value" id="fixedYearly">â‚©0</div></div>
                    </div>
                    <div class="section-header">
                        <div class="section-title">ê³ ì •ë¹„ ëª©ë¡</div>
                        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                            <input type="text" class="form-input" id="fixedSearch" placeholder="í•­ëª©ëª… ê²€ìƒ‰..." style="width:150px" oninput="renderExpenses()">
                            <select class="form-select" id="fixedCategoryFilter" onchange="renderExpenses()" style="width:auto"><option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option></select>
                            <select class="form-select" id="fixedSort" onchange="renderExpenses()" style="width:auto"><option value="date-desc">ë‚ ì§œ ìµœì‹ ìˆœ</option><option value="date-asc">ë‚ ì§œ ì˜¤ë˜ëœìˆœ</option><option value="amount-desc">ê¸ˆì•¡ ë†’ì€ìˆœ</option><option value="amount-asc">ê¸ˆì•¡ ë‚®ì€ìˆœ</option><option value="category">ì¹´í…Œê³ ë¦¬ìˆœ</option></select>
                            <button class="btn btn-primary" onclick="openExpenseModal('fixed')">+ í•­ëª© ì¶”ê°€</button>
                        </div>
                    </div>
                    <div class="table-container"><table><thead><tr><th>ë‚ ì§œ</th><th>í•­ëª©ëª…</th><th>ì¹´í…Œê³ ë¦¬</th><th class="text-right">ê¸ˆì•¡</th><th>ë¹„ê³ </th><th>ê´€ë¦¬</th></tr></thead><tbody id="fixedTable"></tbody></table></div>
                </div>
                <div class="sub-content" id="sub-variable">
                    <div class="expense-summary">
                        <div class="expense-box"><div class="expense-box-label">ì´ë²ˆ ë‹¬ ìœ ë™ë¹„</div><div class="expense-box-value" id="variableTotal">â‚©0</div></div>
                        <div class="expense-box"><div class="expense-box-label">ê±´ìˆ˜</div><div class="expense-box-value" id="variableCount">0ê±´</div></div>
                        <div class="expense-box"><div class="expense-box-label">ì „ì›” ëŒ€ë¹„</div><div class="expense-box-value" id="variableChange">-</div></div>
                    </div>
                    <div class="section-header"><div class="section-title">ìœ ë™ë¹„ ëª©ë¡</div><div><select class="form-select" id="variableSort" onchange="renderExpenses()" style="width:auto;display:inline-block;margin-right:8px"><option value="date-desc">ë‚ ì§œ ìµœì‹ ìˆœ</option><option value="date-asc">ë‚ ì§œ ì˜¤ë˜ëœìˆœ</option><option value="amount-desc">ê¸ˆì•¡ ë†’ì€ìˆœ</option><option value="amount-asc">ê¸ˆì•¡ ë‚®ì€ìˆœ</option><option value="category">ì¹´í…Œê³ ë¦¬ìˆœ</option></select><button class="btn btn-primary" onclick="openExpenseModal('variable')">+ í•­ëª© ì¶”ê°€</button></div></div>
                    <div class="table-container"><table><thead><tr><th>ê²°ì œì¼</th><th>í•­ëª©ëª…</th><th>ì¹´í…Œê³ ë¦¬</th><th>ê²°ì œìˆ˜ë‹¨</th><th class="text-right">ê¸ˆì•¡</th><th>ê´€ë¦¬</th></tr></thead><tbody id="variableTable"></tbody></table></div>
                </div>
                <div class="sub-content" id="sub-payroll">
                    <div class="expense-summary">
                        <div class="expense-box"><div class="expense-box-label">ì´ë²ˆ ë‹¬ ì´ ì¸ê±´ë¹„</div><div class="expense-box-value" id="payrollTotal">â‚©0</div></div>
                        <div class="expense-box"><div class="expense-box-label">ì°¨ì¸ì§€ê¸‰ì•¡ í•©ê³„</div><div class="expense-box-value" id="payrollNetTotal">â‚©0</div></div>
                        <div class="expense-box"><div class="expense-box-label">ì§ì› ìˆ˜</div><div class="expense-box-value" id="payrollCount">0ëª…</div></div>
                    </div>
                    <div class="section-header"><div class="section-title">ê¸‰ì—¬ëŒ€ì¥ ì—…ë¡œë“œ</div></div>
                    <div class="upload-area" onclick="document.getElementById('payrollFile').click()" style="margin-bottom:24px">
                        <div class="upload-icon">ğŸ“‹</div>
                        <div class="upload-text">ê¸‰ì—¬ëŒ€ì¥ ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</div>
                        <div class="upload-hint">ì§€ì› í˜•ì‹: .xlsx, .xls</div>
                        <input type="file" id="payrollFile" accept=".xlsx,.xls" style="display:none" onchange="processPayrollFile(this)">
                    </div>
                    <div class="section-header"><div class="section-title">ì›”ë³„ ê¸‰ì—¬ ë‚´ì—­ (ë…¸ë¬´ì‚¬ ê¸‰ì—¬ëŒ€ì¥)</div><div><select class="form-select" id="payrollMonth" onchange="renderPayroll()" style="width:auto"><option value="">ì „ì²´</option></select></div></div>
                    <div class="table-container"><table><thead><tr><th>ì§€ê¸‰ì›”</th><th>ì§ì›ëª…</th><th class="text-right">OTìˆ˜ë‹¹</th><th class="text-right">ì¸ì„¼í‹°ë¸Œ</th><th class="text-right">ì‹¤ìˆ˜ë ¹ì•¡</th><th>ê´€ë¦¬</th></tr></thead><tbody id="payrollTable"></tbody></table></div>
                </div>
                <div class="sub-content" id="sub-tax">
                    <div class="expense-summary">
                        <div class="expense-box"><div class="expense-box-label">ì˜¬í•´ ì›ì²œì„¸</div><div class="expense-box-value" id="withholdingTotal">â‚©0</div></div>
                        <div class="expense-box"><div class="expense-box-label">ì˜¬í•´ ë¶€ê°€ì„¸</div><div class="expense-box-value" id="vatTotal">â‚©0</div></div>
                        <div class="expense-box"><div class="expense-box-label">ì˜¬í•´ ì¢…ì†Œì„¸</div><div class="expense-box-value" id="incomeTotal">â‚©0</div></div>
                        <div class="expense-box"><div class="expense-box-label">ì„¸ê¸ˆ í•©ê³„</div><div class="expense-box-value" id="taxTotal">â‚©0</div></div>
                    </div>
                    <div class="section-header"><div class="section-title">ğŸ“„ ì„¸ê¸ˆ ê³ ì§€ì„œ ì—…ë¡œë“œ</div></div>
                    <div class="upload-area" id="taxDropZone" style="margin-bottom:24px">
                        <div class="upload-icon">ğŸ“‹</div>
                        <div class="upload-text">ì„¸ê¸ˆ ê³ ì§€ì„œ PDF/ì´ë¯¸ì§€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­</div>
                        <div class="upload-hint">ë¶€ê°€ì„¸, ì¢…ì†Œì„¸, ì›ì²œì„¸(ê·¼ë¡œì†Œë“ì„¸), ì§€ë°©ì„¸ ë‚©ë¶€ì„œ ìë™ ì¸ì‹</div>
                        <input type="file" id="taxFile" accept=".pdf,image/*" style="display:none" onchange="processTaxFile(this)" multiple>
                    </div>
                    <div class="section-header"><div class="section-title">ì›ì²œì„¸ (ê·¼ë¡œì†Œë“ì„¸+ì§€ë°©ì„¸)</div><button class="btn btn-primary" onclick="openTaxModal('withholding')">+ ì›ì²œì„¸ ì¶”ê°€</button></div>
                    <div class="table-container"><table><thead><tr><th>ë‚©ë¶€ì¼</th><th>ê·€ì†ì›”</th><th>ê·¼ë¡œì†Œë“ì„¸</th><th>ì§€ë°©ì†Œë“ì„¸</th><th class="text-right">í•©ê³„</th><th>ë¹„ê³ </th><th>ê´€ë¦¬</th></tr></thead><tbody id="withholdingTable"></tbody></table></div>
                    <div class="section-header" style="margin-top:24px"><div class="section-title">ë¶€ê°€ì„¸ (ë¶„ê¸°ë³„)</div><button class="btn btn-primary" onclick="openTaxModal('vat')">+ ë¶€ê°€ì„¸ ì¶”ê°€</button></div>
                    <div class="table-container"><table><thead><tr><th>ë‚©ë¶€ì¼</th><th>ë¶„ê¸°/ê¸°ê°„</th><th class="text-right">ë‚©ë¶€ì„¸ì•¡</th><th>ë¹„ê³ </th><th>ê´€ë¦¬</th></tr></thead><tbody id="vatTable"></tbody></table></div>
                    <div class="section-header" style="margin-top:24px"><div class="section-title">ì¢…í•©ì†Œë“ì„¸</div><button class="btn btn-primary" onclick="openTaxModal('income')">+ ì¢…ì†Œì„¸ ì¶”ê°€</button></div>
                    <div class="table-container"><table><thead><tr><th>ë‚©ë¶€ì¼</th><th>ê·€ì†ì—°ë„</th><th>êµ¬ë¶„</th><th class="text-right">ë‚©ë¶€ì„¸ì•¡</th><th>ë¹„ê³ </th><th>ê´€ë¦¬</th></tr></thead><tbody id="incomeTable"></tbody></table></div>
                </div>
                <div class="sub-content" id="sub-expense-summary">
                    <div class="card-grid">
                        <div class="card"><div class="card-title">ì›” ì´ ì§€ì¶œ</div><div class="card-value" id="totalExpense">â‚©0</div><div class="card-sub">ê³ ì •ë¹„ + ìœ ë™ë¹„</div></div>
                        <div class="card"><div class="card-title">ì›” ë§¤ì¶œ</div><div class="card-value" id="monthRevenue">â‚©0</div><div class="card-sub" id="monthRevenueDate">-</div></div>
                        <div class="card"><div class="card-title">ì›” ìˆ˜ìµ (ì¶”ì •)</div><div class="card-value" id="monthProfit">â‚©0</div><div class="card-sub">ë§¤ì¶œ - ì§€ì¶œ</div></div>
                        <div class="card"><div class="card-title">ìˆ˜ìµë¥ </div><div class="card-value" id="profitRate">0%</div><div class="card-sub">ìˆ˜ìµ/ë§¤ì¶œ</div></div>
                    </div>
                    <div class="section-header"><div class="section-title">ì›”ë³„ ì§€ì¶œ ì¶”ì´</div></div>
                    <div class="chart-container"><canvas id="expenseChart"></canvas></div>
                    <div class="section-header" style="margin-top:24px"><div class="section-title">ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ</div></div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px">
                        <div><h4 style="margin-bottom:12px">ê³ ì •ë¹„</h4><div id="fixedByCategory"></div></div>
                        <div><h4 style="margin-bottom:12px">ìœ ë™ë¹„</h4><div id="variableByCategory"></div></div>
                    </div>
                </div>
            </div>
            <div class="tab-content" id="tab-employee">
                <div class="sub-tabs">
                    <div class="sub-tab active" data-sub="list">ì§ì› ëª©ë¡</div>
                    <div class="sub-tab" data-sub="leave">ì—°ì°¨ ê´€ë¦¬</div>
                    <div class="sub-tab" data-sub="attendance">ê·¼íƒœ í˜„í™©</div>
                    <div class="sub-tab" data-sub="overtime">ì˜¤ë²„íƒ€ì„</div>
                    <div class="sub-tab" data-sub="incentive">ì¸ì„¼í‹°ë¸Œ</div>
                    <div class="sub-tab" data-sub="salary">ì‚¬ì „ê¸‰ì—¬ëŒ€ì¥</div>
                    <div class="sub-tab" data-sub="settings">ì•± ì„¤ì •</div>
                </div>
                <div class="sub-content active" id="sub-list">
                    <div class="section-header"><div class="section-title">ì§ì› ëª©ë¡</div><button class="btn btn-primary" onclick="openEmployeeModal()">+ ì§ì› ë“±ë¡</button></div>
                    <div class="table-container"><table><thead><tr><th>ì´ë¦„</th><th>ë§¤ì¹­ëª…</th><th>ì§ê¸‰</th><th>ì…ì‚¬ì¼</th><th>ê·¼ì†</th><th>ì—°ì°¨í˜„í™©</th><th>ì—°ë´‰</th><th>ì‹œê¸‰</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead><tbody id="employeeTable"></tbody></table></div>
                </div>
                <div class="sub-content" id="sub-leave">
                    <!-- 2026ë…„ í™©ê¸ˆì—°íœ´ ìº˜ë¦°ë” -->
                    <div class="card" style="margin-bottom:1.5rem">
                        <div class="card-title">ğŸ“… 2026ë…„ í™©ê¸ˆì—°íœ´ & ìƒŒë“œìœ„ì¹˜ íœ´ì¼</div>
                        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem;margin-top:1rem" id="goldenHolidayGrid"></div>
                    </div>

```
                <!-- ì§ì›ë³„ ì—°ì°¨ í˜„í™© -->
                <div class="card" style="margin-bottom:1.5rem">
                    <div class="card-title">ğŸ‘¥ ì§ì›ë³„ ì—°ì°¨ í˜„í™©</div>
                    <div class="table-container"><table><thead><tr><th>ì§ì›</th><th>ì´ ì—°ì°¨</th><th>ì‚¬ìš©</th><th>ì”ì—¬</th><th>ì‚¬ìš© ë‚´ì—­</th></tr></thead><tbody id="leaveStatusTable"></tbody></table></div>
                </div>
                
                <!-- ì—°ì°¨ ìŠ¹ì¸ ëŒ€ê¸° -->
                <div class="card">
                    <div class="card-title">â³ ì—°ì°¨ ì‹ ì²­ ìŠ¹ì¸ ëŒ€ê¸° <span class="badge badge-orange" id="pendingLeaveCount">0</span></div>
                    <div class="table-container"><table><thead><tr><th>ì‹ ì²­ì¼</th><th>ì§ì›</th><th>ìœ í˜•</th><th>ì‹ ì²­ ë‚ ì§œ</th><th>ì‚¬ìœ </th><th>ì²˜ë¦¬</th></tr></thead><tbody id="pendingLeaveTable"></tbody></table></div>
                </div>
                
                <!-- ìŠ¹ì¸ëœ ì—°ì°¨ ëª©ë¡ -->
                <div class="card" style="margin-top:1.5rem">
                    <div class="card-title">âœ… ìŠ¹ì¸ëœ ì—°ì°¨ ë‚´ì—­</div>
                    <div style="display:flex;gap:.5rem;margin-bottom:1rem">
                        <select class="form-select" id="leaveYearFilter" style="width:auto" onchange="renderApprovedLeaves()">
                            <option value="2026">2026ë…„</option>
                            <option value="2025">2025ë…„</option>
                        </select>
                        <select class="form-select" id="leaveEmployeeFilter" style="width:auto" onchange="renderApprovedLeaves()">
                            <option value="all">ì „ì²´ ì§ì›</option>
                        </select>
                    </div>
                    <div class="table-container"><table><thead><tr><th>ì§ì›</th><th>ìœ í˜•</th><th>ë‚ ì§œ</th><th>ì‚¬ìœ </th><th>ìŠ¹ì¸ì¼</th><th>ê´€ë¦¬</th></tr></thead><tbody id="approvedLeaveTable"></tbody></table></div>
                </div>
            </div>
            <div class="sub-content" id="sub-settings">
                <div class="card" style="max-width:500px">
                    <div class="card-title">ğŸ”§ ì§ì›ì•± ì„¤ì •</div>
                    <div class="form-group">
                        <label class="form-label">ìë™ ë¡œê·¸ì•„ì›ƒ ì‹œê°„ (ë¶„)</label>
                        <input type="number" class="form-input" id="autoLogoutMinutes" value="10" min="0" max="60">
                        <p style="font-size:.8rem;color:var(--text-muted);margin-top:.5rem">0ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ìë™ ë¡œê·¸ì•„ì›ƒ ë¹„í™œì„±í™”</p>
                    </div>
                    <button class="btn btn-primary" onclick="saveStaffSettings()">ì„¤ì • ì €ì¥</button>
                </div>
            </div>
            <div class="sub-content" id="sub-attendance">
                <div class="cards-grid">
                    <div class="card"><div class="card-label">ì´ë²ˆ ë‹¬ ì¶œê·¼ì¼</div><div class="card-value" id="workDays">0ì¼</div></div>
                    <div class="card"><div class="card-label">ì§€ê°</div><div class="card-value" id="lateDays">0íšŒ</div></div>
                    <div class="card"><div class="card-label">ì¡°í‡´</div><div class="card-value" id="earlyDays">0íšŒ</div></div>
                    <div class="card"><div class="card-label">ê²°ê·¼</div><div class="card-value" id="absentDays">0íšŒ</div></div>
                </div>
                <div class="section-header"><div class="section-title">ê·¼íƒœ ê¸°ë¡</div><select class="form-select" id="attendanceFilter" style="width:auto" onchange="renderAttendance()"><option value="all">ì „ì²´ ì§ì›</option></select></div>
                <div class="table-container"><table><thead><tr><th>ë‚ ì§œ</th><th>ì§ì›</th><th>ì¶œê·¼</th><th>í‡´ê·¼</th><th>ê·¼ë¬´ì‹œê°„</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead><tbody id="attendanceTable"></tbody></table></div>
            </div>
            <div class="sub-content" id="sub-overtime">
                <div class="cards-grid">
                    <div class="card"><div class="card-label">ì´ë²ˆ ë‹¬ ì´ ì˜¤ë²„íƒ€ì„</div><div class="card-value" id="totalOT">0ì‹œê°„</div></div>
                    <div class="card"><div class="card-label">ì €ë… OT (ìë™)</div><div class="card-value" id="eveningOT">0ì‹œê°„</div></div>
                    <div class="card"><div class="card-label">ì ì‹¬ OT (ìˆ˜ë™)</div><div class="card-value" id="lunchOTVal">0ì‹œê°„</div></div>
                    <div class="card"><div class="card-label">OT ìˆ˜ë‹¹ í•©ê³„</div><div class="card-value" id="totalOTPay">â‚©0</div></div>
                </div>
                <div class="section-header"><div class="section-title">ì ì‹¬ OT ì…ë ¥</div><button class="btn btn-primary" onclick="openOTModal()">+ OT ì…ë ¥</button></div>
                <div class="table-container"><table><thead><tr><th>ë‚ ì§œ</th><th>ì§ì›</th><th>ì‹œê°„(ë¶„)</th><th>ì‚¬ìœ </th><th>ê´€ë¦¬</th></tr></thead><tbody id="lunchOTTable"></tbody></table></div>
            </div>
            <div class="sub-content" id="sub-incentive">
                <div class="section-header"><div class="section-title">ì¸ì„¼í‹°ë¸Œ í•­ëª© ê´€ë¦¬</div><button class="btn btn-primary" onclick="openIncentiveItemModal()">+ í•­ëª© ì¶”ê°€</button></div>
                <div class="table-container"><table><thead><tr><th>í•­ëª©ëª…</th><th>ìœ í˜•/ë‹¨ê°€</th><th>ì ìš© ì§ì›</th><th>ê´€ë¦¬</th></tr></thead><tbody id="incentiveItemTable"></tbody></table></div>
                <div class="section-header mt-1"><div class="section-title">ì§ì›ë³„ ì¸ì„¼í‹°ë¸Œ í˜„í™©</div></div>
                <div class="table-container"><table><thead><tr><th>ì§ì›</th><th>ì§ê¸‰</th><th class="text-right">ë§¤ì¶œ ì¸ì„¼í‹°ë¸Œ</th><th class="text-right">ì¼ë³¸ì¸ ë§¤ì¶œ ì¸ì„¼í‹°ë¸Œ</th><th class="text-right">í•©ê³„</th></tr></thead><tbody id="incentiveSummaryTable"></tbody></table></div>
            </div>
            <div class="sub-content" id="sub-salary">
                <div class="section-header"><div class="section-title">ì‚¬ì „ê¸‰ì—¬ëŒ€ì¥ (ë…¸ë¬´ì‚¬ ì „ë‹¬ìš©)</div><button class="btn btn-secondary" onclick="exportPrePayroll()">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button></div>
                <p style="color:var(--text-secondary);font-size:.85rem;margin-bottom:1rem">ì§ì›ë³„ ì§ê¸‰, OTì‹œê°„, ì¸ì„¼í‹°ë¸Œ ì‹¤ì ì„ ì •ë¦¬í•˜ì—¬ ë…¸ë¬´ì‚¬ì—ê²Œ ì „ë‹¬í•©ë‹ˆë‹¤.</p>
                <div class="table-container"><table><thead><tr><th>ì§ì›</th><th>ì§ê¸‰</th><th>ì—°ë´‰</th><th class="text-right">OTì‹œê°„</th><th class="text-right">ì˜ˆìƒOTìˆ˜ë‹¹</th><th class="text-right">ì¸ì„¼í‹°ë¸Œ ì‹¤ì </th><th class="text-right">ì˜ˆìƒ ì¸ì„¼í‹°ë¸Œ</th></tr></thead><tbody id="prePayrollTable"></tbody></table></div>
            </div>
        </div>
    </main>
</div>

<!-- Modals -->
<div class="modal" id="employeeModal">
    <div class="modal-content">
        <div class="modal-header"><div class="modal-title" id="employeeModalTitle">ì§ì› ë“±ë¡</div><button class="modal-close" onclick="closeModal('employeeModal')">&times;</button></div>
        <div class="modal-body">
            <input type="hidden" id="empEditId">
            <div class="form-row">
                <div class="form-group"><label class="form-label">ì´ë¦„ *</label><input type="text" class="form-input" id="empName" required></div>
                <div class="form-group"><label class="form-label">ë§¤ì¹­ ì´ë¦„ (ì—‘ì…€)</label><input type="text" class="form-input" id="empMatchName" placeholder="ì—‘ì…€ ë‹´ë‹¹ì§ì›ëª…"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">ì§ê¸‰ *</label><select class="form-select" id="empRole"><option value="doctor">ì›ì¥</option><option value="nurse">ê°„í˜¸ì‚¬</option><option value="coordinator">ì½”ë””ë„¤ì´í„°</option><option value="marketing">ë§ˆì¼€íŒ…</option><option value="manager">ì‹¤ì¥</option><option value="esthetician">í”¼ë¶€ê´€ë¦¬ì‚¬</option></select></div>
                <div class="form-group"><label class="form-label">ì…ì‚¬ì¼ *</label><input type="date" class="form-input" id="empJoinDate" required></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">ì—°ë´‰ (ë§Œì›)</label><input type="number" class="form-input" id="empSalary" placeholder="ì˜ˆ: 3000 (3ì²œë§Œì›)"></div>
                <div class="form-group"><label class="form-label">ì‹œê¸‰ (ìë™ê³„ì‚°: ì—°ë´‰Ã·2508)</label><input type="number" class="form-input" id="empHourly" value="12000" readonly style="background:#f5f5f0"></div>
                <div class="form-group"><label class="form-label">ì¸ì„¼í‹°ë¸Œ ìœ í˜•</label><select class="form-select" id="empIncentiveType"><option value="none">ì—†ìŒ</option><option value="staff_sales">ë‹´ë‹¹ì§ì› ë§¤ì¶œ 1%</option><option value="per_case">ê±´ë³„ ì¸ì„¼í‹°ë¸Œ</option><option value="special_treatment">íŠ¹ì • ì‹œìˆ  (í¬ë‹¤ì´ìŠ¤/ìœ„ë„ˆí™•ì¥/í”¼ì§€ì„ )</option><option value="japan_direct">ì¼ë³¸ì¸ ì§ì ‘ë§¤ì¶œ (ë‹´ë‹¹ì§ì› ì œì™¸)</option></select></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">ìƒë…„ì›”ì¼</label><input type="date" class="form-input" id="empBirthday"></div>
                <div class="form-group"><label class="form-label">ìƒíƒœ</label><select class="form-select" id="empStatus"><option value="active">ì¬ì§</option><option value="inactive">í‡´ì‚¬</option></select></div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">ì—°ì°¨ (ë²•ì • ìë™ê³„ì‚°: <span id="autoAnnualLeave">0</span>ì¼)</label>
                    <input type="number" class="form-input" id="empAnnualLeave" placeholder="ë¯¸ì…ë ¥ì‹œ ìë™ê³„ì‚°">
                    <p style="font-size:.75rem;color:var(--text-muted);margin-top:.25rem">ê°œë³„ ì„¤ì • ì‹œ ì…ë ¥, ë¹„ìš°ë©´ ë²•ì • ê¸°ì¤€ ìë™</p>
                </div>
                <div class="form-group">
                    <label class="form-label">ì‚¬ìš© ì—°ì°¨</label>
                    <input type="number" class="form-input" id="empUsedLeave" value="0" min="0">
                </div>
            </div>
            <input type="hidden" id="empId">
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('employeeModal')">ì·¨ì†Œ</button><button class="btn btn-primary" onclick="saveEmployee()">ì €ì¥</button></div>
    </div>
</div>
<div class="modal" id="taxModal">
    <div class="modal-content">
        <div class="modal-header"><div class="modal-title" id="taxModalTitle">ì„¸ê¸ˆ ì¶”ê°€</div><button class="modal-close" onclick="closeModal('taxModal')">&times;</button></div>
        <div class="modal-body">
            <input type="hidden" id="taxEditId"><input type="hidden" id="taxType">
            <div class="form-group"><label class="form-label">ë‚©ë¶€ì¼ *</label><input type="date" class="form-input" id="taxDate" required></div>
            <div id="withholdingFields" style="display:none">
                <div class="form-group"><label class="form-label">ê·€ì†ì›”</label><input type="month" class="form-input" id="taxAttributeMonth"></div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">ê·¼ë¡œì†Œë“ì„¸</label><input type="number" class="form-input" id="taxIncomeTax" placeholder="0"></div>
                    <div class="form-group"><label class="form-label">ì§€ë°©ì†Œë“ì„¸</label><input type="number" class="form-input" id="taxLocalTax" placeholder="0"></div>
                </div>
            </div>
            <div id="vatFields" style="display:none">
                <div class="form-group"><label class="form-label">ë¶„ê¸°/ê¸°ê°„</label><select class="form-select" id="taxQuarter"><option value="1ê¸°">1ê¸° (1~6ì›”)</option><option value="2ê¸°">2ê¸° (7~12ì›”)</option><option value="1ê¸°ì˜ˆì •">1ê¸° ì˜ˆì •</option><option value="1ê¸°í™•ì •">1ê¸° í™•ì •</option><option value="2ê¸°ì˜ˆì •">2ê¸° ì˜ˆì •</option><option value="2ê¸°í™•ì •">2ê¸° í™•ì •</option></select></div>
            </div>
            <div id="incomeFields" style="display:none">
                <div class="form-group"><label class="form-label">ê·€ì†ì—°ë„</label><select class="form-select" id="taxYear"><option value="2024">2024ë…„</option><option value="2025">2025ë…„</option><option value="2026">2026ë…„</option></select></div>
                <div class="form-group"><label class="form-label">êµ¬ë¶„</label><select class="form-select" id="taxIncomeType"><option value="ì¤‘ê°„ì˜ˆë‚©">ì¤‘ê°„ì˜ˆë‚©</option><option value="í™•ì •ì‹ ê³ ">í™•ì •ì‹ ê³ </option><option value="ë¶„ë‚©">ë¶„ë‚©</option></select></div>
            </div>
            <div class="form-group"><label class="form-label">ë‚©ë¶€ì„¸ì•¡ *</label><input type="number" class="form-input" id="taxAmount" required></div>
            <div class="form-group"><label class="form-label">ë¹„ê³ </label><textarea class="form-textarea" id="taxNote" rows="2"></textarea></div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('taxModal')">ì·¨ì†Œ</button><button class="btn btn-primary" onclick="saveTax()">ì €ì¥</button></div>
    </div>
</div>
<div class="modal" id="expenseModal">
    <div class="modal-content" style="max-width:550px">
        <div class="modal-header"><div class="modal-title" id="expenseModalTitle">ì§€ì¶œ ì¶”ê°€</div><button class="modal-close" onclick="closeModal('expenseModal')">&times;</button></div>
        <div class="modal-body">
            <input type="hidden" id="expenseEditId"><input type="hidden" id="expenseType">
            <div class="form-group" id="expenseDateGroup"><label class="form-label">ê²°ì œì¼</label><input type="date" class="form-input" id="expenseDate"></div>
            <div class="form-group"><label class="form-label">í•­ëª©ëª… *</label><input type="text" class="form-input" id="expenseName" required></div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">ì¹´í…Œê³ ë¦¬</label><select class="form-select" id="expenseCategory" onchange="toggleLeaseFields()"></select></div>
                <div class="form-group"><label class="form-label">ê¸ˆì•¡ *</label><input type="number" class="form-input" id="expenseAmount" required></div>
            </div>
            <div id="leaseFields" style="display:none;background:#f9f9f7;padding:16px;border-radius:8px;margin-bottom:16px">
                <div style="font-weight:600;margin-bottom:12px;color:var(--accent-gold)">ğŸ“‹ ì¥ë¹„ ë¦¬ìŠ¤ ì •ë³´</div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">ë¦¬ìŠ¤ ì‹œì‘ì¼</label><input type="date" class="form-input" id="leaseStartDate"></div>
                    <div class="form-group"><label class="form-label">ë¦¬ìŠ¤ ì¢…ë£Œì¼</label><input type="date" class="form-input" id="leaseEndDate"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">ê²°ì œì¼ (ë§¤ì›”)</label><input type="number" class="form-input" id="leasePaymentDay" min="1" max="31" placeholder="ì˜ˆ: 26"></div>
                    <div class="form-group"><label class="form-label">ê²°ì œìˆ˜ë‹¨</label><select class="form-select" id="leasePaymentMethod"><option value="ë¡¯ë°ì¹´ë“œ">ë¡¯ë°ì¹´ë“œ</option><option value="ì‚¼ì„±ì¹´ë“œ">ì‚¼ì„±ì¹´ë“œ</option><option value="ì‹ í•œì¹´ë“œ">ì‹ í•œì¹´ë“œ</option><option value="í˜„ëŒ€ì¹´ë“œ">í˜„ëŒ€ì¹´ë“œ</option><option value="KBì¹´ë“œ">KBì¹´ë“œ</option><option value="ìš°ë¦¬ì¹´ë“œ">ìš°ë¦¬ì¹´ë“œ</option><option value="ê³„ì¢Œì´ì²´">ê³„ì¢Œì´ì²´</option><option value="í˜„ê¸ˆ">í˜„ê¸ˆ</option></select></div>
                </div>
                <div class="form-group"><label class="form-label">ë¦¬ìŠ¤ì‚¬</label><input type="text" class="form-input" id="leaseCompany" placeholder="ì˜ˆ: ì˜¤ë¦­ìŠ¤, ë©”ë¦¬ì¸ "></div>
            </div>
            <div class="form-group" id="expenseCardGroup"><label class="form-label">ê²°ì œìˆ˜ë‹¨</label><select class="form-select" id="expenseCard"><option value="ë¡¯ë°ì¹´ë“œ">ë¡¯ë°ì¹´ë“œ</option><option value="ì‚¼ì„±ì¹´ë“œ">ì‚¼ì„±ì¹´ë“œ</option><option value="ì‹ í•œì¹´ë“œ">ì‹ í•œì¹´ë“œ</option><option value="í˜„ëŒ€ì¹´ë“œ">í˜„ëŒ€ì¹´ë“œ</option><option value="KBì¹´ë“œ">KBì¹´ë“œ</option><option value="ê³„ì¢Œì´ì²´">ê³„ì¢Œì´ì²´</option><option value="í˜„ê¸ˆ">í˜„ê¸ˆ</option></select></div>
            <div class="form-group"><label class="form-label">ë¹„ê³ </label><textarea class="form-textarea" id="expenseNote" rows="2"></textarea></div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('expenseModal')">ì·¨ì†Œ</button><button class="btn btn-primary" onclick="saveExpense()">ì €ì¥</button></div>
    </div>
</div>
<div class="modal" id="otModal">
    <div class="modal-content">
        <div class="modal-header"><div class="modal-title">ì ì‹¬ OT ì…ë ¥</div><button class="modal-close" onclick="closeModal('otModal')">&times;</button></div>
        <div class="modal-body">
            <div class="form-row">
                <div class="form-group"><label class="form-label">ë‚ ì§œ</label><input type="date" class="form-input" id="otDate"></div>
                <div class="form-group"><label class="form-label">ì§ì›</label><select class="form-select" id="otEmployee"></select></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">ì‹œê°„ (ë¶„)</label><input type="number" class="form-input" id="otMinutes" value="30"></div>
                <div class="form-group"><label class="form-label">ì‚¬ìœ </label><input type="text" class="form-input" id="otReason" placeholder="ì˜ˆ: ì ì‹¬ì‹œê°„ ê·¼ë¬´"></div>
            </div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('otModal')">ì·¨ì†Œ</button><button class="btn btn-primary" onclick="saveLunchOT()">ì €ì¥</button></div>
    </div>
</div>
<div class="modal" id="incentiveItemModal">
    <div class="modal-content">
        <div class="modal-header"><div class="modal-title" id="incentiveItemModalTitle">ì¸ì„¼í‹°ë¸Œ í•­ëª© ì¶”ê°€</div><button class="modal-close" onclick="closeModal('incentiveItemModal')">&times;</button></div>
        <div class="modal-body">
            <input type="hidden" id="incItemEditId">
            <div class="form-group"><label class="form-label">í•­ëª©ëª… *</label><input type="text" class="form-input" id="incItemName" placeholder="ì˜ˆ: ê´€ë¦¬ ì§€ì •, ì‹œìˆ  ë³´ì¡°, ì¼ë³¸ì¸ ë§¤ì¶œ"></div>
            <div class="form-group"><label class="form-label">ì¸ì„¼í‹°ë¸Œ ìœ í˜•</label>
                <select class="form-select" id="incItemType" onchange="toggleIncItemFields()">
                    <option value="perCase">ê±´ë³„ ë‹¨ê°€</option>
                    <option value="japanSales">ì¼ë³¸ì¸ ë³¸ì¸ ìƒë‹´ë§¤ì¶œ %</option>
                </select>
            </div>
            <div id="perCaseFields">
                <div class="form-group"><label class="form-label">ë‹¨ê°€ (ê±´ë‹¹)</label><input type="number" class="form-input" id="incItemPrice" value="50000"></div>
            </div>
            <div id="japanSalesFields" style="display:none">
                <div class="form-group"><label class="form-label">ì ìš© ë¹„ìœ¨ (%)</label><input type="number" class="form-input" id="incItemPercent" value="1" step="0.1" min="0" max="100"></div>
                <div class="form-group" style="background:#f5f5f0;padding:12px;border-radius:8px;font-size:.85rem;color:var(--text-secondary)">
                    <strong>ğŸ’¡ ì¼ë³¸ì¸ ë³¸ì¸ ìƒë‹´ë§¤ì¶œ ì¸ì„¼í‹°ë¸Œ</strong><br>
                    ë§¤ì¶œ íŒŒì¼ ë¶„ì„ ì‹œ ì¼ë³¸ì¸ ë§¤ì¶œ ì¤‘ í•´ë‹¹ ì§ì›ì´ ë‹´ë‹¹í•œ ë§¤ì¶œì—ì„œ ì„¤ì •ëœ ë¹„ìœ¨ë§Œí¼ ì¸ì„¼í‹°ë¸Œê°€ ê³„ì‚°ë©ë‹ˆë‹¤.
                </div>
            </div>
            <div class="form-group"><label class="form-label">ì ìš© ì§ì› (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)</label><div id="incItemEmployees" style="max-height:200px;overflow-y:auto;border:1px solid var(--border-color);padding:.75rem;background:#fff"></div></div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('incentiveItemModal')">ì·¨ì†Œ</button><button class="btn btn-primary" onclick="saveIncentiveItem()">ì €ì¥</button></div>
    </div>
</div>

<script>
    // Firebase Configuration
    const firebaseConfig={apiKey:"AIzaSyDnkKNXNnDVlcPd5Y1fl59YysdeEZi7uJU",authDomain:"lumiclinic-c1a95.firebaseapp.com",projectId:"lumiclinic-c1a95",storageBucket:"lumiclinic-c1a95.firebasestorage.app",messagingSenderId:"901456209944",appId:"1:901456209944:web:f287418cd0541f324d3b6d"};
    firebase.initializeApp(firebaseConfig);
    const db=firebase.firestore();

    // Global State
    let currentYear=new Date().getFullYear();
    let currentMonth=new Date().getMonth()+1;
    let employees=[],attendance=[],revenueData={},salesDetail={},fixedExpenses=[],variableExpenses=[],incentiveItems=[],lunchOT=[],incentiveRecords=[],leaveRequests=[];
    let vatTaxes=[],incomeTaxes=[],payrollData=[],withholdingTaxes=[];
    const roleLabels={doctor:'ì›ì¥',nurse:'ê°„í˜¸ì‚¬',coordinator:'ì½”ë””ë„¤ì´í„°',marketing:'ë§ˆì¼€íŒ…',manager:'ì‹¤ì¥',esthetician:'í”¼ë¶€ê´€ë¦¬ì‚¬'};
    let revenueChart=null,compareChart=null;

    // 2024ë…„ ë°ì´í„°
    const data2024={1:{total:243000000,japan:48000000,japanVisitors:32},2:{total:258000000,japan:52000000,japanVisitors:35},3:{total:199000000,japan:38000000,japanVisitors:25},4:{total:210000000,japan:42000000,japanVisitors:28},5:{total:195000000,japan:39000000,japanVisitors:26},6:{total:183000000,japan:36000000,japanVisitors:24},7:{total:169000000,japan:34000000,japanVisitors:23},8:{total:168000000,japan:33000000,japanVisitors:22},9:{total:192000000,japan:38000000,japanVisitors:25},10:{total:186000000,japan:37000000,japanVisitors:25},11:{total:194000000,japan:39000000,japanVisitors:26},12:{total:200000000,japan:40000000,japanVisitors:27}};

    // Utility Functions
    function formatCurrency(num){return num?'â‚©'+Math.round(num).toLocaleString():'â‚©0';}
    function formatNumber(num){return num?Math.round(num).toLocaleString():'0';}
    function getYM(){return `${currentYear}-${String(currentMonth).padStart(2,'0')}`;}
    function togglePw(id,btn){const input=document.getElementById(id);if(input.type==='password'){input.type='text';btn.textContent='ğŸ™ˆ';}else{input.type='password';btn.textContent='ğŸ‘';}}
    function closeModal(id){document.getElementById(id).classList.remove('active');}
    function openModal(id){document.getElementById(id).classList.add('active');}

    function generateEmployeeId(name,joinDate){
        const year=joinDate?joinDate.substring(2,4):String(new Date().getFullYear()).substring(2);
        const initials=getKoreanInitials(name).toLowerCase();
        return year+initials;
    }

    function getKoreanInitials(name){
        const CHO=['ã„±','ã„²','ã„´','ã„·','ã„¸','ã„¹','ã…','ã…‚','ã…ƒ','ã……','ã…†','ã…‡','ã…ˆ','ã…‰','ã…Š','ã…‹','ã…Œ','ã…','ã…'];
        const ALPHA=['g','kk','n','d','tt','r','m','b','pp','s','ss','o','j','jj','ch','k','t','p','h'];
        let result='';
        for(let i=0;i<name.length&&result.length<3;i++){
            const code=name.charCodeAt(i);
            if(code>=0xAC00&&code<=0xD7A3){const idx=Math.floor((code-0xAC00)/588);result+=ALPHA[idx];}
            else if(/[a-zA-Z]/.test(name[i])){result+=name[i].toLowerCase();}
        }
        return result.substring(0,3).padEnd(3,'x');
    }

    function getYearsOfService(joinDate){
        if(!joinDate)return'-';
        const join=new Date(joinDate);const now=new Date();
        const years=Math.floor((now-join)/(365.25*24*60*60*1000));
        return years<1?'1ë…„ ë¯¸ë§Œ':`${years+1}ë…„ì°¨`;
    }

    function getAge(birthday){
        if(!birthday)return'-';
        const birth=new Date(birthday);const now=new Date();
        let age=now.getFullYear()-birth.getFullYear();
        const m=now.getMonth()-birth.getMonth();
        if(m<0||(m===0&&now.getDate()<birth.getDate()))age--;
        return age+'ì„¸';
    }

    function formatBirthday(birthday){
        if(!birthday)return'-';
        const d=new Date(birthday);
        return `${d.getMonth()+1}ì›” ${d.getDate()}ì¼`;
    }

    // Authentication
    const ADMIN_ID='adminhighgo';
    const ADMIN_PW='gndls-asdk!jd-As';
    function handleAdminLogin(){
        const id=document.getElementById('adminId').value.trim();
        const pw=document.getElementById('adminPw').value;
        document.getElementById('loginError').textContent='';
        if(id===ADMIN_ID&&pw===ADMIN_PW){
            localStorage.setItem('lumi_admin_auth','true');
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appContainer').classList.add('active');
            initApp();
        }else{document.getElementById('loginError').textContent='ID ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';}
    }
    function logout(){localStorage.removeItem('lumi_admin_auth');location.reload();}
    function checkAuth(){
        if(localStorage.getItem('lumi_admin_auth')==='true'){
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appContainer').classList.add('active');
            initApp();
        }
    }

    // Tab Navigation
    document.querySelectorAll('.nav-tab').forEach(tab=>{
        tab.addEventListener('click',function(){
            document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
            this.classList.add('active');
            document.getElementById('tab-'+this.dataset.tab).classList.add('active');
        });
    });
    document.querySelectorAll('.sub-tab').forEach(tab=>{
        tab.addEventListener('click',function(){
            const parent=this.closest('.tab-content');
            parent.querySelectorAll('.sub-tab').forEach(t=>t.classList.remove('active'));
            parent.querySelectorAll('.sub-content').forEach(c=>c.classList.remove('active'));
            this.classList.add('active');
            document.getElementById('sub-'+this.dataset.sub).classList.add('active');
        });
    });

    // Month Selector
    function initMonthSelector(){
        const yearSelect=document.getElementById('yearSelect');
        const monthSelect=document.getElementById('monthSelect');
        yearSelect.innerHTML='';monthSelect.innerHTML='';
        for(let y=2024;y<=2026;y++){yearSelect.innerHTML+=`<option value="${y}" ${y===currentYear?'selected':''}>${y}</option>`;}
        for(let m=1;m<=12;m++){monthSelect.innerHTML+=`<option value="${m}" ${m===currentMonth?'selected':''}>${m}</option>`;}
    }
    function changeMonth(delta){
        if(typeof delta === 'number'){
            currentMonth+=delta;
            if(currentMonth>12){currentMonth=1;currentYear++;}
            if(currentMonth<1){currentMonth=12;currentYear--;}
            document.getElementById('yearSelect').value=currentYear;
            document.getElementById('monthSelect').value=currentMonth;
        }else{
            currentYear=parseInt(document.getElementById('yearSelect').value);
            currentMonth=parseInt(document.getElementById('monthSelect').value);
        }
        loadAllData();
    }
    function loadData(){changeMonth();}

    // Data Loading
    async function loadAllData(){
        await Promise.all([loadEmployees(),loadRevenueData(),loadSalesDetailData(),loadExpenses(),loadAttendance(),loadIncentiveItems(),loadIncentiveRecords(),loadLunchOT(),loadLeaveRequests()]);
        renderAll();
    }
    async function loadEmployees(){try{const snapshot=await db.collection('employees').get();employees=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));}catch(e){console.error('Load employees error:',e);}}
    async function loadRevenueData(){try{const snapshot=await db.collection('revenue').get();revenueData={};snapshot.docs.forEach(doc=>{revenueData[doc.id]=doc.data();});}catch(e){console.error('Load revenue error:',e);}}
    async function loadSalesDetailData(){try{const snapshot=await db.collection('salesDetail').get();salesDetail={};snapshot.docs.forEach(doc=>{salesDetail[doc.id]=doc.data();});}catch(e){console.error('Load sales detail error:',e);}}
    async function loadExpenses(){
        try{
            let snapshot=await db.collection('fixedExpenses').get();
            fixedExpenses=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));
            snapshot=await db.collection('variableExpenses').where('yearMonth','==',getYM()).get();
            variableExpenses=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));
            // ì„¸ê¸ˆ ë¡œë“œ (ì˜¬í•´ ë°ì´í„°)
            snapshot=await db.collection('vatTaxes').where('year','==',String(currentYear)).get();
            vatTaxes=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));
            snapshot=await db.collection('incomeTaxes').get();
            incomeTaxes=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));
            snapshot=await db.collection('withholdingTaxes').where('year','==',String(currentYear)).get();
            withholdingTaxes=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));
            // ê¸‰ì—¬ ë¡œë“œ
            snapshot=await db.collection('payroll').get();
            payrollData=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));
        }catch(e){console.error('Load expenses error:',e);}
    }
    async function loadAttendance(){
        try{
            const ym=getYM();
            const snapshot=await db.collection('attendance').where('date','>=',ym+'-01').where('date','<=',ym+'-31').get();
            attendance=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));
        }catch(e){console.error('Load attendance error:',e);}
    }
    async function loadIncentiveItems(){try{const snapshot=await db.collection('incentiveItems').get();incentiveItems=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));}catch(e){console.error('Load incentive items error:',e);}}
    async function loadIncentiveRecords(){try{const snapshot=await db.collection('incentiveRecords').get();incentiveRecords=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));}catch(e){console.error('Load incentive records error:',e);}}
    async function loadLeaveRequests(){try{const snapshot=await db.collection('leaveRequests').get();leaveRequests=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));}catch(e){console.error('Load leave requests error:',e);}}
    async function loadLunchOT(){
        try{
            const ym=getYM();
            const snapshot=await db.collection('lunchOT').where('date','>=',ym+'-01').where('date','<=',ym+'-31').get();
            lunchOT=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));
        }catch(e){console.error('Load lunch OT error:',e);}
    }

    // Render Functions
    function renderAll(){
        renderRevenueOverview();renderDoctorSales();renderStaffSales();renderJapanSales();renderUploadHistory();
        renderExpenses();renderEmployees();renderAttendance();renderOvertime();
        renderIncentiveItems();renderIncentiveSummary();renderSalary();renderCharts();
        renderLeaveManagement();
    }

    // Chart instances
    // revenueChart, compareChart already declared above

    function renderCharts(){
        const labels=['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”'];
        
        // í˜„ì¬ ì—°ë„ ë°ì´í„°
        const currentYearData=labels.map((_,i)=>{
            const ym=`${currentYear}-${String(i+1).padStart(2,'0')}`;
            return (revenueData[ym]?.total||0)/100000000;
        });
        
        // ì „ë…„ë„ ë°ì´í„° (2024ë…„ baseline ë˜ëŠ” Firebase)
        const lastYearData=labels.map((_,i)=>{
            if(currentYear===2025){
                return (data2024[i+1]?.total||0)/100000000;
            }else{
                const ym=`${currentYear-1}-${String(i+1).padStart(2,'0')}`;
                return (revenueData[ym]?.total||0)/100000000;
            }
        });
        
        // ì›”ë³„ ë§¤ì¶œ ì¶”ì´ ì°¨íŠ¸
        const ctx1=document.getElementById('revenueChart');
        if(ctx1){
            if(revenueChart)revenueChart.destroy();
            revenueChart=new Chart(ctx1,{
                type:'line',
                data:{
                    labels,
                    datasets:[
                        {label:`${currentYear}ë…„`,data:currentYearData,borderColor:'#9a8b7a',backgroundColor:'rgba(154,139,122,0.1)',fill:true,tension:0.4},
                        {label:`${currentYear-1}ë…„`,data:lastYearData,borderColor:'#ccc',borderDash:[5,5],fill:false,tension:0.4}
                    ]
                },
                options:{
                    responsive:true,maintainAspectRatio:false,
                    plugins:{legend:{position:'top'}},
                    scales:{y:{beginAtZero:true,ticks:{callback:v=>v+'ì–µ'}}}
                }
            });
        }
        
        // ì—°ë„ë³„ ë¹„êµ ì°¨íŠ¸ (ë§‰ëŒ€)
        const ctx2=document.getElementById('compareChart');
        if(ctx2){
            if(compareChart)compareChart.destroy();
            compareChart=new Chart(ctx2,{
                type:'bar',
                data:{
                    labels,
                    datasets:[
                        {label:`${currentYear-1}ë…„`,data:lastYearData,backgroundColor:'rgba(200,200,200,0.7)'},
                        {label:`${currentYear}ë…„`,data:currentYearData,backgroundColor:'rgba(154,139,122,0.8)'}
                    ]
                },
                options:{
                    responsive:true,maintainAspectRatio:false,
                    plugins:{legend:{position:'top'}},
                    scales:{y:{beginAtZero:true,ticks:{callback:v=>v+'ì–µ'}}}
                }
            });
        }
    }

    function renderRevenueOverview(){
        const ym=getYM();
        const data=revenueData[ym]||{total:0,japan:0,transactions:0,patients:0};
        const prevYM=currentMonth===1?`${currentYear-1}-12`:`${currentYear}-${String(currentMonth-1).padStart(2,'0')}`;
        const prevData=revenueData[prevYM]||{total:0};
        const lastYearData=data2024[currentMonth]||{total:0};
        const growth=data.total-prevData.total;
        const yoyGrowth=data.total-lastYearData.total;
        const patientCount=data.patients||0;
        const avgPerPatient=patientCount?Math.round(data.total/patientCount):0;

        document.getElementById('revenueCards').innerHTML=`
            <div class="card"><div class="card-label">ì´ ë§¤ì¶œ</div><div class="card-value">${formatCurrency(data.total)}</div><div class="card-change ${growth>=0?'positive':'negative'}">ì „ì›” ëŒ€ë¹„ ${growth>=0?'+':''}${formatCurrency(growth)}</div></div>
            <div class="card"><div class="card-label">ì¼ë³¸ì¸ ë§¤ì¶œ</div><div class="card-value">${formatCurrency(data.japan)}</div><div class="card-sub">ì „ì²´ì˜ ${data.total?Math.round(data.japan/data.total*100):0}%</div></div>
            <div class="card"><div class="card-label">í™˜ì ìˆ˜</div><div class="card-value">${formatNumber(patientCount)}ëª…</div><div class="card-sub">ê°ë‹¨ê°€ ${formatCurrency(avgPerPatient)}</div></div>
            <div class="card"><div class="card-label">ì „ë…„ ë™ì›” ëŒ€ë¹„</div><div class="card-value ${yoyGrowth>=0?'positive':'negative'}">${yoyGrowth>=0?'+':''}${formatCurrency(yoyGrowth)}</div><div class="card-sub">2024ë…„ ${currentMonth}ì›”: ${formatCurrency(lastYearData.total)}</div></div>
        `;
    }

    function renderDoctorSales(){
        const ym=getYM();const detail=salesDetail[ym]||{};const doctorSales=detail.doctorSales||{};
        const total=Object.values(doctorSales).reduce((sum,d)=>sum+(d.amount||0),0);
        const totalPatients=Object.values(doctorSales).reduce((sum,d)=>sum+(d.patients||0),0);
        const sorted=Object.entries(doctorSales).sort((a,b)=>b[1].amount-a[1].amount);
        const top=sorted[0];
        document.getElementById('doctorCards').innerHTML=`
            <div class="card"><div class="card-label">ì§„ë£Œì˜ ìˆ˜</div><div class="card-value">${sorted.length}ëª…</div></div>
            <div class="card"><div class="card-label">ì´ ë§¤ì¶œ</div><div class="card-value">${formatCurrency(total)}</div></div>
            <div class="card"><div class="card-label">1ìœ„</div><div class="card-value">${top?top[0]:'-'}</div><div class="card-sub">${top?formatCurrency(top[1].amount):''}</div></div>
        `;
        document.getElementById('doctorTable').innerHTML=sorted.map(([name,data])=>{
            const patients=data.patients||0;
            const avgPerPatient=patients?Math.round(data.amount/patients):0;
            return `<tr><td><strong>${name}</strong></td><td class="text-right">${formatNumber(patients)}ëª…</td><td class="text-right">${formatCurrency(data.amount)}</td><td class="text-right">${formatCurrency(avgPerPatient)}</td><td class="text-right">${total?Math.round(data.amount/total*100):0}%</td></tr>`;
        }).join('')||'<tr><td colspan="5" class="text-center">ë°ì´í„° ì—†ìŒ</td></tr>';
    }

    function renderStaffSales(){
        const ym=getYM();const detail=salesDetail[ym]||{};const staffSales=detail.staffSales||{};
        const total=Object.values(staffSales).reduce((sum,d)=>sum+(d.amount||0),0);
        const totalPatients=Object.values(staffSales).reduce((sum,d)=>sum+(d.patients||0),0);
        const sorted=Object.entries(staffSales).sort((a,b)=>b[1].amount-a[1].amount);
        document.getElementById('staffSalesCards').innerHTML=`
            <div class="card"><div class="card-label">ë‹´ë‹¹ì§ì› ìˆ˜</div><div class="card-value">${sorted.length}ëª…</div></div>
            <div class="card"><div class="card-label">ì´ ë§¤ì¶œ</div><div class="card-value">${formatCurrency(total)}</div></div>
            <div class="card"><div class="card-label">ì¸ì„¼í‹°ë¸Œ ì´ì•¡ (1%)</div><div class="card-value">${formatCurrency(total*0.01)}</div></div>
        `;
        document.getElementById('staffSalesTable').innerHTML=sorted.map(([name,data])=>{
            const patients=data.patients||0;
            const avgPerPatient=patients?Math.round(data.amount/patients):0;
            return `<tr><td><strong>${name}</strong></td><td class="text-right">${formatNumber(patients)}ëª…</td><td class="text-right">${formatCurrency(data.amount)}</td><td class="text-right">${formatCurrency(avgPerPatient)}</td><td class="text-right"><span class="badge badge-green">${formatCurrency(data.amount*0.01)}</span></td></tr>`;
        }).join('')||'<tr><td colspan="5" class="text-center">ë°ì´í„° ì—†ìŒ</td></tr>';
    }

    function renderJapanSales(){
        const ym=getYM();
        const detail=salesDetail[ym]||{};
        const japanStaffSales=detail.japanStaffSales||{};
        const currentRevenue=revenueData[ym]||{japan:0,japanVisitors:0};
        
        // ì›”ë³„ ë°ì´í„°
        const months=[];
        for(let m=1;m<=12;m++){
            const monthYM=`${currentYear}-${String(m).padStart(2,'0')}`;
            const data=revenueData[monthYM]||(currentYear===2024?data2024[m]:{japan:0,japanVisitors:0});
            months.push({month:m,...data});
        }
        const totalJapan=months.reduce((sum,m)=>sum+(m.japan||0),0);
        const totalVisitors=months.reduce((sum,m)=>sum+(m.japanVisitors||0),0);
        const currentVisitors=currentRevenue.japanVisitors||0;
        const avgPrice=currentVisitors?Math.round(currentRevenue.japan/currentVisitors):0;
        
        document.getElementById('japanCards').innerHTML=`
            <div class="card"><div class="card-label">${currentMonth}ì›” ì¼ë³¸ì¸ ë§¤ì¶œ</div><div class="card-value">${formatCurrency(currentRevenue.japan)}</div></div>
            <div class="card"><div class="card-label">${currentMonth}ì›” í™˜ì ìˆ˜</div><div class="card-value">${currentVisitors}ëª…</div><div class="card-sub">ê³ ìœ  ì°¨íŠ¸ë²ˆí˜¸ ê¸°ì¤€</div></div>
            <div class="card"><div class="card-label">${currentMonth}ì›” ê°ë‹¨ê°€</div><div class="card-value">${formatCurrency(avgPrice)}</div></div>
            <div class="card"><div class="card-label">ì—°ê°„ ëˆ„ì </div><div class="card-value">${formatCurrency(totalJapan)}</div><div class="card-sub">${totalVisitors}ëª… ë°©ë¬¸</div></div>
        `;
        
        // ë‹´ë‹¹ì§ì›ë³„ ì¼ë³¸ì¸ ë§¤ì¶œ
        const staffTotal=Object.values(japanStaffSales).reduce((s,d)=>s+(d.amount||0),0);
        const sorted=Object.entries(japanStaffSales).sort((a,b)=>b[1].amount-a[1].amount);
        document.getElementById('japanStaffTable').innerHTML=sorted.map(([name,data])=>{
            const patientCount=data.patients||0;
            const avgPerPatient=patientCount?Math.round(data.amount/patientCount):0;
            const share=staffTotal?Math.round(data.amount/staffTotal*100):0;
            return `<tr><td><strong>${name}</strong></td><td class="text-right">${patientCount}ëª…</td><td class="text-right">${formatCurrency(data.amount)}</td><td class="text-right">${formatCurrency(avgPerPatient)}</td><td class="text-right">${share}%</td></tr>`;
        }).join('')||'<tr><td colspan="5" class="text-center">ë°ì´í„° ì—†ìŒ</td></tr>';
        
        // ì›”ë³„ í…Œì´ë¸”
        document.getElementById('japanTable').innerHTML=months.map(m=>{
            const visitors=m.japanVisitors||0;
            const avg=visitors?Math.round(m.japan/visitors):0;
            return `<tr><td>${m.month}ì›”</td><td class="text-right">${formatCurrency(m.japan)}</td><td class="text-right">${visitors}ëª…</td><td class="text-right">${formatCurrency(avg)}</td></tr>`;
        }).join('');
    }

    function renderUploadHistory(){
        const sorted=Object.entries(revenueData).sort((a,b)=>b[0].localeCompare(a[0]));
        document.getElementById('uploadHistory').innerHTML=sorted.map(([ym,data])=>`<tr><td>${ym}</td><td class="text-right">${formatCurrency(data.total)}</td><td class="text-right">${data.transactions||0}ê±´</td><td>${data.uploadedAt?new Date(data.uploadedAt.toDate()).toLocaleDateString():'-'}</td><td><button class="btn btn-sm btn-danger" onclick="deleteRevenue('${ym}')">ì‚­ì œ</button></td></tr>`).join('')||'<tr><td colspan="5" class="text-center">ì—…ë¡œë“œëœ ë°ì´í„° ì—†ìŒ</td></tr>';
    }

    function renderExpenses(){
        // ì •ë ¬ í•¨ìˆ˜
        const sortExpenses=(list,sortKey)=>{
            const sorted=[...list];
            switch(sortKey){
                case 'date-desc':sorted.sort((a,b)=>(b.date||'').localeCompare(a.date||''));break;
                case 'date-asc':sorted.sort((a,b)=>(a.date||'').localeCompare(b.date||''));break;
                case 'amount-desc':sorted.sort((a,b)=>(b.amount||0)-(a.amount||0));break;
                case 'amount-asc':sorted.sort((a,b)=>(a.amount||0)-(b.amount||0));break;
                case 'category':sorted.sort((a,b)=>(a.category||'').localeCompare(b.category||''));break;
            }
            return sorted;
        };
        
        // ê³ ì •ë¹„ ì¹´í…Œê³ ë¦¬ í•„í„° ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
        const categories=[...new Set(fixedExpenses.map(e=>e.category))].sort();
        const categoryFilter=document.getElementById('fixedCategoryFilter');
        if(categoryFilter){
            const currentVal=categoryFilter.value;
            categoryFilter.innerHTML='<option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>'+categories.map(c=>`<option value="${c}">${c}</option>`).join('');
            categoryFilter.value=currentVal||'';
        }
        
        // ê³ ì •ë¹„ í•„í„°ë§
        const searchText=(document.getElementById('fixedSearch')?.value||'').toLowerCase();
        const filterCategory=document.getElementById('fixedCategoryFilter')?.value||'';
        let filteredFixed=fixedExpenses.filter(e=>{
            const matchSearch=!searchText||e.name.toLowerCase().includes(searchText)||(e.note||'').toLowerCase().includes(searchText);
            const matchCategory=!filterCategory||e.category===filterCategory;
            return matchSearch&&matchCategory;
        });
        
        // ê³ ì •ë¹„
        const fixedSort=document.getElementById('fixedSort')?.value||'date-desc';
        const sortedFixed=sortExpenses(filteredFixed,fixedSort);
        const fixedTotal=fixedExpenses.reduce((sum,e)=>sum+(e.amount||0),0);
        const filteredTotal=filteredFixed.reduce((sum,e)=>sum+(e.amount||0),0);
        document.getElementById('fixedTotal').textContent=formatCurrency(fixedTotal);
        document.getElementById('fixedCount').textContent=fixedExpenses.length+'ê°œ';
        document.getElementById('fixedYearly').textContent=formatCurrency(fixedTotal*12);
        
        // ê³ ì •ë¹„ í…Œì´ë¸” - ì¥ë¹„ë¦¬ìŠ¤ ì •ë³´ í‘œì‹œ ê°œì„ 
        document.getElementById('fixedTable').innerHTML=sortedFixed.map(e=>{
            let noteDisplay=e.note||'-';
            // ì¥ë¹„ë¦¬ìŠ¤ì¸ ê²½ìš° ì¶”ê°€ ì •ë³´ í‘œì‹œ
            if(e.category==='ì¥ë¹„ë¦¬ìŠ¤/ë Œíƒˆ'&&(e.leaseEndDate||e.leasePaymentDay)){
                const leaseInfo=[];
                if(e.leasePaymentMethod)leaseInfo.push(e.leasePaymentMethod);
                if(e.leasePaymentDay)leaseInfo.push('ë§¤ì›” '+e.leasePaymentDay+'ì¼');
                if(e.leaseEndDate)leaseInfo.push(e.leaseEndDate+' ë§Œê¸°');
                if(e.leaseCompany)leaseInfo.push(e.leaseCompany);
                if(leaseInfo.length>0)noteDisplay=leaseInfo.join(', ')+(e.note?' | '+e.note:'');
            }
            return `<tr><td>${e.date||'-'}</td><td><strong>${e.name}</strong></td><td><span class="badge badge-blue">${e.category}</span></td><td class="text-right">${formatCurrency(e.amount)}</td><td>${noteDisplay}</td><td><button class="btn btn-sm btn-secondary" onclick="editExpense('fixed','${e.id}')">ìˆ˜ì •</button> <button class="btn btn-sm btn-danger" onclick="deleteExpense('fixed','${e.id}')">ì‚­ì œ</button></td></tr>`;
        }).join('')||(searchText||filterCategory?`<tr><td colspan="6" class="text-center">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ (ì „ì²´ ${fixedExpenses.length}ê°œ ì¤‘)</td></tr>`:'<tr><td colspan="6" class="text-center">ë“±ë¡ëœ ê³ ì •ë¹„ ì—†ìŒ</td></tr>');

        // ìœ ë™ë¹„
        const variableSort=document.getElementById('variableSort')?.value||'date-desc';
        const sortedVariable=sortExpenses(variableExpenses,variableSort);
        const variableTotal=variableExpenses.reduce((sum,e)=>sum+(e.amount||0),0);
        document.getElementById('variableTotal').textContent=formatCurrency(variableTotal);
        document.getElementById('variableCount').textContent=variableExpenses.length+'ê±´';
        document.getElementById('variableTable').innerHTML=sortedVariable.map(e=>`<tr><td>${e.date}</td><td><strong>${e.name}</strong></td><td><span class="badge badge-orange">${e.category}</span></td><td>${e.card||'-'}</td><td class="text-right">${formatCurrency(e.amount)}</td><td><button class="btn btn-sm btn-secondary" onclick="editExpense('variable','${e.id}')">ìˆ˜ì •</button> <button class="btn btn-sm btn-danger" onclick="deleteExpense('variable','${e.id}')">ì‚­ì œ</button></td></tr>`).join('')||'<tr><td colspan="6" class="text-center">ë“±ë¡ëœ ìœ ë™ë¹„ ì—†ìŒ</td></tr>';
        
        // ê¸‰ì—¬ ë Œë”ë§
        renderPayroll();
        
        // ì„¸ê¸ˆ ë Œë”ë§
        renderTaxes();
        
        // ì§€ì¶œ ë¶„ì„ ë Œë”ë§
        renderExpenseAnalysis();
    }
    
    // ì¥ë¹„ë¦¬ìŠ¤ í•„ë“œ í† ê¸€
    function toggleLeaseFields(){
        const category=document.getElementById('expenseCategory')?.value||'';
        const leaseFields=document.getElementById('leaseFields');
        if(leaseFields){
            leaseFields.style.display=(category==='ì¥ë¹„ë¦¬ìŠ¤/ë Œíƒˆ')?'block':'none';
        }
    }
    
    function renderPayroll(){
        const ym=getYM();
        const filterMonth=document.getElementById('payrollMonth')?.value||'';
        
        // ì›” ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
        const months=[...new Set(payrollData.map(p=>p.yearMonth))].sort().reverse();
        const monthSelect=document.getElementById('payrollMonth');
        if(monthSelect){
            const currentVal=monthSelect.value;
            monthSelect.innerHTML='<option value="">ì „ì²´</option>'+months.map(m=>`<option value="${m}">${m}</option>`).join('');
            monthSelect.value=currentVal||'';
        }
        
        // í•„í„°ë§
        let filtered=payrollData;
        if(filterMonth){filtered=payrollData.filter(p=>p.yearMonth===filterMonth);}
        else{filtered=payrollData.filter(p=>p.yearMonth===ym);}
        
        // í•©ê³„ ê³„ì‚°
        const totalGross=filtered.reduce((sum,p)=>sum+(p.grossPay||0),0);
        const totalNet=filtered.reduce((sum,p)=>sum+(p.netPay||0),0);
        const empCount=filtered.length;
        
        document.getElementById('payrollTotal').textContent=formatCurrency(totalGross);
        document.getElementById('payrollNetTotal').textContent=formatCurrency(totalNet);
        document.getElementById('payrollCount').textContent=empCount+'ëª…';
        
        // í…Œì´ë¸”
        document.getElementById('payrollTable').innerHTML=filtered.sort((a,b)=>(b.yearMonth||'').localeCompare(a.yearMonth||'')||(a.name||'').localeCompare(b.name||'')).map(p=>`<tr><td>${p.yearMonth||'-'}</td><td><strong>${p.name||'-'}</strong></td><td class="text-right">${formatCurrency(p.extraOT||0)}</td><td class="text-right">${formatCurrency(p.incentive||0)}</td><td class="text-right"><strong>${formatCurrency(p.netPay)}</strong></td><td><button class="btn btn-sm btn-danger" onclick="deletePayroll('${p.id}')">ì‚­ì œ</button></td></tr>`).join('')||'<tr><td colspan="6" class="text-center">ë“±ë¡ëœ ê¸‰ì—¬ ë‚´ì—­ ì—†ìŒ</td></tr>';
    }
    
    function renderTaxes(){
        // ì›ì²œì„¸ (ê·¼ë¡œì†Œë“ì„¸+ì§€ë°©ì„¸)
        const withholdingTotal=withholdingTaxes.reduce((sum,t)=>sum+((t.incomeTax||0)+(t.localTax||0)),0);
        document.getElementById('withholdingTotal').textContent=formatCurrency(withholdingTotal);
        document.getElementById('withholdingTable').innerHTML=withholdingTaxes.sort((a,b)=>(b.date||'').localeCompare(a.date||'')).map(t=>`<tr><td>${t.date||'-'}</td><td>${t.attributeMonth||'-'}</td><td class="text-right">${formatCurrency(t.incomeTax)}</td><td class="text-right">${formatCurrency(t.localTax)}</td><td class="text-right"><strong>${formatCurrency((t.incomeTax||0)+(t.localTax||0))}</strong></td><td>${t.note||'-'}</td><td><button class="btn btn-sm btn-secondary" onclick="editTax('withholding','${t.id}')">ìˆ˜ì •</button> <button class="btn btn-sm btn-danger" onclick="deleteTax('withholding','${t.id}')">ì‚­ì œ</button></td></tr>`).join('')||'<tr><td colspan="7" class="text-center">ë“±ë¡ëœ ì›ì²œì„¸ ë‚´ì—­ ì—†ìŒ</td></tr>';
        
        // ë¶€ê°€ì„¸
        const vatTotal=vatTaxes.reduce((sum,t)=>sum+(t.amount||0),0);
        document.getElementById('vatTotal').textContent=formatCurrency(vatTotal);
        document.getElementById('vatTable').innerHTML=vatTaxes.sort((a,b)=>(b.date||'').localeCompare(a.date||'')).map(t=>`<tr><td>${t.date||'-'}</td><td>${t.quarter||'-'}</td><td class="text-right"><strong>${formatCurrency(t.amount)}</strong></td><td>${t.note||'-'}</td><td><button class="btn btn-sm btn-secondary" onclick="editTax('vat','${t.id}')">ìˆ˜ì •</button> <button class="btn btn-sm btn-danger" onclick="deleteTax('vat','${t.id}')">ì‚­ì œ</button></td></tr>`).join('')||'<tr><td colspan="5" class="text-center">ë“±ë¡ëœ ë¶€ê°€ì„¸ ë‚´ì—­ ì—†ìŒ</td></tr>';
        
        // ì¢…ì†Œì„¸
        const incomeTotal=incomeTaxes.filter(t=>t.taxYear===String(currentYear)||t.taxYear===String(currentYear-1)).reduce((sum,t)=>sum+(t.amount||0),0);
        document.getElementById('incomeTotal').textContent=formatCurrency(incomeTotal);
        document.getElementById('incomeTable').innerHTML=incomeTaxes.sort((a,b)=>(b.date||'').localeCompare(a.date||'')).map(t=>`<tr><td>${t.date||'-'}</td><td>${t.taxYear||'-'}ë…„</td><td>${t.incomeType||'-'}</td><td class="text-right"><strong>${formatCurrency(t.amount)}</strong></td><td>${t.note||'-'}</td><td><button class="btn btn-sm btn-secondary" onclick="editTax('income','${t.id}')">ìˆ˜ì •</button> <button class="btn btn-sm btn-danger" onclick="deleteTax('income','${t.id}')">ì‚­ì œ</button></td></tr>`).join('')||'<tr><td colspan="6" class="text-center">ë“±ë¡ëœ ì¢…ì†Œì„¸ ë‚´ì—­ ì—†ìŒ</td></tr>';
        
        // í•©ê³„
        document.getElementById('taxTotal').textContent=formatCurrency(withholdingTotal+vatTotal+incomeTotal);
    }
    
    let expenseChart=null;
    function renderExpenseAnalysis(){
        const ym=getYM();
        const fixedTotal=fixedExpenses.reduce((sum,e)=>sum+(e.amount||0),0);
        const variableTotal=variableExpenses.reduce((sum,e)=>sum+(e.amount||0),0);
        // ì¸ê±´ë¹„ (í•´ë‹¹ì›”)
        const payrollTotal=payrollData.filter(p=>p.yearMonth===ym).reduce((sum,p)=>sum+(p.netPay||0),0);
        const totalExpense=fixedTotal+variableTotal+payrollTotal;
        
        // ì›” ë§¤ì¶œ
        const rev=revenueData[ym];
        const monthRevenue=rev?rev.total:0;
        const monthProfit=monthRevenue-totalExpense;
        const profitRate=monthRevenue>0?((monthProfit/monthRevenue)*100).toFixed(1):0;
        
        document.getElementById('totalExpense').textContent=formatCurrency(totalExpense);
        document.getElementById('totalExpense').nextElementSibling.textContent=`ê³ ì •ë¹„ + ìœ ë™ë¹„ + ì¸ê±´ë¹„`;
        document.getElementById('monthRevenue').textContent=formatCurrency(monthRevenue);
        document.getElementById('monthRevenueDate').textContent=rev?`${ym.substring(0,4)}ë…„ ${parseInt(ym.substring(5))}ì›”`:'ë°ì´í„° ì—†ìŒ';
        document.getElementById('monthProfit').textContent=formatCurrency(monthProfit);
        document.getElementById('monthProfit').style.color=monthProfit>=0?'var(--accent-green)':'var(--accent-red)';
        document.getElementById('profitRate').textContent=profitRate+'%';
        document.getElementById('profitRate').style.color=monthProfit>=0?'var(--accent-green)':'var(--accent-red)';
        
        // ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ
        const fixedByCategory={};
        fixedExpenses.forEach(e=>{fixedByCategory[e.category]=(fixedByCategory[e.category]||0)+e.amount;});
        // ì¸ê±´ë¹„ë¥¼ ê³ ì •ë¹„ ì¹´í…Œê³ ë¦¬ì— ì¶”ê°€
        if(payrollTotal>0)fixedByCategory['ì¸ê±´ë¹„']=payrollTotal;
        const variableByCategory={};
        variableExpenses.forEach(e=>{variableByCategory[e.category]=(variableByCategory[e.category]||0)+e.amount;});
        
        const renderCategoryList=(data,total)=>{
            const sorted=Object.entries(data).sort((a,b)=>b[1]-a[1]);
            return sorted.map(([cat,amt])=>`<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee"><span>${cat}</span><span><strong>${formatCurrency(amt)}</strong> <span style="color:#999">(${((amt/total)*100).toFixed(1)}%)</span></span></div>`).join('')||'<div style="color:#999;padding:8px 0">ë°ì´í„° ì—†ìŒ</div>';
        };
        document.getElementById('fixedByCategory').innerHTML=renderCategoryList(fixedByCategory,fixedTotal||1);
        document.getElementById('variableByCategory').innerHTML=renderCategoryList(variableByCategory,variableTotal||1);
        
        // ì›”ë³„ ì§€ì¶œ ì°¨íŠ¸
        renderExpenseChart();
    }
    
    function renderExpenseChart(){
        const year=currentYear;
        const months=['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”'];
        const fixedData=[];const variableData=[];const revenueDataArr=[];const profitData=[];
        
        for(let m=1;m<=12;m++){
            const ym=year+String(m).padStart(2,'0');
            // ê³ ì •ë¹„ëŠ” í˜„ì¬ ë“±ë¡ëœ ê¸ˆì•¡ì„ ë§¤ì›” ë™ì¼í•˜ê²Œ ê°€ì •
            const fixedTotal=fixedExpenses.reduce((sum,e)=>sum+(e.amount||0),0);
            // ìœ ë™ë¹„ëŠ” í•´ë‹¹ ì›” ë°ì´í„°ë§Œ (yearMonth ê¸°ì¤€)
            const varTotal=variableExpenses.filter(e=>e.yearMonth===ym).reduce((sum,e)=>sum+(e.amount||0),0);
            const rev=revenueData[ym];
            const monthRev=rev?rev.total:0;
            
            fixedData.push(fixedTotal/10000);
            variableData.push(varTotal/10000);
            revenueDataArr.push(monthRev/10000);
            profitData.push((monthRev-fixedTotal-varTotal)/10000);
        }
        
        const ctx=document.getElementById('expenseChart');
        if(!ctx)return;
        if(expenseChart)expenseChart.destroy();
        expenseChart=new Chart(ctx,{
            type:'bar',
            data:{
                labels:months,
                datasets:[
                    {label:'ë§¤ì¶œ',data:revenueDataArr,type:'line',borderColor:'rgba(154,139,122,1)',backgroundColor:'rgba(154,139,122,0.1)',fill:true,tension:0.3,yAxisID:'y'},
                    {label:'ê³ ì •ë¹„',data:fixedData,backgroundColor:'rgba(59,130,246,0.7)',stack:'expense',yAxisID:'y'},
                    {label:'ìœ ë™ë¹„',data:variableData,backgroundColor:'rgba(249,115,22,0.7)',stack:'expense',yAxisID:'y'},
                    {label:'ìˆ˜ìµ',data:profitData,type:'line',borderColor:'rgba(34,197,94,1)',borderDash:[5,5],pointStyle:'rectRot',pointRadius:4,yAxisID:'y'}
                ]
            },
            options:{
                responsive:true,
                interaction:{mode:'index',intersect:false},
                scales:{y:{beginAtZero:true,ticks:{callback:v=>v.toLocaleString()+'ë§Œ'}}},
                plugins:{tooltip:{callbacks:{label:ctx=>ctx.dataset.label+': '+ctx.raw.toLocaleString()+'ë§Œì›'}}}
            }
        });
    }

    function renderEmployees(){
        const roleLabels={doctor:'ì›ì¥',nurse:'ê°„í˜¸ì‚¬',coordinator:'ì½”ë””ë„¤ì´í„°',marketing:'ë§ˆì¼€íŒ…',manager:'ì‹¤ì¥',esthetician:'í”¼ë¶€ê´€ë¦¬ì‚¬'};
        const filter=document.getElementById('attendanceFilter');
        filter.innerHTML='<option value="all">ì „ì²´ ì§ì›</option>'+employees.filter(e=>e.status==='active').map(e=>`<option value="${e.id}">${e.name}</option>`).join('');
        const otSelect=document.getElementById('otEmployee');
        otSelect.innerHTML=employees.filter(e=>e.status==='active').map(e=>`<option value="${e.id}">${e.name}</option>`).join('');
        // ì—°ì°¨ í•„í„°ë„ ì—…ë°ì´íŠ¸
        const leaveEmpFilter=document.getElementById('leaveEmployeeFilter');
        if(leaveEmpFilter){
            leaveEmpFilter.innerHTML='<option value="all">ì „ì²´ ì§ì›</option>'+employees.filter(e=>e.status==='active').map(e=>`<option value="${e.id}">${e.name}</option>`).join('');
        }
        document.getElementById('employeeTable').innerHTML=employees.map(e=>{
            // ì—°ì°¨ ê³„ì‚°
            const totalLeave=e.annualLeave||calculateLegalAnnualLeave(e.joinDate);
            const usedLeave=getUsedLeave(e.id);
            const remainLeave=Math.max(0,totalLeave-usedLeave);
            const leavePercent=totalLeave>0?Math.round((usedLeave/totalLeave)*100):0;
            const leaveBarClass=leavePercent>80?'warning':'';
            
            return `<tr>
                <td><strong>${e.name}</strong></td>
                <td>${e.matchName||'-'}</td>
                <td>${roleLabels[e.role]||e.role}</td>
                <td>${e.joinDate||'-'}</td>
                <td>${getYearsOfService(e.joinDate)}</td>
                <td>
                    <div style="min-width:80px">
                        <span class="badge ${remainLeave<=2?'badge-red':remainLeave<=5?'badge-orange':'badge-green'}">${remainLeave}ì¼ / ${totalLeave}ì¼</span>
                        <div class="leave-bar"><div class="leave-bar-fill ${leaveBarClass}" style="width:${leavePercent}%"></div></div>
                    </div>
                </td>
                <td>${e.salary?e.salary+'ë§Œì›':'-'}</td>
                <td>${formatCurrency(e.hourly)}</td>
                <td><span class="badge ${e.status==='active'?'badge-green':'badge-red'}">${e.status==='active'?'ì¬ì§':'í‡´ì‚¬'}</span></td>
                <td>
                    <button class="btn btn-sm btn-secondary" onclick="editEmployee('${e.id}')">ìˆ˜ì •</button>
                    <button class="btn btn-sm btn-gold" onclick="resetPassword('${e.id}','${e.name}')">ë¹„ë²ˆì´ˆê¸°í™”</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteEmployee('${e.id}')">ì‚­ì œ</button>
                </td>
            </tr>`;
        }).join('')||'<tr><td colspan="10" class="text-center">ë“±ë¡ëœ ì§ì› ì—†ìŒ</td></tr>';
    }
    
    // ì§ì›ì˜ ì‚¬ìš© ì—°ì°¨ ê³„ì‚°
    function getUsedLeave(employeeId){
        const year=new Date().getFullYear().toString();
        const approved=leaveRequests.filter(r=>
            r.employeeId===employeeId && 
            r.status==='approved' &&
            r.dates?.some(d=>d.startsWith(year))
        );
        return approved.reduce((sum,r)=>{
            if(r.type?.includes('ë°˜ì°¨'))return sum+0.5;
            return sum+(r.dates?.filter(d=>d.startsWith(year)).length||1);
        },0);
    }
    
    async function resetPassword(empId,empName){
        if(!confirm(`${empName}ë‹˜ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ˆê¸° ë¹„ë°€ë²ˆí˜¸: fnal12890-`))return;
        try{
            await db.collection('employees').doc(empId).update({password:'fnal12890-'});
            alert(`${empName}ë‹˜ì˜ ë¹„ë°€ë²ˆí˜¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì´ˆê¸° ë¹„ë°€ë²ˆí˜¸: fnal12890-`);
            await loadEmployees();renderEmployees();
        }catch(e){alert('ì´ˆê¸°í™” ì‹¤íŒ¨: '+e.message);}
    }

    function renderAttendance(){
        const filter=document.getElementById('attendanceFilter').value;
        let filtered=attendance;
        if(filter!=='all'){filtered=attendance.filter(a=>a.employeeId===filter);}
        const workDays=filtered.filter(a=>a.checkIn).length;
        const lateDays=filtered.filter(a=>a.status==='late').length;
        const earlyDays=filtered.filter(a=>a.status==='early').length;
        const absentDays=filtered.filter(a=>a.status==='absent').length;
        document.getElementById('workDays').textContent=workDays+'ì¼';
        document.getElementById('lateDays').textContent=lateDays+'íšŒ';
        document.getElementById('earlyDays').textContent=earlyDays+'íšŒ';
        document.getElementById('absentDays').textContent=absentDays+'íšŒ';
        const sorted=filtered.sort((a,b)=>(b.date||'').localeCompare(a.date||''));
        document.getElementById('attendanceTable').innerHTML=sorted.slice(0,50).map(a=>{
            const emp=employees.find(e=>e.id===a.employeeId);
            const workHours=a.checkIn&&a.checkOut?calculateWorkHours(a.checkIn,a.checkOut):'-';
            const statusBadge={normal:'<span class="badge badge-green">ì •ìƒ</span>',late:'<span class="badge badge-orange">ì§€ê°</span>',early:'<span class="badge badge-blue">ì¡°í‡´</span>',absent:'<span class="badge badge-red">ê²°ê·¼</span>'};
            return `<tr><td>${a.date||'-'}</td><td>${emp?emp.name:a.employeeId}</td><td>${a.checkIn||'-'}</td><td>${a.checkOut||'-'}</td><td>${workHours}</td><td>${statusBadge[a.status]||'-'}</td><td><button class="btn btn-sm btn-secondary" onclick="editAttendance('${a.id}')">ìˆ˜ì •</button> <button class="btn btn-sm btn-danger" onclick="deleteAttendance('${a.id}')">ì‚­ì œ</button></td></tr>`;
        }).join('')||'<tr><td colspan="7" class="text-center">ê·¼íƒœ ê¸°ë¡ ì—†ìŒ</td></tr>';
    }
    
    async function editAttendance(id){
        const att=attendance.find(a=>a.id===id);
        if(!att)return;
        const newCheckIn=prompt('ì¶œê·¼ ì‹œê°„ (HH:MM)',att.checkIn||'09:00');
        if(newCheckIn===null)return;
        const newCheckOut=prompt('í‡´ê·¼ ì‹œê°„ (HH:MM)',att.checkOut||'18:00');
        if(newCheckOut===null)return;
        const newStatus=prompt('ìƒíƒœ (normal/late/early/absent)',att.status||'normal');
        if(newStatus===null)return;
        try{
            await db.collection('attendance').doc(id).update({checkIn:newCheckIn,checkOut:newCheckOut,status:newStatus});
            await loadAttendance();renderAttendance();
            alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }catch(e){alert('ìˆ˜ì • ì‹¤íŒ¨: '+e.message);}
    }
    
    async function deleteAttendance(id){
        if(!confirm('ì´ ê·¼íƒœ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
        try{
            await db.collection('attendance').doc(id).delete();
            await loadAttendance();renderAttendance();
            alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }catch(e){alert('ì‚­ì œ ì‹¤íŒ¨: '+e.message);}
    }

    function calculateWorkHours(checkIn,checkOut){
        const [inH,inM]=checkIn.split(':').map(Number);
        const [outH,outM]=checkOut.split(':').map(Number);
        const minutes=(outH*60+outM)-(inH*60+inM);
        const hours=Math.floor(minutes/60);const mins=minutes%60;
        return `${hours}ì‹œê°„ ${mins}ë¶„`;
    }

    function renderOvertime(){
        let eveningMinutes=0;
        attendance.forEach(a=>{
            if(a.checkOut){
                const [h,m]=a.checkOut.split(':').map(Number);
                const totalMinutes=h*60+m;
                if(totalMinutes>18*60){eveningMinutes+=totalMinutes-18*60;}
            }
        });
        const lunchMinutes=lunchOT.reduce((sum,ot)=>sum+(ot.minutes||0),0);
        const totalMinutes=eveningMinutes+lunchMinutes;
        const avgHourly=employees.length?employees.reduce((sum,e)=>sum+(e.hourly||12000),0)/employees.length:12000;
        const totalPay=Math.round(totalMinutes/60*avgHourly*1.5);
        document.getElementById('totalOT').textContent=Math.round(totalMinutes/60*10)/10+'ì‹œê°„';
        document.getElementById('eveningOT').textContent=Math.round(eveningMinutes/60*10)/10+'ì‹œê°„';
        document.getElementById('lunchOTVal').textContent=Math.round(lunchMinutes/60*10)/10+'ì‹œê°„';
        document.getElementById('totalOTPay').textContent=formatCurrency(totalPay);
        const sorted=lunchOT.sort((a,b)=>b.date.localeCompare(a.date));
        document.getElementById('lunchOTTable').innerHTML=sorted.map(ot=>{
            const emp=employees.find(e=>e.id===ot.employeeId);
            return `<tr><td>${ot.date}</td><td>${emp?emp.name:ot.employeeId}</td><td>${ot.minutes}ë¶„</td><td>${ot.reason||'-'}</td><td><button class="btn btn-sm btn-danger" onclick="deleteLunchOT('${ot.id}')">ì‚­ì œ</button></td></tr>`;
        }).join('')||'<tr><td colspan="5" class="text-center">ì ì‹¬ OT ê¸°ë¡ ì—†ìŒ</td></tr>';
    }

    function renderIncentiveItems(){
        document.getElementById('incentiveItemTable').innerHTML=incentiveItems.map(item=>{
            // ì ìš© ì§ì› ì´ë¦„ë§Œ í‘œì‹œ (ì‚¬ë²ˆ ì—†ì´)
            let empNames='ì „ì²´';
            if(item.employees?.length){
                empNames=item.employees.map(id=>{
                    const emp=employees.find(e=>e.id===id);
                    return emp?emp.name:null;
                }).filter(n=>n).join(', ')||'ë¯¸ì§€ì •';
            }
            const typeLabel=item.type==='japanSales'?`ì¼ë³¸ì¸ ë§¤ì¶œ ${item.percent||1}%`:`ê±´ë‹¹ ${formatCurrency(item.price)}`;
            const typeBadge=item.type==='japanSales'?'badge-green':'badge-blue';
            return `<tr><td><strong>${item.name}</strong></td><td><span class="badge ${typeBadge}">${typeLabel}</span></td><td><span class="badge badge-purple">${empNames}</span></td><td><button class="btn btn-sm btn-secondary" onclick="editIncentiveItem('${item.id}')">ìˆ˜ì •</button> <button class="btn btn-sm btn-danger" onclick="deleteIncentiveItem('${item.id}')">ì‚­ì œ</button></td></tr>`;
        }).join('')||'<tr><td colspan="4" class="text-center">ë“±ë¡ëœ í•­ëª© ì—†ìŒ</td></tr>';
    }

    function renderIncentiveSummary(){
        const ym=getYM();const detail=salesDetail[ym]||{};const staffSales=detail.staffSales||{};
        const japanStaffSales=detail.japanStaffSales||{};  // ì¼ë³¸ì¸ ë‹´ë‹¹ë³„ ë§¤ì¶œ
        const roleLabels={doctor:'ì›ì¥',nurse:'ê°„í˜¸ì‚¬',coordinator:'ì½”ë””ë„¤ì´í„°',marketing:'ë§ˆì¼€íŒ…',manager:'ì‹¤ì¥',esthetician:'í”¼ë¶€ê´€ë¦¬ì‚¬'};
        
        document.getElementById('incentiveSummaryTable').innerHTML=employees.filter(e=>e.status==='active').map(emp=>{
            let salesIncentive=0;
            // ê¸°ì¡´ ë‹´ë‹¹ì§ì› ë§¤ì¶œ 1% ì¸ì„¼í‹°ë¸Œ
            if(emp.incentiveType==='staff_sales'&&emp.matchName){
                const sales=staffSales[emp.matchName];
                if(sales)salesIncentive=Math.round(sales.amount*0.01);
            }
            
            // ì¼ë³¸ì¸ ë§¤ì¶œ % ì¸ì„¼í‹°ë¸Œ ê³„ì‚°
            let japanIncentive=0;
            const japanSalesItems=incentiveItems.filter(i=>i.type==='japanSales'&&i.employees?.includes(emp.id));
            japanSalesItems.forEach(item=>{
                // ì§ì›ì˜ matchNameìœ¼ë¡œ ì¼ë³¸ì¸ ë‹´ë‹¹ ë§¤ì¶œ ì°¾ê¸°
                if(emp.matchName&&japanStaffSales[emp.matchName]){
                    japanIncentive+=Math.round(japanStaffSales[emp.matchName]*(item.percent||1)/100);
                }
            });
            
            const itemIncentive=japanIncentive;const total=salesIncentive+itemIncentive;
            return `<tr><td><strong>${emp.name}</strong></td><td>${roleLabels[emp.role]||emp.role}</td><td class="text-right">${formatCurrency(salesIncentive)}</td><td class="text-right">${formatCurrency(itemIncentive)}</td><td class="text-right"><strong>${formatCurrency(total)}</strong></td></tr>`;
        }).join('')||'<tr><td colspan="5" class="text-center">ì§ì› ì—†ìŒ</td></tr>';
    }

    function renderSalary(){
        const ym=getYM();
        const detail=salesDetail[ym]||{};
        const staffSales=detail.staffSales||{};
        const japanStaffSales=detail.japanStaffSales||{};
        const roleLabelsLocal={doctor:'ì›ì¥',nurse:'ê°„í˜¸ì‚¬',coordinator:'ì½”ë””ë„¤ì´í„°',marketing:'ë§ˆì¼€íŒ…',manager:'ì‹¤ì¥',esthetician:'í”¼ë¶€ê´€ë¦¬ì‚¬'};
        
        // ì‚¬ì „ê¸‰ì—¬ëŒ€ì¥ ë Œë”ë§
        document.getElementById('prePayrollTable').innerHTML=employees.filter(e=>e.status==='active').map(emp=>{
            // OT ì‹œê°„ ê³„ì‚°
            const empAttendance=attendance.filter(a=>a.employeeId===emp.id&&a.date?.startsWith(ym));
            let otMinutes=0;
            empAttendance.forEach(a=>{
                if(a.checkOut){
                    const [h,m]=(a.checkOut||'00:00').split(':').map(Number);
                    if(h*60+m>18*60)otMinutes+=(h*60+m)-18*60;
                }
            });
            const empLunchOT=lunchOT.filter(ot=>ot.employeeId===emp.id&&ot.date?.startsWith(ym));
            otMinutes+=empLunchOT.reduce((sum,ot)=>sum+(ot.minutes||0),0);
            const otHours=(otMinutes/60).toFixed(1);
            const otPay=Math.round(otMinutes/60*(emp.hourly||12000)*1.5);
            
            // ì¸ì„¼í‹°ë¸Œ ê³„ì‚°
            const empRecords=incentiveRecords.filter(r=>r.employeeId===emp.id&&r.yearMonth===ym);
            let incentiveCount=empRecords.length;
            let incentiveAmount=0;
            empRecords.forEach(r=>{
                const item=incentiveItems.find(i=>i.id===r.itemId);
                if(item&&item.type!=='japanSales'){
                    incentiveAmount+=item.price||0;
                }
            });
            // ì¼ë³¸ì¸ ë§¤ì¶œ ì¸ì„¼í‹°ë¸Œ
            const japanItems=incentiveItems.filter(i=>i.type==='japanSales'&&i.employees?.includes(emp.id));
            japanItems.forEach(item=>{
                if(emp.matchName&&japanStaffSales[emp.matchName]){
                    incentiveAmount+=Math.round(japanStaffSales[emp.matchName]*(item.percent||1)/100);
                }
            });
            
            return `<tr>
                <td><strong>${emp.name}</strong></td>
                <td>${roleLabelsLocal[emp.role]||emp.role}</td>
                <td>${emp.salary?emp.salary+'ë§Œì›':'-'}</td>
                <td class="text-right">${otHours}H</td>
                <td class="text-right">${formatCurrency(otPay)}</td>
                <td class="text-right">${incentiveCount}ê±´</td>
                <td class="text-right">${formatCurrency(incentiveAmount)}</td>
            </tr>`;
        }).join('')||'<tr><td colspan="7" class="text-center">ì§ì› ì—†ìŒ</td></tr>';
    }

    // CRUD Operations - Expense
    const fixedCategories=[
        {value:'ì„ëŒ€ë£Œ',label:'ì„ëŒ€ë£Œ/ê´€ë¦¬ë¹„'},
        {value:'ê³µê³¼ê¸ˆ',label:'ê³µê³¼ê¸ˆ(ì „ê¸°/ê°€ìŠ¤/ìˆ˜ë„)'},
        {value:'ì¥ë¹„ë¦¬ìŠ¤',label:'ì¥ë¹„ë¦¬ìŠ¤/ë Œíƒˆ'},
        {value:'ëŒ€ì¶œì´ì',label:'ëŒ€ì¶œì´ì'},
        {value:'í†µì‹ _ì¸í„°ë„·',label:'ì¸í„°ë„·'},
        {value:'í†µì‹ _ì „í™”',label:'ì „í™”'},
        {value:'ì„¸ë¬´ë…¸ë¬´',label:'ì„¸ë¬´/ë…¸ë¬´'},
        {value:'ë³´í—˜ë£Œ',label:'ë³´í—˜ë£Œ'},
        {value:'ì²­ì†Œë¹„',label:'ì²­ì†Œë¹„'},
        {value:'ìˆ˜íƒ_íê¸°ë¬¼',label:'ìˆ˜íƒ-íê¸°ë¬¼'},
        {value:'ìˆ˜íƒ_ê²€ì‚¬',label:'ìˆ˜íƒ-ê²€ì‚¬'},
        {value:'ì •ìˆ˜ê¸°',label:'ì •ìˆ˜ê¸°'},
        {value:'ë³´ì•ˆ_ìº¡ìŠ¤',label:'ë³´ì•ˆ(ìº¡ìŠ¤)'},
        {value:'ë³µë¦¬í›„ìƒ',label:'ë³µë¦¬í›„ìƒ'},
        {value:'ë§ˆì¼€íŒ…',label:'ë§ˆì¼€íŒ…'},
        {value:'ê¸°íƒ€',label:'ê¸°íƒ€'}
    ];
    const variableCategories=[
        {value:'ì˜ë£Œì†Œëª¨í’ˆ',label:'ì˜ë£Œì†Œëª¨í’ˆ'},
        {value:'ë¯¸ìš©ì†Œëª¨í’ˆ',label:'ë¯¸ìš©ì†Œëª¨í’ˆ'},
        {value:'ì‚¬ë¬´ìš©í’ˆ',label:'ì‚¬ë¬´/ë¹„í’ˆ'},
        {value:'ì‹œì„¤ë³´ìˆ˜',label:'ì‹œì„¤/ë³´ìˆ˜'},
        {value:'ì¸í…Œë¦¬ì–´',label:'ì¸í…Œë¦¬ì–´'},
        {value:'ì¥ë¹„ìˆ˜ë¦¬',label:'ì¥ë¹„ìˆ˜ë¦¬'},
        {value:'ì„¸ê¸ˆí™˜ê¸‰',label:'ì„¸ê¸ˆí™˜ê¸‰ëŒ€í–‰'},
        {value:'ì ‘ëŒ€ë¹„',label:'ì ‘ëŒ€/íšŒì‹'},
        {value:'êµí†µë¹„',label:'êµí†µ/ì£¼ì°¨'},
        {value:'êµìœ¡ë¹„',label:'êµìœ¡/ì„¸ë¯¸ë‚˜'},
        {value:'ê¸°íƒ€',label:'ê¸°íƒ€'}
    ];
    function openExpenseModal(type,id=null){
        document.getElementById('expenseModalTitle').textContent=id?(type==='fixed'?'ê³ ì •ë¹„ ìˆ˜ì •':'ìœ ë™ë¹„ ìˆ˜ì •'):(type==='fixed'?'ê³ ì •ë¹„ ì¶”ê°€':'ìœ ë™ë¹„ ì¶”ê°€');
        document.getElementById('expenseEditId').value=id||'';document.getElementById('expenseType').value=type;
        document.getElementById('expenseName').value='';document.getElementById('expenseAmount').value='';document.getElementById('expenseNote').value='';
        document.getElementById('expenseDate').value=new Date().toISOString().split('T')[0];
        document.getElementById('expenseDateGroup').style.display='block';  // ê³ ì •ë¹„/ìœ ë™ë¹„ ëª¨ë‘ ë‚ ì§œ í‘œì‹œ
        document.getElementById('expenseCardGroup').style.display=type==='variable'?'block':'none';
        document.getElementById('expenseCard').value='ë¡¯ë°ì¹´ë“œ';
        // ì¥ë¹„ë¦¬ìŠ¤ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById('leaseFields').style.display='none';
        document.getElementById('leaseStartDate').value='';
        document.getElementById('leaseEndDate').value='';
        document.getElementById('leasePaymentDay').value='';
        document.getElementById('leasePaymentMethod').value='ë¡¯ë°ì¹´ë“œ';
        document.getElementById('leaseCompany').value='';
        // ì¹´í…Œê³ ë¦¬ ì˜µì…˜ ë™ì  ë³€ê²½
        const cats=type==='fixed'?fixedCategories:variableCategories;
        document.getElementById('expenseCategory').innerHTML=cats.map(c=>`<option value="${c.value}">${c.label}</option>`).join('');
        document.getElementById('expenseCategory').value='ê¸°íƒ€';
        if(id){const list=type==='fixed'?fixedExpenses:variableExpenses;const item=list.find(e=>e.id===id);if(item){
            document.getElementById('expenseName').value=item.name||'';document.getElementById('expenseCategory').value=item.category||'ê¸°íƒ€';
            document.getElementById('expenseAmount').value=item.amount||'';document.getElementById('expenseNote').value=item.note||'';
            document.getElementById('expenseDate').value=item.date||'';
            if(type==='variable'){document.getElementById('expenseCard').value=item.card||'ë¡¯ë°ì¹´ë“œ';}
            // ì¥ë¹„ë¦¬ìŠ¤ ì •ë³´ ë¡œë“œ
            if(item.category==='ì¥ë¹„ë¦¬ìŠ¤/ë Œíƒˆ'){
                document.getElementById('leaseFields').style.display='block';
                document.getElementById('leaseStartDate').value=item.leaseStartDate||'';
                document.getElementById('leaseEndDate').value=item.leaseEndDate||'';
                document.getElementById('leasePaymentDay').value=item.leasePaymentDay||'';
                document.getElementById('leasePaymentMethod').value=item.leasePaymentMethod||'ë¡¯ë°ì¹´ë“œ';
                document.getElementById('leaseCompany').value=item.leaseCompany||'';
            }
        }}
        toggleLeaseFields();
        openModal('expenseModal');
    }
    async function saveExpense(){
        const editId=document.getElementById('expenseEditId').value;
        const type=document.getElementById('expenseType').value;
        const name=document.getElementById('expenseName').value.trim();
        const category=document.getElementById('expenseCategory').value;
        const amount=parseInt(document.getElementById('expenseAmount').value)||0;
        const note=document.getElementById('expenseNote').value.trim();
        const date=document.getElementById('expenseDate').value;
        const card=document.getElementById('expenseCard').value;
        if(!name||!amount){alert('í•­ëª©ëª…ê³¼ ê¸ˆì•¡ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');return;}
        const collection=type==='fixed'?'fixedExpenses':'variableExpenses';
        const data={name,category,amount,note,date};
        if(type==='variable'){data.card=card;}
        // ì¥ë¹„ë¦¬ìŠ¤ ì •ë³´ ì €ì¥
        if(category==='ì¥ë¹„ë¦¬ìŠ¤/ë Œíƒˆ'){
            data.leaseStartDate=document.getElementById('leaseStartDate').value||null;
            data.leaseEndDate=document.getElementById('leaseEndDate').value||null;
            data.leasePaymentDay=parseInt(document.getElementById('leasePaymentDay').value)||null;
            data.leasePaymentMethod=document.getElementById('leasePaymentMethod').value||null;
            data.leaseCompany=document.getElementById('leaseCompany').value.trim()||null;
        }
        data.yearMonth=date?date.substring(0,7).replace('-',''):getYM();
        try{
            if(editId){await db.collection(collection).doc(editId).update(data);}
            else{await db.collection(collection).add(data);}
            closeModal('expenseModal');await loadExpenses();renderExpenses();
        }catch(e){alert('ì €ì¥ ì‹¤íŒ¨: '+e.message);}
    }
    function editExpense(type,id){openExpenseModal(type,id);}
    async function deleteExpense(type,id){
        if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
        try{const collection=type==='fixed'?'fixedExpenses':'variableExpenses';await db.collection(collection).doc(id).delete();await loadExpenses();renderExpenses();}catch(e){alert('ì‚­ì œ ì‹¤íŒ¨: '+e.message);}
    }

    // CRUD Operations - Payroll
    async function processPayrollFile(input){
        const file=input.files[0];
        if(!file)return;
        const reader=new FileReader();
        reader.onload=async function(e){
            try{
                const data=new Uint8Array(e.target.result);
                const workbook=XLSX.read(data,{type:'array'});
                
                // "4.ì„ê¸ˆëŒ€ì¥" ì‹œíŠ¸ ì°¾ê¸°, ì—†ìœ¼ë©´ ì²«ë²ˆì§¸ ì‹œíŠ¸
                let sheetName=workbook.SheetNames.find(n=>n.includes('ì„ê¸ˆëŒ€ì¥'))||workbook.SheetNames[0];
                const sheet=workbook.Sheets[sheetName];
                const json=XLSX.utils.sheet_to_json(sheet,{header:1});
                
                if(json.length<10){alert('ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.');return;}
                
                // ì—°ì›” ì¶”ì¶œ (í–‰1ì—ì„œ "2025 ë…„    12 ì›”" í˜•ì‹)
                let yearMonth=getYM();
                const row1=json[1];
                if(row1&&row1[0]){
                    const ymMatch=String(row1[0]).match(/(\d{4})\s*ë…„\s*(\d{1,2})\s*ì›”/);
                    if(ymMatch)yearMonth=ymMatch[1]+'-'+ymMatch[2].padStart(2,'0');
                }
                // íŒŒì¼ëª…ì—ì„œë„ ì‹œë„
                const fileMatch=file.name.match(/(\d{4})[\-_]?(\d{2})/);
                if(fileMatch&&!row1)yearMonth=fileMatch[1]+'-'+fileMatch[2];
                
                // ê¸°ì¡´ í•´ë‹¹ì›” ë°ì´í„° ì‚­ì œ
                const existing=await db.collection('payroll').where('yearMonth','==',yearMonth).get();
                const batch=db.batch();
                existing.docs.forEach(doc=>batch.delete(doc.ref));
                
                let totalNet=0;
                let count=0;
                
                // ë£¨ë¯¸ì˜ì› ê¸‰ì—¬ëŒ€ì¥ í˜•ì‹ (ë…¸ë¬´ì‚¬ ì‘ì„±)
                // ì»¬ëŸ¼ ì¸ë±ìŠ¤: 0:ë²ˆí˜¸, 1:ì„±ëª…, 11:ê¸°ë³¸ê¸‰, 14:ì¶”ê°€ì—°ì¥ìˆ˜ë‹¹(=ì‹¤ì œOT), 19:ì¸ì„¼í‹°ë¸Œ, 33:ì§€ê¸‰í•©ê³„, 46:ê³µì œí•©ê³„, 47:ì°¨ì¸ì§€ê¸‰ì•¡
                // ì¶”ê°€ì—°ì¥ìˆ˜ë‹¹ = ì‹¤ì œ OT ê¸ˆì•¡ (ì¤‘ìš”!)
                for(let i=8;i<json.length;i++){
                    const row=json[i];
                    if(!row||!row[1])continue;
                    
                    const name=String(row[1]||'').trim();
                    if(!name||name.includes('í•©ê³„')||name.includes('ì´')||name==='NaN')continue;
                    
                    const basePay=parseInt(row[11])||0;
                    // ì¶”ê°€ì—°ì¥ìˆ˜ë‹¹ = ì‹¤ì œ OT ìˆ˜ë‹¹ (ì»¬ëŸ¼14)
                    const extraOT=parseInt(row[14])||0;
                    // ì¸ì„¼í‹°ë¸Œ (ì»¬ëŸ¼19)
                    const incentive=parseInt(row[19])||0;
                    const grossPay=parseInt(row[33])||0;
                    const deduction=parseInt(row[46])||0;
                    const netPay=parseInt(row[47])||0;
                    
                    if(netPay===0&&grossPay===0)continue;
                    
                    const payrollDoc={
                        yearMonth,
                        name,
                        basePay,
                        extraOT,      // ì¶”ê°€ì—°ì¥ìˆ˜ë‹¹ = ì‹¤ì œ OT (ì¤‘ìš”!)
                        incentive,    // ì¸ì„¼í‹°ë¸Œ
                        grossPay,
                        deduction,
                        netPay,       // ì‹¤ìˆ˜ë ¹ì•¡
                        uploadedAt:firebase.firestore.FieldValue.serverTimestamp()
                    };
                    batch.set(db.collection('payroll').doc(),payrollDoc);
                    totalNet+=netPay;
                    count++;
                }
                
                if(count===0){
                    alert('ìœ íš¨í•œ ê¸‰ì—¬ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì‹œíŠ¸ëª…: '+sheetName);
                    return;
                }
                
                await batch.commit();
                alert(`${yearMonth} ê¸‰ì—¬ëŒ€ì¥ ì—…ë¡œë“œ ì™„ë£Œ!\nì§ì› ${count}ëª…\nì°¨ì¸ì§€ê¸‰ì•¡ í•©ê³„: ${formatCurrency(totalNet)}`);
                input.value='';
                await loadExpenses();
                renderExpenses();
            }catch(err){
                console.error(err);
                alert('íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜: '+err.message);
            }
        };
        reader.readAsArrayBuffer(file);
    }
    
    async function deletePayroll(id){
        if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
        try{
            await db.collection('payroll').doc(id).delete();
            await loadExpenses();renderExpenses();
        }catch(e){alert('ì‚­ì œ ì‹¤íŒ¨: '+e.message);}
    }

    // CRUD Operations - Tax
    function openTaxModal(type,id=null){
        const titles={withholding:'ì›ì²œì„¸',vat:'ë¶€ê°€ì„¸',income:'ì¢…ì†Œì„¸'};
        document.getElementById('taxModalTitle').textContent=id?titles[type]+' ìˆ˜ì •':titles[type]+' ì¶”ê°€';
        document.getElementById('taxEditId').value=id||'';
        document.getElementById('taxType').value=type;
        document.getElementById('withholdingFields').style.display=type==='withholding'?'block':'none';
        document.getElementById('vatFields').style.display=type==='vat'?'block':'none';
        document.getElementById('incomeFields').style.display=type==='income'?'block':'none';
        // ì´ˆê¸°í™”
        document.getElementById('taxDate').value=new Date().toISOString().split('T')[0];
        document.getElementById('taxAttributeMonth').value=getYM();
        document.getElementById('taxIncomeTax').value='';
        document.getElementById('taxLocalTax').value='';
        document.getElementById('taxQuarter').value='1ê¸°';
        document.getElementById('taxYear').value=String(currentYear-1);
        document.getElementById('taxIncomeType').value='ì¤‘ê°„ì˜ˆë‚©';
        document.getElementById('taxAmount').value='';
        document.getElementById('taxNote').value='';
        if(id){
            const list=type==='withholding'?withholdingTaxes:type==='vat'?vatTaxes:incomeTaxes;
            const item=list.find(t=>t.id===id);
            if(item){
                document.getElementById('taxDate').value=item.date||'';
                document.getElementById('taxAmount').value=item.amount||'';
                document.getElementById('taxNote').value=item.note||'';
                if(type==='withholding'){
                    document.getElementById('taxAttributeMonth').value=item.attributeMonth||'';
                    document.getElementById('taxIncomeTax').value=item.incomeTax||'';
                    document.getElementById('taxLocalTax').value=item.localTax||'';
                }else if(type==='vat'){
                    document.getElementById('taxQuarter').value=item.quarter||'1ê¸°';
                }else{
                    document.getElementById('taxYear').value=item.taxYear||String(currentYear-1);
                    document.getElementById('taxIncomeType').value=item.incomeType||'ì¤‘ê°„ì˜ˆë‚©';
                }
            }
        }
        openModal('taxModal');
    }
    async function saveTax(){
        const editId=document.getElementById('taxEditId').value;
        const type=document.getElementById('taxType').value;
        const date=document.getElementById('taxDate').value;
        const note=document.getElementById('taxNote').value.trim();
        if(!date){alert('ë‚©ë¶€ì¼ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');return;}
        const collections={withholding:'withholdingTaxes',vat:'vatTaxes',income:'incomeTaxes'};
        const collection=collections[type];
        let data={date,note,year:date.substring(0,4)};
        if(type==='withholding'){
            data.attributeMonth=document.getElementById('taxAttributeMonth').value;
            data.incomeTax=parseInt(document.getElementById('taxIncomeTax').value)||0;
            data.localTax=parseInt(document.getElementById('taxLocalTax').value)||0;
            data.amount=data.incomeTax+data.localTax;
        }else if(type==='vat'){
            data.quarter=document.getElementById('taxQuarter').value;
            data.amount=parseInt(document.getElementById('taxAmount').value)||0;
        }else{
            data.taxYear=document.getElementById('taxYear').value;
            data.incomeType=document.getElementById('taxIncomeType').value;
            data.amount=parseInt(document.getElementById('taxAmount').value)||0;
        }
        if(!data.amount){alert('ë‚©ë¶€ì„¸ì•¡ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');return;}
        try{
            if(editId){await db.collection(collection).doc(editId).update(data);}
            else{await db.collection(collection).add(data);}
            closeModal('taxModal');await loadExpenses();renderExpenses();
        }catch(e){alert('ì €ì¥ ì‹¤íŒ¨: '+e.message);}
    }
    function editTax(type,id){openTaxModal(type,id);}
    async function deleteTax(type,id){
        if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
        try{
            const collections={withholding:'withholdingTaxes',vat:'vatTaxes',income:'incomeTaxes'};
            await db.collection(collections[type]).doc(id).delete();
            await loadExpenses();renderExpenses();
        }catch(e){alert('ì‚­ì œ ì‹¤íŒ¨: '+e.message);}
    }
    
    // Tax PDF Upload
    function initTaxDropZone(){
        const dropZone=document.getElementById('taxDropZone');
        if(!dropZone)return;
        dropZone.addEventListener('click',()=>document.getElementById('taxFile').click());
        dropZone.addEventListener('dragover',e=>{e.preventDefault();dropZone.style.borderColor='var(--primary)';dropZone.style.background='rgba(154,139,122,0.1)';});
        dropZone.addEventListener('dragleave',e=>{e.preventDefault();dropZone.style.borderColor='#ddd';dropZone.style.background='';});
        dropZone.addEventListener('drop',e=>{
            e.preventDefault();
            dropZone.style.borderColor='#ddd';dropZone.style.background='';
            const files=e.dataTransfer.files;
            if(files.length>0)handleTaxFiles(files);
        });
    }
    
    function processTaxFile(input){
        if(input.files.length>0)handleTaxFiles(input.files);
        input.value='';
    }
    
    async function handleTaxFiles(files){
        for(const file of files){
            try{
                const fileName=file.name.toLowerCase();
                const originalFileName=file.name;
                let taxType=null;
                
                // íŒŒì¼ëª…ìœ¼ë¡œ ì„¸ê¸ˆ ì¢…ë¥˜ ì¶”ì •
                if(fileName.includes('ë¶€ê°€')&&(fileName.includes('ì„¸')||fileName.includes('ê°€ì¹˜'))){
                    taxType='vat';
                }else if(fileName.includes('ì¢…í•©ì†Œë“')||fileName.includes('ì¢…ì†Œì„¸')){
                    taxType='income';
                }else if(fileName.includes('ê·¼ë¡œ')||fileName.includes('ì›ì²œ')){
                    taxType='withholding_income';
                }else if(fileName.includes('ì§€ë°©')){
                    taxType='withholding_local';
                }else{
                    alert('íŒŒì¼ëª…ì—ì„œ ì„¸ê¸ˆ ì¢…ë¥˜ë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: '+file.name+'\n\níŒŒì¼ëª…ì— "ë¶€ê°€ì„¸", "ì¢…í•©ì†Œë“ì„¸", "ê·¼ë¡œ", "ì§€ë°©ì„¸" í‚¤ì›Œë“œë¥¼ í¬í•¨í•´ì£¼ì„¸ìš”.');
                    continue;
                }
                
                // PDFì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
                let pdfText='';
                if(file.type==='application/pdf'||fileName.endsWith('.pdf')){
                    try{
                        pdfText=await extractPdfText(file);
                        console.log('ğŸ“„ PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ ì™„ë£Œ:',pdfText.substring(0,500));
                    }catch(pdfErr){
                        console.error('PDF ì¶”ì¶œ ì‹¤íŒ¨:',pdfErr);
                    }
                }
                
                // íŒŒì¼ëª… + PDF í…ìŠ¤íŠ¸ì—ì„œ ì •ë³´ ì¶”ì¶œ
                const taxInfo=parseTaxInfo(originalFileName,pdfText,taxType);
                console.log('ğŸ“Š íŒŒì‹± ê²°ê³¼:',taxInfo);
                await saveTaxFromFile(taxInfo);
            }catch(err){
                console.error('íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:',err);
                alert('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: '+err.message);
            }
        }
    }
    
    async function extractPdfText(file){
        return new Promise((resolve,reject)=>{
            const reader=new FileReader();
            reader.onload=async function(e){
                try{
                    if(typeof pdfjsLib==='undefined'){
                        console.error('PDF.js ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                        resolve('');
                        return;
                    }
                    pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    const loadingTask=pdfjsLib.getDocument({data:new Uint8Array(e.target.result)});
                    const pdf=await loadingTask.promise;
                    let text='';
                    for(let i=1;i<=pdf.numPages;i++){
                        const page=await pdf.getPage(i);
                        const content=await page.getTextContent();
                        const pageText=content.items.map(item=>item.str).join(' ');
                        text+=pageText+'\n';
                    }
                    console.log('ğŸ“‘ ì „ì²´ PDF í…ìŠ¤íŠ¸:\n',text);
                    resolve(text);
                }catch(err){
                    console.error('PDF íŒŒì‹± ì˜¤ë¥˜:',err);
                    resolve('');
                }
            };
            reader.onerror=()=>{
                console.error('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜');
                resolve('');
            };
            reader.readAsArrayBuffer(file);
        });
    }
    
    function parseTaxInfo(fileName,pdfText,taxType){
        const info={type:taxType,fileName};
        const combinedText=fileName+' '+pdfText;
        const allText=combinedText.replace(/\s+/g,' ');
        
        console.log('ğŸ” íŒŒì‹± ì‹œì‘ - ì„¸ê¸ˆì¢…ë¥˜:',taxType);
        
        // ê¸ˆì•¡ íŒ¨í„´ë“¤ (ë‹¤ì–‘í•œ í˜•ì‹ ì§€ì›)
        const amountPatterns=[
            // "ê³„" ë‹¤ìŒ ê¸ˆì•¡ (êµ­ì„¸ ë‚©ë¶€ì„œ)
            /ê³„\s*([0-9,]+)/g,
            // "í•© ê³„" ë˜ëŠ” "í•©ê³„" ê¸ˆì•¡
            /í•©\s*ê³„\s*([0-9,]+)/g,
            // ë‚©ë¶€ê¸ˆì•¡
            /ë‚©ë¶€ê¸ˆì•¡\s*([0-9,]+)/g,
            /ë‚©ë¶€ì„¸ì•¡\s*([0-9,]+)/g,
            // ì„¸ëª©ë³„ ê¸ˆì•¡
            /ë¶€ê°€ê°€ì¹˜ì„¸\s*([0-9,]+)/g,
            /ì¢…í•©ì†Œë“ì„¸\s*([0-9,]+)/g,
            /ê·¼ë¡œì†Œë“ì„¸[^\d]*([0-9,]+)/g,
            /ì§€ë°©ì†Œë“ì„¸[^\d]*([0-9,]+)/g,
            // ì¼ë°˜ í° ê¸ˆì•¡ íŒ¨í„´ (1ë°±ë§Œì› ì´ìƒ)
            /([1-9][0-9]{0,2},[0-9]{3},[0-9]{3})/g,
            /([1-9][0-9]{6,})/g
        ];
        
        // ê°€ì¥ í° ê¸ˆì•¡ ì°¾ê¸° (ì„¸ê¸ˆì€ ë³´í†µ ê°€ì¥ í° ê¸ˆì•¡)
        let maxAmount=0;
        let foundAmounts=[];
        
        for(const pattern of amountPatterns){
            const matches=[...allText.matchAll(pattern)];
            for(const match of matches){
                const amountStr=match[1]||match[0];
                const amount=parseInt(amountStr.replace(/,/g,''));
                if(amount>10000){// 1ë§Œì› ì´ìƒë§Œ
                    foundAmounts.push(amount);
                    if(amount>maxAmount)maxAmount=amount;
                }
            }
        }
        
        console.log('ğŸ’° ë°œê²¬ëœ ê¸ˆì•¡ë“¤:',foundAmounts);
        
        if(maxAmount>0){
            info.amount=maxAmount;
        }
        
        // ë‚©ë¶€ê¸°í•œ ì¶”ì¶œ (ë‹¤ì–‘í•œ í˜•ì‹)
        const datePatterns=[
            /ë‚©ë¶€ê¸°í•œ[ì¼]?\s*[:\s]*(\d{4})[\-ë…„\.]?\s*(\d{1,2})[\-ì›”\.]?\s*(\d{1,2})/,
            /(\d{4})ë…„\s*(\d{1,2})ì›”\s*(\d{1,2})ì¼\s*ê¹Œì§€/,
            /(\d{4})-(\d{2})-(\d{2})/
        ];
        
        for(const pattern of datePatterns){
            const match=allText.match(pattern);
            if(match){
                info.dueDate=match[1]+'-'+match[2].padStart(2,'0')+'-'+match[3].padStart(2,'0');
                console.log('ğŸ“… ë‚©ë¶€ê¸°í•œ:',info.dueDate);
                break;
            }
        }
        
        // ê·€ì†ì›” ì¶”ì¶œ
        const attrMatch=allText.match(/(\d{1,2})ì›”\s*ê·€ì†/);
        if(attrMatch){
            const yearMatch=allText.match(/(\d{4})/);
            const year=yearMatch?yearMatch[1]:String(currentYear);
            info.attributeMonth=year+'-'+attrMatch[1].padStart(2,'0');
            console.log('ğŸ“† ê·€ì†ì›”:',info.attributeMonth);
        }
        
        // ë¶„ê¸° ì¶”ì¶œ (ë¶€ê°€ì„¸)
        const quarterMatch=allText.match(/(\d{4})\s*ë…„?\s*(\d)\s*ê¸°/);
        if(quarterMatch){
            info.year=quarterMatch[1];
            info.quarter=quarterMatch[2]+'ê¸°';
            console.log('ğŸ“Š ë¶„ê¸°:',info.quarter);
        }
        
        // ê·€ì†ì—°ë„ (ì¢…ì†Œì„¸)
        if(taxType==='income'){
            const yearPatterns=[
                /_(\d{4})_/,
                /(\d{4})ë…„?\s*ê·€ì†/,
                /ê·€ì†[^\d]*(\d{4})/
            ];
            for(const p of yearPatterns){
                const m=allText.match(p);
                if(m){info.taxYear=m[1];break;}
            }
            if(!info.taxYear){
                const y=allText.match(/(\d{4})/);
                if(y)info.taxYear=y[1];
            }
            
            // êµ¬ë¶„
            if(allText.includes('ì¤‘ê°„ì˜ˆë‚©'))info.incomeType='ì¤‘ê°„ì˜ˆë‚©';
            else if(allText.includes('í™•ì •'))info.incomeType='í™•ì •ì‹ ê³ ';
            else if(allText.includes('ë¶„ë‚©'))info.incomeType='ë¶„ë‚©';
        }
        
        return info;
    }
    
    async function saveTaxFromFile(info){
        // íŒŒì¼ì—ì„œ ì¶”ì¶œí•œ ì •ë³´ë¡œ ëª¨ë‹¬ ì—´ê¸°
        if(info.type==='vat'){
            openTaxModal('vat');
            if(info.quarter)document.getElementById('taxQuarter').value=info.quarter;
            if(info.amount)document.getElementById('taxAmount').value=info.amount;
            if(info.dueDate)document.getElementById('taxDate').value=info.dueDate;
            document.getElementById('taxNote').value='íŒŒì¼: '+info.fileName;
        }else if(info.type==='income'){
            openTaxModal('income');
            if(info.taxYear)document.getElementById('taxYear').value=info.taxYear;
            if(info.incomeType)document.getElementById('taxIncomeType').value=info.incomeType;
            if(info.amount)document.getElementById('taxAmount').value=info.amount;
            if(info.dueDate)document.getElementById('taxDate').value=info.dueDate;
            document.getElementById('taxNote').value='íŒŒì¼: '+info.fileName;
        }else if(info.type==='withholding_income'){
            openTaxModal('withholding');
            if(info.attributeMonth)document.getElementById('taxAttributeMonth').value=info.attributeMonth;
            if(info.amount)document.getElementById('taxIncomeTax').value=info.amount;
            if(info.dueDate)document.getElementById('taxDate').value=info.dueDate;
            document.getElementById('taxNote').value='íŒŒì¼: '+info.fileName;
        }else if(info.type==='withholding_local'){
            openTaxModal('withholding');
            if(info.attributeMonth)document.getElementById('taxAttributeMonth').value=info.attributeMonth;
            if(info.amount)document.getElementById('taxLocalTax').value=info.amount;
            if(info.dueDate)document.getElementById('taxDate').value=info.dueDate;
            document.getElementById('taxNote').value='íŒŒì¼: '+info.fileName;
        }
        
        const amountStr=info.amount?formatCurrency(info.amount):'ì¸ì‹ ì‹¤íŒ¨';
        alert(`ğŸ“„ ì„¸ê¸ˆ ê³ ì§€ì„œ ì¸ì‹ ì™„ë£Œ!\n\nì„¸ê¸ˆ ì¢…ë¥˜: ${info.type==='vat'?'ë¶€ê°€ì„¸':info.type==='income'?'ì¢…ì†Œì„¸':'ì›ì²œì„¸'}\nê¸ˆì•¡: ${amountStr}\n\në‚´ìš©ì„ í™•ì¸í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”.`);
    }

    // CRUD Operations - Employee
    function generateEmployeeId(name,joinDate){
        const year=joinDate?joinDate.substring(2,4):String(new Date().getFullYear()).substring(2);
        const CHO=['ã„±','ã„²','ã„´','ã„·','ã„¸','ã„¹','ã…','ã…‚','ã…ƒ','ã……','ã…†','ã…‡','ã…ˆ','ã…‰','ã…Š','ã…‹','ã…Œ','ã…','ã…'];
        const ALPHA=['g','kk','n','d','tt','r','m','b','pp','s','ss','o','j','jj','ch','k','t','p','h'];
        let initials='';
        for(let i=0;i<name.length&&initials.length<3;i++){
            const code=name.charCodeAt(i);
            if(code>=0xAC00&&code<=0xD7A3){initials+=ALPHA[Math.floor((code-0xAC00)/588)];}
            else if(/[a-zA-Z]/.test(name[i])){initials+=name[i].toLowerCase();}
        }
        return year+initials.substring(0,3).padEnd(3,'x');
    }
    function openEmployeeModal(id=null){
        document.getElementById('employeeModalTitle').textContent=id?'ì§ì› ìˆ˜ì •':'ì§ì› ë“±ë¡';
        document.getElementById('empEditId').value=id||'';
        document.getElementById('empName').value='';
        document.getElementById('empMatchName').value='';
        document.getElementById('empRole').value='staff';
        document.getElementById('empJoinDate').value='';
        document.getElementById('empSalary').value='';
        document.getElementById('empHourly').value='12000';
        document.getElementById('empIncentiveType').value='none';
        document.getElementById('empBirthday').value='';
        document.getElementById('empStatus').value='active';
        document.getElementById('empAnnualLeave').value='';
        document.getElementById('empUsedLeave').value='0';
        document.getElementById('autoAnnualLeave').textContent='0';
        document.getElementById('empId').value='';
        if(id){
            const emp=employees.find(e=>e.id===id);
            if(emp){
                document.getElementById('empName').value=emp.name||'';
                document.getElementById('empMatchName').value=emp.matchName||'';
                document.getElementById('empRole').value=emp.role||'staff';
                document.getElementById('empJoinDate').value=emp.joinDate||'';
                document.getElementById('empSalary').value=emp.salary||'';
                document.getElementById('empHourly').value=emp.hourly||12000;
                document.getElementById('empIncentiveType').value=emp.incentiveType||'none';
                document.getElementById('empBirthday').value=emp.birthday||'';
                document.getElementById('empStatus').value=emp.status||'active';
                document.getElementById('empAnnualLeave').value=emp.annualLeave||'';
                document.getElementById('empUsedLeave').value=emp.usedLeave||0;
                document.getElementById('empId').value=emp.id;
                // ë²•ì • ì—°ì°¨ ìë™ê³„ì‚° í‘œì‹œ
                const autoLeave=calculateLegalAnnualLeave(emp.joinDate);
                document.getElementById('autoAnnualLeave').textContent=autoLeave;
            }
        }
        openModal('employeeModal');
    }
    
    // ë²•ì • ì—°ì°¨ ìë™ê³„ì‚° (ê·¼ë¡œê¸°ì¤€ë²•)
    function calculateLegalAnnualLeave(joinDate){
        if(!joinDate)return 0;
        const join=new Date(joinDate);
        const now=new Date();
        const diffMs=now-join;
        const diffDays=Math.floor(diffMs/(1000*60*60*24));
        const years=Math.floor(diffDays/365);
        
        if(years<1){
            // 1ë…„ ë¯¸ë§Œ: 1ê°œì›” ê°œê·¼ ì‹œ 1ì¼ (ìµœëŒ€ 11ì¼)
            const months=Math.floor(diffDays/30);
            return Math.min(months,11);
        }else{
            // 1ë…„ ì´ìƒ: 15ì¼ + 2ë…„ë§ˆë‹¤ 1ì¼ ì¶”ê°€ (ìµœëŒ€ 25ì¼)
            const extraDays=Math.floor((years-1)/2);
            return Math.min(15+extraDays,25);
        }
    }
    
    // ì…ì‚¬ì¼ ë³€ê²½ ì‹œ ë²•ì • ì—°ì°¨ ìë™ê³„ì‚°
    document.getElementById('empJoinDate')?.addEventListener('change',function(){
        const autoLeave=calculateLegalAnnualLeave(this.value);
        document.getElementById('autoAnnualLeave').textContent=autoLeave;
    });
    
    // ì—°ë´‰ ì…ë ¥ ì‹œ ì‹œê¸‰ ìë™ ê³„ì‚° (ì—°ë´‰ Ã· 2508ì‹œê°„)
    document.getElementById('empSalary')?.addEventListener('input',function(){
        const salary=parseInt(this.value)||0;
        const hourly=salary>0?Math.round(salary*10000/2508):12000;
        document.getElementById('empHourly').value=hourly;
    });
    function editEmployee(id){openEmployeeModal(id);}
    async function saveEmployee(){
        const editId=document.getElementById('empEditId').value;
        const name=document.getElementById('empName').value.trim();
        const joinDate=document.getElementById('empJoinDate').value;
        if(!name||!joinDate){alert('ì´ë¦„ê³¼ ì…ì‚¬ì¼ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');return;}
        
        // ID ê²°ì •: ìˆ˜ì • ì‹œ ê¸°ì¡´ ID, ì‹ ê·œ ì‹œ ì´ë¦„ì„ IDë¡œ ì‚¬ìš©
        let empId=editId||name;
        
        // ì‹ ê·œ ë“±ë¡ ì‹œ ì´ë¦„ ì¤‘ë³µ ì²´í¬
        if(!editId){
            const existing=await db.collection('employees').doc(name).get();
            if(existing.exists){
                alert('ì´ë¯¸ ë“±ë¡ëœ ì´ë¦„ì…ë‹ˆë‹¤: '+name);
                return;
            }
        }
        
        const salary=parseInt(document.getElementById('empSalary').value)||0;
        const annualLeaveInput=document.getElementById('empAnnualLeave').value;
        const annualLeave=annualLeaveInput?parseInt(annualLeaveInput):null; // nullì´ë©´ ìë™ê³„ì‚° ì‚¬ìš©
        const usedLeave=parseInt(document.getElementById('empUsedLeave').value)||0;
        
        const data={
            name,
            matchName:document.getElementById('empMatchName').value.trim(),
            role:document.getElementById('empRole').value,
            joinDate,
            salary:salary,
            hourly:parseInt(document.getElementById('empHourly').value)||12000,
            incentiveType:document.getElementById('empIncentiveType').value,
            birthday:document.getElementById('empBirthday').value,
            status:document.getElementById('empStatus').value,
            annualLeave:annualLeave,
            usedLeave:usedLeave
        };
        try{
            await db.collection('employees').doc(empId).set(data,{merge:true});
            closeModal('employeeModal');
            await loadEmployees();
            renderAll();
            alert('ì§ì› ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }catch(e){alert('ì €ì¥ ì‹¤íŒ¨: '+e.message);}
    }
    async function deleteEmployee(id){
        if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
        try{
            await db.collection('employees').doc(id).delete();
            await loadEmployees();
            renderAll();
        }catch(e){alert('ì‚­ì œ ì‹¤íŒ¨: '+e.message);}
    }

    // CRUD Operations - Lunch OT
    function openOTModal(){
        document.getElementById('otDate').value=new Date().toISOString().split('T')[0];
        document.getElementById('otMinutes').value='30';document.getElementById('otReason').value='';
        openModal('otModal');
    }
    async function saveLunchOT(){
        const date=document.getElementById('otDate').value;
        const employeeId=document.getElementById('otEmployee').value;
        const minutes=parseInt(document.getElementById('otMinutes').value)||0;
        const reason=document.getElementById('otReason').value.trim();
        if(!date||!employeeId||!minutes){alert('ë‚ ì§œ, ì§ì›, ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}
        try{await db.collection('lunchOT').add({date,employeeId,minutes,reason,createdAt:firebase.firestore.FieldValue.serverTimestamp()});closeModal('otModal');await loadLunchOT();renderOvertime();}catch(e){alert('ì €ì¥ ì‹¤íŒ¨: '+e.message);}
    }
    async function deleteLunchOT(id){if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;try{await db.collection('lunchOT').doc(id).delete();await loadLunchOT();renderOvertime();}catch(e){alert('ì‚­ì œ ì‹¤íŒ¨: '+e.message);}}

    // CRUD Operations - Incentive Items
    function toggleIncItemFields(){
        const type=document.getElementById('incItemType').value;
        document.getElementById('perCaseFields').style.display=type==='perCase'?'block':'none';
        document.getElementById('japanSalesFields').style.display=type==='japanSales'?'block':'none';
    }
    
    function openIncentiveItemModal(id=null){
        document.getElementById('incentiveItemModalTitle').textContent=id?'ì¸ì„¼í‹°ë¸Œ í•­ëª© ìˆ˜ì •':'ì¸ì„¼í‹°ë¸Œ í•­ëª© ì¶”ê°€';
        document.getElementById('incItemEditId').value=id||'';
        document.getElementById('incItemName').value='';
        document.getElementById('incItemType').value='perCase';
        document.getElementById('incItemPrice').value='50000';
        document.getElementById('incItemPercent').value='1';
        toggleIncItemFields();
        const selectedEmps=id?incentiveItems.find(i=>i.id===id)?.employees||[]:[];
        const container=document.getElementById('incItemEmployees');
        container.innerHTML=employees.filter(e=>e.status==='active').map(e=>`<label style="display:block;padding:.4rem 0;cursor:pointer"><input type="checkbox" name="incEmp" value="${e.id}" ${selectedEmps.includes(e.id)?'checked':''}> ${e.name} (${roleLabels[e.role]||e.role})</label>`).join('')||'<div style="color:var(--text-muted)">ë“±ë¡ëœ ì§ì› ì—†ìŒ</div>';
        if(id){const item=incentiveItems.find(i=>i.id===id);if(item){
            document.getElementById('incItemName').value=item.name||'';
            document.getElementById('incItemType').value=item.type||'perCase';
            document.getElementById('incItemPrice').value=item.price||50000;
            document.getElementById('incItemPercent').value=item.percent||1;
            toggleIncItemFields();
        }}
        openModal('incentiveItemModal');
    }
    async function saveIncentiveItem(){
        const editId=document.getElementById('incItemEditId').value;
        const name=document.getElementById('incItemName').value.trim();
        const type=document.getElementById('incItemType').value;
        const price=parseInt(document.getElementById('incItemPrice').value)||0;
        const percent=parseFloat(document.getElementById('incItemPercent').value)||1;
        const selectedEmps=Array.from(document.querySelectorAll('input[name="incEmp"]:checked')).map(cb=>cb.value);
        if(!name){alert('í•­ëª©ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}
        const data={name,type,employees:selectedEmps};
        if(type==='perCase'){
            data.price=price;
        }else if(type==='japanSales'){
            data.percent=percent;
        }
        try{
            if(editId){await db.collection('incentiveItems').doc(editId).update(data);}
            else{await db.collection('incentiveItems').add(data);}
            closeModal('incentiveItemModal');await loadIncentiveItems();renderIncentiveItems();
        }catch(e){alert('ì €ì¥ ì‹¤íŒ¨: '+e.message);}
    }
    function editIncentiveItem(id){openIncentiveItemModal(id);}
    async function deleteIncentiveItem(id){if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;try{await db.collection('incentiveItems').doc(id).delete();await loadIncentiveItems();renderIncentiveItems();}catch(e){alert('ì‚­ì œ ì‹¤íŒ¨: '+e.message);}}

    // File Upload
    const uploadZone=document.getElementById('uploadZone');
    uploadZone.addEventListener('click',()=>document.getElementById('fileInput').click());
    uploadZone.addEventListener('dragover',e=>{e.preventDefault();uploadZone.style.borderColor='var(--accent-gold)';});
    uploadZone.addEventListener('dragleave',()=>{uploadZone.style.borderColor='var(--border-color)';});
    uploadZone.addEventListener('drop',e=>{e.preventDefault();uploadZone.style.borderColor='var(--border-color)';if(e.dataTransfer.files[0])processFile(e.dataTransfer.files[0]);});
    function handleFileUpload(e){if(e.target.files[0])processFile(e.target.files[0]);}

    function processFile(file){
        const reader=new FileReader();
        reader.onload=async function(e){
            try{
                const data=new Uint8Array(e.target.result);
                const wb=XLSX.read(data,{type:'array'});
                const sheet=wb.Sheets[wb.SheetNames[0]];
                const json=XLSX.utils.sheet_to_json(sheet);
                
                // ì›”ë³„ë¡œ ë°ì´í„° ë¶„ë¦¬
                const monthlyData={};
                
                json.forEach(row=>{
                    const amount=parseInt(row['ê¸ˆì•¡'])||0;
                    const dateStr=String(row['ì§„ë£Œì¼']||'');
                    if(dateStr.length<6)return;
                    
                    const year=dateStr.substring(0,4);
                    const month=dateStr.substring(4,6);
                    const ym=year+'-'+month;
                    
                    const yearNum=parseInt(year);
                    const monthNum=parseInt(month);
                    if(yearNum<2020||yearNum>2030||monthNum<1||monthNum>12)return;
                    
                    if(!monthlyData[ym]){
                        monthlyData[ym]={
                            total:0,japan:0,transactions:0,
                            patients:new Set(),  // ì „ì²´ ê³ ìœ  í™˜ì
                            doctorSales:{},staffSales:{},
                            japanCharts:{},japanStaffSales:{}
                        };
                    }
                    
                    const chartNo=row['ì°¨íŠ¸ë²ˆí˜¸'];
                    monthlyData[ym].total+=amount;
                    monthlyData[ym].transactions++;
                    if(chartNo)monthlyData[ym].patients.add(chartNo);  // ê³ ìœ  í™˜ì ì¶”ì 
                    
                    const doctor=row['ì§„ë£Œì˜ëª…'];
                    if(doctor&&doctor!=='ë¹ ë¥¸ì˜ˆì•½'){
                        if(!monthlyData[ym].doctorSales[doctor]){
                            monthlyData[ym].doctorSales[doctor]={count:0,amount:0,patients:new Set()};
                        }
                        monthlyData[ym].doctorSales[doctor].count++;
                        monthlyData[ym].doctorSales[doctor].amount+=amount;
                        if(chartNo)monthlyData[ym].doctorSales[doctor].patients.add(chartNo);
                    }
                    
                    const staff=row['ë‹´ë‹¹ì§ì›'];
                    if(staff){
                        if(!monthlyData[ym].staffSales[staff]){
                            monthlyData[ym].staffSales[staff]={count:0,amount:0,patients:new Set()};
                        }
                        monthlyData[ym].staffSales[staff].count++;
                        monthlyData[ym].staffSales[staff].amount+=amount;
                        if(chartNo)monthlyData[ym].staffSales[staff].patients.add(chartNo);
                    }
                    
                    // ì¼ë³¸ì¸ ë§¤ì¶œ ì²˜ë¦¬ (ì°¨íŠ¸ë²ˆí˜¸ ê¸°ë°˜)
                    const nationality=row['êµ­ì '];
                    if(nationality&&nationality.includes('ì¼ë³¸')){
                        monthlyData[ym].japan+=amount;
                        // ì°¨íŠ¸ë²ˆí˜¸ë¡œ ê³ ìœ  í™˜ì ì¶”ì 
                        if(chartNo){
                            if(!monthlyData[ym].japanCharts[chartNo]){
                                monthlyData[ym].japanCharts[chartNo]={amount:0,staff:staff||'ë¯¸ì§€ì •'};
                            }
                            monthlyData[ym].japanCharts[chartNo].amount+=amount;
                        }
                        // ë‹´ë‹¹ì§ì›ë³„ ì¼ë³¸ì¸ ë§¤ì¶œ
                        const staffKey=staff||'ë¯¸ì§€ì •';
                        if(!monthlyData[ym].japanStaffSales[staffKey]){
                            monthlyData[ym].japanStaffSales[staffKey]={patients:new Set(),amount:0};
                        }
                        monthlyData[ym].japanStaffSales[staffKey].amount+=amount;
                        if(chartNo)monthlyData[ym].japanStaffSales[staffKey].patients.add(chartNo);
                    }
                });
                
                // ê° ì›”ë³„ë¡œ Firebaseì— ì €ì¥
                const months=Object.keys(monthlyData).sort();
                let savedCount=0;
                
                for(const ym of months){
                    const d=monthlyData[ym];
                    // ì „ì²´ ê³ ìœ  í™˜ì ìˆ˜
                    const patientCount=d.patients.size;
                    // ì¼ë³¸ì¸ ê³ ìœ  í™˜ì ìˆ˜
                    const japanVisitors=Object.keys(d.japanCharts).length;
                    
                    // doctorSalesì˜ Setì„ ìˆ«ìë¡œ ë³€í™˜
                    const doctorSalesForDB={};
                    for(const[doc,data]of Object.entries(d.doctorSales||{})){
                        doctorSalesForDB[doc]={
                            count:data.count,
                            amount:data.amount,
                            patients:data.patients.size
                        };
                    }
                    // staffSalesì˜ Setì„ ìˆ«ìë¡œ ë³€í™˜
                    const staffSalesForDB={};
                    for(const[staff,data]of Object.entries(d.staffSales||{})){
                        staffSalesForDB[staff]={
                            count:data.count,
                            amount:data.amount,
                            patients:data.patients.size
                        };
                    }
                    // japanStaffSalesì˜ Setì„ ìˆ«ìë¡œ ë³€í™˜
                    const japanStaffSalesForDB={};
                    for(const[staff,data]of Object.entries(d.japanStaffSales||{})){
                        japanStaffSalesForDB[staff]={
                            patients:data.patients.size,
                            amount:data.amount
                        };
                    }
                    
                    await db.collection('revenue').doc(ym).set({
                        total:d.total,japan:d.japan,
                        japanVisitors:japanVisitors,
                        transactions:d.transactions,
                        patients:patientCount,
                        uploadedAt:firebase.firestore.FieldValue.serverTimestamp()
                    },{merge:true});
                    await db.collection('salesDetail').doc(ym).set({
                        doctorSales:doctorSalesForDB,
                        staffSales:staffSalesForDB,
                        japanStaffSales:japanStaffSalesForDB,
                        updatedAt:firebase.firestore.FieldValue.serverTimestamp()
                    });
                    savedCount++;
                }
                
                // ê²°ê³¼ ì•Œë¦¼
                const totalAll=Object.values(monthlyData).reduce((s,d)=>s+d.total,0);
                const patientsAll=Object.values(monthlyData).reduce((s,d)=>s+d.patients.size,0);
                alert(`ì—…ë¡œë“œ ì™„ë£Œ!\n\nì €ì¥ëœ ì›”: ${months.join(', ')}\nì´ ${savedCount}ê°œì›” ë°ì´í„°\nì´ í™˜ì: ${patientsAll}ëª…\nì´ ë§¤ì¶œ: ${formatCurrency(totalAll)}`);
                
                await loadRevenueData();await loadSalesDetailData();renderAll();
            }catch(err){alert('íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜: '+err.message);console.error(err);}
        };
        reader.readAsArrayBuffer(file);
    }
    
    // ì—…ë¡œë“œ ì´ë ¥ ì‚­ì œ
    async function deleteRevenue(ym){
        if(!confirm(`${ym} ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\në§¤ì¶œ ë° ìƒì„¸ ë°ì´í„°ê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.`))return;
        try{
            await db.collection('revenue').doc(ym).delete();
            await db.collection('salesDetail').doc(ym).delete();
            alert(`${ym} ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            await loadRevenueData();await loadSalesDetailData();renderAll();
        }catch(err){alert('ì‚­ì œ ì‹¤íŒ¨: '+err.message);}
    }

    // Export Pre-Payroll (ë…¸ë¬´ì‚¬ ì „ë‹¬ìš©)
    function exportPrePayroll(){
        const ym=getYM();
        const detail=salesDetail[ym]||{};
        const japanStaffSales=detail.japanStaffSales||{};
        const roleLabelsLocal={doctor:'ì›ì¥',nurse:'ê°„í˜¸ì‚¬',coordinator:'ì½”ë””ë„¤ì´í„°',marketing:'ë§ˆì¼€íŒ…',manager:'ì‹¤ì¥',esthetician:'í”¼ë¶€ê´€ë¦¬ì‚¬'};
        
        const rows=[['ì§ì›','ì§ê¸‰','ì—°ë´‰(ë§Œì›)','ì‹œê¸‰','OTì‹œê°„(H)','ì˜ˆìƒOTìˆ˜ë‹¹','ì¸ì„¼í‹°ë¸Œì‹¤ì (ê±´)','ì˜ˆìƒì¸ì„¼í‹°ë¸Œ']];
        
        employees.filter(e=>e.status==='active').forEach(emp=>{
            // OT ê³„ì‚°
            const empAttendance=attendance.filter(a=>a.employeeId===emp.id&&a.date?.startsWith(ym));
            let otMinutes=0;
            empAttendance.forEach(a=>{
                if(a.checkOut){
                    const [h,m]=(a.checkOut||'00:00').split(':').map(Number);
                    if(h*60+m>18*60)otMinutes+=(h*60+m)-18*60;
                }
            });
            const empLunchOT=lunchOT.filter(ot=>ot.employeeId===emp.id&&ot.date?.startsWith(ym));
            otMinutes+=empLunchOT.reduce((sum,ot)=>sum+(ot.minutes||0),0);
            const otHours=(otMinutes/60).toFixed(1);
            const otPay=Math.round(otMinutes/60*(emp.hourly||12000)*1.5);
            
            // ì¸ì„¼í‹°ë¸Œ ê³„ì‚°
            const empRecords=incentiveRecords.filter(r=>r.employeeId===emp.id&&r.yearMonth===ym);
            let incentiveCount=empRecords.length;
            let incentiveAmount=0;
            empRecords.forEach(r=>{
                const item=incentiveItems.find(i=>i.id===r.itemId);
                if(item&&item.type!=='japanSales'){
                    incentiveAmount+=item.price||0;
                }
            });
            // ì¼ë³¸ì¸ ë§¤ì¶œ ì¸ì„¼í‹°ë¸Œ
            const japanItems=incentiveItems.filter(i=>i.type==='japanSales'&&i.employees?.includes(emp.id));
            japanItems.forEach(item=>{
                if(emp.matchName&&japanStaffSales[emp.matchName]){
                    incentiveAmount+=Math.round(japanStaffSales[emp.matchName]*(item.percent||1)/100);
                }
            });
            
            rows.push([
                emp.name,
                roleLabelsLocal[emp.role]||emp.role,
                emp.salary||0,
                emp.hourly||12000,
                otHours,
                otPay,
                incentiveCount,
                incentiveAmount
            ]);
        });
        
        const ws=XLSX.utils.aoa_to_sheet(rows);
        const wb=XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb,ws,'ì‚¬ì „ê¸‰ì—¬ëŒ€ì¥');
        XLSX.writeFile(wb,'ì‚¬ì „ê¸‰ì—¬ëŒ€ì¥_'+ym+'_ë…¸ë¬´ì‚¬ì „ë‹¬ìš©.xlsx');
    }

    // Staff App Settings
    async function loadStaffSettings(){
        try{
            const doc=await db.collection('settings').doc('staff').get();
            if(doc.exists){
                const data=doc.data();
                document.getElementById('autoLogoutMinutes').value=data.autoLogoutMinutes||10;
            }
        }catch(e){console.error('ì„¤ì • ë¡œë“œ ì˜¤ë¥˜:',e);}
    }
    
    async function saveStaffSettings(){
        const autoLogoutMinutes=parseInt(document.getElementById('autoLogoutMinutes').value)||10;
        try{
            await db.collection('settings').doc('staff').set({
                autoLogoutMinutes,
                updatedAt:firebase.firestore.FieldValue.serverTimestamp()
            },{merge:true});
            alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\nìë™ ë¡œê·¸ì•„ì›ƒ: '+autoLogoutMinutes+'ë¶„');
        }catch(e){alert('ì„¤ì • ì €ì¥ ì‹¤íŒ¨: '+e.message);}
    }

    // Initialize
    function initApp(){initMonthSelector();loadAllData();initTaxDropZone();loadStaffSettings();}
    
    // ==========================================
    // ì—°ì°¨ ê´€ë¦¬ ê¸°ëŠ¥
    // ==========================================
    
    // 2026ë…„ í™©ê¸ˆì—°íœ´ & ìƒŒë“œìœ„ì¹˜ íœ´ì¼ ë°ì´í„°
    const goldenHolidays2026 = [
        { month: '1ì›”', name: 'ì‹ ì • ì—°íœ´', dates: '1.1(ëª©)~1.4(ì¼)', tip: '1/2(ê¸ˆ) ì—°ì°¨ â†’ 4ì¼ ì—°íœ´', type: 'sandwich', days: 4 },
        { month: '2ì›”', name: 'ì„¤ë‚  ì—°íœ´', dates: '2.14(í† )~2.18(ìˆ˜)', tip: '2/19(ëª©),20(ê¸ˆ) ì—°ì°¨ â†’ 9ì¼ ì—°íœ´ ê°€ëŠ¥', type: 'golden', days: 5 },
        { month: '3ì›”', name: 'ì‚¼ì¼ì ˆ ì—°íœ´', dates: '3.1(ì¼)~3.2(ì›”)', tip: 'ëŒ€ì²´íœ´ì¼ ì ìš©, 3ì¼ ì—°íœ´', type: 'golden', days: 3 },
        { month: '5ì›”', name: 'ì–´ë¦°ì´ë‚  ì—°íœ´', dates: '5.1(ê¸ˆ)~5.5(í™”)', tip: 'ê·¼ë¡œìì˜ë‚ +ì–´ë¦°ì´ë‚ , 5/4(ì›”) ì—°ì°¨ â†’ 5ì¼', type: 'golden', days: 5 },
        { month: '5ì›”', name: 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ', dates: '5.24(ì¼)~5.25(ì›”)', tip: 'ëŒ€ì²´íœ´ì¼ ì ìš©, 3ì¼ ì—°íœ´', type: 'golden', days: 3 },
        { month: '6ì›”', name: 'ì§€ë°©ì„ ê±°+í˜„ì¶©ì¼', dates: '6.3(ìˆ˜), 6.6(í† )', tip: '6/4,5 ì—°ì°¨ â†’ 6ì¼ ì—°íœ´', type: 'sandwich', days: 6 },
        { month: '7ì›”', name: 'ì œí—Œì ˆ (ì˜ˆì •)', dates: '7.17(ê¸ˆ)~7.19(ì¼)', tip: 'ê³µíœ´ì¼ ì¬ì§€ì • ì‹œ 3ì¼ ì—°íœ´', type: 'golden', days: 3 },
        { month: '8ì›”', name: 'ê´‘ë³µì ˆ ì—°íœ´', dates: '8.15(í† )~8.17(ì›”)', tip: 'ëŒ€ì²´íœ´ì¼ ì ìš©, 3ì¼ ì—°íœ´', type: 'golden', days: 3 },
        { month: '9ì›”', name: 'ì¶”ì„ ì—°íœ´', dates: '9.24(ëª©)~9.27(ì¼)', tip: '9/28(ì›”) ì—°ì°¨ â†’ 5ì¼ ì—°íœ´', type: 'golden', days: 4 },
        { month: '10ì›”', name: 'ê°œì²œì ˆ~í•œê¸€ë‚ ', dates: '10.3(í† )~10.11(ì¼)', tip: '10/6~8 ì—°ì°¨ 3ì¼ â†’ 9ì¼ ëŒ€ì—°íœ´!', type: 'golden', days: 9 },
        { month: '12ì›”', name: 'ì„±íƒ„ì ˆ ì—°íœ´', dates: '12.25(ê¸ˆ)~12.27(ì¼)', tip: '3ì¼ ì—°íœ´', type: 'golden', days: 3 }
    ];
    
    function renderLeaveManagement(){
        renderGoldenHolidays();
        renderLeaveStatus();
        renderPendingLeaves();
        renderApprovedLeaves();
    }
    
    function renderGoldenHolidays(){
        const container = document.getElementById('goldenHolidayGrid');
        if(!container) return;
        
        container.innerHTML = goldenHolidays2026.map(h => `
            <div class="holiday-card ${h.type}">
                <span class="holiday-badge ${h.type}">${h.type==='golden'?'í™©ê¸ˆì—°íœ´':'ìƒŒë“œìœ„ì¹˜'}</span>
                <div class="holiday-month">${h.month}</div>
                <div class="holiday-name">${h.name}</div>
                <div class="holiday-dates">ğŸ“… ${h.dates}</div>
                <div class="holiday-tip">ğŸ’¡ ${h.tip}</div>
            </div>
        `).join('');
    }
    
    function renderLeaveStatus(){
        const container = document.getElementById('leaveStatusTable');
        if(!container) return;
        
        const year = new Date().getFullYear().toString();
        const roleLabels={doctor:'ì›ì¥',nurse:'ê°„í˜¸ì‚¬',coordinator:'ì½”ë””ë„¤ì´í„°',marketing:'ë§ˆì¼€íŒ…',manager:'ì‹¤ì¥',esthetician:'í”¼ë¶€ê´€ë¦¬ì‚¬'};
        
        container.innerHTML = employees.filter(e=>e.status==='active').map(emp => {
            const totalLeave = emp.annualLeave || calculateLegalAnnualLeave(emp.joinDate);
            const usedLeave = getUsedLeave(emp.id);
            const remainLeave = Math.max(0, totalLeave - usedLeave);
            
            // ì‚¬ìš© ë‚´ì—­ ìš”ì•½
            const usedDates = leaveRequests
                .filter(r => r.employeeId === emp.id && r.status === 'approved' && r.dates?.some(d => d.startsWith(year)))
                .flatMap(r => r.dates?.filter(d => d.startsWith(year)) || [])
                .sort()
                .slice(0, 5);
            const usedSummary = usedDates.length > 0 
                ? usedDates.map(d => d.slice(5)).join(', ') + (usedDates.length < usedLeave ? '...' : '')
                : '-';
            
            return `<tr>
                <td><strong>${emp.name}</strong> <span class="badge badge-purple">${roleLabels[emp.role]||''}</span></td>
                <td class="text-center">${totalLeave}ì¼</td>
                <td class="text-center">${usedLeave}ì¼</td>
                <td class="text-center"><strong style="color:${remainLeave<=2?'var(--accent-red)':remainLeave<=5?'var(--accent-orange)':'var(--accent-green)'}">${remainLeave}ì¼</strong></td>
                <td style="font-size:.8rem;color:var(--text-secondary)">${usedSummary}</td>
            </tr>`;
        }).join('') || '<tr><td colspan="5" class="text-center">ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
    }
    
    function renderPendingLeaves(){
        const container = document.getElementById('pendingLeaveTable');
        const countBadge = document.getElementById('pendingLeaveCount');
        if(!container) return;
        
        const pending = leaveRequests.filter(r => r.status === 'pending');
        if(countBadge) countBadge.textContent = pending.length;
        
        if(pending.length === 0){
            container.innerHTML = '<tr><td colspan="6" class="text-center" style="color:var(--text-muted)">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ì—°ì°¨ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            return;
        }
        
        container.innerHTML = pending.map(r => {
            const emp = employees.find(e => e.id === r.employeeId);
            const dates = r.dates?.join(', ') || '-';
            const createdAt = r.createdAt?.toDate ? r.createdAt.toDate().toLocaleDateString('ko-KR') : '-';
            
            // í™©ê¸ˆì—°íœ´ ì²´í¬
            const isGoldenPeriod = r.dates?.some(d => {
                const month = parseInt(d.split('-')[1]);
                return [2,5,9,10].includes(month); // ì„¤,ì–´ë¦°ì´ë‚ ,ì¶”ì„,ê°œì²œì ˆ~í•œê¸€ë‚ 
            });
            
            return `<tr style="${isGoldenPeriod?'background:#fff9f0':''}">
                <td>${createdAt}</td>
                <td><strong>${emp?.name || r.employeeId}</strong></td>
                <td><span class="badge badge-blue">${r.type || 'ì—°ì°¨'}</span></td>
                <td>${dates} ${isGoldenPeriod?'<span class="badge badge-gold">í™©ê¸ˆì—°íœ´</span>':''}</td>
                <td style="font-size:.85rem">${r.reason || '-'}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="approveLeave('${r.id}')">ìŠ¹ì¸</button>
                    <button class="btn btn-sm btn-danger" onclick="rejectLeave('${r.id}')">ë°˜ë ¤</button>
                </td>
            </tr>`;
        }).join('');
    }
    
    function renderApprovedLeaves(){
        const container = document.getElementById('approvedLeaveTable');
        if(!container) return;
        
        const year = document.getElementById('leaveYearFilter')?.value || new Date().getFullYear().toString();
        const empFilter = document.getElementById('leaveEmployeeFilter')?.value || 'all';
        
        let approved = leaveRequests.filter(r => 
            r.status === 'approved' && 
            r.dates?.some(d => d.startsWith(year))
        );
        
        if(empFilter !== 'all'){
            approved = approved.filter(r => r.employeeId === empFilter);
        }
        
        // ë‚ ì§œìˆœ ì •ë ¬
        approved.sort((a, b) => {
            const dateA = a.dates?.[0] || '';
            const dateB = b.dates?.[0] || '';
            return dateA.localeCompare(dateB);
        });
        
        if(approved.length === 0){
            container.innerHTML = '<tr><td colspan="6" class="text-center" style="color:var(--text-muted)">ìŠ¹ì¸ëœ ì—°ì°¨ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            return;
        }
        
        container.innerHTML = approved.map(r => {
            const emp = employees.find(e => e.id === r.employeeId);
            const dates = r.dates?.filter(d => d.startsWith(year)).join(', ') || '-';
            const approvedAt = r.approvedAt?.toDate ? r.approvedAt.toDate().toLocaleDateString('ko-KR') : '-';
            
            return `<tr>
                <td><strong>${emp?.name || r.employeeId}</strong></td>
                <td><span class="badge badge-blue">${r.type || 'ì—°ì°¨'}</span></td>
                <td>${dates}</td>
                <td style="font-size:.85rem">${r.reason || '-'}</td>
                <td>${approvedAt}</td>
                <td><button class="btn btn-sm btn-danger" onclick="cancelLeave('${r.id}')">ì·¨ì†Œ</button></td>
            </tr>`;
        }).join('');
    }
    
    async function approveLeave(id){
        if(!confirm('ì´ ì—°ì°¨ ì‹ ì²­ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try{
            await db.collection('leaveRequests').doc(id).update({
                status: 'approved',
                approvedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            await loadLeaveRequests();
            renderLeaveManagement();
            renderEmployees();
            alert('ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }catch(e){
            alert('ìŠ¹ì¸ ì‹¤íŒ¨: ' + e.message);
        }
    }
    
    async function rejectLeave(id){
        const reason = prompt('ë°˜ë ¤ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
        if(reason === null) return;
        try{
            await db.collection('leaveRequests').doc(id).update({
                status: 'rejected',
                rejectReason: reason,
                rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            await loadLeaveRequests();
            renderLeaveManagement();
            alert('ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }catch(e){
            alert('ë°˜ë ¤ ì‹¤íŒ¨: ' + e.message);
        }
    }
    
    async function cancelLeave(id){
        if(!confirm('ì´ ìŠ¹ì¸ëœ ì—°ì°¨ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try{
            await db.collection('leaveRequests').doc(id).update({
                status: 'cancelled',
                cancelledAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            await loadLeaveRequests();
            renderLeaveManagement();
            renderEmployees();
            alert('ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }catch(e){
            alert('ì·¨ì†Œ ì‹¤íŒ¨: ' + e.message);
        }
    }
    
    checkAuth();
</script>
```

</body>
</html>
