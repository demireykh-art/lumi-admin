<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>THE CLINIC LUMI - Staff</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon.png">
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--bg:#faf9f7;--bg-card:#fff;--primary:#9a8b7a;--primary-dark:#7a6b5a;--text:#2c2c2c;--text-secondary:#6b6b6b;--text-muted:#999;--border:#e8e4df;--green:#5a7a5a;--red:#a85a5a;--orange:#c4956a;--purple:#7a6a8a}
        *{margin:0;padding:0;box-sizing:border-box}
        html,body{height:100%;overflow:hidden}
        body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text)}
        
        /* Login */
        .login-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;padding:2rem;position:fixed;inset:0;z-index:2000;background:var(--bg)}
        .login-screen.hidden{display:none}
        .login-logo{font-family:'Cormorant Garamond',serif;letter-spacing:4px;color:var(--text-muted);font-size:.8rem;margin-bottom:.25rem}
        .login-title{font-family:'Cormorant Garamond',serif;font-size:2.2rem;font-weight:500;letter-spacing:2px;margin-bottom:2rem}
        .login-form{width:100%;max-width:300px}
        .login-input{width:100%;padding:1rem;background:#fff;border:1px solid var(--border);font-size:1rem;margin-bottom:.75rem}
        .login-input:focus{outline:none;border-color:var(--primary)}
        .login-btn{width:100%;padding:1rem;background:var(--text);border:none;color:#fff;font-size:.9rem;cursor:pointer;letter-spacing:1px}
        .login-btn:hover{background:#444}
        .login-error{color:var(--red);font-size:.85rem;margin-bottom:.75rem;text-align:center;min-height:1.2rem}
        .pw-wrap{position:relative}
        .pw-toggle{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1rem;margin-top:-6px}
        
        /* Password Setup Modal */
        .pw-setup{display:none;position:fixed;inset:0;z-index:2001;background:var(--bg);flex-direction:column;align-items:center;justify-content:center;padding:2rem}
        .pw-setup.active{display:flex}
        .pw-setup-title{font-size:1.2rem;font-weight:600;margin-bottom:.5rem}
        .pw-setup-desc{color:var(--text-secondary);font-size:.9rem;margin-bottom:1.5rem;text-align:center}
        
        /* App Container */
        .app-container{display:none;flex-direction:column;height:100vh;height:100dvh}
        .app-container.active{display:flex}
        
        /* Header */
        .header{background:var(--bg-card);border-bottom:1px solid var(--border);padding:1rem;position:sticky;top:0;z-index:100}
        .header-content{display:flex;justify-content:space-between;align-items:center}
        .header-logo{font-family:'Cormorant Garamond',serif}
        .header-logo-sub{font-size:.6rem;letter-spacing:3px;color:var(--text-muted)}
        .header-logo-text{font-size:1.3rem;font-weight:500;letter-spacing:2px}
        .header-user{display:flex;align-items:center;gap:.75rem}
        .user-name{font-weight:500;font-size:.9rem}
        .logout-btn{padding:.4rem .8rem;border:1px solid var(--border);background:transparent;font-size:.75rem;cursor:pointer;letter-spacing:1px}
        .logout-btn:hover{border-color:var(--primary)}
        
        /* Content */
        .content{flex:1;overflow-y:auto;padding:1rem;padding-bottom:calc(80px + env(safe-area-inset-bottom))}
        
        /* Cards */
        .card{background:var(--bg-card);border:1px solid var(--border);padding:1.25rem;margin-bottom:1rem}
        .card-title{font-weight:600;margin-bottom:1rem;font-size:.95rem}
        .info-row{display:flex;justify-content:space-between;padding:.6rem 0;border-bottom:1px solid var(--border)}
        .info-row:last-child{border-bottom:none}
        .info-label{color:var(--text-secondary);font-size:.9rem}
        .info-value{font-weight:500;font-size:.9rem}
        
        /* Stats Grid */
        .stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem;margin-bottom:1rem}
        .stat-card{background:var(--bg-card);border:1px solid var(--border);padding:1rem;text-align:center}
        .stat-value{font-size:1.5rem;font-weight:700;color:var(--primary)}
        .stat-label{font-size:.75rem;color:var(--text-muted);margin-top:.25rem}
        .stat-card.green .stat-value{color:var(--green)}
        .stat-card.orange .stat-value{color:var(--orange)}
        .stat-card.purple .stat-value{color:var(--purple)}
        
        /* Buttons */
        .btn{width:100%;padding:1rem;border:none;font-size:.95rem;font-weight:500;cursor:pointer;margin-bottom:.75rem}
        .btn-primary{background:var(--text);color:#fff}
        .btn-primary:hover{background:#444}
        .btn-secondary{background:var(--bg);border:1px solid var(--border);color:var(--text)}
        .btn-gold{background:var(--primary);color:#fff}
        .btn-gold:hover{background:var(--primary-dark)}
        
        /* Tab Content */
        .tab-content{display:none}
        .tab-content.active{display:block}
        
        /* Bottom Nav */
        .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--bg-card);border-top:1px solid var(--border);display:flex;padding-bottom:env(safe-area-inset-bottom);z-index:100}
        .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;padding:.75rem .5rem;cursor:pointer;color:var(--text-muted);font-size:.7rem;transition:color .2s}
        .nav-item.active{color:var(--primary)}
        .nav-item .nav-icon{font-size:1.3rem;margin-bottom:.25rem}
        
        /* Modal */
        .modal{display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,.5);align-items:center;justify-content:center;padding:1rem}
        .modal.active{display:flex}
        .modal-content{background:var(--bg-card);width:100%;max-width:400px;max-height:90vh;overflow-y:auto;border-radius:0}
        .modal-header{padding:1rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .modal-title{font-weight:600}
        .modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-muted)}
        .modal-body{padding:1rem}
        .modal-footer{padding:1rem;border-top:1px solid var(--border);display:flex;gap:.5rem}
        .modal-footer .btn{margin-bottom:0}
        
        /* Form */
        .form-group{margin-bottom:1rem}
        .form-label{display:block;font-size:.85rem;color:var(--text-secondary);margin-bottom:.5rem}
        .form-input,.form-select,.form-textarea{width:100%;padding:.75rem;border:1px solid var(--border);font-size:.95rem;background:#fff}
        .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--primary)}
        
        /* Badge */
        .badge{display:inline-block;padding:.25rem .5rem;font-size:.75rem;border-radius:2px}
        .badge-green{background:rgba(90,122,90,.15);color:var(--green)}
        .badge-orange{background:rgba(196,149,106,.15);color:var(--orange)}
        .badge-red{background:rgba(168,90,90,.15);color:var(--red)}
        .badge-purple{background:rgba(122,106,138,.15);color:var(--purple)}
        .badge-gold{background:rgba(154,139,122,.15);color:var(--primary)}
        
        /* List */
        .list-item{display:flex;justify-content:space-between;align-items:center;padding:.75rem 0;border-bottom:1px solid var(--border)}
        .list-item:last-child{border-bottom:none}
        .list-item-title{font-weight:500;font-size:.9rem}
        .list-item-sub{font-size:.8rem;color:var(--text-muted)}
        
        /* Incentive Item Card */
        .inc-item{background:var(--bg);padding:1rem;margin-bottom:.75rem;border:1px solid var(--border)}
        .inc-item-name{font-weight:600;margin-bottom:.25rem}
        .inc-item-info{font-size:.85rem;color:var(--text-secondary)}
        .inc-item-value{font-size:1.1rem;font-weight:700;color:var(--primary);margin-top:.5rem}
        
        /* Leave Item */
        .leave-item{padding:.75rem;background:var(--bg);margin-bottom:.5rem;border-left:3px solid var(--border)}
        .leave-item.pending{border-left-color:var(--orange)}
        .leave-item.approved{border-left-color:var(--green)}
        .leave-item.rejected{border-left-color:var(--red)}
        .leave-dates{font-weight:500;margin-bottom:.25rem}
        .leave-status{font-size:.8rem}
        
        /* Date Tag List */
        .date-tags{display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:1rem;min-height:2rem}
        .date-tag{display:inline-flex;align-items:center;gap:.25rem;padding:.35rem .6rem;background:var(--bg);border:1px solid var(--border);font-size:.85rem}
        .date-tag-remove{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1rem;line-height:1}
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-logo">THE CLINIC</div>
        <div class="login-title">LUMI</div>
        <form class="login-form" onsubmit="attemptLogin(); return false;" autocomplete="on">
            <input type="text" class="login-input" id="empIdInput" placeholder="ì‚¬ë²ˆ" autocomplete="username">
            <div class="pw-wrap">
                <input type="password" class="login-input" id="empPwInput" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password">
                <button type="button" class="pw-toggle" onclick="togglePw('empPwInput',this)">ğŸ‘</button>
            </div>
            <div class="login-error" id="loginError"></div>
            <button type="submit" class="login-btn">ë¡œê·¸ì¸</button>
        </form>
    </div>
    
    <!-- Password Setup -->
    <div class="pw-setup" id="pwSetup">
        <div class="pw-setup-title">ë¹„ë°€ë²ˆí˜¸ ì„¤ì •</div>
        <div class="pw-setup-desc">ìµœì´ˆ ë¡œê·¸ì¸ì…ë‹ˆë‹¤.<br>ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.</div>
        <form class="login-form" onsubmit="setupPassword(); return false;" autocomplete="on">
            <input type="text" id="setupUsername" autocomplete="username" style="display:none" aria-hidden="true">
            <div class="pw-wrap">
                <input type="password" class="login-input" id="newPw1" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ (4ì ì´ìƒ)" autocomplete="new-password">
                <button type="button" class="pw-toggle" onclick="togglePw('newPw1',this)">ğŸ‘</button>
            </div>
            <div class="pw-wrap">
                <input type="password" class="login-input" id="newPw2" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" autocomplete="new-password">
                <button type="button" class="pw-toggle" onclick="togglePw('newPw2',this)">ğŸ‘</button>
            </div>
            <div class="login-error" id="pwError"></div>
            <button type="submit" class="login-btn">ì„¤ì • ì™„ë£Œ</button>
        </form>
    </div>
    
    <!-- App -->
    <div class="app-container" id="appContainer">
        <header class="header">
            <div class="header-content">
                <div class="header-logo">
                    <div class="header-logo-sub">THE CLINIC</div>
                    <div class="header-logo-text">LUMI</div>
                </div>
                <div class="header-user">
                    <span class="user-name" id="userName">-</span>
                    <button class="logout-btn" onclick="logout()">LOGOUT</button>
                </div>
            </div>
        </header>
        
        <div class="content">
            <!-- ë‚´ ì •ë³´ íƒ­ -->
            <div class="tab-content active" id="tab-info">
                <div class="card">
                    <div class="card-title">ë‚´ ì •ë³´</div>
                    <div class="info-row"><span class="info-label">ì´ë¦„</span><span class="info-value" id="infoName">-</span></div>
                    <div class="info-row"><span class="info-label">ì‚¬ë²ˆ</span><span class="info-value" id="infoId">-</span></div>
                    <div class="info-row"><span class="info-label">ì§ê¸‰</span><span class="info-value" id="infoRole">-</span></div>
                    <div class="info-row"><span class="info-label">ì…ì‚¬ì¼</span><span class="info-value" id="infoJoinDate">-</span></div>
                    <div class="info-row"><span class="info-label">ê·¼ì†ê¸°ê°„</span><span class="info-value" id="infoTenure">-</span></div>
                </div>
                <div class="card">
                    <div class="card-title">ì´ë²ˆ ë‹¬ ê¸‰ì—¬ ì •ë³´</div>
                    <div class="info-row"><span class="info-label">ì‹¤ìˆ˜ë ¹ì•¡</span><span class="info-value" id="infoNetPay">-</span></div>
                    <div class="info-row"><span class="info-label">ì¶”ê°€ì—°ì¥ìˆ˜ë‹¹</span><span class="info-value" id="infoExtraOT">-</span></div>
                    <div class="info-row"><span class="info-label">ì¸ì„¼í‹°ë¸Œ</span><span class="info-value" id="infoIncentive">-</span></div>
                </div>
            </div>
            
            <!-- ì¶œí‡´ê·¼ íƒ­ -->
            <div class="tab-content" id="tab-attendance">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-value" id="attWorkDays">0</div><div class="stat-label">ì¶œê·¼ì¼</div></div>
                    <div class="stat-card orange"><div class="stat-value" id="attLate">0</div><div class="stat-label">ì§€ê°</div></div>
                    <div class="stat-card green"><div class="stat-value" id="attEarly">0</div><div class="stat-label">ì¡°í‡´</div></div>
                </div>
                <div class="card">
                    <div class="card-title">ì˜¤ëŠ˜ ê·¼ë¬´</div>
                    <div class="info-row"><span class="info-label">ì¶œê·¼</span><span class="info-value" id="todayCheckIn">-</span></div>
                    <div class="info-row"><span class="info-label">í‡´ê·¼</span><span class="info-value" id="todayCheckOut">-</span></div>
                </div>
                <button class="btn btn-primary" id="checkInBtn" onclick="checkIn()">ì¶œê·¼í•˜ê¸°</button>
                <button class="btn btn-gold" id="checkOutBtn" onclick="checkOut()" style="display:none">í‡´ê·¼í•˜ê¸°</button>
            </div>
            
            <!-- OT íƒ­ -->
            <div class="tab-content" id="tab-ot">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-value" id="otTotal">0H</div><div class="stat-label">ì´ë²ˆë‹¬ OT</div></div>
                    <div class="stat-card purple"><div class="stat-value" id="otLunch">0H</div><div class="stat-label">ì ì‹¬ OT</div></div>
                    <div class="stat-card orange"><div class="stat-value" id="otAfter">0H</div><div class="stat-label">í‡´ê·¼í›„ OT</div></div>
                </div>
                <button class="btn btn-primary" onclick="openLunchOTModal()">ì ì‹¬ OT ì…ë ¥</button>
                <div class="card">
                    <div class="card-title">ì´ë²ˆ ë‹¬ OT ë‚´ì—­</div>
                    <div id="otList"><div style="text-align:center;color:var(--text-muted);padding:1rem">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div></div>
                </div>
            </div>
            
            <!-- ì¸ì„¼í‹°ë¸Œ íƒ­ -->
            <div class="tab-content" id="tab-incentive">
                <div class="card">
                    <div class="card-title">ë‚˜ì˜ ì¸ì„¼í‹°ë¸Œ í•­ëª©</div>
                    <div id="myIncentiveItems"><div style="text-align:center;color:var(--text-muted);padding:1rem">ë“±ë¡ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div></div>
                </div>
                <button class="btn btn-primary" onclick="openIncentiveModal()">ì¸ì„¼í‹°ë¸Œ ì‹¤ì  ì…ë ¥</button>
                <div class="card">
                    <div class="card-title">ì´ë²ˆ ë‹¬ ì‹¤ì  ë‚´ì—­</div>
                    <div id="incentiveRecords"><div style="text-align:center;color:var(--text-muted);padding:1rem">ì…ë ¥ëœ ì‹¤ì ì´ ì—†ìŠµë‹ˆë‹¤</div></div>
                </div>
            </div>
            
            <!-- íœ´ê°€ íƒ­ -->
            <div class="tab-content" id="tab-leave">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-value" id="leaveTotal">15</div><div class="stat-label">ì´ ì—°ì°¨</div></div>
                    <div class="stat-card orange"><div class="stat-value" id="leaveUsed">0</div><div class="stat-label">ì‚¬ìš©</div></div>
                    <div class="stat-card green"><div class="stat-value" id="leaveRemain">15</div><div class="stat-label">ì”ì—¬</div></div>
                </div>
                <button class="btn btn-primary" onclick="openLeaveModal()">íœ´ê°€ ì‹ ì²­</button>
                <div class="card">
                    <div class="card-title">ì‹ ì²­ ë‚´ì—­</div>
                    <div id="leaveHistory"><div style="text-align:center;color:var(--text-muted);padding:1rem">ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div></div>
                </div>
            </div>
        </div>
        
        <!-- Bottom Nav -->
        <nav class="bottom-nav">
            <div class="nav-item active" data-tab="info"><div class="nav-icon">ğŸ‘¤</div>ë‚´ ì •ë³´</div>
            <div class="nav-item" data-tab="attendance"><div class="nav-icon">ğŸ“…</div>ì¶œí‡´ê·¼</div>
            <div class="nav-item" data-tab="ot"><div class="nav-icon">â°</div>OT</div>
            <div class="nav-item" data-tab="incentive"><div class="nav-icon">ğŸ’</div>ì¸ì„¼í‹°ë¸Œ</div>
            <div class="nav-item" data-tab="leave"><div class="nav-icon">ğŸ–</div>íœ´ê°€</div>
        </nav>
    </div>
    
    <!-- ì ì‹¬ OT ëª¨ë‹¬ -->
    <div class="modal" id="lunchOTModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ì ì‹¬ OT ì…ë ¥</div>
                <button class="modal-close" onclick="closeModal('lunchOTModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ë‚ ì§œ</label>
                    <input type="date" class="form-input" id="lunchOTDate">
                </div>
                <div class="form-group">
                    <label class="form-label">ì‹œê°„ (ë¶„)</label>
                    <input type="number" class="form-input" id="lunchOTMinutes" value="30" min="0" max="60">
                </div>
                <div class="form-group">
                    <label class="form-label">ì‚¬ìœ </label>
                    <input type="text" class="form-input" id="lunchOTReason" placeholder="ì˜ˆ: ì ì‹¬ì‹œê°„ ì—…ë¬´">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('lunchOTModal')">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="saveLunchOT()">ì €ì¥</button>
            </div>
        </div>
    </div>
    
    <!-- ì¸ì„¼í‹°ë¸Œ ì…ë ¥ ëª¨ë‹¬ -->
    <div class="modal" id="incentiveModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ì¸ì„¼í‹°ë¸Œ ì‹¤ì  ì…ë ¥</div>
                <button class="modal-close" onclick="closeModal('incentiveModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">í•­ëª© ì„ íƒ</label>
                    <select class="form-select" id="incItemSelect">
                        <option value="">í•­ëª© ì„ íƒ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ê³ ê°ëª…</label>
                    <input type="text" class="form-input" id="incCustomerName" placeholder="ê³ ê° ì´ë¦„">
                </div>
                <div class="form-group">
                    <label class="form-label">ì°¨íŠ¸ë²ˆí˜¸</label>
                    <input type="text" class="form-input" id="incChartNo" placeholder="ì°¨íŠ¸ë²ˆí˜¸">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('incentiveModal')">ë‹«ê¸°</button>
                <button class="btn btn-primary" onclick="addIncentiveRecord()">+ 1ê±´ ì¶”ê°€</button>
            </div>
        </div>
    </div>
    
    <!-- íœ´ê°€ ì‹ ì²­ ëª¨ë‹¬ -->
    <div class="modal" id="leaveModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">íœ´ê°€ ì‹ ì²­</div>
                <button class="modal-close" onclick="closeModal('leaveModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">íœ´ê°€ ìœ í˜•</label>
                    <select class="form-select" id="leaveType">
                        <option value="ì—°ì°¨">ì—°ì°¨</option>
                        <option value="ë°˜ì°¨(ì˜¤ì „)">ë°˜ì°¨ (ì˜¤ì „)</option>
                        <option value="ë°˜ì°¨(ì˜¤í›„)">ë°˜ì°¨ (ì˜¤í›„)</option>
                        <option value="ì˜¤í”„">ì˜¤í”„</option>
                        <option value="ë³‘ê°€">ë³‘ê°€</option>
                        <option value="ê²½ì¡°ì‚¬">ê²½ì¡°ì‚¬</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">íœ´ê°€ ë‚ ì§œ</label>
                    <div style="display:flex;gap:.5rem;margin-bottom:.5rem">
                        <input type="date" class="form-input" id="leaveDateInput" style="flex:1">
                        <button class="btn btn-secondary" onclick="addLeaveDate()" style="width:auto;padding:.75rem 1rem;margin:0">+ ì¶”ê°€</button>
                    </div>
                    <div class="date-tags" id="leaveDateTags"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">ì‚¬ìœ </label>
                    <input type="text" class="form-input" id="leaveReason" placeholder="ì‚¬ìœ  ì…ë ¥ (ì„ íƒ)">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('leaveModal')">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="submitLeave()">ì‹ ì²­í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase
        const firebaseConfig={apiKey:"AIzaSyDnkKNXNnDVlcPd5Y1fl59YysdeEZi7uJU",authDomain:"lumiclinic-c1a95.firebaseapp.com",projectId:"lumiclinic-c1a95",storageBucket:"lumiclinic-c1a95.firebasestorage.app",messagingSenderId:"901456209944",appId:"1:901456209944:web:f287418cd0541f324d3b6d"};
        firebase.initializeApp(firebaseConfig);
        const db=firebase.firestore();
        
        // State
        let currentUser=null;
        let attendance=[];
        let lunchOT=[];
        let incentiveItems=[];
        let incentiveRecords=[];
        let leaveRequests=[];
        let payrollData=[];
        let selectedLeaveDates=[];
        
        const roleLabels={doctor:'ì›ì¥',nurse:'ê°„í˜¸ì‚¬',coordinator:'ì½”ë””ë„¤ì´í„°',marketing:'ë§ˆì¼€íŒ…',manager:'ì‹¤ì¥',esthetician:'í”¼ë¶€ê´€ë¦¬ì‚¬'};
        
        // Utility
        function formatCurrency(n){return n?'â‚©'+Math.round(n).toLocaleString():'â‚©0';}
        function getYM(){const d=new Date();return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');}
        function getToday(){return new Date().toISOString().split('T')[0];}
        
        function getTenure(joinDate){
            if(!joinDate)return '-';
            const join=new Date(joinDate);
            const now=new Date();
            const diffMs=now-join;
            const diffDays=Math.floor(diffMs/(1000*60*60*24));
            const years=Math.floor(diffDays/365);
            const months=Math.floor((diffDays%365)/30);
            
            if(years===0){
                return months>0?`${months}ê°œì›”`:'1ê°œì›” ë¯¸ë§Œ';
            }else{
                // ê·¼ì† Në…„ Mê°œì›” (N+1ë…„ì°¨)
                const yearNum=years+1;
                if(months>0){
                    return `${years}ë…„ ${months}ê°œì›” (${yearNum}ë…„ì°¨)`;
                }else{
                    return `ë§Œ ${years}ë…„ (${yearNum}ë…„ì°¨)`;
                }
            }
        }
        
        function togglePw(inputId,btn){
            const input=document.getElementById(inputId);
            if(input.type==='password'){
                input.type='text';btn.textContent='ğŸ™ˆ';
            }else{
                input.type='password';btn.textContent='ğŸ‘';
            }
        }
        
        // Login
        async function attemptLogin(){
            const empId=document.getElementById('empIdInput').value.trim().toUpperCase();
            const pw=document.getElementById('empPwInput').value;
            document.getElementById('loginError').textContent='';
            
            if(!empId||!pw){
                document.getElementById('loginError').textContent='ì‚¬ë²ˆê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                return;
            }
            
            try{
                const doc=await db.collection('employees').doc(empId).get();
                if(!doc.exists){
                    document.getElementById('loginError').textContent='ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ë²ˆì…ë‹ˆë‹¤.';
                    return;
                }
                
                const emp=doc.data();
                
                // ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ ì²´í¬
                if(pw==='final12890-'&&(!emp.password||emp.password==='final12890-')){
                    currentUser={id:empId,...emp};
                    document.getElementById('setupUsername').value=empId;
                    document.getElementById('pwSetup').classList.add('active');
                    return;
                }
                
                // ë¹„ë°€ë²ˆí˜¸ í™•ì¸
                if(emp.password!==pw){
                    document.getElementById('loginError').textContent='ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                    return;
                }
                
                // ë¡œê·¸ì¸ ì„±ê³µ
                currentUser={id:empId,...emp};
                localStorage.setItem('lumi_staff_user',JSON.stringify(currentUser));
                showApp();
            }catch(e){
                console.error(e);
                document.getElementById('loginError').textContent='ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            }
        }
        
        async function setupPassword(){
            const pw1=document.getElementById('newPw1').value;
            const pw2=document.getElementById('newPw2').value;
            document.getElementById('pwError').textContent='';
            
            if(pw1.length<4){
                document.getElementById('pwError').textContent='ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
                return;
            }
            if(pw1!==pw2){
                document.getElementById('pwError').textContent='ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                return;
            }
            
            try{
                await db.collection('employees').doc(currentUser.id).update({password:pw1});
                currentUser.password=pw1;
                localStorage.setItem('lumi_staff_user',JSON.stringify(currentUser));
                document.getElementById('pwSetup').classList.remove('active');
                showApp();
            }catch(e){
                document.getElementById('pwError').textContent='ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            }
        }
        
        function showApp(){
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appContainer').classList.add('active');
            document.getElementById('userName').textContent=currentUser.name;
            loadAllData();
        }
        
        function logout(){
            localStorage.removeItem('lumi_staff_user');
            location.reload();
        }
        
        function checkAuth(){
            const saved=localStorage.getItem('lumi_staff_user');
            if(saved){
                currentUser=JSON.parse(saved);
                showApp();
            }
        }
        
        // Data Loading
        async function loadAllData(){
            await Promise.all([
                loadAttendance(),
                loadLunchOT(),
                loadIncentiveItems(),
                loadIncentiveRecords(),
                loadLeaveRequests(),
                loadPayrollData()
            ]);
            renderAll();
        }
        
        async function loadAttendance(){
            const ym=getYM();
            const snapshot=await db.collection('attendance').where('employeeId','==',currentUser.id).where('date','>=',ym+'-01').where('date','<=',ym+'-31').get();
            attendance=snapshot.docs.map(d=>({id:d.id,...d.data()}));
        }
        
        async function loadLunchOT(){
            const ym=getYM();
            const snapshot=await db.collection('lunchOT').where('employeeId','==',currentUser.id).where('date','>=',ym+'-01').where('date','<=',ym+'-31').get();
            lunchOT=snapshot.docs.map(d=>({id:d.id,...d.data()}));
        }
        
        async function loadIncentiveItems(){
            const snapshot=await db.collection('incentiveItems').get();
            incentiveItems=snapshot.docs.map(d=>({id:d.id,...d.data()})).filter(item=>!item.employees||item.employees.length===0||item.employees.includes(currentUser.id));
        }
        
        async function loadIncentiveRecords(){
            const ym=getYM();
            const snapshot=await db.collection('incentiveRecords').where('employeeId','==',currentUser.id).where('yearMonth','==',ym).get();
            incentiveRecords=snapshot.docs.map(d=>({id:d.id,...d.data()}));
        }
        
        async function loadLeaveRequests(){
            const snapshot=await db.collection('leaveRequests').where('employeeId','==',currentUser.id).orderBy('createdAt','desc').limit(20).get();
            leaveRequests=snapshot.docs.map(d=>({id:d.id,...d.data()}));
        }
        
        async function loadPayrollData(){
            const ym=getYM();
            const snapshot=await db.collection('payroll').where('yearMonth','==',ym).get();
            payrollData=snapshot.docs.map(d=>({id:d.id,...d.data()}));
        }
        
        // Render
        function renderAll(){
            renderInfo();
            renderAttendance();
            renderOT();
            renderIncentive();
            renderLeave();
        }
        
        function renderInfo(){
            document.getElementById('infoName').textContent=currentUser.name||'-';
            document.getElementById('infoId').textContent=currentUser.id||'-';
            document.getElementById('infoRole').textContent=roleLabels[currentUser.role]||currentUser.role||'-';
            document.getElementById('infoJoinDate').textContent=currentUser.joinDate||'-';
            document.getElementById('infoTenure').textContent=getTenure(currentUser.joinDate);
            
            // ê¸‰ì—¬ ì •ë³´ (payroll ë°ì´í„°ì—ì„œ)
            const myPayroll=payrollData.find(p=>p.name===currentUser.name||p.name===currentUser.matchName);
            if(myPayroll){
                document.getElementById('infoNetPay').textContent=formatCurrency(myPayroll.netPay);
                document.getElementById('infoExtraOT').textContent=formatCurrency(myPayroll.extraOT||myPayroll.allowance||0);
                document.getElementById('infoIncentive').textContent=formatCurrency(myPayroll.incentive||0);
            }else{
                document.getElementById('infoNetPay').textContent='-';
                document.getElementById('infoExtraOT').textContent='-';
                document.getElementById('infoIncentive').textContent='-';
            }
        }
        
        function renderAttendance(){
            const today=getToday();
            const todayAtt=attendance.find(a=>a.date===today);
            
            document.getElementById('attWorkDays').textContent=attendance.filter(a=>a.checkIn).length;
            document.getElementById('attLate').textContent=attendance.filter(a=>a.status==='late').length;
            document.getElementById('attEarly').textContent=attendance.filter(a=>a.status==='early').length;
            
            if(todayAtt){
                document.getElementById('todayCheckIn').textContent=todayAtt.checkIn||'-';
                document.getElementById('todayCheckOut').textContent=todayAtt.checkOut||'-';
                
                if(todayAtt.checkOut){
                    document.getElementById('checkInBtn').style.display='none';
                    document.getElementById('checkOutBtn').style.display='none';
                }else{
                    document.getElementById('checkInBtn').style.display='none';
                    document.getElementById('checkOutBtn').style.display='block';
                }
            }else{
                document.getElementById('todayCheckIn').textContent='-';
                document.getElementById('todayCheckOut').textContent='-';
                document.getElementById('checkInBtn').style.display='block';
                document.getElementById('checkOutBtn').style.display='none';
            }
        }
        
        function renderOT(){
            // ì ì‹¬ OT í•©ê³„
            const lunchMinutes=lunchOT.reduce((sum,ot)=>sum+(ot.minutes||0),0);
            const lunchHours=(lunchMinutes/60).toFixed(1);
            
            // í‡´ê·¼ í›„ OT (ì¶œí‡´ê·¼ ê¸°ë¡ì—ì„œ)
            let afterMinutes=0;
            attendance.forEach(a=>{
                if(a.checkOut){
                    const [h,m]=a.checkOut.split(':').map(Number);
                    const endMinute=18*60; // 18:00
                    const checkOutMinute=h*60+m;
                    if(checkOutMinute>endMinute){
                        afterMinutes+=checkOutMinute-endMinute;
                    }
                }
            });
            const afterHours=(afterMinutes/60).toFixed(1);
            
            const totalHours=((lunchMinutes+afterMinutes)/60).toFixed(1);
            
            document.getElementById('otTotal').textContent=totalHours+'H';
            document.getElementById('otLunch').textContent=lunchHours+'H';
            document.getElementById('otAfter').textContent=afterHours+'H';
            
            // OT ë‚´ì—­
            const otItems=[...lunchOT.map(ot=>({...ot,type:'ì ì‹¬'}))];
            otItems.sort((a,b)=>b.date.localeCompare(a.date));
            
            if(otItems.length>0){
                document.getElementById('otList').innerHTML=otItems.map(ot=>`
                    <div class="list-item">
                        <div>
                            <div class="list-item-title">${ot.date}</div>
                            <div class="list-item-sub">${ot.reason||ot.type}</div>
                        </div>
                        <span class="badge badge-purple">${ot.minutes}ë¶„</span>
                    </div>
                `).join('');
            }else{
                document.getElementById('otList').innerHTML='<div style="text-align:center;color:var(--text-muted);padding:1rem">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
            }
        }
        
        function renderIncentive(){
            // ë‚˜ì˜ ì¸ì„¼í‹°ë¸Œ í•­ëª©
            if(incentiveItems.length>0){
                document.getElementById('myIncentiveItems').innerHTML=incentiveItems.map(item=>{
                    const records=incentiveRecords.filter(r=>r.itemId===item.id);
                    const count=records.length;
                    const typeLabel=item.type==='japanSales'?`ì¼ë³¸ì¸ ë§¤ì¶œ ${item.percent||1}%`:`ê±´ë‹¹ ${formatCurrency(item.price||0)}`;
                    const total=item.type==='japanSales'?0:(count*(item.price||0));
                    return `
                        <div class="inc-item">
                            <div class="inc-item-name">${item.name}</div>
                            <div class="inc-item-info"><span class="badge badge-gold">${typeLabel}</span></div>
                            <div class="inc-item-value">${count}ê±´ = ${formatCurrency(total)}</div>
                        </div>
                    `;
                }).join('');
            }else{
                document.getElementById('myIncentiveItems').innerHTML='<div style="text-align:center;color:var(--text-muted);padding:1rem">ë“±ë¡ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>';
            }
            
            // ì‹¤ì  ë‚´ì—­
            if(incentiveRecords.length>0){
                document.getElementById('incentiveRecords').innerHTML=incentiveRecords.map(r=>{
                    const item=incentiveItems.find(i=>i.id===r.itemId);
                    return `
                        <div class="list-item">
                            <div>
                                <div class="list-item-title">${item?.name||'í•­ëª©'}</div>
                                <div class="list-item-sub">${r.customerName} (${r.chartNo})</div>
                            </div>
                            <span class="badge badge-green">${r.date}</span>
                        </div>
                    `;
                }).join('');
            }else{
                document.getElementById('incentiveRecords').innerHTML='<div style="text-align:center;color:var(--text-muted);padding:1rem">ì…ë ¥ëœ ì‹¤ì ì´ ì—†ìŠµë‹ˆë‹¤</div>';
            }
            
            // ì¸ì„¼í‹°ë¸Œ ëª¨ë‹¬ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
            const select=document.getElementById('incItemSelect');
            select.innerHTML='<option value="">í•­ëª© ì„ íƒ</option>'+incentiveItems.filter(i=>i.type!=='japanSales').map(i=>`<option value="${i.id}">${i.name} (${formatCurrency(i.price||0)}/ê±´)</option>`).join('');
        }
        
        function renderLeave(){
            // ì—°ì°¨ ê³„ì‚°
            const approved=leaveRequests.filter(r=>r.status==='approved');
            const usedDays=approved.reduce((sum,r)=>{
                if(r.type?.includes('ë°˜ì°¨'))return sum+0.5;
                return sum+(r.dates?.length||1);
            },0);
            
            const total=currentUser.annualLeave||15;
            const remain=total-usedDays;
            
            document.getElementById('leaveTotal').textContent=total;
            document.getElementById('leaveUsed').textContent=usedDays;
            document.getElementById('leaveRemain').textContent=remain;
            
            // ì‹ ì²­ ë‚´ì—­
            if(leaveRequests.length>0){
                document.getElementById('leaveHistory').innerHTML=leaveRequests.map(r=>{
                    const statusClass=r.status==='approved'?'approved':r.status==='rejected'?'rejected':'pending';
                    const statusLabel=r.status==='approved'?'ìŠ¹ì¸':r.status==='rejected'?'ë°˜ë ¤':'ëŒ€ê¸°ì¤‘';
                    const dates=r.dates?.join(', ')||r.startDate||'-';
                    return `
                        <div class="leave-item ${statusClass}">
                            <div class="leave-dates">${r.type} : ${dates}</div>
                            <div class="leave-status">
                                <span class="badge badge-${statusClass==='approved'?'green':statusClass==='rejected'?'red':'orange'}">${statusLabel}</span>
                                ${r.reason?` Â· ${r.reason}`:''}
                            </div>
                        </div>
                    `;
                }).join('');
            }else{
                document.getElementById('leaveHistory').innerHTML='<div style="text-align:center;color:var(--text-muted);padding:1rem">ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
            }
        }
        
        // Actions
        async function checkIn(){
            const now=new Date();
            const time=now.toTimeString().substring(0,5);
            const today=getToday();
            const status=now.getHours()>=9&&now.getMinutes()>10?'late':'normal';
            
            try{
                await db.collection('attendance').add({
                    employeeId:currentUser.id,
                    employeeName:currentUser.name,
                    date:today,
                    checkIn:time,
                    status:status,
                    createdAt:firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('ì¶œê·¼ ì™„ë£Œ: '+time);
                await loadAttendance();
                renderAttendance();
            }catch(e){
                alert('ì¶œê·¼ ì²˜ë¦¬ ì‹¤íŒ¨: '+e.message);
            }
        }
        
        async function checkOut(){
            const now=new Date();
            const time=now.toTimeString().substring(0,5);
            const today=getToday();
            const todayAtt=attendance.find(a=>a.date===today);
            
            if(!todayAtt){
                alert('ì˜¤ëŠ˜ ì¶œê·¼ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            try{
                await db.collection('attendance').doc(todayAtt.id).update({
                    checkOut:time,
                    status:now.getHours()<18?'early':todayAtt.status
                });
                alert('í‡´ê·¼ ì™„ë£Œ: '+time);
                await loadAttendance();
                renderAttendance();
            }catch(e){
                alert('í‡´ê·¼ ì²˜ë¦¬ ì‹¤íŒ¨: '+e.message);
            }
        }
        
        // Modals
        function openModal(id){document.getElementById(id).classList.add('active');}
        function closeModal(id){document.getElementById(id).classList.remove('active');}
        
        function openLunchOTModal(){
            document.getElementById('lunchOTDate').value=getToday();
            document.getElementById('lunchOTMinutes').value='30';
            document.getElementById('lunchOTReason').value='';
            openModal('lunchOTModal');
        }
        
        async function saveLunchOT(){
            const date=document.getElementById('lunchOTDate').value;
            const minutes=parseInt(document.getElementById('lunchOTMinutes').value)||0;
            const reason=document.getElementById('lunchOTReason').value.trim();
            
            if(!date||minutes<=0){
                alert('ë‚ ì§œì™€ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try{
                await db.collection('lunchOT').add({
                    employeeId:currentUser.id,
                    employeeName:currentUser.name,
                    date:date,
                    minutes:minutes,
                    reason:reason,
                    createdAt:firebase.firestore.FieldValue.serverTimestamp()
                });
                closeModal('lunchOTModal');
                alert('ì ì‹¬ OTê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                await loadLunchOT();
                renderOT();
            }catch(e){
                alert('ì €ì¥ ì‹¤íŒ¨: '+e.message);
            }
        }
        
        function openIncentiveModal(){
            document.getElementById('incCustomerName').value='';
            document.getElementById('incChartNo').value='';
            openModal('incentiveModal');
        }
        
        async function addIncentiveRecord(){
            const itemId=document.getElementById('incItemSelect').value;
            const customerName=document.getElementById('incCustomerName').value.trim();
            const chartNo=document.getElementById('incChartNo').value.trim();
            
            if(!itemId){
                alert('í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            if(!customerName||!chartNo){
                alert('ê³ ê°ëª…ê³¼ ì°¨íŠ¸ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try{
                await db.collection('incentiveRecords').add({
                    employeeId:currentUser.id,
                    employeeName:currentUser.name,
                    itemId:itemId,
                    customerName:customerName,
                    chartNo:chartNo,
                    date:getToday(),
                    yearMonth:getYM(),
                    createdAt:firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('ì‹¤ì ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                document.getElementById('incCustomerName').value='';
                document.getElementById('incChartNo').value='';
                await loadIncentiveRecords();
                renderIncentive();
            }catch(e){
                alert('ì €ì¥ ì‹¤íŒ¨: '+e.message);
            }
        }
        
        function openLeaveModal(){
            selectedLeaveDates=[];
            document.getElementById('leaveType').value='ì—°ì°¨';
            document.getElementById('leaveDateInput').value='';
            document.getElementById('leaveReason').value='';
            renderLeaveDates();
            openModal('leaveModal');
        }
        
        function addLeaveDate(){
            const date=document.getElementById('leaveDateInput').value;
            if(!date){
                alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            if(selectedLeaveDates.includes(date)){
                alert('ì´ë¯¸ ì¶”ê°€ëœ ë‚ ì§œì…ë‹ˆë‹¤.');
                return;
            }
            selectedLeaveDates.push(date);
            selectedLeaveDates.sort();
            document.getElementById('leaveDateInput').value='';
            renderLeaveDates();
        }
        
        function removeLeaveDate(date){
            selectedLeaveDates=selectedLeaveDates.filter(d=>d!==date);
            renderLeaveDates();
        }
        
        function renderLeaveDates(){
            const container=document.getElementById('leaveDateTags');
            if(selectedLeaveDates.length>0){
                container.innerHTML=selectedLeaveDates.map(d=>`
                    <div class="date-tag">
                        ${d}
                        <button class="date-tag-remove" onclick="removeLeaveDate('${d}')">&times;</button>
                    </div>
                `).join('');
            }else{
                container.innerHTML='<span style="color:var(--text-muted);font-size:.85rem">ë‚ ì§œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”</span>';
            }
        }
        
        async function submitLeave(){
            const type=document.getElementById('leaveType').value;
            const reason=document.getElementById('leaveReason').value.trim();
            
            if(selectedLeaveDates.length===0){
                alert('íœ´ê°€ ë‚ ì§œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try{
                await db.collection('leaveRequests').add({
                    employeeId:currentUser.id,
                    employeeName:currentUser.name,
                    type:type,
                    dates:selectedLeaveDates,
                    reason:reason,
                    status:'pending',
                    createdAt:firebase.firestore.FieldValue.serverTimestamp()
                });
                closeModal('leaveModal');
                alert('íœ´ê°€ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                await loadLeaveRequests();
                renderLeave();
            }catch(e){
                alert('ì‹ ì²­ ì‹¤íŒ¨: '+e.message);
            }
        }
        
        // Tab Navigation
        document.querySelectorAll('.nav-item').forEach(item=>{
            item.addEventListener('click',function(){
                document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('tab-'+this.dataset.tab).classList.add('active');
            });
        });
        
        // Init
        checkAuth();
    </script>
</body>
</html>
