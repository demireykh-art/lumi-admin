<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>THE CLINIC LUMI</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon.png">
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--bg-primary:#faf9f7;--bg-secondary:#ffffff;--bg-card:#ffffff;--accent-gold:#9a8b7a;--accent-dark:#2c2c2c;--accent-green:#5a7a5a;--accent-red:#a85a5a;--accent-blue:#5a6a7a;--text-primary:#2c2c2c;--text-secondary:#6b6b6b;--text-muted:#999999;--border-color:#e8e4df}
        *{margin:0;padding:0;box-sizing:border-box}html,body{height:100%;overflow:hidden}
        body{font-family:'Noto Sans KR',sans-serif;background:var(--bg-primary);color:var(--text-primary)}
        .login-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;padding:2rem;position:fixed;top:0;left:0;right:0;bottom:0;z-index:1000;background:var(--bg-primary)}
        .login-screen.hidden{display:none}
        .login-logo{font-family:'Cormorant Garamond',serif;letter-spacing:4px;color:var(--text-muted);font-size:.8rem;margin-bottom:.5rem}
        .login-title{font-family:'Cormorant Garamond',serif;font-size:2.2rem;font-weight:500;margin-bottom:2rem;color:var(--text-primary);letter-spacing:2px}
        .login-form{width:100%;max-width:300px}
        .login-input{width:100%;padding:1rem;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:0;color:var(--text-primary);font-size:1rem;margin-bottom:1rem}
        .login-input:focus{outline:none;border-color:var(--accent-gold)}.login-input::placeholder{color:var(--text-muted)}
        .pw-wrapper{position:relative}.pw-toggle{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1rem;margin-top:-8px}
        .login-btn{width:100%;padding:1rem;background:var(--accent-dark);border:none;color:white;font-size:.9rem;font-weight:500;cursor:pointer;letter-spacing:1px}
        .login-error{color:var(--accent-red);font-size:.85rem;text-align:center;margin-bottom:1rem}
        .pw-modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:2000;align-items:center;justify-content:center;padding:1rem}
        .pw-modal.active{display:flex}.pw-modal-content{background:var(--bg-card);padding:2rem;width:100%;max-width:320px;border:1px solid var(--border-color)}
        .pw-modal-title{font-size:1rem;font-weight:600;margin-bottom:1rem;text-align:center}
        .app-container{display:none;flex-direction:column;height:100vh;height:100dvh}.app-container.active{display:flex}
        .header{background:var(--bg-secondary);padding:1rem;padding-top:max(1rem,env(safe-area-inset-top));border-bottom:1px solid var(--border-color);flex-shrink:0}
        .header-content{display:flex;justify-content:space-between;align-items:center}
        .header-logo{display:flex;flex-direction:column}.header-logo-sub{font-family:'Cormorant Garamond',serif;font-size:.6rem;letter-spacing:2px;color:var(--text-muted)}.header-logo-text{font-family:'Cormorant Garamond',serif;font-size:1.1rem;letter-spacing:1px}
        .header-user{display:flex;align-items:center;gap:.5rem}.user-name{font-size:.85rem;font-weight:500}
        .logout-btn{padding:.4rem .8rem;background:transparent;border:1px solid var(--border-color);color:var(--text-secondary);font-size:.7rem;cursor:pointer;letter-spacing:.5px}
        .content{flex:1;overflow-y:auto;padding:1rem;padding-bottom:calc(70px + env(safe-area-inset-bottom))}
        .card{background:var(--bg-card);padding:1.25rem;margin-bottom:1rem;border:1px solid var(--border-color)}
        .card-title{font-size:.85rem;font-weight:600;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem;letter-spacing:.5px}
        .info-row{display:flex;justify-content:space-between;padding:.75rem 0;border-bottom:1px solid var(--border-color)}
        .info-row:last-child{border-bottom:none}.info-label{color:var(--text-secondary);font-size:.8rem}.info-value{font-weight:500;font-size:.85rem}
        .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:.75rem;margin-bottom:1rem}
        .stat-card{background:var(--bg-secondary);padding:1rem;text-align:center;border:1px solid var(--border-color)}
        .stat-value{font-size:1.3rem;font-weight:600;margin-bottom:.25rem}.stat-label{font-size:.7rem;color:var(--text-secondary);letter-spacing:.5px}
        .stat-card.gold .stat-value{color:var(--accent-gold)}.stat-card.green .stat-value{color:var(--accent-green)}
        .stat-card.orange .stat-value{color:#c4956a}.stat-card.purple .stat-value{color:#7a6a8a}
        .ot-input-section{background:var(--bg-secondary);padding:1rem;margin-bottom:1rem;border:1px solid var(--border-color)}
        .ot-input-title{font-size:.8rem;font-weight:500;margin-bottom:.75rem;color:var(--text-secondary)}
        .ot-input-row{display:flex;align-items:center;gap:1rem}
        .ot-input{flex:1;padding:.75rem;background:var(--bg-card);border:1px solid var(--border-color);color:var(--text-primary);font-size:1rem;text-align:center}
        .ot-save-btn{padding:.75rem 1.5rem;background:var(--accent-dark);border:none;color:white;font-weight:500;cursor:pointer}
        .leave-balance{display:flex;justify-content:space-around;background:var(--bg-secondary);padding:1rem;margin-bottom:1rem;border:1px solid var(--border-color)}
        .leave-item{text-align:center}.leave-num{font-size:1.4rem;font-weight:600;color:var(--accent-gold)}.leave-label{font-size:.7rem;color:var(--text-secondary)}
        .action-btn{width:100%;padding:1rem;background:var(--accent-dark);border:none;color:white;font-weight:500;cursor:pointer;margin-bottom:1rem;letter-spacing:.5px}
        .action-btn.secondary{background:var(--bg-secondary);color:var(--text-primary);border:1px solid var(--border-color)}
        .action-btn.gold{background:var(--accent-gold)}
        .leave-list{max-height:300px;overflow-y:auto}
        .leave-item-card{background:var(--bg-secondary);padding:1rem;margin-bottom:.75rem;border:1px solid var(--border-color)}
        .leave-date{font-weight:500;margin-bottom:.25rem;font-size:.9rem}.leave-type{font-size:.75rem;color:var(--text-muted)}
        .leave-status{display:inline-block;padding:.25rem .75rem;font-size:.7rem;font-weight:500;margin-top:.5rem}
        .leave-status.pending{background:rgba(196,149,106,.15);color:#a07a4a}
        .leave-status.approved{background:rgba(90,122,90,.15);color:var(--accent-green)}
        .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--bg-secondary);border-top:1px solid var(--border-color);display:flex;padding-bottom:env(safe-area-inset-bottom);z-index:100}
        .nav-item{flex:1;padding:.75rem .5rem;display:flex;flex-direction:column;align-items:center;gap:.25rem;cursor:pointer;color:var(--text-muted);border:none;background:none}
        .nav-item.active{color:var(--accent-gold)}.nav-icon{font-size:1.1rem}.nav-label{font-size:.65rem;font-weight:500;letter-spacing:.5px}
        .tab-content{display:none}.tab-content.active{display:block}
        .modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:200;align-items:flex-end;justify-content:center}
        .modal.active{display:flex}
        .modal-content{background:var(--bg-card);padding:2rem;padding-bottom:calc(2rem + env(safe-area-inset-bottom));width:100%;max-height:80vh;overflow-y:auto;border-top:1px solid var(--border-color)}
        .modal-title{font-size:1rem;font-weight:600;margin-bottom:1.5rem;text-align:center;letter-spacing:.5px}
        .modal-input,.modal-select{width:100%;padding:1rem;background:var(--bg-secondary);border:1px solid var(--border-color);color:var(--text-primary);font-size:1rem;margin-bottom:1rem}
        .modal-btn{width:100%;padding:1rem;border:none;font-size:.9rem;font-weight:500;cursor:pointer;margin-bottom:.75rem;letter-spacing:.5px}
        .modal-btn.primary{background:var(--accent-dark);color:white}.modal-btn.secondary{background:var(--bg-secondary);color:var(--text-secondary);border:1px solid var(--border-color)}
        .badge{display:inline-flex;padding:.25rem .75rem;font-size:.7rem;font-weight:500}
        .badge-purple{background:rgba(122,106,138,.15);color:#7a6a8a}.badge-green{background:rgba(90,122,90,.15);color:var(--accent-green)}.badge-orange{background:rgba(196,149,106,.15);color:#a07a4a}
        .incentive-record{background:var(--bg-secondary);padding:1rem;margin-bottom:.75rem;display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border-color)}
        .incentive-record-info{flex:1}.incentive-record-name{font-weight:500;font-size:.85rem}.incentive-record-detail{font-size:.75rem;color:var(--text-muted)}
        .incentive-record-delete{padding:.5rem;background:transparent;border:1px solid var(--accent-red);color:var(--accent-red);font-size:.7rem;cursor:pointer}
        .no-incentive{text-align:center;padding:2rem;color:var(--text-muted)}
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-logo">THE CLINIC</div>
        <div class="login-title">LUMI</div>
        <form class="login-form" onsubmit="handleLogin(); return false;" autocomplete="on">
            <input type="text" class="login-input" id="loginId" placeholder="ì‚¬ë²ˆ" autocapitalize="none" autocomplete="username">
            <div class="pw-wrapper">
                <input type="password" class="login-input" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password">
                <button type="button" class="pw-toggle" onclick="togglePw('loginPw',this)">ğŸ‘</button>
            </div>
            <div class="login-error" id="loginError"></div>
            <button type="submit" class="login-btn">ë¡œê·¸ì¸</button>
        </form>
    </div>
    <div class="pw-modal" id="pwSetupModal">
        <div class="pw-modal-content">
            <div class="pw-modal-title">ë¹„ë°€ë²ˆí˜¸ ì„¤ì •</div>
            <p style="font-size:.8rem;color:var(--text-secondary);margin-bottom:1rem;text-align:center">ìµœì´ˆ ë¡œê·¸ì¸ì…ë‹ˆë‹¤. ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.</p>
            <form onsubmit="setupPassword(); return false;" autocomplete="on">
                <input type="text" id="setupUsername" autocomplete="username" style="display:none" aria-hidden="true">
                <input type="password" class="login-input" id="newPw1" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ (4ì ì´ìƒ)" autocomplete="new-password">
                <input type="password" class="login-input" id="newPw2" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" autocomplete="new-password">
                <div class="login-error" id="pwError"></div>
                <button type="submit" class="login-btn">ì„¤ì • ì™„ë£Œ</button>
            </form>
        </div>
    </div>
    <div class="app-container" id="appContainer">
        <header class="header"><div class="header-content"><div class="header-logo"><div class="header-logo-sub">THE CLINIC</div><div class="header-logo-text">LUMI</div></div><div class="header-user"><span class="user-name" id="userName">-</span><button class="logout-btn" onclick="logout()">LOGOUT</button></div></div></header>
        <div class="content">
            <div class="tab-content active" id="tab-info">
                <div class="card"><div class="card-title">ë‚´ ì •ë³´</div>
                    <div class="info-row"><span class="info-label">ì´ë¦„</span><span class="info-value" id="infoName">-</span></div>
                    <div class="info-row"><span class="info-label">ì‚¬ë²ˆ</span><span class="info-value" id="infoId">-</span></div>
                    <div class="info-row"><span class="info-label">ì§ê¸‰</span><span class="info-value" id="infoRole">-</span></div>
                    <div class="info-row"><span class="info-label">ì…ì‚¬ì¼</span><span class="info-value" id="infoJoinDate">-</span></div>
                    <div class="info-row"><span class="info-label">ê·¼ì†ê¸°ê°„</span><span class="info-value" id="infoTenure">-</span></div>
                </div>
                <div class="card"><div class="card-title">ê¸‰ì—¬ ì •ë³´</div>
                    <div class="info-row"><span class="info-label">ê¸°ë³¸ê¸‰</span><span class="info-value" id="infoBaseSalary">-</span></div>
                    <div class="info-row"><span class="info-label">ê³ ì •OTìˆ˜ë‹¹</span><span class="info-value" id="infoFixedOT">-</span></div>
                    <div class="info-row"><span class="info-label">ì‹œê¸‰</span><span class="info-value" id="infoHourlyWage">-</span></div>
                </div>
            </div>
            <div class="tab-content" id="tab-attendance">
                <div class="stats-grid">
                    <div class="stat-card gold"><div class="stat-value" id="attWorkDays">0</div><div class="stat-label">ì´ë²ˆë‹¬ ì¶œê·¼</div></div>
                    <div class="stat-card orange"><div class="stat-value" id="attLate">0</div><div class="stat-label">ì§€ê°</div></div>
                </div>
                <div class="card"><div class="card-title">ì˜¤ëŠ˜ ê·¼ë¬´</div>
                    <div class="info-row"><span class="info-label">ì¶œê·¼</span><span class="info-value" id="todayCheckIn">-</span></div>
                    <div class="info-row"><span class="info-label">í‡´ê·¼</span><span class="info-value" id="todayCheckOut">-</span></div>
                </div>
                <button class="action-btn" id="checkInBtn" onclick="checkIn()">ì¶œê·¼í•˜ê¸°</button>
                <button class="action-btn gold" id="checkOutBtn" onclick="checkOut()" style="display:none">í‡´ê·¼í•˜ê¸°</button>
            </div>
            <div class="tab-content" id="tab-overtime">
                <div class="stats-grid">
                    <div class="stat-card gold"><div class="stat-value" id="otAfterWork">0H</div><div class="stat-label">í‡´ê·¼í›„ OT</div></div>
                    <div class="stat-card purple"><div class="stat-value" id="otLunch">0H</div><div class="stat-label">ì ì‹¬ OT</div></div>
                    <div class="stat-card green"><div class="stat-value" id="otTotal">0H</div><div class="stat-label">ì´ OT</div></div>
                    <div class="stat-card orange"><div class="stat-value" id="otPay">â‚©0</div><div class="stat-label">ì˜ˆìƒ OTìˆ˜ë‹¹</div></div>
                </div>
                <div class="ot-input-section">
                    <div class="ot-input-title">ì˜¤ëŠ˜ ì ì‹¬ ì˜¤ë²„íƒ€ì„ ì…ë ¥</div>
                    <div class="ot-input-row"><input type="number" class="ot-input" id="lunchOTInput" placeholder="0" min="0" step="5"><span style="color:var(--text-secondary)">ë¶„</span><button class="ot-save-btn" onclick="saveLunchOT()">ì €ì¥</button></div>
                </div>
            </div>
            <div class="tab-content" id="tab-incentive">
                <div class="stats-grid">
                    <div class="stat-card green"><div class="stat-value" id="incTotal">â‚©0</div><div class="stat-label">ì´ë²ˆë‹¬ ì¸ì„¼í‹°ë¸Œ</div></div>
                    <div class="stat-card purple"><div class="stat-value" id="incItemCount">0ê°œ</div><div class="stat-label">ì ìš© í•­ëª©</div></div>
                </div>
                <div class="card"><div class="card-title">ë‚˜ì˜ ì¸ì„¼í‹°ë¸Œ í•­ëª©</div><div id="myIncentiveItems"><div class="no-incentive">ì ìš©ëœ ì¸ì„¼í‹°ë¸Œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div></div></div>
                <button class="action-btn gold" onclick="openIncentiveModal()">ì‹¤ì  ì…ë ¥</button>
                <div class="card"><div class="card-title">ì´ë²ˆë‹¬ ì…ë ¥ ë‚´ì—­</div><div id="incRecordsList"><div class="no-incentive">ì…ë ¥ëœ ì‹¤ì ì´ ì—†ìŠµë‹ˆë‹¤.</div></div></div>
            </div>
            <div class="tab-content" id="tab-leave">
                <div class="leave-balance">
                    <div class="leave-item"><div class="leave-num" id="leaveTotal">0</div><div class="leave-label">ì´ ì—°ì°¨</div></div>
                    <div class="leave-item"><div class="leave-num" id="leaveUsed">0</div><div class="leave-label">ì‚¬ìš©</div></div>
                    <div class="leave-item"><div class="leave-num" style="color:var(--accent-green)" id="leaveRemain">0</div><div class="leave-label">ì”ì—¬</div></div>
                </div>
                <button class="action-btn" onclick="openLeaveModal()">íœ´ê°€ ì‹ ì²­</button>
                <div class="card"><div class="card-title">ì‹ ì²­ ë‚´ì—­</div><div class="leave-list" id="leaveList"><div style="text-align:center;color:var(--text-muted);padding:1rem">ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div></div></div>
            </div>
        </div>
        <nav class="bottom-nav">
            <button class="nav-item active" data-tab="info"><span class="nav-icon">ğŸ‘¤</span><span class="nav-label">ë‚´ ì •ë³´</span></button>
            <button class="nav-item" data-tab="attendance"><span class="nav-icon">ğŸ“…</span><span class="nav-label">ì¶œí‡´ê·¼</span></button>
            <button class="nav-item" data-tab="overtime"><span class="nav-icon">â°</span><span class="nav-label">OT</span></button>
            <button class="nav-item" data-tab="incentive"><span class="nav-icon">ğŸ’</span><span class="nav-label">ì¸ì„¼í‹°ë¸Œ</span></button>
            <button class="nav-item" data-tab="leave"><span class="nav-icon">ğŸ–ï¸</span><span class="nav-label">íœ´ê°€</span></button>
        </nav>
    </div>
    <div class="modal" id="incentiveModal">
        <div class="modal-content">
            <div class="modal-title">ì¸ì„¼í‹°ë¸Œ ì‹¤ì  ì…ë ¥</div>
            <select class="modal-select" id="incItemSelect"><option value="">í•­ëª© ì„ íƒ</option></select>
            <input type="text" class="modal-input" id="incClientName" placeholder="ê³ ê° ì´ë¦„">
            <input type="text" class="modal-input" id="incChartNo" placeholder="ì°¨íŠ¸ë²ˆí˜¸">
            <button class="modal-btn primary" onclick="submitIncentiveRecord()">+ 1ê±´ ì¶”ê°€</button>
            <button class="modal-btn secondary" onclick="closeIncentiveModal()">ë‹«ê¸°</button>
        </div>
    </div>
    <div class="modal" id="leaveModal">
        <div class="modal-content">
            <div class="modal-title">íœ´ê°€ ì‹ ì²­</div>
            <select class="modal-select" id="leaveType"><option value="annual">ì—°ì°¨</option><option value="half">ë°˜ì°¨</option><option value="off">ì˜¤í”„</option></select>
            <input type="date" class="modal-input" id="leaveStart" placeholder="ì‹œì‘ì¼">
            <input type="date" class="modal-input" id="leaveEnd" placeholder="ì¢…ë£Œì¼">
            <input type="text" class="modal-input" id="leaveReason" placeholder="ì‚¬ìœ ">
            <button class="modal-btn primary" onclick="submitLeave()">ì‹ ì²­í•˜ê¸°</button>
            <button class="modal-btn secondary" onclick="closeLeaveModal()">ì·¨ì†Œ</button>
        </div>
    </div>
    <script>
        const firebaseConfig={apiKey:"AIzaSyDnkKNXNnDVlcPd5Y1fl59YysdeEZi7uJU",authDomain:"lumiclinic-c1a95.firebaseapp.com",projectId:"lumiclinic-c1a95",storageBucket:"lumiclinic-c1a95.firebasestorage.app",messagingSenderId:"901456209944",appId:"1:901456209944:web:f287418cd0541f324d3b6d"};
        firebase.initializeApp(firebaseConfig);const db=firebase.firestore();

        let currentUser=null,attendanceData={},leaveRequests=[],lunchOTRecords={},myIncentiveItems=[],incentiveRecords={},revenueData={},salesDetailData={};
        const DEFAULT_PW='final12890-';
        const overtimeRules={1:'18:30',2:'18:30',3:'18:00',4:'18:00',5:'18:30',6:'15:00'};
        const monthlyData2024=[173111326,156060457,198554450,207124800,193543660,179806116,187612314,157672141,206156505,211217542,243773264,215202565];

        function togglePw(id,btn){const inp=document.getElementById(id);if(inp.type==='password'){inp.type='text';btn.textContent='ğŸ”’';}else{inp.type='password';btn.textContent='ğŸ‘';}}

        async function handleLogin(){
            const inputId=document.getElementById('loginId').value.trim();
            const pw=document.getElementById('loginPw').value;
            document.getElementById('loginError').textContent='';
            if(!inputId){document.getElementById('loginError').textContent='ì‚¬ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”';return;}
            if(!pw){document.getElementById('loginError').textContent='ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”';return;}
            try{
                // ì†Œë¬¸ì, ëŒ€ë¬¸ì, ì›ë³¸ ìˆœì„œë¡œ ì‹œë„
                const tryIds=[inputId.toLowerCase(),inputId.toUpperCase(),inputId];
                let doc=null,foundId=null;
                for(const tryId of tryIds){
                    const d=await db.collection('employees').doc(tryId).get();
                    if(d.exists){doc=d;foundId=tryId;break;}
                }
                if(!doc){document.getElementById('loginError').textContent='ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ë²ˆì…ë‹ˆë‹¤ ('+inputId+')';return;}
                const emp=doc.data();
                if(!emp.password){currentUser={id:foundId,...emp};document.getElementById('setupUsername').value=foundId;document.getElementById('pwSetupModal').classList.add('active');return;}
                if(emp.password!==pw){document.getElementById('loginError').textContent='ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤';return;}
                currentUser={id:foundId,...emp};localStorage.setItem('lumiUser',foundId);showApp();
            }catch(e){document.getElementById('loginError').textContent='ë¡œê·¸ì¸ ì‹¤íŒ¨: '+e.message;}
        }
        async function setupPassword(){
            const pw1=document.getElementById('newPw1').value,pw2=document.getElementById('newPw2').value;
            document.getElementById('pwError').textContent='';
            if(pw1.length<4){document.getElementById('pwError').textContent='ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒ';return;}
            if(pw1!==pw2){document.getElementById('pwError').textContent='ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤';return;}
            try{await db.collection('employees').doc(currentUser.id).update({password:pw1});currentUser.password=pw1;localStorage.setItem('lumiUser',currentUser.id);document.getElementById('pwSetupModal').classList.remove('active');showApp();}catch(e){document.getElementById('pwError').textContent='ì„¤ì • ì‹¤íŒ¨';}
        }
        function logout(){localStorage.removeItem('lumiUser');currentUser=null;document.getElementById('loginScreen').classList.remove('hidden');document.getElementById('appContainer').classList.remove('active');document.getElementById('loginId').value='';document.getElementById('loginPw').value='';}
        async function showApp(){document.getElementById('loginScreen').classList.add('hidden');document.getElementById('appContainer').classList.add('active');await loadAllData();renderAll();}
        async function checkAutoLogin(){const savedId=localStorage.getItem('lumiUser');if(savedId){try{const doc=await db.collection('employees').doc(savedId).get();if(doc.exists){currentUser={id:savedId,...doc.data()};showApp();return;}}catch(e){}}}

        function getYM(){const d=new Date();return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');}
        function getToday(){return new Date().toISOString().split('T')[0];}

        async function loadAllData(){await loadAttendance();await loadLeaveRequests();await loadLunchOTRecords();await loadMyIncentiveItems();await loadIncentiveRecords();await loadRevenueData();await loadSalesDetailData();}
        async function loadAttendance(){
            const ym=getYM();
            try{const snap=await db.collection('attendance').doc(currentUser.id).collection('records').where(firebase.firestore.FieldPath.documentId(),'>=',ym+'-01').where(firebase.firestore.FieldPath.documentId(),'<=',ym+'-31').get();
                attendanceData={records:[],summary:{workDays:0,late:0,afterWorkOT:0}};
                snap.forEach(d=>{const data=d.data(),dow=new Date(d.id).getDay(),ot=calcAfterWorkOT(data.checkOut,dow);attendanceData.records.push({date:d.id,...data,afterWorkOT:ot});attendanceData.summary.workDays++;if(data.status==='late')attendanceData.summary.late++;attendanceData.summary.afterWorkOT+=ot;});
            }catch(e){}
        }
        async function loadLeaveRequests(){try{const snap=await db.collection('leaveRequests').where('employeeId','==',currentUser.id).orderBy('createdAt','desc').limit(20).get();leaveRequests=[];snap.forEach(d=>leaveRequests.push({id:d.id,...d.data()}));}catch(e){}}
        async function loadLunchOTRecords(){try{const doc=await db.collection('lunchOTDaily').doc(currentUser.id).get();lunchOTRecords=doc.exists?doc.data():{};}catch(e){}}
        async function loadMyIncentiveItems(){try{const snap=await db.collection('incentiveItems').where('employees','array-contains',currentUser.id).get();myIncentiveItems=[];snap.forEach(d=>myIncentiveItems.push({id:d.id,...d.data()}));}catch(e){}}
        async function loadIncentiveRecords(){const ym=getYM();try{const doc=await db.collection('incentiveRecords').doc(currentUser.id).collection('monthly').doc(ym).get();incentiveRecords=doc.exists?doc.data():{};}catch(e){incentiveRecords={};}}
        async function loadRevenueData(){const ym=getYM();try{const doc=await db.collection('revenue').doc(ym).get();revenueData=doc.exists?doc.data():{total:0,japan:0,japanVisitors:0};}catch(e){revenueData={total:0,japan:0,japanVisitors:0};}}
        async function loadSalesDetailData(){const ym=getYM();try{const doc=await db.collection('salesDetail').doc(ym).get();salesDetailData=doc.exists?doc.data():{staffSales:{},japanStaffSales:{}};}catch(e){salesDetailData={staffSales:{},japanStaffSales:{}};}}

        function timeToMin(t){if(!t)return 0;const[h,m]=t.split(':').map(Number);return h*60+m;}
        function calcAfterWorkOT(checkOut,dow){if(!checkOut||dow===0)return 0;const rule=overtimeRules[dow];if(!rule)return 0;return Math.max(0,timeToMin(checkOut)-timeToMin(rule));}
        function calcTenure(jd){if(!jd)return'-';const j=new Date(jd),n=new Date();let y=n.getFullYear()-j.getFullYear(),m=n.getMonth()-j.getMonth();if(m<0){y--;m+=12;}if(y>0)return m>0?y+'ë…„ '+m+'ê°œì›”':y+'ë…„ì°¨';if(m>0)return m+'ê°œì›”';return'ì‹ ì…';}
        function calcAnnualLeave(jd){if(!jd)return 0;const j=new Date(jd),n=new Date(),months=(n.getFullYear()-j.getFullYear())*12+(n.getMonth()-j.getMonth());if(months<12)return Math.min(months,11);return Math.min(15+Math.floor((Math.floor(months/12)-1)/2),25);}
        function formatCurrency(n){return'â‚©'+new Intl.NumberFormat('ko-KR').format(n||0);}

        function getMyStaffSales(){if(!currentUser.matchName)return 0;return salesDetailData.staffSales?.[currentUser.matchName]?.amount||0;}
        function getMyJapanSales(){if(!currentUser.matchName)return 0;return salesDetailData.japanStaffSales?.[currentUser.matchName]?.amount||0;}

        function calcMyIncentive(){
            let total=0;const details=[];
            myIncentiveItems.forEach(item=>{
                let amount=0,desc='';
                switch(item.type){
                    case 'per_case':const count=incentiveRecords[item.id]?.count||0;amount=count*(item.perCaseAmount||0);desc=`${count}ê±´ Ã— ${formatCurrency(item.perCaseAmount)}`;break;
                    case 'revenue_percent':amount=Math.round((revenueData.total||0)*(item.percent||0)/100);if(item.cap&&amount>item.cap)amount=item.cap;desc=`ì´ë§¤ì¶œ Ã— ${item.percent}%`;break;
                    case 'growth_percent':const monthIdx=new Date().getMonth();const prev=monthlyData2024[monthIdx]||0;const growth=Math.max(0,(revenueData.total||0)-prev);amount=Math.round(growth*(item.percent||0)/100);if(item.cap&&amount>item.cap)amount=item.cap;desc=`ì„±ì¥ë¶„ Ã— ${item.percent}%`;break;
                    case 'staff_sales':const staffSales=getMyStaffSales();amount=Math.round(staffSales*(item.percent||0)/100);desc=`ë‹´ë‹¹ë§¤ì¶œ ${formatCurrency(staffSales)} Ã— ${item.percent}%`;break;
                    case 'japan_visit':amount=(revenueData.japanVisitors||0)*(item.perCaseAmount||0);desc=`${revenueData.japanVisitors||0}ëª… Ã— ${formatCurrency(item.perCaseAmount)}`;break;
                    case 'japan_revenue':const japanSales=getMyJapanSales();amount=Math.round(japanSales*(item.percent||0)/100);desc=`ì¼ë³¸ì¸ë§¤ì¶œ ${formatCurrency(japanSales)} Ã— ${item.percent}%`;break;
                }
                details.push({item:item.name,type:item.type,amount,desc,id:item.id});total+=amount;
            });
            return{total,details};
        }

        function renderAll(){document.getElementById('userName').textContent=currentUser.name;renderInfo();renderAttendance();renderOvertime();renderIncentive();renderLeave();}
        function renderInfo(){
            document.getElementById('infoName').textContent=currentUser.name;document.getElementById('infoId').textContent=currentUser.id;
            document.getElementById('infoRole').textContent=currentUser.role||'-';document.getElementById('infoJoinDate').textContent=currentUser.joinDate||'-';
            document.getElementById('infoTenure').textContent=calcTenure(currentUser.joinDate);
            document.getElementById('infoBaseSalary').textContent=formatCurrency(currentUser.baseSalary);
            document.getElementById('infoFixedOT').textContent=formatCurrency(currentUser.fixedOT);
            document.getElementById('infoHourlyWage').textContent=formatCurrency(currentUser.hourlyWage);
        }
        function renderAttendance(){
            document.getElementById('attWorkDays').textContent=attendanceData.summary?.workDays||0;document.getElementById('attLate').textContent=attendanceData.summary?.late||0;
            const today=getToday(),todayRec=attendanceData.records?.find(r=>r.date===today);
            document.getElementById('todayCheckIn').textContent=todayRec?.checkIn||'-';document.getElementById('todayCheckOut').textContent=todayRec?.checkOut||'-';
            if(todayRec?.checkIn&&!todayRec?.checkOut){document.getElementById('checkInBtn').style.display='none';document.getElementById('checkOutBtn').style.display='block';}
            else{document.getElementById('checkInBtn').style.display='block';document.getElementById('checkOutBtn').style.display='none';}
        }
        function renderOvertime(){
            const ym=getYM();let totalLunchOT=0;Object.keys(lunchOTRecords).forEach(k=>{if(k.startsWith(ym))totalLunchOT+=lunchOTRecords[k]||0;});
            const afterWorkOT=attendanceData.summary?.afterWorkOT||0,totalOT=afterWorkOT+totalLunchOT;
            const otPay=Math.round((totalOT/60)*(currentUser.hourlyWage||0)*1.5*0.967);
            document.getElementById('otAfterWork').textContent=(afterWorkOT/60).toFixed(1)+'H';document.getElementById('otLunch').textContent=(totalLunchOT/60).toFixed(1)+'H';
            document.getElementById('otTotal').textContent=(totalOT/60).toFixed(1)+'H';document.getElementById('otPay').textContent=formatCurrency(otPay);
            document.getElementById('lunchOTInput').value=lunchOTRecords[getToday()]||'';
        }
        function renderIncentive(){
            const inc=calcMyIncentive();document.getElementById('incTotal').textContent=formatCurrency(inc.total);document.getElementById('incItemCount').textContent=myIncentiveItems.length+'ê°œ';
            const itemsDiv=document.getElementById('myIncentiveItems');
            if(myIncentiveItems.length===0){itemsDiv.innerHTML='<div class="no-incentive">ì ìš©ëœ ì¸ì„¼í‹°ë¸Œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';}
            else{const typeLabels={per_case:'ê±´ë‹¹',revenue_percent:'ë§¤ì¶œë¹„ìœ¨',growth_percent:'ì„±ì¥ë¶„',staff_sales:'ë‹´ë‹¹ë§¤ì¶œ',japan_visit:'ì¼ë³¸ì¸ë°©ë¬¸',japan_revenue:'ì¼ë³¸ì¸ë§¤ì¶œ'};itemsDiv.innerHTML=inc.details.map(d=>`<div class="incentive-record"><div class="incentive-record-info"><div class="incentive-record-name">${d.item} <span class="badge badge-purple">${typeLabels[d.type]||d.type}</span></div><div class="incentive-record-detail">${d.desc} = <strong style="color:var(--accent-green)">${formatCurrency(d.amount)}</strong></div></div></div>`).join('');}
            const recordsDiv=document.getElementById('incRecordsList');const perCaseItems=myIncentiveItems.filter(i=>i.type==='per_case');let allRecords=[];
            perCaseItems.forEach(item=>{const recs=incentiveRecords[item.id]?.records||[];recs.forEach((r,idx)=>allRecords.push({...r,itemName:item.name,itemId:item.id,idx}));});
            if(allRecords.length===0){recordsDiv.innerHTML='<div class="no-incentive">ì…ë ¥ëœ ì‹¤ì ì´ ì—†ìŠµë‹ˆë‹¤.</div>';}
            else{recordsDiv.innerHTML=allRecords.map(r=>`<div class="incentive-record"><div class="incentive-record-info"><div class="incentive-record-name">${r.itemName}</div><div class="incentive-record-detail">${r.clientName} (${r.chartNo}) - ${r.date}</div></div><button class="incentive-record-delete" onclick="deleteIncentiveRecord('${r.itemId}',${r.idx})">ì‚­ì œ</button></div>`).join('');}
            const select=document.getElementById('incItemSelect');select.innerHTML='<option value="">í•­ëª© ì„ íƒ</option>'+perCaseItems.map(i=>`<option value="${i.id}">${i.name} (${formatCurrency(i.perCaseAmount)}/ê±´)</option>`).join('');
        }
        function renderLeave(){
            const total=calcAnnualLeave(currentUser.joinDate),used=leaveRequests.filter(l=>l.status==='approved'&&l.type==='annual').length;
            document.getElementById('leaveTotal').textContent=total;document.getElementById('leaveUsed').textContent=used;document.getElementById('leaveRemain').textContent=total-used;
            const list=document.getElementById('leaveList');
            if(leaveRequests.length===0){list.innerHTML='<div style="text-align:center;color:var(--text-muted);padding:1rem">ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';return;}
            list.innerHTML=leaveRequests.map(l=>`<div class="leave-item-card"><div class="leave-date">${l.startDate}${l.startDate!==l.endDate?' ~ '+l.endDate:''}</div><div class="leave-type">${l.type==='annual'?'ì—°ì°¨':l.type==='half'?'ë°˜ì°¨':'ì˜¤í”„'}${l.reason?' - '+l.reason:''}</div><span class="leave-status ${l.status}">${l.status==='pending'?'ëŒ€ê¸°ì¤‘':l.status==='approved'?'ìŠ¹ì¸ë¨':'ë°˜ë ¤ë¨'}</span></div>`).join('');
        }

        async function checkIn(){const now=new Date(),time=String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');const today=getToday(),status=timeToMin(time)>timeToMin('09:30')?'late':'normal';try{await db.collection('attendance').doc(currentUser.id).collection('records').doc(today).set({checkIn:time,status,createdAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});alert('ì¶œê·¼ ì™„ë£Œ: '+time);await loadAttendance();renderAttendance();renderOvertime();}catch(e){alert('ì¶œê·¼ ì‹¤íŒ¨');}}
        async function checkOut(){const now=new Date(),time=String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');const today=getToday();try{await db.collection('attendance').doc(currentUser.id).collection('records').doc(today).update({checkOut:time,updatedAt:firebase.firestore.FieldValue.serverTimestamp()});alert('í‡´ê·¼ ì™„ë£Œ: '+time);await loadAttendance();renderAttendance();renderOvertime();}catch(e){alert('í‡´ê·¼ ì‹¤íŒ¨');}}
        async function saveLunchOT(){const today=getToday(),min=parseInt(document.getElementById('lunchOTInput').value)||0;lunchOTRecords[today]=min;try{await db.collection('lunchOTDaily').doc(currentUser.id).set(lunchOTRecords,{merge:true});alert('ì €ì¥ ì™„ë£Œ');renderOvertime();}catch(e){alert('ì €ì¥ ì‹¤íŒ¨');}}

        function openIncentiveModal(){document.getElementById('incentiveModal').classList.add('active');document.getElementById('incClientName').value='';document.getElementById('incChartNo').value='';}
        function closeIncentiveModal(){document.getElementById('incentiveModal').classList.remove('active');}
        async function submitIncentiveRecord(){
            const itemId=document.getElementById('incItemSelect').value;const clientName=document.getElementById('incClientName').value.trim();const chartNo=document.getElementById('incChartNo').value.trim();
            if(!itemId){alert('í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”');return;}if(!clientName){alert('ê³ ê° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
            const ym=getYM();const newRecord={clientName,chartNo,date:getToday()};const current=incentiveRecords[itemId]||{count:0,records:[]};
            current.count=(current.count||0)+1;current.records=current.records||[];current.records.push(newRecord);incentiveRecords[itemId]=current;
            try{await db.collection('incentiveRecords').doc(currentUser.id).collection('monthly').doc(ym).set(incentiveRecords);alert('1ê±´ ì¶”ê°€ ì™„ë£Œ');document.getElementById('incClientName').value='';document.getElementById('incChartNo').value='';renderIncentive();}catch(e){alert('ì €ì¥ ì‹¤íŒ¨');}
        }
        async function deleteIncentiveRecord(itemId,idx){
            if(!confirm('ì‚­ì œ?'))return;const ym=getYM();const current=incentiveRecords[itemId];
            if(current&&current.records&&current.records[idx]!==undefined){current.records.splice(idx,1);current.count=Math.max(0,(current.count||1)-1);incentiveRecords[itemId]=current;
                try{await db.collection('incentiveRecords').doc(currentUser.id).collection('monthly').doc(ym).set(incentiveRecords);renderIncentive();}catch(e){alert('ì‚­ì œ ì‹¤íŒ¨');}}
        }

        function openLeaveModal(){document.getElementById('leaveModal').classList.add('active');}
        function closeLeaveModal(){document.getElementById('leaveModal').classList.remove('active');}
        async function submitLeave(){
            const data={employeeId:currentUser.id,type:document.getElementById('leaveType').value,startDate:document.getElementById('leaveStart').value,endDate:document.getElementById('leaveEnd').value||document.getElementById('leaveStart').value,reason:document.getElementById('leaveReason').value,status:'pending',createdAt:firebase.firestore.FieldValue.serverTimestamp()};
            if(!data.startDate){alert('ì‹œì‘ì¼ì„ ì„ íƒí•˜ì„¸ìš”');return;}
            try{await db.collection('leaveRequests').add(data);alert('íœ´ê°€ ì‹ ì²­ ì™„ë£Œ');closeLeaveModal();await loadLeaveRequests();renderLeave();}catch(e){alert('ì‹ ì²­ ì‹¤íŒ¨');}
        }

        document.querySelectorAll('.nav-item').forEach(n=>n.addEventListener('click',()=>{document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));n.classList.add('active');document.getElementById('tab-'+n.dataset.tab).classList.add('active');}));
        checkAutoLogin();
    </script>
</body>
</html>
