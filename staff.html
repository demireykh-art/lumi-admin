<!DOCTYPE html>

<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>THE CLINIC LUMI - Staff</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon.png">
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--bg:#faf9f7;--bg-card:#fff;--primary:#9a8b7a;--primary-dark:#7a6b5a;--text:#2c2c2c;--text-secondary:#6b6b6b;--text-muted:#999;--border:#e8e4df;--green:#5a7a5a;--red:#a85a5a;--orange:#c4956a;--purple:#7a6a8a}
        *{margin:0;padding:0;box-sizing:border-box}
        html,body{height:100%;overflow:hidden}
        body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text)}

```
    .login-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;padding:2rem;position:fixed;inset:0;z-index:2000;background:var(--bg)}
    .login-screen.hidden{display:none}
    .login-logo{font-family:'Cormorant Garamond',serif;letter-spacing:4px;color:var(--text-muted);font-size:.8rem;margin-bottom:.25rem}
    .login-title{font-family:'Cormorant Garamond',serif;font-size:2.2rem;font-weight:500;letter-spacing:2px;margin-bottom:2rem}
    .login-form{width:100%;max-width:300px}
    .login-input{width:100%;padding:1rem;background:#fff;border:1px solid var(--border);font-size:1rem;margin-bottom:.75rem}
    .login-input:focus{outline:none;border-color:var(--primary)}
    .login-btn{width:100%;padding:1rem;background:var(--text);border:none;color:#fff;font-size:.9rem;cursor:pointer;letter-spacing:1px}
    .login-error{color:var(--red);font-size:.85rem;margin-bottom:.75rem;text-align:center;min-height:1.2rem}
    .pw-wrap{position:relative}
    .pw-toggle{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1rem;margin-top:-6px}
    
    .pw-setup{display:none;position:fixed;inset:0;z-index:2001;background:var(--bg);flex-direction:column;align-items:center;justify-content:center;padding:2rem}
    .pw-setup.active{display:flex}
    .pw-setup-title{font-size:1.2rem;font-weight:600;margin-bottom:.5rem}
    .pw-setup-desc{color:var(--text-secondary);font-size:.9rem;margin-bottom:1.5rem;text-align:center}
    
    .app-container{display:none;flex-direction:column;height:100vh;height:100dvh}
    .app-container.active{display:flex}
    
    .header{background:var(--bg-card);border-bottom:1px solid var(--border);padding:1rem;position:sticky;top:0;z-index:100}
    .header-content{display:flex;justify-content:space-between;align-items:center}
    .header-logo{font-family:'Cormorant Garamond',serif}
    .header-logo-sub{font-size:.6rem;letter-spacing:3px;color:var(--text-muted)}
    .header-logo-text{font-size:1.3rem;font-weight:500;letter-spacing:2px}
    .header-user{display:flex;align-items:center;gap:.75rem}
    .user-name{font-weight:500;font-size:.9rem}
    .logout-btn{padding:.4rem .8rem;border:1px solid var(--border);background:transparent;font-size:.75rem;cursor:pointer;letter-spacing:1px}
    
    .content{flex:1;overflow-y:auto;padding:1rem;padding-bottom:calc(70px + env(safe-area-inset-bottom))}
    
    .card{background:var(--bg-card);border:1px solid var(--border);padding:1.25rem;margin-bottom:1rem}
    .card-title{font-weight:600;margin-bottom:1rem;font-size:.95rem;display:flex;justify-content:space-between;align-items:center}
    .info-row{display:flex;justify-content:space-between;padding:.6rem 0;border-bottom:1px solid var(--border)}
    .info-row:last-child{border-bottom:none}
    .info-label{color:var(--text-secondary);font-size:.9rem}
    .info-value{font-weight:500;font-size:.9rem}
    
    .stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem;margin-bottom:1rem}
    .stat-card{background:var(--bg-card);border:1px solid var(--border);padding:1rem;text-align:center}
    .stat-value{font-size:1.4rem;font-weight:700;color:var(--primary)}
    .stat-label{font-size:.7rem;color:var(--text-muted);margin-top:.25rem}
    .stat-card.green .stat-value{color:var(--green)}
    .stat-card.orange .stat-value{color:var(--orange)}
    .stat-card.purple .stat-value{color:var(--purple)}
    .stat-card.red .stat-value{color:var(--red)}
    
    .btn{width:100%;padding:1rem;border:none;font-size:.95rem;font-weight:500;cursor:pointer;margin-bottom:.75rem}
    .btn-primary{background:var(--text);color:#fff}
    .btn-secondary{background:var(--bg);border:1px solid var(--border);color:var(--text)}
    .btn-gold{background:var(--primary);color:#fff}
    .btn-green{background:var(--green);color:#fff}
    .btn-disabled{background:#ccc;color:#666;cursor:not-allowed}
    
    /* ì¶œí‡´ê·¼ v2.1 í° ë²„íŠ¼ */
    .att-v2-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:1.5rem 1rem;border:2px solid var(--border);background:var(--bg-card);cursor:pointer;transition:all .2s;border-radius:8px;min-height:100px}
    .att-v2-btn .att-v2-icon{font-size:2rem;margin-bottom:.4rem}
    .att-v2-btn .att-v2-label{font-size:1.1rem;font-weight:600;letter-spacing:1px}
    .att-v2-btn .att-v2-time{font-size:.8rem;color:var(--text-muted);margin-top:.3rem}
    .att-v2-btn.active-in{border-color:var(--text);background:var(--text);color:#fff}
    .att-v2-btn.active-in .att-v2-label{color:#fff}
    .att-v2-btn.active-out{border-color:var(--primary);background:var(--primary);color:#fff}
    .att-v2-btn.active-out .att-v2-label{color:#fff}
    .att-v2-btn.done{border-color:var(--border);background:var(--bg);opacity:.5;cursor:not-allowed}
    .att-v2-btn.done .att-v2-label{color:var(--text-muted)}
    .att-v2-btn:active:not(.done){transform:scale(.97)}
    
    .tab-content{display:none}
    .tab-content.active{display:block}
    
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--bg-card);border-top:1px solid var(--border);display:flex;padding-bottom:env(safe-area-inset-bottom);z-index:100}
    .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;padding:.5rem .15rem;cursor:pointer;color:var(--text-muted);font-size:.6rem;transition:color .2s}
    .nav-item.active{color:var(--primary)}
    .nav-item .nav-icon{font-size:1.2rem;margin-bottom:.2rem}
    
    .modal{display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,.5);align-items:center;justify-content:center;padding:1rem}
    .modal.active{display:flex}
    .modal-content{background:var(--bg-card);width:100%;max-width:400px;max-height:90vh;overflow-y:auto}
    .modal-header{padding:1rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .modal-title{font-weight:600}
    .modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-muted)}
    .modal-body{padding:1rem}
    .modal-footer{padding:1rem;border-top:1px solid var(--border);display:flex;gap:.5rem}
    .modal-footer .btn{margin-bottom:0}
    
    .form-group{margin-bottom:1rem}
    .form-label{display:block;font-size:.85rem;color:var(--text-secondary);margin-bottom:.5rem}
    .form-input,.form-select{width:100%;padding:.75rem;border:1px solid var(--border);font-size:.95rem;background:#fff}
    .form-input:focus,.form-select:focus{outline:none;border-color:var(--primary)}
    
    .badge{display:inline-block;padding:.25rem .5rem;font-size:.75rem;border-radius:2px}
    .badge-green{background:rgba(90,122,90,.15);color:var(--green)}
    .badge-orange{background:rgba(196,149,106,.15);color:var(--orange)}
    .badge-red{background:rgba(168,90,90,.15);color:var(--red)}
    .badge-purple{background:rgba(122,106,138,.15);color:var(--purple)}
    .badge-gold{background:rgba(154,139,122,.15);color:var(--primary)}
    
    .list-item{display:flex;justify-content:space-between;align-items:center;padding:.75rem 0;border-bottom:1px solid var(--border)}
    .list-item:last-child{border-bottom:none}
    .list-item-title{font-weight:500;font-size:.9rem}
    .list-item-sub{font-size:.8rem;color:var(--text-muted)}
    
    .leave-item{padding:.75rem;background:var(--bg);margin-bottom:.5rem;border-left:3px solid var(--border)}
    .leave-item.pending{border-left-color:var(--orange)}
    .leave-item.approved{border-left-color:var(--green)}
    .leave-item.rejected{border-left-color:var(--red)}
    
    .date-tags{display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:1rem;min-height:2rem}
    .date-tag{display:inline-flex;align-items:center;gap:.25rem;padding:.35rem .6rem;background:var(--bg);border:1px solid var(--border);font-size:.85rem}
    .date-tag-remove{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1rem;line-height:1}
    
    .progress-bar{height:8px;background:var(--border);border-radius:4px;overflow:hidden;margin-top:.5rem}
    .progress-fill{height:100%;background:var(--green);transition:width .3s}
    .progress-fill.warning{background:var(--orange)}
    .progress-fill.danger{background:var(--red)}
    
    .golden-slider{display:flex;gap:.5rem;overflow-x:auto;padding:.25rem 0;-webkit-overflow-scrolling:touch;scroll-snap-type:x mandatory}
    .golden-slider::-webkit-scrollbar{height:4px}
    .golden-slider::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
    .golden-card{flex:0 0 140px;scroll-snap-align:start;background:linear-gradient(135deg,#fff9f0,#fff);border:1px solid var(--border);border-left:3px solid var(--gold);border-radius:8px;padding:.6rem}
    .golden-card .gc-month{font-size:.65rem;color:var(--text-muted);font-weight:600}
    .golden-card .gc-name{font-size:.8rem;font-weight:600;color:var(--text);margin:.2rem 0}
    .golden-card .gc-dates{font-size:.7rem;color:var(--gold);font-weight:500}
    .golden-card .gc-tip{font-size:.65rem;color:var(--text-muted);margin-top:.3rem;padding-top:.3rem;border-top:1px dashed var(--border)}
    
    .month-select{display:flex;align-items:center;gap:.5rem}
    .month-select select{padding:.4rem .6rem;border:1px solid var(--border);font-size:.85rem;background:#fff}
    
    .gps-status{font-size:.8rem;padding:.5rem;text-align:center;margin-bottom:1rem;border-radius:4px}
    .gps-status.ok{background:rgba(90,122,90,.1);color:var(--green)}
    .gps-status.error{background:rgba(168,90,90,.1);color:var(--red)}
    .gps-status.loading{background:rgba(154,139,122,.1);color:var(--primary)}
    
    /* ì¬ê³  ì‹¤ì‚¬ */
    .inv-cat-filters{display:flex;gap:.5rem;margin-bottom:1rem;flex-wrap:wrap}
    .inv-cat-btn{flex:1;min-width:0;padding:.75rem .5rem;border:2px solid var(--border);background:var(--bg-card);font-size:.9rem;font-weight:600;cursor:pointer;text-align:center;transition:all .2s;border-radius:8px}
    .inv-cat-btn.active{border-color:var(--primary);background:var(--primary);color:#fff}
    .inv-cat-btn .cat-icon{font-size:1.2rem;display:block;margin-bottom:.2rem}
    .inv-cat-btn .cat-count{font-size:.7rem;font-weight:400;opacity:.7}
    .inv-item-row{background:var(--bg-card);border:1px solid var(--border);padding:1rem;margin-bottom:.5rem;border-radius:6px}
    .inv-item-row.saved{border-color:var(--green);background:rgba(90,122,90,.05)}
    .inv-item-row-header{display:flex;align-items:flex-start;gap:.75rem}
    .inv-item-info{flex:1;min-width:0}
    .inv-item-name{font-weight:600;font-size:.9rem;margin-bottom:.2rem}
    .inv-item-meta{font-size:.75rem;color:var(--text-muted);display:flex;gap:.75rem;flex-wrap:wrap}
    .inv-item-meta span{white-space:nowrap}
    /* ì¥ì†Œë³„ ì‹¤ì‚¬ ì…ë ¥ ì˜ì—­ */
    .inv-loc-inputs{margin-top:.6rem;display:flex;flex-direction:column;gap:.35rem}
    .inv-loc-input-row{display:flex;align-items:center;gap:.5rem;padding:.35rem .5rem;background:var(--bg);border:1px solid var(--border);border-radius:5px}
    .inv-loc-input-row.loc-filled{border-color:var(--green);background:rgba(90,122,90,.06)}
    .inv-loc-label{flex:1;font-size:.78rem;color:var(--text-secondary);min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .inv-loc-sys{font-size:.75rem;color:var(--text-muted);min-width:38px;text-align:right;white-space:nowrap}
    .inv-stock-input{width:70px;padding:.4rem .3rem;border:1px solid var(--border);font-size:.95rem;text-align:center;font-weight:600;border-radius:4px;background:#fff;flex-shrink:0}
    .inv-stock-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 2px rgba(154,139,122,.2)}
    .inv-stock-unit{font-size:.78rem;color:var(--text-muted);min-width:20px;flex-shrink:0}
    .inv-progress{display:flex;align-items:center;gap:.5rem;padding:.75rem 1rem;background:var(--bg-card);border:1px solid var(--border);margin-bottom:1rem;border-radius:6px;font-size:.85rem}
    .inv-progress-bar{flex:1;height:6px;background:var(--border);border-radius:3px;overflow:hidden}
    .inv-progress-fill{height:100%;background:var(--green);transition:width .3s}
    .inv-submit-bar{position:sticky;bottom:env(safe-area-inset-bottom,0);padding:1rem;background:var(--bg);border-top:1px solid var(--border);margin:0 -1rem}
    .inv-submit-btn{width:100%;padding:.9rem;font-size:1rem;font-weight:600;border:none;cursor:pointer;letter-spacing:1px;border-radius:6px}
    .inv-submit-btn.ready{background:var(--primary);color:#fff}
    .inv-submit-btn.disabled{background:var(--border);color:var(--text-muted);pointer-events:none}
    /* íƒœë¸”ë¦¿/ì•„ì´íŒ¨ë“œ ë°˜ì‘í˜• */
    @media(min-width:768px){
        .inv-item-row{padding:.8rem 1rem}
        .inv-item-name{font-size:1rem}
        .inv-item-meta{font-size:.8rem;gap:1rem;flex-wrap:nowrap}
        .inv-stock-input{width:80px;font-size:1rem;padding:.45rem}
        .inv-cat-btn{padding:.8rem 1.2rem;font-size:.95rem}
        .inv-cat-btn .cat-icon{font-size:1.4rem}
        .inv-cat-filters{gap:.5rem}
        .card{padding:1.2rem}
        .bottom-nav{padding:.5rem 1rem;gap:.5rem}
        .nav-item{font-size:.75rem;padding:.5rem .5rem}
        .inv-loc-input-row{padding:.4rem .6rem}
        .inv-loc-label{font-size:.82rem}
        .inv-stock-input{width:82px}
    }
    /* ì•„ì´íŒ¨ë“œ ê°€ë¡œëª¨ë“œ ìµœì í™” */
    @media(min-width:1024px){
        .inv-cat-btn{padding:1rem 1.5rem;font-size:1.05rem;min-width:120px}
        .inv-cat-btn .cat-icon{font-size:1.6rem}
        .inv-item-row{padding:1rem 1.5rem}
        .inv-item-name{font-size:1.1rem}
        .inv-item-meta{font-size:.85rem;gap:1.2rem}
        .inv-stock-input{width:90px;font-size:1.05rem;padding:.5rem}
    }
</style>
```

</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-logo">THE CLINIC</div>
        <div class="login-title">LUMI</div>
        <form class="login-form" onsubmit="attemptLogin(); return false;">
            <input type="text" class="login-input" id="empIdInput" placeholder="ì´ë¦„" autocomplete="username">
            <div class="pw-wrap">
                <input type="password" class="login-input" id="empPwInput" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password">
                <button type="button" class="pw-toggle" onclick="togglePw('empPwInput',this)">ğŸ‘</button>
            </div>
            <div class="login-error" id="loginError"></div>
            <button type="submit" class="login-btn">ë¡œê·¸ì¸</button>
            <button type="button" class="login-btn" id="biometricBtn" style="display:none;margin-top:.5rem;background:var(--primary)" onclick="biometricLogin()">ğŸ” ìƒì²´ì¸ì‹ ë¡œê·¸ì¸</button>
        </form>
    </div>

```
<div class="pw-setup" id="pwSetup">
    <div class="pw-setup-title">ë¹„ë°€ë²ˆí˜¸ ì„¤ì •</div>
    <div class="pw-setup-desc">ìµœì´ˆ ë¡œê·¸ì¸ì…ë‹ˆë‹¤.<br>ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.</div>
    <form class="login-form" onsubmit="setupPassword(); return false;">
        <div class="pw-wrap">
            <input type="password" class="login-input" id="newPw1" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ (4ì ì´ìƒ)">
            <button type="button" class="pw-toggle" onclick="togglePw('newPw1',this)">ğŸ‘</button>
        </div>
        <div class="pw-wrap">
            <input type="password" class="login-input" id="newPw2" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸">
            <button type="button" class="pw-toggle" onclick="togglePw('newPw2',this)">ğŸ‘</button>
        </div>
        <div class="login-error" id="pwError"></div>
        <button type="submit" class="login-btn">ì„¤ì • ì™„ë£Œ</button>
    </form>
</div>

<div class="app-container" id="appContainer">
    <header class="header">
        <div class="header-content">
            <div class="header-logo">
                <div class="header-logo-sub">THE CLINIC</div>
                <div class="header-logo-text">LUMI</div>
            </div>
            <div class="header-user">
                <span class="user-name" id="userName">-</span>
                <button class="logout-btn" onclick="logout()">LOGOUT</button>
            </div>
        </div>
    </header>
    
    <div class="content">
        <!-- ì¶œí‡´ê·¼ íƒ­ v2.1 -->
        <div class="tab-content active" id="tab-attendance">
            <div class="gps-status loading" id="gpsStatus">ğŸ“ ìœ„ì¹˜ í™•ì¸ ì¤‘...</div>
            
            <!-- ì–´ì œ í‡´ê·¼ ëˆ„ë½ ì•Œë¦¼ -->
            <div id="missedClockOutAlert" style="display:none;background:#FFF3CD;border:1px solid #FFEEBA;padding:1rem;margin-bottom:1rem;border-radius:4px">
                <div style="font-weight:600;color:#856404;margin-bottom:.5rem">âš ï¸ ì–´ì œ í‡´ê·¼ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>
                <div style="font-size:.85rem;color:#856404;margin-bottom:.75rem">
                    ë‹¨ì²´ LINEë°©ì— ë‚¨ê¸´ ì‹œê°„ê³¼ ë™ì¼í•˜ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.
                </div>
                <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem">
                    <span style="font-size:.85rem;color:#856404" id="missedDateLabel">-</span>
                    <input type="time" id="missedClockOutTime" style="padding:.4rem;border:1px solid #FFEEBA;border-radius:4px;font-size:.95rem">
                </div>
                <div style="display:flex;gap:.5rem">
                    <button onclick="submitMissedClockOut()" style="flex:1;padding:.6rem;background:#856404;color:#fff;border:none;font-size:.85rem;font-weight:500;cursor:pointer;border-radius:4px">í‡´ê·¼ ì‹œê°„ ì…ë ¥</button>
                    <button onclick="dismissMissedAlert()" style="padding:.6rem .8rem;background:transparent;border:1px solid #FFEEBA;color:#856404;font-size:.85rem;cursor:pointer;border-radius:4px">ë‹«ê¸°</button>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="attWorkDays">0</div><div class="stat-label">ì¶œê·¼ì¼</div></div>
                <div class="stat-card orange"><div class="stat-value" id="attLate">0</div><div class="stat-label">ì§€ê°</div></div>
                <div class="stat-card green"><div class="stat-value" id="attEarly">0</div><div class="stat-label">ì¡°í‡´</div></div>
            </div>
            <div class="card">
                <div class="card-title">ì˜¤ëŠ˜ ê·¼ë¬´</div>
                <div class="info-row"><span class="info-label">ì¶œê·¼</span><span class="info-value" id="todayCheckIn">-</span></div>
                <div class="info-row"><span class="info-label">í‡´ê·¼</span><span class="info-value" id="todayCheckOut">-</span></div>
                <div class="info-row"><span class="info-label">ìƒíƒœ</span><span class="info-value" id="todayStatus">-</span></div>
            </div>
            <!-- v2.1: ì¢Œìš° í° ë²„íŠ¼ í•­ìƒ í‘œì‹œ -->
            <div style="display:flex;gap:.75rem;margin-bottom:.5rem">
                <button class="att-v2-btn" id="checkInBtn" onclick="checkIn()">
                    <span class="att-v2-icon">ğŸŸ¢</span>
                    <span class="att-v2-label">ì¶œê·¼</span>
                </button>
                <button class="att-v2-btn" id="checkOutBtn" onclick="checkOut()">
                    <span class="att-v2-icon">ğŸ”´</span>
                    <span class="att-v2-label">í‡´ê·¼</span>
                </button>
            </div>
            <div id="attBtnHint" style="text-align:center;font-size:.8rem;color:var(--text-muted);margin-bottom:.75rem"></div>
        </div>
        
        <!-- OT íƒ­ -->
        <div class="tab-content" id="tab-ot">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="otTotal">0H</div><div class="stat-label">ì´ë²ˆë‹¬ OT</div></div>
                <div class="stat-card purple"><div class="stat-value" id="otLunch">0H</div><div class="stat-label">ì ì‹¬ OT</div></div>
                <div class="stat-card orange"><div class="stat-value" id="otAfter">0H</div><div class="stat-label">í‡´ê·¼í›„ OT</div></div>
            </div>
            <div class="card">
                <div class="card-title">ì˜ˆìƒ OTìˆ˜ë‹¹ (ì„¸ì „)</div>
                <div class="info-row"><span class="info-label">ì‹œê¸‰ Ã— 1.5</span><span class="info-value" id="otHourlyRate">-</span></div>
                <div class="info-row"><span class="info-label">ì˜ˆìƒ ê¸ˆì•¡</span><span class="info-value" id="otExpected" style="color:var(--primary);font-weight:700">â‚©0</span></div>
            </div>
            <button class="btn btn-primary" onclick="openLunchOTModal()">ì ì‹¬ OT ì…ë ¥</button>
            <div class="card">
                <div class="card-title">ì´ë²ˆ ë‹¬ OT ë‚´ì—­</div>
                <div id="otList"><div style="text-align:center;color:var(--text-muted);padding:1rem">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div></div>
            </div>
        </div>
        
        <!-- ì‹ì‚¬ íƒ­ -->
        <div class="tab-content" id="tab-meal">
            <div class="card">
                <div class="card-title">ì´ë²ˆ ë‹¬ ì‹ëŒ€ í˜„í™©</div>
                <div class="info-row"><span class="info-label">ì›” í•œë„</span><span class="info-value">â‚©300,000</span></div>
                <div class="info-row"><span class="info-label">ì‚¬ìš© ê¸ˆì•¡</span><span class="info-value" id="mealUsed">â‚©0</span></div>
                <div class="info-row"><span class="info-label">ë‚¨ì€ ê¸ˆì•¡</span><span class="info-value" id="mealRemain" style="color:var(--green);font-weight:700">â‚©300,000</span></div>
                <div class="progress-bar"><div class="progress-fill" id="mealProgress" style="width:0%"></div></div>
            </div>
            <button class="btn btn-primary" onclick="openPersonalMealModal()">ğŸ½ ê°œì¸ ì‹ì‚¬ ì…ë ¥</button>
            <div class="card">
                <div class="card-title">ì´ë²ˆ ë‹¬ ì‹ì‚¬ ë‚´ì—­</div>
                <div id="mealList"><div style="text-align:center;color:var(--text-muted);padding:1rem">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div></div>
            </div>
        </div>
        
        <!-- ì—°ì°¨ íƒ­ -->
        <div class="tab-content" id="tab-leave">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="leaveTotal">15</div><div class="stat-label">ì´ ì—°ì°¨</div></div>
                <div class="stat-card orange"><div class="stat-value" id="leaveUsed">0</div><div class="stat-label">ì‚¬ìš©</div></div>
                <div class="stat-card green"><div class="stat-value" id="leaveRemain">15</div><div class="stat-label">ì”ì—¬</div></div>
            </div>
            
            <!-- í™©ê¸ˆì—°íœ´ ìŠ¬ë¼ì´ë” -->
            <div class="card" style="margin-bottom:1rem;padding:.75rem">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
                    <span style="font-size:.8rem;font-weight:600;color:var(--gold)">ğŸ“… 2026 í™©ê¸ˆì—°íœ´</span>
                    <span style="font-size:.7rem;color:var(--text-muted)">â† ìŠ¤ì™€ì´í”„ â†’</span>
                </div>
                <div class="golden-slider" id="goldenSlider"></div>
            </div>
            
            <button class="btn btn-primary" onclick="openLeaveModal()">ì—°ì°¨ ì‹ ì²­</button>
            <div class="card">
                <div class="card-title">ì‹ ì²­ ë‚´ì—­</div>
                <div id="leaveHistory"><div style="text-align:center;color:var(--text-muted);padding:1rem">ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div></div>
            </div>
        </div>
        
        <!-- ì¸ì„¼í‹°ë¸Œ íƒ­ -->
        <div class="tab-content" id="tab-incentive">
            <div class="stats-grid" style="grid-template-columns:repeat(2,1fr)">
                <div class="stat-card"><div class="stat-value" id="incTotalCount">0</div><div class="stat-label">ì´ë²ˆë‹¬ ì‹¤ì </div></div>
                <div class="stat-card green"><div class="stat-value" id="incTotalAmount">â‚©0</div><div class="stat-label">ì˜ˆìƒ ì¸ì„¼í‹°ë¸Œ</div></div>
            </div>
            <div class="card" id="salesIncentiveCard" style="display:none">
                <div class="card-title">ë§¤ì¶œ ê¸°ë°˜ ì¸ì„¼í‹°ë¸Œ</div>
                <div id="salesIncentiveDetail"></div>
            </div>
            <div class="card">
                <div class="card-title">ë‚˜ì˜ ì¸ì„¼í‹°ë¸Œ í•­ëª©</div>
                <div id="myIncentiveItems"><div style="text-align:center;color:var(--text-muted);padding:1rem">ë“±ë¡ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div></div>
            </div>
            <button class="btn btn-primary" onclick="openIncentiveModal()">ì¸ì„¼í‹°ë¸Œ ì‹¤ì  ì…ë ¥</button>
            <div class="card">
                <div class="card-title">ì´ë²ˆ ë‹¬ ì‹¤ì  ë‚´ì—­</div>
                <div id="incentiveRecords"><div style="text-align:center;color:var(--text-muted);padding:1rem">ì…ë ¥ëœ ì‹¤ì ì´ ì—†ìŠµë‹ˆë‹¤</div></div>
            </div>
        </div>
        
        <!-- ë‚´ì •ë³´ íƒ­ -->
        <div class="tab-content" id="tab-info">
            <div class="card">
                <div class="card-title">ë‚´ ì •ë³´</div>
                <div class="info-row"><span class="info-label">ì´ë¦„</span><span class="info-value" id="infoName">-</span></div>
                <div class="info-row"><span class="info-label">ì§ê¸‰</span><span class="info-value" id="infoRole">-</span></div>
                <div class="info-row"><span class="info-label">ì…ì‚¬ì¼</span><span class="info-value" id="infoJoinDate">-</span></div>
                <div class="info-row"><span class="info-label">ê·¼ì†ê¸°ê°„</span><span class="info-value" id="infoTenure">-</span></div>
            </div>
            <div class="card">
                <div class="card-title">
                    <span id="salaryTitle">ê¸‰ì—¬ ì •ë³´</span>
                    <div class="month-select">
                        <select id="salaryMonth" onchange="renderSalary()"></select>
                    </div>
                </div>
                <div class="info-row"><span class="info-label">ì‹¤ìˆ˜ë ¹ì•¡</span><span class="info-value" id="infoNetPay">-</span></div>
                <div class="info-row"><span class="info-label">OTìˆ˜ë‹¹</span><span class="info-value" id="infoOT">-</span></div>
                <div class="info-row"><span class="info-label">ì¸ì„¼í‹°ë¸Œ</span><span class="info-value" id="infoIncentive">-</span></div>
            </div>
            <div class="card">
                <div class="card-title">ğŸ” ìƒì²´ì¸ì‹ ë¡œê·¸ì¸</div>
                <p style="font-size:.85rem;color:var(--text-secondary);margin-bottom:1rem">Face ID ë˜ëŠ” ì§€ë¬¸ìœ¼ë¡œ ë¹ ë¥´ê²Œ ë¡œê·¸ì¸í•˜ì„¸ìš”.</p>
                <button class="btn btn-gold" onclick="registerBiometric()" id="biometricRegisterBtn">ìƒì²´ì¸ì‹ ë“±ë¡</button>
                <div id="biometricStatus" style="font-size:.85rem;color:var(--text-muted);margin-top:.5rem;text-align:center"></div>
            </div>
        </div>

        <!-- ì¬ê³  ì‹¤ì‚¬ íƒ­ -->
        <div class="tab-content" id="tab-inventory">
            <div class="card" style="margin-bottom:0;padding-bottom:.5rem">
                <div class="card-title" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:.5rem">
                    <span>ğŸ“¦ ì¬ê³  ì‹¤ì‚¬</span>
                    <div style="display:flex;gap:.5rem">
                        <button class="btn btn-primary" style="font-size:.8rem;padding:.4rem .8rem" onclick="openNewItemModal()">+ ì‹ ê·œ í’ˆëª©</button>
                        <button class="btn btn-secondary" style="font-size:.8rem;padding:.4rem .8rem" onclick="openWishlistModal()">ğŸ›ï¸ ë¹„í’ˆ ìš”ì²­</button>
                    </div>
                </div>
                
                <!-- ê²€ìƒ‰ ê¸°ëŠ¥ -->
                <div style="margin-bottom:.75rem;margin-top:.75rem">
                    <input type="text" id="invSearchInput" placeholder="ğŸ” í’ˆëª©ëª… ê²€ìƒ‰..." 
                        oninput="filterInventoryItems()"
                        style="width:100%;padding:.6rem;border:1px solid var(--border);border-radius:6px;font-size:.9rem">
                </div>
                
                <!-- ì¥ì†Œ ì„ íƒ í•„í„° -->
                <div style="margin-bottom:.75rem">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.3rem">
                        <label style="font-size:.85rem;font-weight:600;color:var(--text)">
                            ğŸ“ ì‹¤ì‚¬ ì¥ì†Œ ì„ íƒ
                        </label>
                        <button class="btn btn-secondary" style="font-size:.7rem;padding:.3rem .6rem" onclick="openLocationManageModal()">ì¥ì†Œ ê´€ë¦¬</button>
                    </div>
                    <select id="invAuditLocationFilter" class="form-select" onchange="filterInventoryItems()" style="width:100%;padding:.6rem;border:1px solid var(--border);border-radius:6px;font-size:.9rem">
                        <option value="">ì „ì²´ ì¥ì†Œ (ëª¨ë“  í’ˆëª©)</option>
                    </select>
                    <div style="font-size:.75rem;color:var(--text-secondary);margin-top:.3rem">
                        ì¥ì†Œë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ ì¥ì†Œì— ìˆëŠ” í’ˆëª©ë§Œ í‘œì‹œë©ë‹ˆë‹¤
                    </div>
                </div>
                
                <!-- ì •ë ¬ ì˜µì…˜ -->
                <div style="margin-bottom:.75rem">
                    <label style="font-size:.85rem;font-weight:600;color:var(--text);margin-bottom:.3rem;display:block">
                        ğŸ“Š ì •ë ¬
                    </label>
                    <div style="display:flex;gap:.5rem">
                        <select id="invSortBy" class="form-select" onchange="filterInventoryItems()" style="flex:1;padding:.5rem;border:1px solid var(--border);border-radius:6px;font-size:.85rem">
                            <option value="name">ì´ë¦„ìˆœ (ê°€ë‚˜ë‹¤)</option>
                            <option value="location">ì¥ì†Œìˆœ</option>
                            <option value="stock-low">ì¬ê³  ì ì€ìˆœ</option>
                            <option value="stock-high">ì¬ê³  ë§ì€ìˆœ</option>
                        </select>
                    </div>
                </div>
                
                <div id="invLowStockAlert" style="display:none;background:rgba(168,90,90,.08);border:1px solid rgba(168,90,90,.2);padding:.6rem .8rem;border-radius:6px;margin-bottom:.5rem;font-size:.85rem;color:var(--red)"></div>
                <div class="inv-cat-filters" id="invCatButtons"></div>
                <div class="inv-progress" id="invProgress">
                    <span>ì§„í–‰ë¥ </span>
                    <div class="inv-progress-bar"><div class="inv-progress-fill" id="invProgressFill" style="width:0%"></div></div>
                    <span id="invProgressText">0/0</span>
                </div>
            </div>
            <div id="invAuditList" style="padding:.5rem 0"></div>
            <div class="inv-submit-bar">
                <button class="inv-submit-btn disabled" id="invSubmitBtn" onclick="submitInventoryAudit()">ì‹¤ì‚¬ ê²°ê³¼ ì œì¶œ</button>
            </div>
        </div>

        <!-- ì…ê³  íƒ­ -->
        <div class="tab-content" id="tab-receiving">
            <div class="card" style="margin-bottom:.5rem">
                <div class="card-title">ğŸ“¥ ë¬¼í’ˆ ì…ê³ </div>
                <div style="font-size:.85rem;color:var(--text-muted);margin-bottom:1rem">
                    ìƒˆë¡œ ë„ì°©í•œ ë¬¼í’ˆì„ ë“±ë¡í•˜ì„¸ìš”. í’ˆëª©ì„ ê²€ìƒ‰í•˜ì—¬ ì…ê³  ìˆ˜ëŸ‰, ìœ í†µê¸°í•œ, ë³´ê´€ ì¥ì†Œë¥¼ ì…ë ¥í•˜ë©´ ë°°ì¹˜(Batch)ê°€ ìë™ ìƒì„±ë©ë‹ˆë‹¤.
                </div>
                
                <!-- í’ˆëª© ê²€ìƒ‰ -->
                <div style="margin-bottom:1rem">
                    <label style="font-weight:600;font-size:.9rem;margin-bottom:.5rem;display:block">í’ˆëª© ê²€ìƒ‰</label>
                    <input type="text" id="receivingSearch" placeholder="í’ˆëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”..." 
                        style="width:100%;padding:.75rem;border:1px solid var(--border);border-radius:6px;font-size:.9rem"
                        oninput="searchItemsForReceiving(this.value)">
                    <div id="receivingSearchResults" style="margin-top:.5rem;max-height:200px;overflow-y:auto"></div>
                </div>
                
                <!-- ì…ê³  í¼ (í’ˆëª© ì„ íƒ í›„ í‘œì‹œ) -->
                <div id="receivingForm" style="display:none;border-top:1px solid var(--border);padding-top:1rem;margin-top:1rem">
                    <input type="hidden" id="receivingItemId">
                    <div style="background:var(--bg);padding:.75rem;border-radius:6px;margin-bottom:1rem">
                        <div style="font-weight:600;font-size:1rem" id="receivingItemName"></div>
                        <div style="font-size:.8rem;color:var(--text-muted);margin-top:.25rem">
                            í˜„ì¬ê³ : <span id="receivingCurrentStock">-</span> | 
                            ë‹¨ìœ„: <span id="receivingItemUnit">ê°œ</span>
                        </div>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem">
                        <div>
                            <label style="font-weight:600;font-size:.85rem;margin-bottom:.5rem;display:block">ì…ê³  ìˆ˜ëŸ‰ *</label>
                            <input type="number" id="receivingQty" placeholder="0" step="0.01" min="0.01" 
                                style="width:100%;padding:.6rem;border:1px solid var(--border);border-radius:6px">
                        </div>
                        <div>
                            <label style="font-weight:600;font-size:.85rem;margin-bottom:.5rem;display:block">ìœ í†µê¸°í•œ *</label>
                            <input type="date" id="receivingExpiry" 
                                style="width:100%;padding:.6rem;border:1px solid var(--border);border-radius:6px">
                        </div>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-top:.75rem">
                        <div>
                            <label style="font-weight:600;font-size:.85rem;margin-bottom:.5rem;display:block">êµ¬ë§¤ë‹¨ê°€ (ì›)</label>
                            <input type="number" id="receivingPrice" placeholder="0" min="0" 
                                style="width:100%;padding:.6rem;border:1px solid var(--border);border-radius:6px">
                        </div>
                        <div>
                            <label style="font-weight:600;font-size:.85rem;margin-bottom:.5rem;display:block">ë³´ê´€ ì¥ì†Œ *</label>
                            <select id="receivingLocation" 
                                style="width:100%;padding:.6rem;border:1px solid var(--border);border-radius:6px">
                                <option value="">ì¥ì†Œ ì„ íƒ</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-top:1rem">
                        <label style="font-weight:600;font-size:.85rem;margin-bottom:.5rem;display:block">ë©”ëª¨</label>
                        <textarea id="receivingMemo" rows="2" placeholder="ì…ê³  ê´€ë ¨ ë©”ëª¨ (ì„ íƒ)" 
                            style="width:100%;padding:.6rem;border:1px solid var(--border);border-radius:6px;font-size:.85rem"></textarea>
                    </div>
                    
                    <div style="display:flex;gap:.5rem;margin-top:1.5rem">
                        <button onclick="cancelReceiving()" style="flex:1;padding:.75rem;background:#eee;border:none;border-radius:6px;cursor:pointer;font-weight:600">ì·¨ì†Œ</button>
                        <button onclick="submitReceiving()" style="flex:2;padding:.75rem;background:var(--primary);color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600">ì…ê³  ì™„ë£Œ</button>
                    </div>
                </div>
            </div>
            
            <!-- ìµœê·¼ ì…ê³  ë‚´ì—­ -->
            <div class="card">
                <div class="card-title">ğŸ“‹ ìµœê·¼ ì…ê³  ë‚´ì—­</div>
                <div id="recentReceivingList" style="font-size:.85rem;color:var(--text-muted);text-align:center;padding:1rem">
                    ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </div>
            </div>
        </div>

        <!-- ë¹„í’ˆ ìš”ì²­ íƒ­ -->
        <div class="tab-content" id="tab-wishlist">
            <div class="card" style="margin-bottom:.5rem">
                <div class="card-title" style="display:flex;justify-content:space-between;align-items:center">
                    ğŸ›ï¸ ë¹„í’ˆ êµ¬ë§¤ ìš”ì²­
                    <button class="btn btn-primary" style="font-size:.8rem;padding:.4rem .8rem" onclick="openWishlistModal()">+ ìƒˆ ìš”ì²­</button>
                </div>
                <div style="font-size:.8rem;color:var(--text-muted);margin-bottom:.75rem">1íšŒì„± ë¹„í’ˆ(ì˜ì, ì˜¨í’ê¸° ë“±)ì„ ìš”ì²­í•˜ì„¸ìš”. ê´€ë¦¬ì ìŠ¹ì¸ í›„ êµ¬ë§¤ê°€ ì§„í–‰ë©ë‹ˆë‹¤.</div>
                <div id="staffWishlistHistory" style="font-size:.85rem;color:var(--text-muted);text-align:center;padding:1rem">ìš”ì²­ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>
    <nav class="bottom-nav">
        <div class="nav-item active" data-tab="attendance"><div class="nav-icon">ğŸ“…</div>ì¶œí‡´ê·¼</div>
        <div class="nav-item" data-tab="meal"><div class="nav-icon">ğŸ½</div>ì‹ì‚¬</div>
        <div class="nav-item" data-tab="ot"><div class="nav-icon">â°</div>OT</div>
        <div class="nav-item" data-tab="leave"><div class="nav-icon">ğŸ–</div>ì—°ì°¨</div>
        <div class="nav-item" data-tab="incentive"><div class="nav-icon">ğŸ’</div>ì¸ì„¼í‹°ë¸Œ</div>
        <div class="nav-item" data-tab="inventory"><div class="nav-icon">ğŸ“¦</div>ì¬ê³ </div>
        <div class="nav-item" data-tab="receiving"><div class="nav-icon">ğŸ“¥</div>ì…ê³ </div>
        <div class="nav-item" data-tab="wishlist"><div class="nav-icon">ğŸ›ï¸</div>ë¹„í’ˆìš”ì²­</div>
        <div class="nav-item" data-tab="info"><div class="nav-icon">ğŸ‘¤</div>ë‚´ì •ë³´</div>
    </nav>
</div>

<!-- ì ì‹¬ OT ëª¨ë‹¬ v2.0 -->
<div class="modal" id="lunchOTModal">
    <div class="modal-content" style="max-width:380px">
        <div class="modal-header">
            <div class="modal-title">ğŸ½ï¸ ì ì‹¬ì‹œê°„ OT ì…ë ¥</div>
            <button class="modal-close" onclick="closeModal('lunchOTModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div id="lunchOTDayHint" style="font-size:.8rem;padding:.4rem .7rem;background:var(--bg);border-radius:6px;color:var(--text-muted);margin-bottom:.9rem"></div>
            <div class="form-group">
                <label class="form-label">ë‚ ì§œ</label>
                <input type="date" class="form-input" id="lunchOTDate" onchange="updateLunchOTHint()">
            </div>
            <div class="form-group">
                <label class="form-label">ì ì‹¬ì‹œê°„ ì‚¬ìš© (ë¶„) <span style="font-size:.75rem;font-weight:400;color:var(--text-muted)">â€” ê¸°ì¤€ì‹œê°„ ì´ˆê³¼ë¶„ë§Œ OT</span></label>
                <div style="display:flex;gap:.5rem;align-items:center">
                    <input type="number" class="form-input" id="lunchOTMinutes" value="30" min="1" max="120" inputmode="numeric" style="flex:1;font-size:1.05rem;text-align:center;font-weight:700">
                    <span style="color:var(--text-muted)">ë¶„</span>
                </div>
                <div style="display:flex;gap:.4rem;margin-top:.5rem">
                    <button type="button" onclick="document.getElementById('lunchOTMinutes').value=10" style="flex:1;padding:.35rem;border:1px solid var(--border);border-radius:5px;background:#fff;cursor:pointer;font-size:.8rem">10</button>
                    <button type="button" onclick="document.getElementById('lunchOTMinutes').value=20" style="flex:1;padding:.35rem;border:1px solid var(--border);border-radius:5px;background:#fff;cursor:pointer;font-size:.8rem">20</button>
                    <button type="button" onclick="document.getElementById('lunchOTMinutes').value=30" style="flex:1;padding:.35rem;border:1px solid var(--border);border-radius:5px;background:#fff;cursor:pointer;font-size:.8rem">30</button>
                    <button type="button" onclick="document.getElementById('lunchOTMinutes').value=60" style="flex:1;padding:.35rem;border:1px solid var(--border);border-radius:5px;background:#fff;cursor:pointer;font-size:.8rem">60</button>
                </div>
            </div>
            <div class="form-group" style="margin-bottom:0">
                <label class="form-label">ì‚¬ìœ  (ì„ íƒ)</label>
                <input type="text" class="form-input" id="lunchOTReason" placeholder="ì˜ˆ: ì ì‹¬ì‹œê°„ ì—…ë¬´ ì²˜ë¦¬">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('lunchOTModal')" style="flex:1">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveLunchOT()" style="flex:2">ì €ì¥</button>
        </div>
    </div>
</div>

<!-- ì‹ì‚¬ ì…ë ¥ ëª¨ë‹¬ -->
<div class="modal" id="mealModal">
    <div class="modal-content" style="max-width:460px">
        <div class="modal-header">
            <div class="modal-title">ğŸ½ ì‹ì‚¬ ì •ì‚°</div>
            <button class="modal-close" onclick="closeModal('mealModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">ë‚ ì§œ</label>
                <input type="date" class="form-input" id="mealDate">
            </div>
            <div class="form-group">
                <label class="form-label">ì´ ê²°ì œ ê¸ˆì•¡ (ì›)</label>
                <input type="number" class="form-input" id="mealTotalAmount" placeholder="ì˜ˆ: 50000" oninput="onMealTotalChange()">
            </div>
            <div class="form-group">
                <label class="form-label">ë©”ëª¨</label>
                <input type="text" class="form-input" id="mealMemo" placeholder="ì˜ˆ: ì ì‹¬ ê¹€ì¹˜ì°Œê°œ">
            </div>
            <div style="border-top:1px solid var(--border);padding-top:.75rem;margin-top:.5rem">
                <label class="form-label" style="font-weight:700">ì°¸ì—¬ ì¸ì› ì„ íƒ</label>
                <div id="mealStaffList" style="display:flex;flex-wrap:wrap;gap:.4rem;margin-bottom:.75rem"></div>
            </div>
            <div style="display:flex;gap:.5rem;margin-bottom:.75rem">
                <button class="btn btn-outline" id="mealModeEven" style="flex:1;font-size:.85rem" onclick="setMealMode('even')">1/N ê· ë“±</button>
                <button class="btn btn-outline" id="mealModeManual" style="flex:1;font-size:.85rem" onclick="setMealMode('manual')">ê°œë³„ ì…ë ¥</button>
            </div>
            <div id="mealSplitDetail"></div>
            <div id="mealValidation" style="font-size:.8rem;margin-top:.5rem;min-height:1.2rem"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('mealModal')" style="flex:1">ì·¨ì†Œ</button>
            <button class="btn btn-primary" id="mealSaveBtn" onclick="saveMealGroup()" style="flex:2">ì •ì‚° ì €ì¥</button>
        </div>
    </div>
</div>

<!-- ê°œì¸ ì‹ì‚¬ ì…ë ¥ ëª¨ë‹¬ -->
<div class="modal" id="personalMealModal">
    <div class="modal-content" style="max-width:400px">
        <div class="modal-header">
            <div class="modal-title">ğŸ½ ê°œì¸ ì‹ì‚¬ ì…ë ¥</div>
            <button class="modal-close" onclick="closeModal('personalMealModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">ë‚ ì§œ *</label>
                <input type="date" class="form-input" id="personalMealDate">
            </div>
            <div class="form-group">
                <label class="form-label">ê¸ˆì•¡ (ì›) *</label>
                <input type="number" class="form-input" id="personalMealAmount" min="0" placeholder="ì˜ˆ: 12000">
            </div>
            <div class="form-group">
                <label class="form-label">ë©”ëª¨</label>
                <input type="text" class="form-input" id="personalMealMemo" placeholder="ì˜ˆ: ì ì‹¬ - ê¹€ì¹˜ì°Œê°œ">
            </div>
            <div style="background:var(--bg);padding:.75rem;border-radius:6px;margin-top:.5rem">
                <div style="font-size:.75rem;color:var(--text-muted);line-height:1.5">
                    ğŸ’¡ ê°œì¸ ì‹ì‚¬ ì…ë ¥ì€ ë³¸ì¸ ê³„ì •ì—ì„œë§Œ ê°€ëŠ¥í•˜ë©°,<br>
                    30ë§Œì› í•œë„ì—ì„œ ìë™ìœ¼ë¡œ ì°¨ê°ë©ë‹ˆë‹¤.
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('personalMealModal')" style="flex:1">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="savePersonalMeal()" style="flex:2">ì…ë ¥</button>
        </div>
    </div>
</div>

<!-- ì—°ì°¨ ì‹ ì²­ ëª¨ë‹¬ -->
<div class="modal" id="leaveModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">ì—°ì°¨ ì‹ ì²­</div>
            <button class="modal-close" onclick="closeModal('leaveModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">ìœ í˜•</label>
                <select class="form-select" id="leaveType">
                    <option value="ì—°ì°¨">ì—°ì°¨</option>
                    <option value="ë°˜ì°¨(ì˜¤ì „)">ë°˜ì°¨ (ì˜¤ì „)</option>
                    <option value="ë°˜ì°¨(ì˜¤í›„)">ë°˜ì°¨ (ì˜¤í›„)</option>
                    <option value="ì˜¤í”„">ì˜¤í”„</option>
                    <option value="ë³‘ê°€">ë³‘ê°€</option>
                    <option value="ê²½ì¡°ì‚¬">ê²½ì¡°ì‚¬</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">ë‚ ì§œ ì¶”ê°€</label>
                <div style="display:flex;gap:.5rem;margin-bottom:.5rem">
                    <input type="date" class="form-input" id="leaveDateInput" style="flex:1">
                    <button class="btn btn-secondary" onclick="addLeaveDate()" style="width:auto;padding:.75rem 1rem;margin:0">ì¶”ê°€</button>
                </div>
                <div class="date-tags" id="leaveDateTags"><span style="color:var(--text-muted);font-size:.85rem">ë‚ ì§œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”</span></div>
            </div>
            <div class="form-group">
                <label class="form-label">ì‚¬ìœ </label>
                <input type="text" class="form-input" id="leaveReason" placeholder="ì‚¬ìœ  ì…ë ¥ (ì„ íƒ)">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('leaveModal')">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="submitLeave()">ì‹ ì²­í•˜ê¸°</button>
        </div>
    </div>
</div>

<!-- ì¸ì„¼í‹°ë¸Œ ì…ë ¥ ëª¨ë‹¬ -->
<div class="modal" id="incentiveModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">ì¸ì„¼í‹°ë¸Œ ì‹¤ì  ì…ë ¥</div>
            <button class="modal-close" onclick="closeModal('incentiveModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">í•­ëª© ì„ íƒ</label>
                <select class="form-select" id="incItemSelect">
                    <option value="">í•­ëª© ì„ íƒ</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">ê³ ê°ëª…</label>
                <input type="text" class="form-input" id="incCustomerName" placeholder="ê³ ê° ì´ë¦„">
            </div>
            <div class="form-group">
                <label class="form-label">ì°¨íŠ¸ë²ˆí˜¸</label>
                <input type="text" class="form-input" id="incChartNo" placeholder="ì°¨íŠ¸ë²ˆí˜¸">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('incentiveModal')">ë‹«ê¸°</button>
            <button class="btn btn-primary" onclick="addIncentiveRecord()">+ 1ê±´ ì¶”ê°€</button>
        </div>
    </div>
</div>

<!-- ì‹ ê·œ í’ˆëª© ë“±ë¡ ëª¨ë‹¬ -->
<div class="modal" id="newItemModal">
    <div class="modal-content" style="max-width:440px">
        <div class="modal-header">
            <div class="modal-title">ğŸ“¦ ì‹ ê·œ í’ˆëª© ë“±ë¡</div>
            <button class="modal-close" onclick="closeModal('newItemModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">í’ˆëª©ëª… *</label>
                <input type="text" class="form-input" id="newItemName" placeholder="ì˜ˆ: ë©¸ê· ì¥ê°‘(M)">
            </div>
            <div style="display:flex;gap:.5rem">
                <div class="form-group" style="flex:1">
                    <label class="form-label">íƒ€ì…</label>
                    <select class="form-select" id="newItemType">
                        <option value="disposable">1íšŒìš©</option>
                        <option value="portioned">ì†Œë¶„ìš©</option>
                        <option value="hygiene">ìœ„ìƒìš©í’ˆ</option>
                    </select>
                </div>
                <div class="form-group" style="flex:1">
                    <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
                    <select class="form-select" id="newItemCategory">
                        <option value="nursing">ê°„í˜¸</option>
                        <option value="skin">í”¼ë¶€</option>
                        <option value="desk">ë°ìŠ¤í¬</option>
                        <option value="common">ê³µí†µ</option>
                    </select>
                </div>
            </div>
            
            <!-- ì¥ì†Œë³„ ì´ˆê¸° ì¬ê³  ì…ë ¥ -->
            <div style="background:var(--bg);border:1px solid var(--border);padding:.75rem;border-radius:6px;margin-bottom:.5rem">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
                    <label class="form-label" style="margin:0;font-weight:600">ğŸ“ ë³´ê´€ ì¥ì†Œë³„ ì´ˆê¸° ì¬ê³ </label>
                    <button type="button" class="btn btn-secondary" onclick="addNewLocationRow()" style="font-size:.75rem;padding:.3rem .6rem">+ ì¥ì†Œ ì¶”ê°€</button>
                </div>
                <div id="newLocationsList"></div>
                <div style="margin-top:.5rem;padding:.5rem;background:var(--bg-card);border-radius:4px;text-align:center">
                    ì´ ì¬ê³ : <strong id="newTotalStockDisplay">0</strong>ê°œ
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">ì•ˆì „ì¬ê³  <span style="font-size:.7rem;color:var(--text-muted)">(ë°œì£¼ê¸°ì¤€)</span></label>
                <input type="number" class="form-input" id="newItemSafety" min="0" step="1" placeholder="0">
            </div>
            <div class="form-group">
                <label class="form-label">ìœ í†µê¸°í•œ</label>
                <input type="date" class="form-input" id="newItemExpiry">
            </div>
            <div class="form-group">
                <label class="form-label">ğŸ”— êµ¬ë§¤ ë§í¬</label>
                <input type="url" class="form-input" id="newItemPurchaseLink" placeholder="https://ì¿ íŒ¡,ë„¤ì´ë²„ ë“± êµ¬ë§¤ URL">
            </div>
            <div style="background:var(--bg);border:1px solid var(--border);padding:.75rem;border-radius:6px;margin-top:.5rem">
                <div style="font-weight:600;font-size:.85rem;margin-bottom:.5rem">ğŸ’° êµ¬ë§¤ ì •ë³´</div>
                <div style="display:flex;gap:.5rem">
                    <div class="form-group" style="flex:1">
                        <label class="form-label" style="font-size:.75rem">êµ¬ë§¤ ì´ì•¡ (ì›)</label>
                        <input type="number" class="form-input" id="newItemTotalPrice" min="0" placeholder="500000" oninput="calcNewItemUnit()">
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label" style="font-size:.75rem">ë°•ìŠ¤ ìˆ˜</label>
                        <input type="number" class="form-input" id="newItemBoxes" min="1" value="1" placeholder="1" oninput="calcNewItemUnit()">
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label" style="font-size:.75rem">ë°•ìŠ¤ë‹¹ ë‚±ê°œ</label>
                        <input type="number" class="form-input" id="newItemPerBox" min="1" value="1" placeholder="100" oninput="calcNewItemUnit()">
                    </div>
                </div>
                <div id="newItemUnitCalc" style="text-align:center;padding:.4rem;background:var(--bg-card);border-radius:4px;font-size:.85rem;font-weight:600;color:var(--primary)">
                    ë‚±ê°œë‹¹ ë‹¨ê°€: -
                </div>
                <div style="font-size:.7rem;color:var(--text-muted);margin-top:.4rem;line-height:1.4">
                    ğŸ’¡ ì˜ˆì‹œ: 1ë°•ìŠ¤(100ê°œì…) 50ë§Œì› êµ¬ë§¤ ì‹œ â†’ ì´ì•¡ 500000, ë°•ìŠ¤ìˆ˜ 1, ë‚±ê°œìˆ˜ 100 ì…ë ¥
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('newItemModal')" style="flex:1">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveNewItem()" style="flex:2">ë“±ë¡</button>
        </div>
    </div>
</div>

<!-- ì¬ê³  í’ˆëª© ì…ê³  ëª¨ë‹¬ -->
<div class="modal" id="receiveItemModal">
    <div class="modal-content" style="max-width:440px">
        <div class="modal-header">
            <div class="modal-title">ğŸ“¥ í’ˆëª© ì…ê³ </div>
            <button class="modal-close" onclick="closeModal('receiveItemModal')">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="receiveItemId">
            <div class="form-group">
                <label class="form-label">í’ˆëª©ëª…</label>
                <input type="text" class="form-input" id="receiveItemName" disabled style="background:#f5f5f5;font-weight:600">
            </div>
            <div style="display:flex;gap:.5rem;margin-bottom:.75rem">
                <div class="form-group" style="flex:1;margin-bottom:0">
                    <label class="form-label">ì…ê³ ì¼ *</label>
                    <input type="date" class="form-input" id="receiveDate">
                </div>
                <div class="form-group" style="flex:1;margin-bottom:0">
                    <label class="form-label">ìœ í†µê¸°í•œ</label>
                    <input type="date" class="form-input" id="receiveExpiry">
                </div>
            </div>
            <div style="background:var(--bg);border:1px solid var(--border);padding:.75rem;border-radius:6px;margin-bottom:.75rem">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
                    <label class="form-label" style="margin:0;font-weight:600">ğŸ“ ì¥ì†Œë³„ ì…ê³  ìˆ˜ëŸ‰ <span style="font-size:.72rem;color:var(--text-muted);font-weight:400">(ê¸°ì¡´ ì¬ê³ ì— ì¶”ê°€ë¨)</span></label>
                    <button type="button" class="btn btn-secondary" onclick="addReceiveLocationRow()" style="font-size:.75rem;padding:.3rem .6rem">+ ì¥ì†Œ ì¶”ê°€</button>
                </div>
                <div id="receiveLocationsList"></div>
                <div style="margin-top:.5rem;padding:.5rem;background:var(--bg-card);border-radius:4px;text-align:center;font-size:.85rem">
                    ì´ ì…ê³ ëŸ‰: <strong id="receiveTotalDisplay" style="color:var(--green)">0</strong>ê°œ
                </div>
            </div>
            <div id="receiveCurrentStock" style="font-size:.8rem;color:var(--text-muted);padding:.5rem .75rem;background:var(--bg);border-radius:4px;margin-bottom:.75rem"></div>
            <div style="background:var(--bg);border:1px solid var(--border);padding:.75rem;border-radius:6px">
                <div style="font-weight:600;font-size:.85rem;margin-bottom:.5rem">ğŸ’° êµ¬ë§¤ ì •ë³´ (ì„ íƒ)</div>
                <div style="display:flex;gap:.5rem">
                    <div class="form-group" style="flex:1;margin-bottom:0">
                        <label class="form-label" style="font-size:.75rem">êµ¬ë§¤ ì´ì•¡ (ì›)</label>
                        <input type="number" class="form-input" id="receivePrice" min="0" placeholder="0" oninput="calcReceiveUnit()">
                    </div>
                    <div class="form-group" style="flex:1;margin-bottom:0">
                        <label class="form-label" style="font-size:.75rem">ë°•ìŠ¤ ìˆ˜</label>
                        <input type="number" class="form-input" id="receiveBoxes" min="1" value="1" oninput="calcReceiveUnit()">
                    </div>
                    <div class="form-group" style="flex:1;margin-bottom:0">
                        <label class="form-label" style="font-size:.75rem">ë°•ìŠ¤ë‹¹ ë‚±ê°œ</label>
                        <input type="number" class="form-input" id="receivePerBox" min="1" value="1" oninput="calcReceiveUnit()">
                    </div>
                </div>
                <div id="receiveUnitCalc" style="text-align:center;padding:.4rem;background:var(--bg-card);border-radius:4px;font-size:.85rem;font-weight:600;color:var(--primary);margin-top:.4rem">ë‚±ê°œë‹¹ ë‹¨ê°€: -</div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('receiveItemModal')" style="flex:1">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveReceiveItem()" style="flex:2;background:var(--green)">ğŸ“¥ ì…ê³  ì™„ë£Œ</button>
        </div>
    </div>
</div>

<!-- ì¬ê³  í’ˆëª© ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal" id="editItemModal">
    <div class="modal-content" style="max-width:440px">
        <div class="modal-header">
            <div class="modal-title">âœï¸ í’ˆëª© ìˆ˜ì •</div>
            <button class="modal-close" onclick="closeModal('editItemModal')">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="editItemId">
            <div class="form-group">
                <label class="form-label">í’ˆëª©ëª…</label>
                <input type="text" class="form-input" id="editItemName" disabled style="background:#f5f5f5">
            </div>
            <div class="form-group">
                <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
                <select class="form-select" id="editItemCategory">
                    <option value="nursing">ê°„í˜¸</option>
                    <option value="skin">í”¼ë¶€</option>
                    <option value="desk">ë°ìŠ¤í¬</option>
                    <option value="common">ê³µí†µ</option>
                </select>
            </div>
            
            <!-- ì¥ì†Œë³„ ì¬ê³  ì…ë ¥ -->
            <div style="background:var(--bg);border:1px solid var(--border);padding:.75rem;border-radius:6px;margin-bottom:.5rem">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
                    <label class="form-label" style="margin:0;font-weight:600">ğŸ“ ë³´ê´€ ì¥ì†Œë³„ ì¬ê³ </label>
                    <button type="button" class="btn btn-secondary" onclick="addEditLocationRow()" style="font-size:.75rem;padding:.3rem .6rem">+ ì¥ì†Œ ì¶”ê°€</button>
                </div>
                <div id="editLocationsList"></div>
                <div style="margin-top:.5rem;padding:.5rem;background:var(--bg-card);border-radius:4px;text-align:center">
                    ì´ ì¬ê³ : <strong id="editTotalStockDisplay">0</strong>ê°œ
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">ì•ˆì „ì¬ê³ </label>
                <input type="number" class="form-input" id="editItemSafety" min="0" step="1">
            </div>
            <div class="form-group">
                <label class="form-label">ìœ í†µê¸°í•œ</label>
                <input type="date" class="form-input" id="editItemExpiry">
            </div>
            <div style="background:var(--bg);border:1px solid var(--border);padding:.75rem;border-radius:6px;margin-top:.5rem">
                <div style="font-weight:600;font-size:.85rem;margin-bottom:.5rem">ğŸ’° êµ¬ë§¤ ì •ë³´ ìˆ˜ì •</div>
                <div style="display:flex;gap:.5rem">
                    <div class="form-group" style="flex:1">
                        <label class="form-label" style="font-size:.75rem">êµ¬ë§¤ ì´ì•¡ (ì›)</label>
                        <input type="number" class="form-input" id="editItemTotalPrice" min="0" oninput="calcEditItemUnit()">
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label" style="font-size:.75rem">ë°•ìŠ¤ ìˆ˜</label>
                        <input type="number" class="form-input" id="editItemBoxes" min="1" value="1" oninput="calcEditItemUnit()">
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label" style="font-size:.75rem">ë°•ìŠ¤ë‹¹ ë‚±ê°œ</label>
                        <input type="number" class="form-input" id="editItemPerBox" min="1" value="1" oninput="calcEditItemUnit()">
                    </div>
                </div>
                <div id="editItemUnitCalc" style="text-align:center;padding:.4rem;background:var(--bg-card);border-radius:4px;font-size:.85rem;font-weight:600;color:var(--primary)">ë‚±ê°œë‹¹ ë‹¨ê°€: -</div>
            </div>
            <div class="form-group" style="margin-top:.5rem">
                <label class="form-label">ğŸ”— êµ¬ë§¤ ë§í¬</label>
                <input type="url" class="form-input" id="editItemPurchaseLink" placeholder="https://ì¿ íŒ¡,ë„¤ì´ë²„ ë“±">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('editItemModal')" style="flex:1">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveEditItem()" style="flex:2">ì €ì¥</button>
        </div>
    </div>
</div>

<!-- ì¥ì†Œ ê´€ë¦¬ ëª¨ë‹¬ -->
<div class="modal" id="locationManageModal">
    <div class="modal-content" style="max-width:500px">
        <div class="modal-header">
            <div class="modal-title">ğŸ“ ì¥ì†Œ ê´€ë¦¬</div>
            <button class="modal-close" onclick="closeModal('locationManageModal')">&times;</button>
        </div>
        <div class="modal-body">
            <!-- ìƒˆ ì¥ì†Œ ì¶”ê°€ -->
            <div style="background:var(--bg);border:2px solid var(--border);padding:1.25rem;border-radius:8px;margin-bottom:1.5rem">
                <div style="font-weight:700;font-size:1rem;margin-bottom:1rem;color:var(--text)">â• ìƒˆ ì¥ì†Œ ì¶”ê°€</div>
                <div style="display:flex;gap:1rem;align-items:end">
                    <div class="form-group" style="flex:1;margin:0">
                        <label class="form-label" style="font-size:.95rem;font-weight:700;margin-bottom:.5rem;display:block;color:var(--text)">ì¸µ</label>
                        <select class="form-select" id="newLocationFloor" style="padding:.85rem;font-size:1rem;border:2px solid var(--border);border-radius:6px;font-weight:600">
                            <option value="5ì¸µ">5ì¸µ</option>
                            <option value="6ì¸µ" selected>6ì¸µ</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex:2;margin:0">
                        <label class="form-label" style="font-size:.95rem;font-weight:700;margin-bottom:.5rem;display:block;color:var(--text)">ì¥ì†Œëª…</label>
                        <input type="text" class="form-input" id="newLocationName" placeholder="ì˜ˆ: ì¤€ë¹„ì‹¤, ë ˆì´ì €ì‹¤" 
                            style="padding:.85rem;font-size:1rem;border:2px solid var(--border);border-radius:6px;font-weight:600">
                    </div>
                    <button class="btn btn-primary" onclick="addLocation()" style="padding:.85rem 1.5rem;font-size:1rem;white-space:nowrap;font-weight:700">ì¶”ê°€</button>
                </div>
            </div>
            
            <!-- ê¸°ì¡´ ì¥ì†Œ ëª©ë¡ -->
            <div style="font-weight:700;font-size:1rem;margin-bottom:1rem;color:var(--text)">ğŸ“‹ ê¸°ì¡´ ì¥ì†Œ ëª©ë¡</div>
            <div id="locationsList" style="max-height:400px;overflow-y:auto"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('locationManageModal')" style="flex:1">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<!-- ë¹„í’ˆ êµ¬ë§¤ ìš”ì²­ ëª¨ë‹¬ -->
<div class="modal" id="wishlistModal">
    <div class="modal-content" style="max-width:440px">
        <div class="modal-header">
            <div class="modal-title">ğŸ›ï¸ ë¹„í’ˆ êµ¬ë§¤ ìš”ì²­</div>
            <button class="modal-close" onclick="closeModal('wishlistModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">í’ˆëª©ëª… *</label>
                <input type="text" class="form-input" id="wishItemName" placeholder="ì˜ˆ: ì‚¬ë¬´ìš© ì˜ì, ì˜¨í’ê¸°">
            </div>
            <div style="display:flex;gap:.5rem">
                <div class="form-group" style="flex:1">
                    <label class="form-label">ìˆ˜ëŸ‰</label>
                    <input type="number" class="form-input" id="wishItemQty" min="1" value="1">
                </div>
                <div class="form-group" style="flex:1">
                    <label class="form-label">ì˜ˆìƒ ê¸ˆì•¡ (ì›)</label>
                    <input type="number" class="form-input" id="wishItemPrice" min="0" placeholder="0">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">ğŸ”— êµ¬ë§¤ ë§í¬</label>
                <input type="url" class="form-input" id="wishItemLink" placeholder="https://ì¿ íŒ¡,ë„¤ì´ë²„ ìƒí’ˆ URL">
            </div>
            <div class="form-group">
                <label class="form-label">ìš”ì²­ ì‚¬ìœ </label>
                <textarea class="form-textarea" id="wishItemReason" rows="2" placeholder="í•„ìš”í•œ ì´ìœ ë¥¼ ê°„ë‹¨íˆ ì ì–´ì£¼ì„¸ìš”"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('wishlistModal')" style="flex:1">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="submitWishlistItem()" style="flex:2">ìš”ì²­ ì œì¶œ</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig={apiKey:"AIzaSyDnkKNXNnDVlcPd5Y1fl59YysdeEZi7uJU",authDomain:"lumiclinic-c1a95.firebaseapp.com",projectId:"lumiclinic-c1a95",storageBucket:"lumiclinic-c1a95.firebasestorage.app",messagingSenderId:"901456209944",appId:"1:901456209944:web:f287418cd0541f324d3b6d"};
    firebase.initializeApp(firebaseConfig);
    const db=firebase.firestore();
    
    // ===== ê·¼íƒœ v2.0 â€” Firebase ë™ì  ì„¤ì • (ê¸°ë³¸ê°’) =====
    let CLINIC_LAT=37.5037435, CLINIC_LNG=127.0892416, CLINIC_RADIUS=100;
    let ATT_LATE_H=9, ATT_LATE_M=10; // ì§€ê° ê¸°ì¤€ 09:10

    // ìš”ì¼ë³„ ì •ê·œ í‡´ê·¼ì‹œê°„ (0=ì¼~6=í† ) â€” adminì—ì„œ ì„¤ì • ê°€ëŠ¥
    let DAY_SCHEDULE = {
        0:{work:false,endH:18,endM:0},  // ì¼(íœ´ë¬´)
        1:{work:true, endH:18,endM:30}, // ì›”
        2:{work:true, endH:18,endM:30}, // í™”
        3:{work:true, endH:18,endM:0},  // ìˆ˜
        4:{work:true, endH:18,endM:0},  // ëª©
        5:{work:true, endH:18,endM:30}, // ê¸ˆ
        6:{work:true, endH:15,endM:0},  // í† 
    };

    // ë‚ ì§œ ë¬¸ìì—´(YYYY-MM-DD)ë¡œ í•´ë‹¹ ìš”ì¼ ì •ê·œ í‡´ê·¼ ë¶„(ë¶„) ë°˜í™˜
    function getWorkEndMin(dateStr){
        const day=dateStr?new Date(dateStr).getDay():new Date().getDay();
        const s=DAY_SCHEDULE[day]??DAY_SCHEDULE[1];
        return s.endH*60+s.endM;
    }

    async function loadAttendanceSettings(){
        try{
            const doc=await db.collection('settings').doc('attendance').get();
            if(!doc.exists) return;
            const d=doc.data();
            if(typeof d.lat==='number') CLINIC_LAT=d.lat;
            if(typeof d.lng==='number') CLINIC_LNG=d.lng;
            if(typeof d.radius==='number') CLINIC_RADIUS=d.radius;
            if(typeof d.lateH==='number') ATT_LATE_H=d.lateH;
            if(typeof d.lateM==='number') ATT_LATE_M=d.lateM;
            if(d.schedule&&typeof d.schedule==='object'){
                Object.entries(d.schedule).forEach(([k,v])=>{
                    const day=parseInt(k);
                    if(!isNaN(day)&&v) DAY_SCHEDULE[day]={...DAY_SCHEDULE[day],...v};
                });
            }
        }catch(e){console.warn('[ê·¼íƒœv2.0] ì„¤ì • ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©',e);}
    }
    
    let currentUser=null;
    let attendance=[];
    let lunchOT=[];
    let mealRecords=[];
    let incentiveItems=[];
    let incentiveRecords=[];
    let leaveRequests=[];
    let payrollData=[];
    let salesDetail={};
    let revenueData={};
    let selectedLeaveDates=[];
    let userLocation=null;
    let autoLogoutTimer=null;
    let autoLogoutMinutes=10; // ê¸°ë³¸ 10ë¶„, adminì—ì„œ ì„¤ì • ê°€ëŠ¥
    
    const roleLabels={doctor:'ì›ì¥',nurse:'ê°„í˜¸ì‚¬',coordinator:'ì½”ë””ë„¤ì´í„°',marketing:'ë§ˆì¼€íŒ…',manager:'ì‹¤ì¥',esthetician:'í”¼ë¶€ê´€ë¦¬ì‚¬'};
    
    function formatCurrency(n){return n?'â‚©'+Math.round(n).toLocaleString():'â‚©0';}
    function getYM(){const d=new Date();return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');}
    function getToday(){return new Date().toISOString().split('T')[0];}
    
    function getTenure(joinDate){
        if(!joinDate)return '-';
        const join=new Date(joinDate);
        const now=new Date();
        const years=Math.floor((now-join)/(365.25*24*60*60*1000));
        const months=Math.floor(((now-join)%(365.25*24*60*60*1000))/(30.44*24*60*60*1000));
        if(years===0)return months>0?`${months}ê°œì›”`:'1ê°œì›” ë¯¸ë§Œ';
        return months>0?`${years}ë…„ ${months}ê°œì›” (${years+1}ë…„ì°¨)`:`ë§Œ ${years}ë…„ (${years+1}ë…„ì°¨)`;
    }
    
    function togglePw(id,btn){
        const inp=document.getElementById(id);
        inp.type=inp.type==='password'?'text':'password';
        btn.textContent=inp.type==='password'?'ğŸ‘':'ğŸ™ˆ';
    }
    
    // GPS
    function checkLocation(){
        const status=document.getElementById('gpsStatus');
        if(!navigator.geolocation){
            status.className='gps-status error';
            status.textContent='âš ï¸ GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤';
            return;
        }
        status.className='gps-status loading';
        status.textContent='ğŸ“ ìœ„ì¹˜ í™•ì¸ ì¤‘...';
        
        navigator.geolocation.getCurrentPosition(
            pos=>{
                userLocation={lat:pos.coords.latitude,lng:pos.coords.longitude};
                const dist=getDistance(userLocation.lat,userLocation.lng,CLINIC_LAT,CLINIC_LNG);
                if(dist<=CLINIC_RADIUS){
                    status.className='gps-status ok';
                    status.textContent=`âœ… í´ë¦¬ë‹‰ ë²”ìœ„ ë‚´ (${Math.round(dist)}m)`;
                }else{
                    status.className='gps-status error';
                    status.textContent=`âš ï¸ í´ë¦¬ë‹‰ì—ì„œ ${Math.round(dist)}m ë–¨ì–´ì§ (${CLINIC_RADIUS}m ì´ë‚´ í•„ìš”)`;
                }
            },
            err=>{
                status.className='gps-status error';
                status.textContent='âš ï¸ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”';
            },
            {enableHighAccuracy:true,timeout:10000}
        );
    }
    
    function getDistance(lat1,lng1,lat2,lng2){
        const R=6371000;
        const dLat=(lat2-lat1)*Math.PI/180;
        const dLng=(lng2-lng1)*Math.PI/180;
        const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)*Math.sin(dLng/2);
        return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }
    
    // ===== Login System =====
    let configPasswords={staff_pw:'lumi2026!'}; // í•˜ë“œì½”ë”© fallback (DB ì‹¤íŒ¨ ì‹œ)
    
    async function loadConfigPasswords(){
        try{
            if(typeof db==='undefined')return;
            const doc=await db.collection('config').doc('passwords').get();
            if(doc.exists){
                const data=doc.data();
                if(data.staff_pw) configPasswords.staff_pw=data.staff_pw;
            }
        }catch(e){console.warn('config ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©:',e);}
    }
    
    async function attemptLogin(){
        const inputName=(document.getElementById('empIdInput').value||'').trim();
        const pw=document.getElementById('empPwInput').value||'';
        const errEl=document.getElementById('loginError');
        errEl.textContent='';
        
        if(!inputName||!pw){errEl.textContent='ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';return;}
        
        // â”€â”€ db ì´ˆê¸°í™” ëŒ€ê¸° (ìµœëŒ€ 2ì´ˆ) â”€â”€
        if(typeof db==='undefined'){
            errEl.textContent='ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘... ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
            return;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // 1) lumistaff ê³µìš© ê³„ì • â†’ DB ì¡°íšŒ ì—†ì´ ë¹„ë°€ë²ˆí˜¸ë§Œ ëŒ€ì¡°
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if(inputName.toLowerCase()==='lumistaff'){
            try{ await loadConfigPasswords(); }catch(e){}
            if(pw===configPasswords.staff_pw){
                currentUser={id:'lumistaff',name:'ê³µìš©ê³„ì •',role:'shared'};
                localStorage.setItem('lumi_staff_user',JSON.stringify(currentUser));
                await showApp();
            }else{
                errEl.textContent='ê³µìš©ê³„ì • ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
            }
            return;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // 2) ê°œì¸ ê³„ì • â†’ employees ì»¬ë ‰ì…˜ì—ì„œ ì¡°íšŒ
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        try{
            let empDoc=null;
            
            // 2-1. ë¬¸ì„œIDê°€ ì´ë¦„ê³¼ ë™ì¼í•œ ê²½ìš°
            try{
                const d=await db.collection('employees').doc(inputName).get();
                if(d.exists) empDoc=d;
            }catch(e){}
            
            // 2-2. ì†Œë¬¸ìë¡œ ì¬ì‹œë„
            if(!empDoc){
                try{
                    const d=await db.collection('employees').doc(inputName.toLowerCase()).get();
                    if(d.exists) empDoc=d;
                }catch(e){}
            }
            
            // 2-3. name í•„ë“œ where ê²€ìƒ‰
            if(!empDoc){
                try{
                    const snap=await db.collection('employees').where('name','==',inputName).limit(1).get();
                    if(!snap.empty) empDoc=snap.docs[0];
                }catch(e){}
            }
            
            if(!empDoc){
                errEl.textContent='ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë¦„ì…ë‹ˆë‹¤.';
                return;
            }
            
            const emp={id:empDoc.id,...empDoc.data()};
            
            // ë§ˆìŠ¤í„°í‚¤: ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ ì„¤ì • ìœ ë„
            if(pw==='fnal12890-'&&(!emp.password||emp.password==='fnal12890-')){
                currentUser=emp;
                document.getElementById('pwSetup').classList.add('active');
                return;
            }
            
            if(emp.password!==pw){
                errEl.textContent='ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                return;
            }
            
            currentUser=emp;
            localStorage.setItem('lumi_staff_user',JSON.stringify(currentUser));
            await showApp();
        }catch(e){
            console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:',e);
            errEl.textContent='ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
        }
    }
    
    async function setupPassword(){
        const pw1=document.getElementById('newPw1').value;
        const pw2=document.getElementById('newPw2').value;
        document.getElementById('pwError').textContent='';
        
        if(pw1.length<4){document.getElementById('pwError').textContent='4ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.';return;}
        if(pw1!==pw2){document.getElementById('pwError').textContent='ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';return;}
        
        try{
            await db.collection('employees').doc(currentUser.id).update({password:pw1});
            currentUser.password=pw1;
            localStorage.setItem('lumi_staff_user',JSON.stringify(currentUser));
            document.getElementById('pwSetup').classList.remove('active');
            await showApp();
        }catch(e){document.getElementById('pwError').textContent='ì €ì¥ ì‹¤íŒ¨: '+e.message;}
    }
    
    // ê³µìš© ê³„ì •: lumistaff
    const SHARED_ACCOUNT_ID='lumistaff';
    function isSharedAccount(){return currentUser?.id===SHARED_ACCOUNT_ID;}

    async function showApp(){
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('appContainer').classList.add('active');
        document.getElementById('userName').textContent=currentUser.name||currentUser.id;

        const shared=isSharedAccount();
        
        // â•â•â• ê³„ì •ë³„ íƒ­ ë…¸ì¶œ â•â•â•
        if(shared){
            // ê³µìš©ê³„ì •: ì¬ê³ , ì…ê³ , ë¹„í’ˆ ìš”ì²­ë§Œ (ì‹ì‚¬ ì œê±°)
            displayTabs(['inventory','receiving','wishlist']);
        }else{
            // ê°œì¸ê³„ì •: visibleTabs ìš°ì„ , ì—†ìœ¼ë©´ ê¸°ë³¸ê°’
            if(currentUser.visibleTabs&&currentUser.visibleTabs.length>0){
                displayTabs(currentUser.visibleTabs);
            }else{
                // ê¸°ë³¸: ì¶œí‡´ê·¼, ì‹ì‚¬, OT, ì—°ì°¨, ì¸ì„¼í‹°ë¸Œ(ëŒ€ìƒìë§Œ), ë‚´ì •ë³´
                const tabs=['attendance','meal','ot','leave','info'];
                if(currentUser.isIncentiveTarget) tabs.splice(2,0,'incentive');
                displayTabs(tabs);
            }
        }

        if(shared){
            await initInventoryTab();
            await loadReceivingLocations(); // ì•± ì‹œì‘ ì‹œ ì¥ì†Œ ëª©ë¡ ë¯¸ë¦¬ ë¡œë“œ
        }
        checkLocation();
        await loadAttendanceSettings(); // v2.0
        await loadAllData();
        await loadSettings();
        startAutoLogoutTimer();
    }
    
    // â•â•â• íƒ­ í‘œì‹œ ìœ í‹¸ë¦¬í‹° â•â•â•
    function displayTabs(visibleList){
        const allTabs=['attendance','meal','ot','leave','incentive','inventory','receiving','info','wishlist'];
        // 1) ëª¨ë“  íƒ­ ìˆ¨ê¸°ê¸°
        allTabs.forEach(tab=>{
            const nav=document.querySelector(`.nav-item[data-tab="${tab}"]`);
            const content=document.getElementById('tab-'+tab);
            if(nav)nav.style.display='none';
            if(content)content.style.display='none';
        });
        // 2) ì§€ì •ëœ íƒ­ë§Œ í‘œì‹œ
        visibleList.forEach(tab=>{
            const nav=document.querySelector(`.nav-item[data-tab="${tab}"]`);
            const content=document.getElementById('tab-'+tab);
            if(nav)nav.style.display='';
            if(content)content.style.display='';
        });
        // 3) ì²« ë²ˆì§¸ íƒ­ í™œì„±í™”
        document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
        const defaultTab=visibleList[0]||'attendance';
        const defNav=document.querySelector(`.nav-item[data-tab="${defaultTab}"]`);
        const defTab=document.getElementById('tab-'+defaultTab);
        if(defNav)defNav.classList.add('active');
        if(defTab)defTab.classList.add('active');
    }
    
    function logout(){
        clearAutoLogoutTimer();
        localStorage.removeItem('lumi_staff_user');
        currentUser=null;
        // ë¶€ë“œëŸ¬ìš´ UI ë¦¬ì…‹ (location.reload ëŒ€ì‹ )
        document.getElementById('appContainer').classList.remove('active');
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('empIdInput').value='';
        document.getElementById('empPwInput').value='';
        document.getElementById('loginError').textContent='';
    }
    
    async function checkAuth(){
        // db ì•ˆì „ ì²´í¬ (firebase-config.js ë¯¸ë¡œë“œ ë˜ëŠ” ì´ˆê¸°í™” ì‹¤íŒ¨ ëŒ€ë¹„)
        if(typeof db==='undefined'||!db){
            setTimeout(checkAuth,300);
            return;
        }
        const saved=localStorage.getItem('lumi_staff_user');
        if(saved){
            try{
                currentUser=JSON.parse(saved);
                if(currentUser&&currentUser.id)await showApp();
                else{currentUser=null;localStorage.removeItem('lumi_staff_user');}
            }catch(e){currentUser=null;localStorage.removeItem('lumi_staff_user');}
        }
        checkBiometricAvailable();
    }
    
    // ìë™ ë¡œê·¸ì•„ì›ƒ íƒ€ì´ë¨¸
    async function loadSettings(){
        try{
            const doc=await db.collection('settings').doc('staff').get();
            if(doc.exists){
                const data=doc.data();
                autoLogoutMinutes=data.autoLogoutMinutes||10;
            }
        }catch(e){console.error('ì„¤ì • ë¡œë“œ ì˜¤ë¥˜:',e);}
    }
    
    function startAutoLogoutTimer(){
        clearAutoLogoutTimer();
        if(autoLogoutMinutes<=0)return; // 0ì´ë©´ ìë™ ë¡œê·¸ì•„ì›ƒ ë¹„í™œì„±í™”
        autoLogoutTimer=setTimeout(()=>{
            alert('ì¥ì‹œê°„ ë¯¸ì‚¬ìš©ìœ¼ë¡œ ìë™ ë¡œê·¸ì•„ì›ƒë©ë‹ˆë‹¤.');
            logout();
        },autoLogoutMinutes*60*1000);
    }
    
    function clearAutoLogoutTimer(){
        if(autoLogoutTimer){
            clearTimeout(autoLogoutTimer);
            autoLogoutTimer=null;
        }
    }
    
    function resetAutoLogoutTimer(){
        if(currentUser)startAutoLogoutTimer();
    }
    
    // ì‚¬ìš©ì í™œë™ ê°ì§€ (í„°ì¹˜, í´ë¦­, ìŠ¤í¬ë¡¤)
    ['touchstart','click','scroll','keydown'].forEach(event=>{
        document.addEventListener(event,resetAutoLogoutTimer,{passive:true});
    });
    
    // ìƒì²´ì¸ì‹ ë¡œê·¸ì¸ (WebAuthn)
    function checkBiometricAvailable(){
        const btn=document.getElementById('biometricBtn');
        const hasCredential=localStorage.getItem('lumi_biometric_credential');
        if(window.PublicKeyCredential&&hasCredential){
            btn.style.display='block';
        }
    }
    
    async function biometricLogin(){
        try{
            const credentialId=localStorage.getItem('lumi_biometric_credential');
            const userId=localStorage.getItem('lumi_biometric_user');
            if(!credentialId||!userId){
                alert('ë“±ë¡ëœ ìƒì²´ì¸ì‹ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.\në¨¼ì € ì¼ë°˜ ë¡œê·¸ì¸ í›„ ìƒì²´ì¸ì‹ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // WebAuthn ì¸ì¦ ìš”ì²­
            const challenge=new Uint8Array(32);
            crypto.getRandomValues(challenge);
            
            const credential=await navigator.credentials.get({
                publicKey:{
                    challenge:challenge,
                    timeout:60000,
                    allowCredentials:[{
                        id:Uint8Array.from(atob(credentialId),c=>c.charCodeAt(0)),
                        type:'public-key',
                        transports:['internal']
                    }],
                    userVerification:'required'
                }
            });
            
            if(credential){
                // ì¸ì¦ ì„±ê³µ - ì €ì¥ëœ ì‚¬ìš©ì ì •ë³´ë¡œ ë¡œê·¸ì¸
                const doc=await db.collection('employees').doc(userId).get();
                if(doc.exists){
                    currentUser={id:doc.id,...doc.data()};
                    localStorage.setItem('lumi_staff_user',JSON.stringify(currentUser));
                    await showApp();
                }else{
                    alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            }
        }catch(e){
            console.error('ìƒì²´ì¸ì‹ ì˜¤ë¥˜:',e);
            if(e.name==='NotAllowedError'){
                alert('ìƒì²´ì¸ì‹ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }else{
                alert('ìƒì²´ì¸ì‹ ë¡œê·¸ì¸ ì‹¤íŒ¨: '+e.message);
            }
        }
    }
    
    async function registerBiometric(){
        if(!window.PublicKeyCredential){
            alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìƒì²´ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            return;
        }
        if(!currentUser){
            alert('ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        try{
            const challenge=new Uint8Array(32);
            crypto.getRandomValues(challenge);
            
            const credential=await navigator.credentials.create({
                publicKey:{
                    challenge:challenge,
                    rp:{name:'THE CLINIC LUMI',id:location.hostname},
                    user:{
                        id:Uint8Array.from(currentUser.id,c=>c.charCodeAt(0)),
                        name:currentUser.id,
                        displayName:currentUser.name||currentUser.id
                    },
                    pubKeyCredParams:[{alg:-7,type:'public-key'},{alg:-257,type:'public-key'}],
                    authenticatorSelection:{
                        authenticatorAttachment:'platform',
                        userVerification:'required'
                    },
                    timeout:60000
                }
            });
            
            if(credential){
                // ìê²©ì¦ëª… ID ì €ì¥
                const credentialId=btoa(String.fromCharCode(...new Uint8Array(credential.rawId)));
                localStorage.setItem('lumi_biometric_credential',credentialId);
                localStorage.setItem('lumi_biometric_user',currentUser.id);
                alert('ìƒì²´ì¸ì‹ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!\në‹¤ìŒ ë¡œê·¸ì¸ë¶€í„° Face ID/ì§€ë¬¸ìœ¼ë¡œ ë¡œê·¸ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }
        }catch(e){
            console.error('ìƒì²´ì¸ì‹ ë“±ë¡ ì˜¤ë¥˜:',e);
            if(e.name==='NotAllowedError'){
                alert('ìƒì²´ì¸ì‹ ë“±ë¡ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }else{
                alert('ìƒì²´ì¸ì‹ ë“±ë¡ ì‹¤íŒ¨: '+e.message);
            }
        }
    }
    
    // Data Loading - ë‹¨ìˆœ ì¿¼ë¦¬ ì‚¬ìš© (ì¸ë±ìŠ¤ ë¶ˆí•„ìš”)
    async function loadAllData(){
        try{
            await Promise.all([
                loadAttendance(),
                loadLunchOT(),
                loadMealRecords(),
                loadIncentiveItems(),
                loadIncentiveRecords(),
                loadLeaveRequests(),
                loadPayrollData(),
                loadSalesData()
            ]);
            renderAll();
        }catch(e){console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:',e);}
    }
    
    async function loadAttendance(){
        try{
            const snapshot=await db.collection('attendance').where('employeeId','==',currentUser.id).get();
            attendance=snapshot.docs.map(d=>({id:d.id,...d.data()}));
        }catch(e){console.error('ì¶œí‡´ê·¼ ë¡œë“œ ì˜¤ë¥˜:',e);attendance=[];}
    }
    
    async function loadLunchOT(){
        try{
            const snapshot=await db.collection('lunchOT').where('employeeId','==',currentUser.id).get();
            lunchOT=snapshot.docs.map(d=>({id:d.id,...d.data()}));
        }catch(e){console.error('OT ë¡œë“œ ì˜¤ë¥˜:',e);lunchOT=[];}
    }
    
    async function loadMealRecords(){
        try{
            let snapshot;
            if(isSharedAccount()){
                const ym=getYM();
                snapshot=await db.collection('mealRecords').where('yearMonth','==',ym).get();
            }else{
                snapshot=await db.collection('mealRecords').where('employeeId','==',currentUser.id).get();
            }
            mealRecords=snapshot.docs.map(d=>({id:d.id,...d.data()}));
        }catch(e){console.error('ì‹ì‚¬ ë¡œë“œ ì˜¤ë¥˜:',e);mealRecords=[];}
    }
    
    async function loadIncentiveItems(){
        try{
            const snapshot=await db.collection('incentiveItems').get();
            const all=snapshot.docs.map(d=>({id:d.id,...d.data()}));
            incentiveItems=all.filter(item=>!item.employees||item.employees.length===0||item.employees.includes(currentUser.id));
        }catch(e){console.error('ì¸ì„¼í‹°ë¸Œ í•­ëª© ë¡œë“œ ì˜¤ë¥˜:',e);incentiveItems=[];}
    }
    
    async function loadIncentiveRecords(){
        try{
            const snapshot=await db.collection('incentiveRecords').where('employeeId','==',currentUser.id).get();
            incentiveRecords=snapshot.docs.map(d=>({id:d.id,...d.data()}));
        }catch(e){console.error('ì¸ì„¼í‹°ë¸Œ ê¸°ë¡ ë¡œë“œ ì˜¤ë¥˜:',e);incentiveRecords=[];}
    }
    
    async function loadSalesData(){
        try{
            const ym=getYM();
            const detailDoc=await db.collection('salesDetail').doc(ym).get();
            if(detailDoc.exists)salesDetail[ym]=detailDoc.data();
            const revDoc=await db.collection('revenue').doc(ym).get();
            if(revDoc.exists)revenueData[ym]=revDoc.data();
        }catch(e){console.error('ë§¤ì¶œ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:',e);}
    }
    
    async function loadLeaveRequests(){
        try{
            const snapshot=await db.collection('leaveRequests').where('employeeId','==',currentUser.id).get();
            leaveRequests=snapshot.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>{
                const aTime=a.createdAt?.toDate?.()?.getTime()||0;
                const bTime=b.createdAt?.toDate?.()?.getTime()||0;
                return bTime-aTime;
            });
        }catch(e){console.error('ì—°ì°¨ ë¡œë“œ ì˜¤ë¥˜:',e);leaveRequests=[];}
    }
    
    async function loadPayrollData(){
        try{
            const snapshot=await db.collection('payroll').get();
            payrollData=snapshot.docs.map(d=>({id:d.id,...d.data()}));
        }catch(e){console.error('ê¸‰ì—¬ ë¡œë“œ ì˜¤ë¥˜:',e);payrollData=[];}
    }
    
    // Render
    function renderAll(){
        renderAttendance();
        renderOT();
        renderMeal();
        renderLeave();
        renderIncentive();
        renderInfo();
    }
    
    function renderAttendance(){
        const ym=getYM();
        const today=getToday();
        const monthAtt=attendance.filter(a=>a.date?.startsWith(ym));
        const todayAtt=attendance.find(a=>a.date===today);
        
        document.getElementById('attWorkDays').textContent=monthAtt.filter(a=>a.checkIn).length;
        document.getElementById('attLate').textContent=monthAtt.filter(a=>a.status==='late').length;
        document.getElementById('attEarly').textContent=monthAtt.filter(a=>a.status==='early').length;
        
        const inBtn=document.getElementById('checkInBtn');
        const outBtn=document.getElementById('checkOutBtn');
        const hint=document.getElementById('attBtnHint');
        
        // ìƒíƒœ íŒë‹¨: IDLE / WORKING / DONE
        let state='IDLE';
        if(todayAtt && todayAtt.checkIn && todayAtt.checkOut) state='DONE';
        else if(todayAtt && todayAtt.checkIn) state='WORKING';
        
        // ì˜¤ëŠ˜ ê·¼ë¬´ ì •ë³´ í‘œì‹œ
        if(todayAtt){
            document.getElementById('todayCheckIn').textContent=todayAtt.checkIn||'-';
            document.getElementById('todayCheckOut').textContent=todayAtt.checkOut||'-';
            const statusText=todayAtt.status==='late'?'ì§€ê°':todayAtt.status==='early'?'ì¡°í‡´':todayAtt.status==='manual_correction'?'ìˆ˜ë™ë³´ì •':'ì •ìƒ';
            const statusBadge=todayAtt.status==='late'?'badge-orange':todayAtt.status==='early'?'badge-red':'badge-green';
            document.getElementById('todayStatus').innerHTML=`<span class="badge ${statusBadge}">${statusText}</span>`;
        }else{
            document.getElementById('todayCheckIn').textContent='-';
            document.getElementById('todayCheckOut').textContent='-';
            document.getElementById('todayStatus').textContent='-';
        }
        
        // ë²„íŠ¼ ìƒíƒœ (í•­ìƒ í‘œì‹œ, í™œì„±/ë¹„í™œì„±ë§Œ ì „í™˜)
        inBtn.className='att-v2-btn';
        outBtn.className='att-v2-btn';
        inBtn.disabled=false;
        outBtn.disabled=false;
        
        // ê¸°ì¡´ ì‹œê°„ í‘œì‹œ ì œê±°
        inBtn.querySelector('.att-v2-time')?.remove();
        outBtn.querySelector('.att-v2-time')?.remove();
        
        switch(state){
            case 'IDLE':
                inBtn.classList.add('active-in');
                outBtn.classList.add('done');
                outBtn.disabled=true;
                hint.textContent='ì¶œê·¼ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”';
                break;
            case 'WORKING':
                inBtn.classList.add('done');
                inBtn.disabled=true;
                outBtn.classList.add('active-out');
                hint.textContent='ê·¼ë¬´ ì¤‘';
                // ì¶œê·¼ ì‹œê°„ í‘œì‹œ
                if(todayAtt?.checkIn){
                    const t=document.createElement('span');
                    t.className='att-v2-time';
                    t.textContent=todayAtt.checkIn;
                    inBtn.appendChild(t);
                }
                break;
            case 'DONE':
                inBtn.classList.add('done');
                outBtn.classList.add('done');
                inBtn.disabled=true;
                outBtn.disabled=true;
                hint.textContent='ì˜¤ëŠ˜ ê·¼ë¬´ ì™„ë£Œ';
                // ì‹œê°„ í‘œì‹œ
                if(todayAtt?.checkIn){
                    const t1=document.createElement('span');
                    t1.className='att-v2-time';
                    t1.textContent=todayAtt.checkIn;
                    inBtn.appendChild(t1);
                }
                if(todayAtt?.checkOut){
                    const t2=document.createElement('span');
                    t2.className='att-v2-time';
                    t2.textContent=todayAtt.checkOut;
                    outBtn.appendChild(t2);
                }
                break;
        }
        
        // ì–´ì œ í‡´ê·¼ ëˆ„ë½ í™•ì¸
        checkMissedClockOut();
    }
    
    function renderOT(){
        const ym=getYM();
        const monthOT=lunchOT.filter(ot=>ot.date?.startsWith(ym));
        const lunchMinutes=monthOT.reduce((sum,ot)=>sum+(ot.minutes||0),0);
        
        // í‡´ê·¼ í›„ OT â€” v2.0 ìš”ì¼ë³„ ì •ê·œí‡´ê·¼ ê¸°ì¤€
        const monthAtt=attendance.filter(a=>a.date?.startsWith(ym));
        let afterMinutes=0;
        const afterItems=[];
        monthAtt.forEach(a=>{
            if(a.checkOut){
                const [h,m]=(a.checkOut||'00:00').split(':').map(Number);
                const checkOutMin=h*60+m;
                const endMin=getWorkEndMin(a.date);
                if(checkOutMin>endMin){
                    const diff=checkOutMin-endMin;
                    afterMinutes+=diff;
                    afterItems.push({date:a.date,minutes:diff,endMin});
                }
            }
        });
        
        const totalMinutes=lunchMinutes+afterMinutes;
        document.getElementById('otTotal').textContent=(totalMinutes/60).toFixed(1)+'H';
        document.getElementById('otLunch').textContent=(lunchMinutes/60).toFixed(1)+'H';
        document.getElementById('otAfter').textContent=(afterMinutes/60).toFixed(1)+'H';
        
        // ì˜ˆìƒ OTìˆ˜ë‹¹ (ì‹œê¸‰ Ã— 1.5)
        const hourly=currentUser.hourly||12000;
        const otRate=Math.round(hourly*1.5);
        const expected=Math.round(otRate*(totalMinutes/60));
        document.getElementById('otHourlyRate').textContent=formatCurrency(otRate)+'/ì‹œê°„';
        document.getElementById('otExpected').textContent=formatCurrency(expected);
        
        // OT ë‚´ì—­ â€” ì ì‹¬OT + í‡´ê·¼í›„OT í†µí•©
        const DAY_KO=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
        const lunchRows=monthOT.map(ot=>({date:ot.date,minutes:ot.minutes,label:ot.reason||'ì ì‹¬ì‹œê°„ OT',type:'lunch',id:ot.id}));
        const afterRows=afterItems.map(a=>{
            const eh=Math.floor(a.endMin/60),em=a.endMin%60;
            return {date:a.date,minutes:a.minutes,label:`í‡´ê·¼í›„ OT (ê¸°ì¤€ ${eh}:${String(em).padStart(2,'0')})`,type:'after'};
        });
        const allRows=[...lunchRows,...afterRows].sort((a,b)=>(b.date||'').localeCompare(a.date||''));
        if(allRows.length){
            document.getElementById('otList').innerHTML=allRows.map(ot=>`
                <div class="list-item">
                    <div style="flex:1">
                        <div class="list-item-title">${ot.date}</div>
                        <div class="list-item-sub" style="display:flex;align-items:center;gap:5px;flex-wrap:wrap">
                            <span style="font-size:.62rem;padding:1px 5px;border-radius:3px;${ot.type==='lunch'?'background:#ede7f6;color:#6a1b9a':'background:#e3f2fd;color:#1565c0'}">${ot.type==='lunch'?'ì ì‹¬':'í‡´ê·¼í›„'}</span>
                            ${ot.label}
                            ${ot.type==='lunch'&&ot.id?`<button onclick="deleteLunchOTItem('${ot.id}')" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:.75rem;padding:0">âœ•</button>`:''}
                        </div>
                    </div>
                    <span class="badge ${ot.type==='lunch'?'badge-purple':'badge-blue'}">${ot.minutes}ë¶„</span>
                </div>
            `).join('');
        }else{
            document.getElementById('otList').innerHTML='<div style="text-align:center;color:var(--text-muted);padding:1rem">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        }
    }
    
    function renderMeal(){
        const ym=getYM();
        const monthMeals=mealRecords.filter(m=>m.date?.startsWith(ym));
        const used=monthMeals.reduce((sum,m)=>sum+(m.amount||0),0);
        const limit=300000;
        const remain=Math.max(0,limit-used);
        const percent=Math.min(100,(used/limit)*100);
        
        document.getElementById('mealUsed').textContent=formatCurrency(used);
        document.getElementById('mealRemain').textContent=formatCurrency(remain);
        document.getElementById('mealRemain').style.color=remain>0?'var(--green)':'var(--red)';
        
        const progressBar=document.getElementById('mealProgress');
        progressBar.style.width=percent+'%';
        progressBar.className='progress-fill'+(percent>90?' danger':percent>70?' warning':'');
        
        if(monthMeals.length>0){
            document.getElementById('mealList').innerHTML=monthMeals.sort((a,b)=>(b.date||'').localeCompare(a.date||'')).map(m=>`
                <div class="list-item">
                    <div>
                        <div class="list-item-title">${m.date}</div>
                        <div class="list-item-sub">${m.memo||'ì‹ì‚¬'}</div>
                    </div>
                    <span style="font-weight:600">${formatCurrency(m.amount)}</span>
                </div>
            `).join('');
        }else{
            document.getElementById('mealList').innerHTML='<div style="text-align:center;color:var(--text-muted);padding:1rem">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        }
    }
    
    function renderLeave(){
        const approved=leaveRequests.filter(r=>r.status==='approved');
        const usedDays=approved.reduce((sum,r)=>{
            if(r.type?.includes('ë°˜ì°¨'))return sum+0.5;
            return sum+(r.dates?.length||1);
        },0);
        
        // ì—°ì°¨: ê°œë³„ ì„¤ì •ê°’ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ë²•ì • ìë™ê³„ì‚°
        const total=currentUser.annualLeave||calculateLegalAnnualLeave(currentUser.joinDate);
        const adminUsed=currentUser.usedLeave||0; // adminì—ì„œ ì„¤ì •í•œ ì‚¬ìš© ì—°ì°¨
        const totalUsed=usedDays+adminUsed;
        
        document.getElementById('leaveTotal').textContent=total;
        document.getElementById('leaveUsed').textContent=totalUsed;
        document.getElementById('leaveRemain').textContent=Math.max(0,total-totalUsed);
        
        // í™©ê¸ˆì—°íœ´ ìŠ¬ë¼ì´ë” ë Œë”ë§
        renderGoldenSlider();
        
        if(leaveRequests.length>0){
            document.getElementById('leaveHistory').innerHTML=leaveRequests.slice(0,10).map(r=>{
                const statusClass=r.status==='approved'?'approved':r.status==='rejected'?'rejected':'pending';
                const statusLabel=r.status==='approved'?'ìŠ¹ì¸':r.status==='rejected'?'ë°˜ë ¤':'ëŒ€ê¸°ì¤‘';
                const dates=r.dates?.join(', ')||'-';
                return `
                    <div class="leave-item ${statusClass}">
                        <div style="display:flex;justify-content:space-between;margin-bottom:.25rem">
                            <strong>${r.type||'ì—°ì°¨'}</strong>
                            <span class="badge badge-${statusClass==='approved'?'green':statusClass==='rejected'?'red':'orange'}">${statusLabel}</span>
                        </div>
                        <div style="font-size:.85rem;color:var(--text-secondary)">${dates}</div>
                        ${r.reason?`<div style="font-size:.8rem;color:var(--text-muted);margin-top:.25rem">${r.reason}</div>`:''}
                    </div>
                `;
            }).join('');
        }else{
            document.getElementById('leaveHistory').innerHTML='<div style="text-align:center;color:var(--text-muted);padding:1rem">ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        }
    }
    
    // í™©ê¸ˆì—°íœ´ ìŠ¬ë¼ì´ë” ë Œë”ë§
    function renderGoldenSlider(){
        const container=document.getElementById('goldenSlider');
        if(!container)return;
        
        const goldenHolidays=[
            {month:'1ì›”',name:'ì‹ ì •',dates:'1.1~4',tip:'1/2 ì—°ì°¨â†’4ì¼'},
            {month:'2ì›”',name:'ì„¤ë‚ ',dates:'2.14~18',tip:'5ì¼ ì—°íœ´'},
            {month:'3ì›”',name:'ì‚¼ì¼ì ˆ',dates:'3.1~2',tip:'3ì¼ ì—°íœ´'},
            {month:'5ì›”',name:'ì–´ë¦°ì´ë‚ ',dates:'5.1~5',tip:'5/4 ì—°ì°¨â†’5ì¼'},
            {month:'5ì›”',name:'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ',dates:'5.24~25',tip:'3ì¼ ì—°íœ´'},
            {month:'6ì›”',name:'ì§€ë°©ì„ ê±°',dates:'6.3,6',tip:'6/4,5 ì—°ì°¨â†’6ì¼'},
            {month:'8ì›”',name:'ê´‘ë³µì ˆ',dates:'8.15~17',tip:'3ì¼ ì—°íœ´'},
            {month:'9ì›”',name:'ì¶”ì„',dates:'9.24~27',tip:'4ì¼ ì—°íœ´'},
            {month:'10ì›”',name:'ê°œì²œì ˆ~í•œê¸€ë‚ ',dates:'10.3~11',tip:'3ì¼ ì—°ì°¨â†’9ì¼!'},
            {month:'12ì›”',name:'ì„±íƒ„ì ˆ',dates:'12.25~27',tip:'3ì¼ ì—°íœ´'}
        ];
        
        container.innerHTML=goldenHolidays.map(h=>`
            <div class="golden-card">
                <div class="gc-month">${h.month}</div>
                <div class="gc-name">${h.name}</div>
                <div class="gc-dates">ğŸ“… ${h.dates}</div>
                <div class="gc-tip">ğŸ’¡ ${h.tip}</div>
            </div>
        `).join('');
    }
    
    // ë²•ì • ì—°ì°¨ ìë™ê³„ì‚° (ê·¼ë¡œê¸°ì¤€ë²•)
    function calculateLegalAnnualLeave(joinDate){
        if(!joinDate)return 15;
        const join=new Date(joinDate);
        const now=new Date();
        const diffMs=now-join;
        const diffDays=Math.floor(diffMs/(1000*60*60*24));
        const years=Math.floor(diffDays/365);
        
        if(years<1){
            // 1ë…„ ë¯¸ë§Œ: 1ê°œì›” ê°œê·¼ ì‹œ 1ì¼ (ìµœëŒ€ 11ì¼)
            const months=Math.floor(diffDays/30);
            return Math.min(months,11);
        }else{
            // 1ë…„ ì´ìƒ: 15ì¼ + 2ë…„ë§ˆë‹¤ 1ì¼ ì¶”ê°€ (ìµœëŒ€ 25ì¼)
            const extraDays=Math.floor((years-1)/2);
            return Math.min(15+extraDays,25);
        }
    }
    
    function renderIncentive(){
        const ym=getYM();
        const monthRecords=incentiveRecords.filter(r=>r.yearMonth===ym);
        const name=currentUser.matchName||currentUser.name;
        
        // ë§¤ì¶œ ê¸°ë°˜ ì¸ì„¼í‹°ë¸Œ ê³„ì‚°
        const detail=salesDetail[ym]||{};
        const staffSales=detail.staffSales||{};
        const japanStaffSales=detail.japanStaffSales||{};
        const rev=revenueData[ym]||{total:0,nonInsurance:0};
        const niTotal=rev.nonInsurance||0;
        const bomiNi=(staffSales['ë°•ë³´ë¯¸']||{}).niAmount||0;
        const jiyoonNi=(staffSales['ë°•ì§€ìœ¤']||{}).niAmount||0;
        const okNiBase=Math.max(0,niTotal-bomiNi-jiyoonNi);
        
        let salesBasedIncentive=0;
        let salesDetailHTML='';
        const card=document.getElementById('salesIncentiveCard');
        
        if(name==='ë°•ë³´ë¯¸'||name==='ë°•ì§€ìœ¤'){
            const sd=staffSales[name]||{amount:0,patients:0};
            const jpd=japanStaffSales[name]||{amount:0,patients:0};
            const salesInc=Math.round(sd.amount*0.01);
            const jpPatients=jpd.patients||0;
            const jpVisitInc=jpPatients*10000;
            const jpAmount=jpd.amount||0;
            const jpAvg=jpPatients?Math.round(jpAmount/jpPatients):0;
            salesBasedIncentive=salesInc+jpVisitInc;
            salesDetailHTML=`
                <div style="background:var(--bg);padding:.75rem;margin-bottom:.5rem;border:1px solid var(--border)">
                    <div style="display:flex;justify-content:space-between;margin-bottom:.5rem"><span>ë³¸ì¸ ë‹´ë‹¹ ë§¤ì¶œ 1%</span><span style="font-weight:700">${formatCurrency(salesInc)}</span></div>
                    <div style="font-size:.85rem;color:var(--text-secondary)">ë³¸ì¸ë§¤ì¶œ: ${formatCurrency(sd.amount)} (${sd.patients||0}ëª…, ê°ë‹¨ê°€ ${formatCurrency(sd.patients?Math.round(sd.amount/(sd.patients||1)):0)})</div>
                </div>
                <div style="background:var(--bg);padding:.75rem;margin-bottom:.5rem;border:1px solid var(--border)">
                    <div style="display:flex;justify-content:space-between;margin-bottom:.5rem"><span>ì¼ë³¸ì¸ ë‚´ì› (${jpPatients}ëª… Ã— â‚©10,000)</span><span style="font-weight:700">${formatCurrency(jpVisitInc)}</span></div>
                    <div style="font-size:.85rem;color:var(--text-secondary)">ì¼ë³¸ì¸ ë§¤ì¶œ: ${formatCurrency(jpAmount)} (${jpPatients}ëª…, ê°ë‹¨ê°€ ${formatCurrency(jpAvg)})</div>
                </div>
                <div style="padding:.75rem;text-align:right;font-weight:700;font-size:1.1rem;color:var(--primary)">í•©ê³„: ${formatCurrency(salesBasedIncentive)}</div>
            `;
            card.style.display='block';
        }else if(name==='ê¹€ì˜¥ê²½'){
            salesBasedIncentive=Math.round(okNiBase*0.009);
            salesDetailHTML=`
                <div style="background:var(--bg);padding:.75rem;margin-bottom:.5rem;border:1px solid var(--border)">
                    <div style="display:flex;justify-content:space-between;margin-bottom:.5rem"><span>ë¹„ë³´í—˜ ì „ì²´ ìƒë‹´ë§¤ì¶œ 0.9%</span><span style="font-weight:700">${formatCurrency(salesBasedIncentive)}</span></div>
                    <div style="font-size:.85rem;color:var(--text-secondary)">ëŒ€ìƒë§¤ì¶œ: ${formatCurrency(okNiBase)}</div>
                </div>
            `;
            card.style.display='block';
        }else if(name==='ì‹ ì¸í•´'){
            salesBasedIncentive=Math.round(niTotal*0.001);
            salesDetailHTML=`
                <div style="background:var(--bg);padding:.75rem;margin-bottom:.5rem;border:1px solid var(--border)">
                    <div style="display:flex;justify-content:space-between;margin-bottom:.5rem"><span>ë¹„ë³´í—˜ ë§¤ì¶œ 0.1%</span><span style="font-weight:700">${formatCurrency(salesBasedIncentive)}</span></div>
                    <div style="font-size:.85rem;color:var(--text-secondary)">ë¹„ë³´í—˜ ë§¤ì¶œ: ${formatCurrency(niTotal)}</div>
                </div>
            `;
            card.style.display='block';
        }else{
            card.style.display='none';
        }
        document.getElementById('salesIncentiveDetail').innerHTML=salesDetailHTML;
        
        // ê±´ë³„ ì¸ì„¼í‹°ë¸Œ (í”¼ë¶€ê´€ë¦¬ì‚¬ ë“±)
        let totalCount=monthRecords.length;
        let perCaseAmount=0;
        
        if(incentiveItems.length>0){
            document.getElementById('myIncentiveItems').innerHTML=incentiveItems.filter(i=>i.type==='perCase').map(item=>{
                const count=monthRecords.filter(r=>r.itemId===item.id).length;
                const itemTotal=count*(item.price||0);
                perCaseAmount+=itemTotal;
                return `
                    <div style="background:var(--bg);padding:.75rem;margin-bottom:.5rem;border:1px solid var(--border)">
                        <div style="font-weight:600;margin-bottom:.25rem">${item.name}</div>
                        <div style="font-size:.85rem;color:var(--text-secondary)"><span class="badge badge-gold">ê±´ë‹¹ ${formatCurrency(item.price||0)}</span></div>
                        <div style="font-size:1rem;font-weight:700;color:var(--primary);margin-top:.5rem">${count}ê±´ = ${formatCurrency(itemTotal)}</div>
                    </div>
                `;
            }).join('')||'<div style="text-align:center;color:var(--text-muted);padding:1rem">ë“±ë¡ëœ ê±´ë³„ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>';
            
            // ì¸ì„¼í‹°ë¸Œ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
            document.getElementById('incItemSelect').innerHTML='<option value="">í•­ëª© ì„ íƒ</option>'+incentiveItems.filter(i=>i.type==='perCase').map(i=>`<option value="${i.id}">${i.name} (${formatCurrency(i.price||0)}/ê±´)</option>`).join('');
        }else{
            document.getElementById('myIncentiveItems').innerHTML='<div style="text-align:center;color:var(--text-muted);padding:1rem">ë“±ë¡ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        }
        
        // ìƒë‹¨ í†µê³„ ì—…ë°ì´íŠ¸
        const totalAmount=salesBasedIncentive+perCaseAmount;
        document.getElementById('incTotalCount').textContent=totalCount+'ê±´';
        document.getElementById('incTotalAmount').textContent=formatCurrency(totalAmount);
        
        if(monthRecords.length>0){
            document.getElementById('incentiveRecords').innerHTML=monthRecords.map(r=>{
                const item=incentiveItems.find(i=>i.id===r.itemId);
                return `
                    <div class="list-item">
                        <div>
                            <div class="list-item-title">${item?.name||'í•­ëª©'}</div>
                            <div class="list-item-sub">${r.customerName||''} ${r.chartNo?'('+r.chartNo+')':''}</div>
                        </div>
                        <span class="badge badge-green">${r.date||''}</span>
                    </div>
                `;
            }).join('');
        }else{
            document.getElementById('incentiveRecords').innerHTML='<div style="text-align:center;color:var(--text-muted);padding:1rem">ì…ë ¥ëœ ì‹¤ì ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        }
    }
    
    function renderInfo(){
        document.getElementById('infoName').textContent=currentUser.name||'-';
        document.getElementById('infoRole').textContent=roleLabels[currentUser.role]||currentUser.role||'-';
        document.getElementById('infoJoinDate').textContent=currentUser.joinDate||'-';
        document.getElementById('infoTenure').textContent=getTenure(currentUser.joinDate);
        
        // ê¸‰ì—¬ ì›” ì„ íƒ ë“œë¡­ë‹¤ìš´
        const months=[...new Set(payrollData.map(p=>p.yearMonth))].sort().reverse();
        const select=document.getElementById('salaryMonth');
        select.innerHTML=months.length>0?months.map(m=>`<option value="${m}">${m.replace('-','ë…„ ')}ì›”</option>`).join(''):'<option value="">ë°ì´í„° ì—†ìŒ</option>';
        
        // ìƒì²´ì¸ì‹ ìƒíƒœ í‘œì‹œ
        const bioStatus=document.getElementById('biometricStatus');
        const hasCredential=localStorage.getItem('lumi_biometric_credential');
        if(hasCredential){
            bioStatus.innerHTML='âœ… ë“±ë¡ë¨ - <a href="#" onclick="removeBiometric();return false;" style="color:var(--red)">í•´ì œ</a>';
        }else if(!window.PublicKeyCredential){
            bioStatus.textContent='âš ï¸ ì´ ë¸Œë¼ìš°ì €ì—ì„œ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤';
            document.getElementById('biometricRegisterBtn').style.display='none';
        }else{
            bioStatus.textContent='ë¯¸ë“±ë¡';
        }
        
        renderSalary();
    }
    
    function removeBiometric(){
        if(confirm('ìƒì²´ì¸ì‹ ë“±ë¡ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
            localStorage.removeItem('lumi_biometric_credential');
            localStorage.removeItem('lumi_biometric_user');
            renderInfo();
            alert('ìƒì²´ì¸ì‹ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
    }
    
    function renderSalary(){
        const ym=document.getElementById('salaryMonth').value||getYM();
        document.getElementById('salaryTitle').textContent=ym.replace('-','ë…„ ')+'ì›” ê¸‰ì—¬ ì •ë³´';
        
        const myPayroll=payrollData.find(p=>(p.yearMonth===ym)&&(p.name===currentUser.name||p.name===currentUser.matchName));
        if(myPayroll){
            // ë…¸ë¬´ì‚¬ì—ì„œ ë°›ì€ ê¸‰ì—¬ëŒ€ì¥ ë°ì´í„°ê°€ ìˆìœ¼ë©´ í‘œì‹œ
            document.getElementById('infoNetPay').textContent=formatCurrency(myPayroll.netPay);
            // OTìˆ˜ë‹¹ = ì¶”ê°€ì—°ì¥ìˆ˜ë‹¹ í•„ë“œ (ì¤‘ìš”!)
            document.getElementById('infoOT').textContent=formatCurrency(myPayroll.extraOT||myPayroll.additionalOT||0);
            document.getElementById('infoIncentive').textContent=formatCurrency(myPayroll.incentive||0);
        }else{
            // ê¸‰ì—¬ëŒ€ì¥ ì—†ìœ¼ë©´ ì§ì ‘ ê³„ì‚°í•œ ì˜ˆìƒ ê°’ í‘œì‹œ
            const monthOT=lunchOT.filter(ot=>ot.date?.startsWith(ym));
            const monthAtt=attendance.filter(a=>a.date?.startsWith(ym));
            const lunchMinutes=monthOT.reduce((sum,ot)=>sum+(ot.minutes||0),0);
            let afterMinutes=0;
            monthAtt.forEach(a=>{
                if(a.checkOut){
                    const [h,m]=(a.checkOut||'00:00').split(':').map(Number);
                    const checkOutMin=h*60+m;
                    const endMin2=getWorkEndMin(a.date); // v2.0 ë™ì 
                    if(checkOutMin>endMin2)afterMinutes+=checkOutMin-endMin2;
                }
            });
            const totalOTMinutes=lunchMinutes+afterMinutes;
            const hourly=currentUser.hourly||12000;
            const estimatedOT=Math.round((totalOTMinutes/60)*hourly*1.5);
            
            // ì¸ì„¼í‹°ë¸Œ ê³„ì‚°
            const monthRecords=incentiveRecords.filter(r=>r.yearMonth===ym);
            let estimatedIncentive=0;
            incentiveItems.forEach(item=>{
                if(item.type!=='japanSales'){
                    const count=monthRecords.filter(r=>r.itemId===item.id).length;
                    estimatedIncentive+=count*(item.price||0);
                }
            });
            
            document.getElementById('infoNetPay').textContent='ë¯¸í™•ì •';
            document.getElementById('infoOT').textContent=formatCurrency(estimatedOT)+' (ì˜ˆìƒ)';
            document.getElementById('infoIncentive').textContent=formatCurrency(estimatedIncentive)+' (ì˜ˆìƒ)';
        }
    }
    
    // Actions v2.1
    let _checkInBusy=false, _checkOutBusy=false;
    
    async function checkIn(){
        if(_checkInBusy) return;
        
        // ìƒíƒœ ì¬í™•ì¸ (ë©”ëª¨ë¦¬)
        const today=getToday();
        const todayAtt=attendance.find(a=>a.date===today);
        if(todayAtt && todayAtt.checkIn){
            alert('ì´ë¯¸ ì¶œê·¼ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. ('+todayAtt.checkIn+')');
            renderAttendance();
            return;
        }
        
        if(!userLocation){
            alert('ìœ„ì¹˜ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
            checkLocation();
            return;
        }
        
        const dist=getDistance(userLocation.lat,userLocation.lng,CLINIC_LAT,CLINIC_LNG);
        if(dist>CLINIC_RADIUS){
            alert(`í´ë¦¬ë‹‰ ë²”ìœ„ ë°–ì…ë‹ˆë‹¤. (í˜„ì¬ ${Math.round(dist)}m)\n${CLINIC_RADIUS}m ì´ë‚´ì—ì„œ ì¶œê·¼í•´ì£¼ì„¸ìš”.`);
            return;
        }
        
        if(!confirm('ì¶œê·¼í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        
        // ì¦‰ì‹œ ë¹„í™œì„± (ë”ë¸”í´ë¦­ ë°©ì§€)
        _checkInBusy=true;
        const inBtn=document.getElementById('checkInBtn');
        inBtn.disabled=true;
        inBtn.querySelector('.att-v2-label').textContent='ì²˜ë¦¬ ì¤‘...';
        
        try{
            // ì„œë²„ì—ì„œ ë‹¤ì‹œ í•œë²ˆ í™•ì¸ (race condition ë°©ì§€)
            const existing=await db.collection('attendance')
                .where('employeeId','==',currentUser.id)
                .where('date','==',today)
                .limit(1).get();
            
            if(!existing.empty && existing.docs[0].data().checkIn){
                alert('ì´ë¯¸ ì¶œê·¼ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                await loadAttendance();
                renderAttendance();
                return;
            }
            
            const now=new Date();
            const time=now.toTimeString().substring(0,5);
            const h=now.getHours(),m=now.getMinutes();
            const status=(h*60+m > ATT_LATE_H*60+ATT_LATE_M)?'late':'normal';
            
            await db.collection('attendance').add({
                employeeId:currentUser.id,
                employeeName:currentUser.name,
                date:today,
                checkIn:time,
                status:status,
                location:{lat:userLocation.lat,lng:userLocation.lng},
                createdAt:firebase.firestore.FieldValue.serverTimestamp()
            });
            alert('ì¶œê·¼ ì™„ë£Œ: '+time+(status==='late'?' (ì§€ê°)':''));
            await loadAttendance();
            renderAttendance();
        }catch(e){
            alert('ì¶œê·¼ ì‹¤íŒ¨: '+e.message);
            renderAttendance();
        }finally{
            _checkInBusy=false;
            inBtn.querySelector('.att-v2-label').textContent='ì¶œê·¼';
        }
    }
    
    async function checkOut(){
        if(_checkOutBusy) return;
        
        const today=getToday();
        const todayAtt=attendance.find(a=>a.date===today);
        
        if(!todayAtt || !todayAtt.checkIn){
            alert('ì˜¤ëŠ˜ ì¶œê·¼ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        if(todayAtt.checkOut){
            alert('ì´ë¯¸ í‡´ê·¼ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. ('+todayAtt.checkOut+')');
            renderAttendance();
            return;
        }
        
        if(!userLocation){
            alert('ìœ„ì¹˜ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            checkLocation();
            return;
        }
        
        const dist=getDistance(userLocation.lat,userLocation.lng,CLINIC_LAT,CLINIC_LNG);
        if(dist>CLINIC_RADIUS){
            alert(`í´ë¦¬ë‹‰ ë²”ìœ„ ë°–ì…ë‹ˆë‹¤. (í˜„ì¬ ${Math.round(dist)}m)`);
            return;
        }
        
        if(!confirm('í‡´ê·¼í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        
        // ì¦‰ì‹œ ë¹„í™œì„±
        _checkOutBusy=true;
        const outBtn=document.getElementById('checkOutBtn');
        outBtn.disabled=true;
        outBtn.querySelector('.att-v2-label').textContent='ì²˜ë¦¬ ì¤‘...';
        
        try{
            const now=new Date();
            const time=now.toTimeString().substring(0,5);
            const hh=now.getHours(),mm2=now.getMinutes();
            const newStatus=(hh*60+mm2<getWorkEndMin(today))?'early':todayAtt.status;
            
            await db.collection('attendance').doc(todayAtt.id).update({
                checkOut:time,
                status:newStatus
            });
            alert('í‡´ê·¼ ì™„ë£Œ: '+time+(newStatus==='early'?' (ì¡°í‡´)':''));
            await loadAttendance();
            renderAttendance();
        }catch(e){
            alert('í‡´ê·¼ ì‹¤íŒ¨: '+e.message);
            renderAttendance();
        }finally{
            _checkOutBusy=false;
            outBtn.querySelector('.att-v2-label').textContent='í‡´ê·¼';
        }
    }
    
    function openModal(id){document.getElementById(id).classList.add('active');}
    function closeModal(id){document.getElementById(id).classList.remove('active');}
    
    // ===== í‡´ê·¼ ëˆ„ë½ ê°ì§€ v2.1 =====
    let _missedRecord=null;
    
    function checkMissedClockOut(){
        const today=getToday();
        const d=new Date();
        d.setDate(d.getDate()-1);
        const yesterday=d.toISOString().split('T')[0];
        
        // ì–´ì œ ì¶œê·¼í–ˆëŠ”ë° í‡´ê·¼ ì•ˆ ì°ì€ ê¸°ë¡ ì°¾ê¸°
        const missed=attendance.find(a=>a.date===yesterday && a.checkIn && !a.checkOut);
        const alert_el=document.getElementById('missedClockOutAlert');
        
        if(missed){
            _missedRecord=missed;
            document.getElementById('missedDateLabel').textContent=`${yesterday} í‡´ê·¼ ì‹œê°„:`;
            alert_el.style.display='block';
        }else{
            _missedRecord=null;
            alert_el.style.display='none';
        }
    }
    
    async function submitMissedClockOut(){
        if(!_missedRecord) return;
        const timeInput=document.getElementById('missedClockOutTime').value;
        if(!timeInput){
            alert('í‡´ê·¼ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        if(!confirm(`${_missedRecord.date} í‡´ê·¼ ì‹œê°„ì„ ${timeInput}ìœ¼ë¡œ ì…ë ¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€» ë‹¨ì²´ LINEë°©ì— ë‚¨ê¸´ ì‹œê°„ê³¼ ë™ì¼í•´ì•¼ í•©ë‹ˆë‹¤.`)) return;
        
        try{
            // ì¡°í‡´ ì—¬ë¶€ ê³„ì‚°
            const [hh,mm]=timeInput.split(':').map(Number);
            const endMin=getWorkEndMin(_missedRecord.date);
            const newStatus=(hh*60+mm<endMin)?'early':_missedRecord.status;
            
            await db.collection('attendance').doc(_missedRecord.id).update({
                checkOut:timeInput,
                status:newStatus==='early'?'early':(newStatus||'normal'),
                manualCorrection:true,
                correctionNote:'í‡´ê·¼ ëˆ„ë½ - ë³¸ì¸ ì…ë ¥',
                correctedAt:firebase.firestore.FieldValue.serverTimestamp()
            });
            alert('í‡´ê·¼ ì‹œê°„ì´ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤: '+timeInput);
            _missedRecord=null;
            document.getElementById('missedClockOutAlert').style.display='none';
            await loadAttendance();
            renderAttendance();
        }catch(e){
            alert('ì €ì¥ ì‹¤íŒ¨: '+e.message);
        }
    }
    
    function dismissMissedAlert(){
        document.getElementById('missedClockOutAlert').style.display='none';
    }
    
    // ===== ì ì‹¬ OT v2.0 =====
    function updateLunchOTHint(){
        const DAY_KO=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
        const dateVal=document.getElementById('lunchOTDate').value;
        const hint=document.getElementById('lunchOTDayHint');
        if(!hint) return;
        if(!dateVal){hint.textContent='';return;}
        const day=new Date(dateVal).getDay();
        const s=DAY_SCHEDULE[day]??DAY_SCHEDULE[1];
        if(!s.work){
            hint.innerHTML=`${DAY_KO[day]}ìš”ì¼ì€ íœ´ë¬´ì…ë‹ˆë‹¤.`;
            hint.style.color='var(--red)';
        } else {
            hint.innerHTML=`${DAY_KO[day]}ìš”ì¼ ì •ê·œí‡´ê·¼ <strong>${s.endH}:${String(s.endM).padStart(2,'0')}</strong>`;
            hint.style.color='var(--text-muted)';
        }
    }

    function openLunchOTModal(){
        document.getElementById('lunchOTDate').value=getToday();
        document.getElementById('lunchOTMinutes').value='30';
        document.getElementById('lunchOTReason').value='';
        updateLunchOTHint();
        openModal('lunchOTModal');
        setTimeout(()=>document.getElementById('lunchOTMinutes')?.select(),150);
    }
    
    async function saveLunchOT(){
        const date=document.getElementById('lunchOTDate').value;
        const minutes=parseInt(document.getElementById('lunchOTMinutes').value)||0;
        const reason=document.getElementById('lunchOTReason').value.trim();
        if(!date||minutes<=0){alert('ë‚ ì§œì™€ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}
        try{
            await db.collection('lunchOT').add({
                employeeId:currentUser.id,
                employeeName:currentUser.name,
                date:date,
                minutes:minutes,
                reason:reason||'ì ì‹¬ì‹œê°„ OT',
                createdAt:firebase.firestore.FieldValue.serverTimestamp()
            });
            closeModal('lunchOTModal');
            alert(`âœ… ì ì‹¬ OT ì €ì¥\n${date} / ${minutes}ë¶„`);
            await loadLunchOT();
            renderOT();
        }catch(e){alert('ì €ì¥ ì‹¤íŒ¨: '+e.message);}
    }

    async function deleteLunchOTItem(id){
        if(!confirm('ì´ ì ì‹¬ OT ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
        try{
            await db.collection('lunchOT').doc(id).delete();
            lunchOT=lunchOT.filter(o=>o.id!==id);
            renderOT();
        }catch(e){alert('ì‚­ì œ ì‹¤íŒ¨: '+e.message);}
    }
    
    function openMealModal(){
        document.getElementById('mealDate').value=getToday();
        document.getElementById('mealTotalAmount').value='';
        document.getElementById('mealMemo').value='';
        mealMode='even';
        mealSelectedStaff={};
        mealManualAmounts={};
        loadMealStaffList();
        setMealMode('even');
        document.getElementById('mealSplitDetail').innerHTML='';
        document.getElementById('mealValidation').innerHTML='';
        openModal('mealModal');
    }
    
    // ===== ê°œì¸ ì‹ì‚¬ ì…ë ¥ =====
    function openPersonalMealModal(){
        document.getElementById('personalMealDate').value=getToday();
        document.getElementById('personalMealAmount').value='';
        document.getElementById('personalMealMemo').value='';
        openModal('personalMealModal');
    }
    
    async function savePersonalMeal(){
        const date=document.getElementById('personalMealDate').value;
        const amount=parseInt(document.getElementById('personalMealAmount').value)||0;
        const memo=document.getElementById('personalMealMemo').value.trim();
        
        if(!date || !amount){
            alert('ë‚ ì§œì™€ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        if(amount <= 0){
            alert('ê¸ˆì•¡ì€ 0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.');
            return;
        }
        
        console.log('ğŸ“ ê°œì¸ ì‹ì‚¬ ì…ë ¥ ì‹œì‘:', {date, amount, memo});
        
        try{
            await db.runTransaction(async tx=>{
                // 1) ì§ì› ë¬¸ì„œ ì½ê¸°
                const ref=db.collection('employees').doc(currentUser.id);
                const doc=await tx.get(ref);
                
                if(!doc.exists){
                    throw new Error('ì§ì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                const data=doc.data();
                const curAllowance=data.foodAllowance!=null?data.foodAllowance:300000;
                
                // 2) ì”ì•¡ ê²€ì¦
                if(amount > curAllowance){
                    throw new Error(`ì”ì•¡ ë¶€ì¡± (ì”ì•¡ ${curAllowance.toLocaleString()}ì›, ì°¨ê° ${amount.toLocaleString()}ì›)`);
                }
                
                // 3) ì”ì•¡ ì°¨ê°
                tx.update(ref, {
                    foodAllowance: curAllowance - amount
                });
                
                // 4) mealRecords ìƒì„±
                const record = {
                    employeeId: currentUser.id,
                    employeeName: currentUser.name,
                    date: date,
                    amount: amount,
                    memo: memo || 'ê°œì¸ ì‹ì‚¬',
                    yearMonth: date.substring(0, 7),
                    groupId: null, // ê°œì¸ ì…ë ¥ì€ groupId ì—†ìŒ
                    totalAmount: amount,
                    splitMode: 'personal', // ê°œì¸ ì…ë ¥ í‘œì‹œ
                    headCount: 1,
                    createdBy: currentUser.name || currentUser.id,
                    createdAt: new Date().toISOString()
                };
                
                console.log('ğŸ“„ mealRecord ìƒì„±:', record);
                
                const mealRef = db.collection('mealRecords').doc();
                tx.set(mealRef, record);
            });
            
            console.log('âœ… Firebase íŠ¸ëœì­ì…˜ ì™„ë£Œ');
            
            // ë°ì´í„° ë¦¬ë¡œë“œ
            await loadMealRecords();
            await loadAllData(); // ì”ì•¡ ì—…ë°ì´íŠ¸
            renderMeal();
            
            console.log('âœ… ë°ì´í„° ë¦¬ë¡œë“œ ì™„ë£Œ');
            
            closeModal('personalMealModal');
            alert(`âœ… ê°œì¸ ì‹ì‚¬ê°€ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nê¸ˆì•¡: ${amount.toLocaleString()}ì›`);
            
        }catch(e){
            console.error('âŒ ê°œì¸ ì‹ì‚¬ ì…ë ¥ ì‹¤íŒ¨:', e);
            alert('ì…ë ¥ ì‹¤íŒ¨: '+e.message+'\n\në‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
    }

    let mealMode='even'; // 'even' or 'manual'
    let mealAllStaff=[];
    let mealSelectedStaff={};
    let mealManualAmounts={};

    async function loadMealStaffList(){
        try{
            const s=await db.collection('employees').where('status','==','active').get();
            mealAllStaff=s.docs.map(d=>({id:d.id,...d.data()})).filter(e=>e.id!==SHARED_ACCOUNT_ID&&e.status==='active');
        }catch(e){mealAllStaff=[];}
        renderMealStaffList();
    }

    function renderMealStaffList(){
        const container=document.getElementById('mealStaffList');
        if(!container)return;
        container.innerHTML=mealAllStaff.map(emp=>{
            const sel=!!mealSelectedStaff[emp.id];
            return `<button style="padding:.4rem .7rem;border:1px solid ${sel?'var(--primary)':'var(--border)'};background:${sel?'var(--primary)':'var(--bg-card)'};color:${sel?'#fff':'var(--text)'};font-size:.8rem;cursor:pointer;border-radius:4px" onclick="toggleMealStaff('${emp.id}')">${emp.name||emp.id}</button>`;
        }).join('');
    }

    function toggleMealStaff(id){
        if(mealSelectedStaff[id])delete mealSelectedStaff[id];
        else mealSelectedStaff[id]=true;
        renderMealStaffList();
        renderMealSplit();
    }

    function setMealMode(mode){
        mealMode=mode;
        document.getElementById('mealModeEven').className='btn '+(mode==='even'?'btn-primary':'btn-outline');
        document.getElementById('mealModeManual').className='btn '+(mode==='manual'?'btn-primary':'btn-outline');
        renderMealSplit();
    }

    function onMealTotalChange(){renderMealSplit();}

    function renderMealSplit(){
        const container=document.getElementById('mealSplitDetail');
        const selected=Object.keys(mealSelectedStaff);
        const total=parseInt(document.getElementById('mealTotalAmount').value)||0;
        if(!selected.length||!total){container.innerHTML='';validateMeal();return;}

        if(mealMode==='even'){
            const perPerson=Math.round(total/selected.length);
            container.innerHTML=selected.map(id=>{
                const emp=mealAllStaff.find(e=>e.id===id);
                const name=emp?.name||id;
                const remain=getMealRemain(id);
                const over=perPerson>remain;
                return `<div style="display:flex;justify-content:space-between;align-items:center;padding:.4rem 0;border-bottom:1px solid var(--border)">
                    <span>${name} <span style="font-size:.7rem;color:var(--text-muted)">ì”ì•¡ ${formatCurrency(remain)}</span></span>
                    <span style="font-weight:600;${over?'color:var(--red)':''}">â‚©${perPerson.toLocaleString()}${over?' âš ':''}
                    </span>
                </div>`;
            }).join('');
        }else{
            container.innerHTML=selected.map(id=>{
                const emp=mealAllStaff.find(e=>e.id===id);
                const name=emp?.name||id;
                const remain=getMealRemain(id);
                const val=mealManualAmounts[id]||'';
                return `<div style="display:flex;justify-content:space-between;align-items:center;padding:.4rem 0;border-bottom:1px solid var(--border);gap:.5rem">
                    <span style="min-width:50px">${name} <span style="font-size:.7rem;color:var(--text-muted)">ì”ì•¡ ${formatCurrency(remain)}</span></span>
                    <input type="number" value="${val}" placeholder="ê¸ˆì•¡" style="width:90px;padding:.3rem;border:1px solid var(--border);text-align:right;font-size:.9rem" oninput="mealManualAmounts['${id}']=parseInt(this.value)||0;validateMeal()">
                </div>`;
            }).join('');
        }
        validateMeal();
    }

    function getMealRemain(empId){
        // employeesì˜ foodAllowance í•„ë“œ ì‚¬ìš© (ì—†ìœ¼ë©´ mealRecords í•©ì‚° ë°©ì‹ fallback)
        const emp=mealAllStaff.find(e=>e.id===empId);
        if(emp&&emp.foodAllowance!=null)return Math.max(0,emp.foodAllowance);
        const ym=getYM();
        const used=mealRecords.filter(m=>m.employeeId===empId&&m.date?.startsWith(ym)).reduce((s,m)=>s+(m.amount||0),0);
        return Math.max(0,300000-used);
    }

    function validateMeal(){
        const el=document.getElementById('mealValidation');
        const selected=Object.keys(mealSelectedStaff);
        const total=parseInt(document.getElementById('mealTotalAmount').value)||0;
        const btn=document.getElementById('mealSaveBtn');
        if(!selected.length||!total){el.innerHTML='';btn.disabled=true;return;}

        let errors=[];
        if(mealMode==='even'){
            const pp=Math.round(total/selected.length);
            selected.forEach(id=>{
                const remain=getMealRemain(id);
                const emp=mealAllStaff.find(e=>e.id===id);
                if(pp>remain)errors.push(`${emp?.name||id}: ì”ì•¡ ì´ˆê³¼ (${formatCurrency(pp)} > ${formatCurrency(remain)})`);
            });
        }else{
            const sum=selected.reduce((s,id)=>s+(mealManualAmounts[id]||0),0);
            if(sum!==total)errors.push(`ì…ë ¥ í•©ê³„(${formatCurrency(sum)}) â‰  ì´ì•¡(${formatCurrency(total)})`);
            selected.forEach(id=>{
                const amt=mealManualAmounts[id]||0;
                const remain=getMealRemain(id);
                const emp=mealAllStaff.find(e=>e.id===id);
                if(amt>remain)errors.push(`${emp?.name||id}: ì”ì•¡ ì´ˆê³¼`);
            });
        }
        if(errors.length){
            el.innerHTML='<div style="color:var(--red)">âš  '+errors.join('<br>')+'</div>';
            btn.disabled=true;
        }else{
            el.innerHTML='<div style="color:var(--green)">âœ… ì •ì‚° ê°€ëŠ¥</div>';
            btn.disabled=false;
        }
    }

    async function saveMealGroup(){
        const date=document.getElementById('mealDate').value;
        const total=parseInt(document.getElementById('mealTotalAmount').value)||0;
        const memo=document.getElementById('mealMemo').value.trim();
        const selected=Object.keys(mealSelectedStaff);
        if(!date||!total||!selected.length){alert('ë‚ ì§œ, ê¸ˆì•¡, ì¸ì›ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}

        // ê° ì§ì›ë³„ ì°¨ê° ê¸ˆì•¡ ê³„ì‚°
        const deductions={};
        for(const empId of selected){
            if(mealMode==='even') deductions[empId]=Math.round(total/selected.length);
            else deductions[empId]=mealManualAmounts[empId]||0;
        }

        const groupId=Date.now().toString(36);
        try{
            await db.runTransaction(async tx=>{
                // 1) ëª¨ë“  ì§ì› ë¬¸ì„œ ì½ê¸°
                const empDocs={};
                for(const empId of selected){
                    const ref=db.collection('employees').doc(empId);
                    empDocs[empId]=await tx.get(ref);
                }
                // 2) ì”ì•¡ ê²€ì¦ + ì—…ë°ì´íŠ¸
                for(const empId of selected){
                    const amt=deductions[empId];
                    if(amt<=0)continue;
                    const doc=empDocs[empId];
                    const data=doc.exists?doc.data():{};
                    const curAllowance=data.foodAllowance!=null?data.foodAllowance:300000;
                    if(amt>curAllowance){
                        const name=data.name||empId;
                        throw new Error(`${name}: ì”ì•¡ ë¶€ì¡± (ì”ì•¡ ${curAllowance.toLocaleString()}ì›, ì°¨ê° ${amt.toLocaleString()}ì›)`);
                    }
                    tx.update(db.collection('employees').doc(empId),{
                        foodAllowance:curAllowance-amt
                    });
                }
                // 3) mealRecords ìƒì„±
                for(const empId of selected){
                    const amt=deductions[empId];
                    if(amt<=0)continue;
                    const ref=db.collection('mealRecords').doc();
                    tx.set(ref,{
                        employeeId:empId,
                        employeeName:mealAllStaff.find(e=>e.id===empId)?.name||empId,
                        date,amount:amt,memo,
                        yearMonth:date.substring(0,7),
                        groupId,totalAmount:total,
                        splitMode:mealMode,headCount:selected.length,
                        createdBy:currentUser?.name||currentUser?.id||'staff',
                        createdAt:new Date().toISOString()
                    });
                }
            });
            closeModal('mealModal');
            alert('âœ… '+selected.length+'ëª… ì‹ëŒ€ ì •ì‚° ì™„ë£Œ');
            await loadMealRecords();
            await loadMealStaffList(); // employees ì”ì•¡ ì¬ë¡œë“œ
            renderMeal();
        }catch(e){alert('ì •ì‚° ì‹¤íŒ¨: '+e.message);}
    }
    
    function openLeaveModal(){
        selectedLeaveDates=[];
        document.getElementById('leaveType').value='ì—°ì°¨';
        document.getElementById('leaveDateInput').value='';
        document.getElementById('leaveReason').value='';
        renderLeaveDates();
        openModal('leaveModal');
    }
    
    function addLeaveDate(){
        const date=document.getElementById('leaveDateInput').value;
        if(!date){alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');return;}
        if(selectedLeaveDates.includes(date)){alert('ì´ë¯¸ ì¶”ê°€ëœ ë‚ ì§œì…ë‹ˆë‹¤.');return;}
        selectedLeaveDates.push(date);
        selectedLeaveDates.sort();
        document.getElementById('leaveDateInput').value='';
        renderLeaveDates();
    }
    
    function removeLeaveDate(date){
        selectedLeaveDates=selectedLeaveDates.filter(d=>d!==date);
        renderLeaveDates();
    }
    
    function renderLeaveDates(){
        const container=document.getElementById('leaveDateTags');
        container.innerHTML=selectedLeaveDates.length>0?selectedLeaveDates.map(d=>`<div class="date-tag">${d}<button class="date-tag-remove" onclick="removeLeaveDate('${d}')">&times;</button></div>`).join(''):'<span style="color:var(--text-muted);font-size:.85rem">ë‚ ì§œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”</span>';
    }
    
    async function submitLeave(){
        const type=document.getElementById('leaveType').value;
        const reason=document.getElementById('leaveReason').value.trim();
        
        if(selectedLeaveDates.length===0){alert('ë‚ ì§œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.');return;}
        
        try{
            await db.collection('leaveRequests').add({
                employeeId:currentUser.id,
                employeeName:currentUser.name,
                type:type,
                dates:selectedLeaveDates,
                reason:reason,
                status:'pending',
                createdAt:firebase.firestore.FieldValue.serverTimestamp()
            });
            closeModal('leaveModal');
            alert('ì—°ì°¨ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            await loadLeaveRequests();
            renderLeave();
        }catch(e){alert('ì‹ ì²­ ì‹¤íŒ¨: '+e.message);}
    }
    
    function openIncentiveModal(){
        document.getElementById('incCustomerName').value='';
        document.getElementById('incChartNo').value='';
        openModal('incentiveModal');
    }
    
    async function addIncentiveRecord(){
        const itemId=document.getElementById('incItemSelect').value;
        const customerName=document.getElementById('incCustomerName').value.trim();
        const chartNo=document.getElementById('incChartNo').value.trim();
        
        if(!itemId){alert('í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');return;}
        if(!customerName){alert('ê³ ê°ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}
        
        try{
            await db.collection('incentiveRecords').add({
                employeeId:currentUser.id,
                employeeName:currentUser.name,
                itemId:itemId,
                customerName:customerName,
                chartNo:chartNo,
                date:getToday(),
                yearMonth:getYM(),
                createdAt:firebase.firestore.FieldValue.serverTimestamp()
            });
            alert('ì‹¤ì ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            document.getElementById('incCustomerName').value='';
            document.getElementById('incChartNo').value='';
            await loadIncentiveRecords();
            renderIncentive();
        }catch(e){alert('ì €ì¥ ì‹¤íŒ¨: '+e.message);}
    }
    
    // ===== ì¬ê³  ì‹¤ì‚¬ ì‹œìŠ¤í…œ =====
    const INV_CATEGORIES={nursing:'ê°„í˜¸',skin:'í”¼ë¶€',desk:'ë°ìŠ¤í¬',common:'ê³µí†µ'};
    const CAT_ICONS={nursing:'ğŸ’‰',skin:'âœ¨',desk:'ğŸ–¥ï¸',common:'ğŸ“'};
    let invItems=[];
    let auditInputs={}; // {itemId: {locId: qty, ...}} - ì¥ì†Œë³„ ì‹¤ì‚¬ê°’
    let lastWeekAudits={}; // {itemId: lastAuditData}
    let currentInvCat=''; // '' = ì „ì²´
    let currentAuditLocation=''; // '' = ì „ì²´ ì¥ì†Œ

    async function loadInventoryForStaff(){
        try{
            const s=await db.collection('inventory').orderBy('name').get();
            invItems=s.docs.map(d=>({id:d.id,...d.data()}));
            await updateAuditLocationFilter();
        }catch(e){console.error('Load inv:',e);}
    }
    
    async function updateAuditLocationFilter(){
        const select=document.getElementById('invAuditLocationFilter');
        if(!select)return;
        try{
            const snapshot=await db.collection('locations').orderBy('order').get();
            const locationList=snapshot.docs.map(d=>({id:d.id,name:d.data().name}));
            locationList.sort((a,b)=>{
                const floorA=a.name.startsWith('5ì¸µ')?0:1;
                const floorB=b.name.startsWith('5ì¸µ')?0:1;
                if(floorA!==floorB)return floorA-floorB;
                return a.name.localeCompare(b.name,'ko');
            });
            select.innerHTML='<option value="">ì „ì²´ ì¥ì†Œ (ëª¨ë“  í’ˆëª©)</option>'+
                locationList.map(loc=>`<option value="${loc.id}">${loc.name}</option>`).join('');
        }catch(e){console.error('ì¥ì†Œ ë¡œë“œ:',e);}
    }
    
    // ===== ì¥ì†Œ ê´€ë¦¬ =====
    async function openLocationManageModal(){
        await loadLocationsList();
        openModal('locationManageModal');
    }
    
    async function loadLocationsList(){
        const container=document.getElementById('locationsList');
        if(!container)return;
        
        try{
            const snapshot=await db.collection('locations').orderBy('order').get();
            const locs=snapshot.docs.map(d=>({id:d.id,...d.data()}));
            
            if(locs.length===0){
                container.innerHTML='<div style="text-align:center;color:var(--text-muted);padding:2rem">ë“±ë¡ëœ ì¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤<br><br>ìœ„ì—ì„œ ìƒˆ ì¥ì†Œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”</div>';
                return;
            }
            
            // ì¸µë³„ ê·¸ë£¹í•‘
            const floor5=locs.filter(l=>l.name.startsWith('5ì¸µ')).sort((a,b)=>a.name.localeCompare(b.name,'ko'));
            const floor6=locs.filter(l=>l.name.startsWith('6ì¸µ')).sort((a,b)=>a.name.localeCompare(b.name,'ko'));
            
            let html='';
            
            if(floor5.length>0){
                html+='<div style="font-weight:600;font-size:.8rem;color:var(--text-secondary);margin-top:.5rem;padding:.5rem;background:var(--bg);border-radius:4px">5ì¸µ</div>';
                floor5.forEach(loc=>{
                    html+=`<div style="display:flex;justify-content:space-between;align-items:center;padding:.5rem;border-bottom:1px solid var(--border)">
                        <span style="font-size:.9rem">${loc.name}</span>
                        <button onclick="deleteLocation('${loc.id}','${loc.name.replace(/'/g,"\\'")}')" 
                                style="background:var(--red);color:#fff;border:none;padding:.3rem .6rem;border-radius:4px;font-size:.75rem;cursor:pointer">ì‚­ì œ</button>
                    </div>`;
                });
            }
            
            if(floor6.length>0){
                html+='<div style="font-weight:600;font-size:.8rem;color:var(--text-secondary);margin-top:.5rem;padding:.5rem;background:var(--bg);border-radius:4px">6ì¸µ</div>';
                floor6.forEach(loc=>{
                    html+=`<div style="display:flex;justify-content:space-between;align-items:center;padding:.5rem;border-bottom:1px solid var(--border)">
                        <span style="font-size:.9rem">${loc.name}</span>
                        <button onclick="deleteLocation('${loc.id}','${loc.name.replace(/'/g,"\\'")}')" 
                                style="background:var(--red);color:#fff;border:none;padding:.3rem .6rem;border-radius:4px;font-size:.75rem;cursor:pointer">ì‚­ì œ</button>
                    </div>`;
                });
            }
            
            container.innerHTML=html;
        }catch(e){
            console.error('ì¥ì†Œ ë¡œë“œ ì‹¤íŒ¨:',e);
            container.innerHTML='<div style="text-align:center;color:var(--red);padding:2rem">ì¥ì†Œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
        }
    }
    
    async function addLocation(){
        const floor=document.getElementById('newLocationFloor').value;
        const name=document.getElementById('newLocationName').value.trim();
        
        if(!name){
            alert('ì¥ì†Œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
            return;
        }
        
        const fullName=`${floor}-${name}`;
        
        try{
            // ì¤‘ë³µ í™•ì¸
            const existing=await db.collection('locations').where('name','==',fullName).get();
            if(!existing.empty){
                alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì¥ì†Œì…ë‹ˆë‹¤');
                return;
            }
            
            // í˜„ì¬ ìµœëŒ€ order ê°’ ì°¾ê¸°
            const allLocs=await db.collection('locations').orderBy('order','desc').limit(1).get();
            const maxOrder=allLocs.empty?0:allLocs.docs[0].data().order||0;
            
            // ìƒˆ ì¥ì†Œ ì¶”ê°€
            await db.collection('locations').add({
                name:fullName,
                floor:floor,
                order:maxOrder+1,
                createdAt:new Date().toISOString(),
                createdBy:currentUser?.name||'staff'
            });
            
            // ì…ë ¥ ì´ˆê¸°í™”
            document.getElementById('newLocationName').value='';
            
            // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            await loadLocationsList();
            await updateAuditLocationFilter();
            
            alert('âœ… ì¥ì†Œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
        }catch(e){
            alert('ì¶”ê°€ ì‹¤íŒ¨: '+e.message);
        }
    }
    
    async function deleteLocation(locId,locName){
        if(!confirm(`"${locName}" ì¥ì†Œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì£¼ì˜: ì´ ì¥ì†Œë¥¼ ì‚¬ìš©í•˜ëŠ” í’ˆëª©ì˜ ì¬ê³  ì •ë³´ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`))return;
        
        try{
            // ì¥ì†Œ ì‚­ì œ
            await db.collection('locations').doc(locId).delete();
            
            // í’ˆëª©ì˜ locations í•„ë“œì—ì„œ í•´ë‹¹ ì¥ì†Œ ì œê±°
            const items=await db.collection('inventory').get();
            const batch=db.batch();
            
            items.docs.forEach(doc=>{
                const data=doc.data();
                if(data.locations&&data.locations[locId]){
                    const newLocs={...data.locations};
                    delete newLocs[locId];
                    const newTotal=Object.values(newLocs).reduce((sum,qty)=>sum+qty,0);
                    batch.update(doc.ref,{
                        locations:newLocs,
                        totalStock:newTotal,
                        currentStock:newTotal
                    });
                }
            });
            
            await batch.commit();
            
            // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            await loadLocationsList();
            await updateAuditLocationFilter();
            await loadInventoryForStaff();
            renderInvAuditList();
            
            alert('âœ… ì¥ì†Œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        }catch(e){
            alert('ì‚­ì œ ì‹¤íŒ¨: '+e.message);
        }
    }

    async function loadLastWeekAudits(){
        try{
            const oneWeekAgo=new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate()-14);
            const s=await db.collection('inventoryAudits')
                .where('createdAt','>=',oneWeekAgo.toISOString())
                .orderBy('createdAt','desc').limit(500).get();
            lastWeekAudits={};
            s.docs.forEach(d=>{
                const data=d.data();
                if(!lastWeekAudits[data.itemId])lastWeekAudits[data.itemId]=data;
            });
        }catch(e){console.error('Load audits:',e);}
    }

    function renderInvCatButtons(){
        const container=document.getElementById('invCatButtons');
        if(!container)return;
        const cats=[{key:'',label:'ì „ì²´',icon:'ğŸ“‹'},{key:'nursing',label:'ê°„í˜¸',icon:'ğŸ’‰'},{key:'skin',label:'í”¼ë¶€',icon:'âœ¨'},{key:'desk',label:'ë°ìŠ¤í¬',icon:'ğŸ–¥ï¸'},{key:'common',label:'ê³µí†µ',icon:'ğŸ“'}];
        container.innerHTML=cats.map(c=>{
            const count=c.key?invItems.filter(i=>i.category===c.key).length:invItems.length;
            return `<div class="inv-cat-btn ${currentInvCat===c.key?'active':''}" onclick="setInvCat('${c.key}')">
                <span class="cat-icon">${c.icon}</span>${c.label}<span class="cat-count">${count}ê°œ</span>
            </div>`;
        }).join('');
    }

    function setInvCat(cat){
        currentInvCat=cat;
        renderInvCatButtons();
        renderInvAuditList();
    }

    function renderInvAuditList(){
        const container=document.getElementById('invAuditList');
        if(!container)return;
        
        let items=invItems;
        
        // ê²€ìƒ‰ í•„í„°
        const searchTerm = document.getElementById('invSearchInput')?.value?.trim().toLowerCase();
        if(searchTerm){
            items = items.filter(i => (i.name || '').toLowerCase().includes(searchTerm));
        }
        
        // ì¹´í…Œê³ ë¦¬ í•„í„°
        if(currentInvCat){
            items=items.filter(i=>i.category===currentInvCat);
        }
        
        // ì¥ì†Œ í•„í„°
        if(currentAuditLocation){
            items=items.filter(i=>{
                // locations ê°ì²´ í™•ì¸
                if(i.locations){
                    const qty=i.locations[currentAuditLocation];
                    return qty&&qty>0;
                }
                // êµ¬ í˜•ì‹ location í•„ë“œ í™•ì¸
                if(i.location === currentAuditLocation){
                    return true;
                }
                return false;
            });
        }
        
        // ì •ë ¬
        const sortBy = document.getElementById('invSortBy')?.value || 'name';
        if(sortBy === 'name'){
            items.sort((a,b)=>(a.name||'').localeCompare(b.name||'','ko'));
        }else if(sortBy === 'location'){
            items.sort((a,b)=>{
                const locA = getFirstLocation(a);
                const locB = getFirstLocation(b);
                return locA.localeCompare(locB,'ko');
            });
        }else if(sortBy === 'stock-low'){
            items.sort((a,b)=>(a.currentStock||0) - (b.currentStock||0));
        }else if(sortBy === 'stock-high'){
            items.sort((a,b)=>(b.currentStock||0) - (a.currentStock||0));
        }
        
        if(!items.length){
            const msg=searchTerm ? 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.' : 
                      currentAuditLocation ? 'ì„ íƒí•œ ì¥ì†Œì— í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.' : 
                      'ë“±ë¡ëœ í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.';
            container.innerHTML=`<div style="text-align:center;color:var(--text-muted);padding:2rem">${msg}</div>`;
            return;
        }

        container.innerHTML=items.map(item=>{
            const lastAudit=lastWeekAudits[item.id];
            const lastQty=lastAudit?lastAudit.actualStock:null;
            const lastDate=lastAudit?new Date(lastAudit.createdAt).toLocaleDateString('ko-KR',{month:'short',day:'numeric'}):'';
            const itemAuditInputs=auditInputs[item.id]||{};
            const isSaved=Object.values(itemAuditInputs).some(v=>v!=null&&v!=='');
            const catLabel=INV_CATEGORIES[item.category]||'';
            const isLow=item.safetyStock&&item.currentStock<item.safetyStock;
            const sysStock=item.currentStock||0;
            const buyLink=item.purchaseLink?`<a href="${item.purchaseLink}" target="_blank" style="display:inline-block;background:#f0f0f0;color:#333;font-size:.65rem;padding:2px 6px;border-radius:3px;text-decoration:none;margin-left:4px;vertical-align:middle">ğŸ›’</a>`:'';
            const lowBg=isLow?'background:rgba(255,152,0,0.08);border-left:3px solid #ff9800':'';

            // ì¥ì†Œë³„ ì‹¤ì‚¬ ì…ë ¥ rows ìƒì„±
            let locRows='';
            const itemLocs=item.locations&&Object.keys(item.locations).length>0?item.locations:{};
            const hasLocData=Object.keys(itemLocs).length>0;

            if(hasLocData){
                const sortedLocs=Object.entries(itemLocs)
                    .sort(([aId],[bId])=>{
                        const aIs5=aId.startsWith('5ì¸µ')?0:1;
                        const bIs5=bId.startsWith('5ì¸µ')?0:1;
                        if(aIs5!==bIs5)return aIs5-bIs5;
                        return aId.localeCompare(bId,'ko');
                    });
                locRows=sortedLocs.map(([locId,sysQty])=>{
                    const safeLocId=locId.replace(/[^a-zA-Z0-9]/g,'_');
                    const inputVal=itemAuditInputs[locId];
                    const isFilled=inputVal!=null&&inputVal!=='';
                    return `<div class="inv-loc-input-row${isFilled?' loc-filled':''}" id="inv-loc-row-${item.id}-${safeLocId}">
                        <span class="inv-loc-label">ğŸ“ ${locId}</span>
                        <span class="inv-loc-sys">ì‹œìŠ¤í…œ: ${sysQty}</span>
                        <input type="number" class="inv-stock-input"
                            id="inv-input-${item.id}-${safeLocId}"
                            placeholder="-" step="0.01" min="0"
                            value="${inputVal!=null?inputVal:''}"
                            onchange="onInvInput('${item.id}','${locId.replace(/'/g,"\\'")}',this.value)"
                            oninput="onInvInputLive('${item.id}','${locId.replace(/'/g,"\\'")}',this.value)"
                            inputmode="decimal">
                        <span class="inv-stock-unit">${item.unit||'ê°œ'}</span>
                    </div>`;
                }).join('');
            }else{
                // êµ¬í˜• ë‹¨ì¼ ìœ„ì¹˜ ë°ì´í„°
                const inputVal=itemAuditInputs['__total__'];
                const isFilled=inputVal!=null&&inputVal!=='';
                const locLabel=item.location||'ìœ„ì¹˜ ë¯¸ì§€ì •';
                locRows=`<div class="inv-loc-input-row${isFilled?' loc-filled':''}" id="inv-loc-row-${item.id}-__total__">
                    <span class="inv-loc-label">ğŸ“ ${locLabel}</span>
                    <span class="inv-loc-sys">ì‹œìŠ¤í…œ: ${sysStock}</span>
                    <input type="number" class="inv-stock-input"
                        id="inv-input-${item.id}-__total__"
                        placeholder="-" step="0.01" min="0"
                        value="${inputVal!=null?inputVal:''}"
                        onchange="onInvInput('${item.id}','__total__',this.value)"
                        oninput="onInvInputLive('${item.id}','__total__',this.value)"
                        inputmode="decimal">
                    <span class="inv-stock-unit">${item.unit||'ê°œ'}</span>
                </div>`;
            }

            return `<div class="inv-item-row ${isSaved?'saved':''}" id="inv-row-${item.id}" style="${lowBg}">
                <div class="inv-item-row-header">
                    <div class="inv-item-info">
                        <div class="inv-item-name">${item.name}${buyLink}${isLow?' <span style="display:inline-block;background:var(--red);color:#fff;font-size:.6rem;padding:1px 5px;border-radius:3px;vertical-align:middle;margin-left:4px">ë°œì£¼í•„ìš”</span>':'' }</div>
                        <div class="inv-item-meta">
                            <span>${catLabel}</span>
                            <span>ì´ ì¬ê³ : <strong>${sysStock}</strong> ${item.unit||'ê°œ'}</span>
                            ${isLow?`<span style="color:var(--red)">ì•ˆì „: ${item.safetyStock}</span>`:''}
                            ${lastQty!=null?`<span>ì§€ë‚œì‹¤ì‚¬: ${lastQty} (${lastDate})</span>`:''}
                            ${item.lastReceiveDate?`<span style="color:var(--green)">ìµœê·¼ì…ê³ : ${item.lastReceiveDate}</span>`:''}
                            <button onclick="openReceiveItemModal('${item.id}')" style="background:none;border:1px solid var(--green);color:var(--green);font-size:.6rem;padding:1px 6px;border-radius:3px;cursor:pointer">ğŸ“¥ ì…ê³ </button>
                            <button onclick="openEditItemModal('${item.id}')" style="background:none;border:1px solid #ccc;color:#666;font-size:.6rem;padding:1px 6px;border-radius:3px;cursor:pointer;margin-left:3px">âœï¸ ìˆ˜ì •</button>
                            <button onclick="deleteInventoryItem('${item.id}','${item.name.replace(/'/g,"\\'")}' )" style="background:none;border:1px solid var(--red);color:var(--red);font-size:.6rem;padding:1px 6px;border-radius:3px;cursor:pointer;margin-left:3px">ğŸ—‘ï¸ ì‚­ì œ</button>
                        </div>
                    </div>
                </div>
                <div class="inv-loc-inputs">${locRows}</div>
            </div>`;
        }).join('');

        updateInvProgress();
    }
    
    // í’ˆëª©ì˜ ì²« ë²ˆì§¸ ì¥ì†Œ ê°€ì ¸ì˜¤ê¸° (ì •ë ¬ìš©)
    function getFirstLocation(item){
        if(item.locations && Object.keys(item.locations).length > 0){
            const locs = Object.keys(item.locations).filter(loc => item.locations[loc] > 0);
            return locs.length > 0 ? locs[0] : '';
        }
        return item.location || '';
    }
    
    // í†µí•© í•„í„°ë§ í•¨ìˆ˜
    function filterInventoryItems(){
        currentAuditLocation = document.getElementById('invAuditLocationFilter')?.value || '';
        renderInvAuditList();
    }

    function onInvInputLive(itemId,locId,val){
        if(!auditInputs[itemId])auditInputs[itemId]={};
        if(val===''||val==null){
            delete auditInputs[itemId][locId];
            if(Object.keys(auditInputs[itemId]).length===0)delete auditInputs[itemId];
        }else{
            auditInputs[itemId][locId]=parseFloat(val);
        }
        // í–‰ ì…ë ¥ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
        const safeLocId=locId.replace(/[^a-zA-Z0-9]/g,'_');
        const locRow=document.getElementById('inv-loc-row-'+itemId+'-'+safeLocId);
        if(locRow){
            if(val!==''&&val!=null)locRow.classList.add('loc-filled');
            else locRow.classList.remove('loc-filled');
        }
        const row=document.getElementById('inv-row-'+itemId);
        if(row){
            const hasFilled=auditInputs[itemId]&&Object.values(auditInputs[itemId]).some(v=>v!=null&&v!=='');
            if(hasFilled)row.classList.add('saved');
            else row.classList.remove('saved');
        }
        updateInvProgress();
    }

    function updateInvProgress(){
        const visibleItems=currentInvCat?invItems.filter(i=>i.category===currentInvCat):invItems;
        const totalItems=visibleItems.length;
        // í•˜ë‚˜ë¼ë„ ì¥ì†Œ ì…ë ¥ëœ í’ˆëª© ìˆ˜
        const filledItems=visibleItems.filter(i=>auditInputs[i.id]&&Object.keys(auditInputs[i.id]).length>0).length;
        // ì´ ì…ë ¥ëœ ì¥ì†Œ-í’ˆëª© ìŒ ìˆ˜
        const totalLocEntries=Object.values(auditInputs).reduce((s,locs)=>s+Object.keys(locs).length,0);
        const pct=totalItems?Math.round(filledItems/totalItems*100):0;
        const fill=document.getElementById('invProgressFill');
        const text=document.getElementById('invProgressText');
        const btn=document.getElementById('invSubmitBtn');
        if(fill)fill.style.width=pct+'%';
        if(text)text.textContent=filledItems+'/'+totalItems;
        if(btn){
            if(totalLocEntries>0){btn.classList.remove('disabled');btn.classList.add('ready');btn.textContent=`ì‹¤ì‚¬ ê²°ê³¼ ì œì¶œ (${totalLocEntries}ê±´)` ;}
            else{btn.classList.add('disabled');btn.classList.remove('ready');btn.textContent='ì‹¤ì‚¬ ê²°ê³¼ ì œì¶œ';}
        }
    }

    // ê°œë³„ í’ˆëª© ì¦‰ì‹œ ì €ì¥ (onchange ì‹œ Firebase íŠ¸ëœì­ì…˜)
    async function onInvInput(itemId,locId,val){
        onInvInputLive(itemId,locId,val);
        if(val===''||val==null)return;
        const locQty=parseFloat(val);
        const item=invItems.find(i=>i.id===itemId);
        if(!item)return;
        const staffName=currentUser?.name||currentUser?.id||'staff';
        try{
            const ref=db.collection('inventory').doc(itemId);
            await db.runTransaction(async tx=>{
                const doc=await tx.get(ref);
                const data=doc.data()||{};
                const prevStock=data.currentStock||0;
                // locations ì—…ë°ì´íŠ¸
                let newLocations={...(data.locations||{})};
                if(locId==='__total__'){
                    // êµ¬í˜•: ì´ëŸ‰ìœ¼ë¡œ ì €ì¥
                    const newTotal=locQty;
                    tx.update(ref,{currentStock:newTotal,lastAuditAt:new Date().toISOString(),lastAuditBy:staffName});
                    // inventoryLogs
                    const logRef=db.collection('inventoryLogs').doc();
                    tx.set(logRef,{itemId,itemName:item.name,prevStock,newStock:newTotal,diff:newTotal-prevStock,type:'audit',staffName,createdAt:new Date().toISOString()});
                }else{
                    // ì‹ í˜•: í•´ë‹¹ ì¥ì†Œ ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸ â†’ ì´ëŸ‰ ì¬ê³„ì‚°
                    newLocations[locId]=locQty;
                    const newTotal=Object.values(newLocations).reduce((s,q)=>s+(q||0),0);
                    tx.update(ref,{locations:newLocations,currentStock:newTotal,lastAuditAt:new Date().toISOString(),lastAuditBy:staffName});
                    // ë¡œì»¬ locationsë„ ì—…ë°ì´íŠ¸
                    if(!item.locations)item.locations={};
                    item.locations[locId]=locQty;
                    // inventoryLogs
                    const logRef=db.collection('inventoryLogs').doc();
                    tx.set(logRef,{itemId,itemName:item.name,location:locId,prevLocQty:(data.locations||{})[locId]||0,newLocQty:locQty,prevStock,newStock:newTotal,diff:newTotal-prevStock,type:'audit',staffName,createdAt:new Date().toISOString()});
                }
            });
            // inventoryAudits ê¸°ë¡ (ì¥ì†Œ ì •ë³´ í¬í•¨)
            const allLocInputs=auditInputs[itemId]||{};
            const totalAuditQty=Object.values(allLocInputs).reduce((s,q)=>s+(parseFloat(q)||0),0);
            await db.collection('inventoryAudits').add({
                itemId,location:locId,locationQty:locQty,actualStock:totalAuditQty,
                staffId:currentUser?.id||'unknown',staffName,
                createdAt:new Date().toISOString()
            });
            // ë¡œì»¬ ì´ì¬ê³  ë™ê¸°í™”
            if(locId!=='__total__'){
                item.currentStock=Object.values(item.locations||{}).reduce((s,q)=>s+(q||0),0);
            }else{
                item.currentStock=locQty;
            }
            const row=document.getElementById('inv-row-'+itemId);
            if(row)row.classList.add('saved');
        }catch(e){console.error('ì‹¤ì‚¬ ì €ì¥ ì˜¤ë¥˜:',e);}
    }

    async function submitInventoryAudit(){
        const filledItems=Object.keys(auditInputs).length;
        const totalLocEntries=Object.values(auditInputs).reduce((s,locs)=>s+Object.keys(locs).length,0);
        if(!totalLocEntries){alert('ì…ë ¥ëœ ì‹¤ì‚¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');return;}
        alert(`âœ… ${filledItems}ê°œ í’ˆëª© / ${totalLocEntries}ê°œ ì¥ì†Œ ì‹¤ì‚¬ ì™„ë£Œ!\n\nê° í•­ëª©ì€ ì…ë ¥ ì¦‰ì‹œ ì‹œìŠ¤í…œì— ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        auditInputs={};
        await loadInventoryForStaff();
        await loadLastWeekAudits();
        renderInvAuditList();
        renderLowStockAlert();
    }

    async function initInventoryTab(){
        await Promise.all([loadInventoryForStaff(),loadLastWeekAudits(),loadReceivingLocations()]);
        
        // ì¥ì†Œ í•„í„° ì´ˆê¸°í™”
        const locFilter = document.getElementById('invAuditLocationFilter');
        if(locFilter && receivingLocations.length > 0){
            locFilter.innerHTML = '<option value="">ì „ì²´ ì¥ì†Œ (ëª¨ë“  í’ˆëª©)</option>';
            receivingLocations.forEach(loc => {
                const opt = document.createElement('option');
                opt.value = `${loc.floor}-${loc.name}`;
                opt.textContent = `${loc.floor}-${loc.name}`;
                locFilter.appendChild(opt);
            });
        }
        
        renderInvCatButtons();
        renderInvAuditList();
        renderLowStockAlert();
    }

    // ===== ë°œì£¼ í•„ìš” ì•Œë¦¼ =====
    function renderLowStockAlert(){
        const alert=document.getElementById('invLowStockAlert');
        if(!alert)return;
        const lowItems=invItems.filter(i=>i.safetyStock&&i.currentStock<i.safetyStock);
        if(lowItems.length){
            alert.style.display='block';
            alert.innerHTML='âš ï¸ <strong>ë°œì£¼ í•„ìš” '+lowItems.length+'ê±´</strong>: '+lowItems.slice(0,5).map(i=>i.name).join(', ')+(lowItems.length>5?' ì™¸ '+(lowItems.length-5)+'ê±´':'');
        }else{
            alert.style.display='none';
        }
    }

    // ===== ì‹ ê·œ í’ˆëª© ë“±ë¡ =====
    function openNewItemModal(){
        ['newItemName','newItemTotalPrice','newItemExpiry','newItemPurchaseLink'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
        document.getElementById('newItemType').value='disposable';
        document.getElementById('newItemCategory').value='common';
        document.getElementById('newItemSafety').value='';
        document.getElementById('newItemBoxes').value='1';
        document.getElementById('newItemPerBox').value='1';
        document.getElementById('newItemUnitCalc').textContent='ë‚±ê°œë‹¹ ë‹¨ê°€: -';
        
        // ì¥ì†Œë³„ ì¬ê³  ì´ˆê¸°í™”
        document.getElementById('newLocationsList').innerHTML='';
        document.getElementById('newTotalStockDisplay').textContent='0';
        addNewLocationRow(); // ê¸°ë³¸ 1ê°œ í–‰ ì¶”ê°€
        
        openModal('newItemModal');
    }
    
    // ì‹ ê·œ í’ˆëª© - ì¥ì†Œ í–‰ ì¶”ê°€
    function addNewLocationRow(){
        const container = document.getElementById('newLocationsList');
        const rowId = 'newLoc_' + Date.now();
        
        const row = document.createElement('div');
        row.id = rowId;
        row.style.cssText = 'display:flex;gap:.5rem;margin-bottom:.5rem;align-items:stretch;width:100%';
        row.innerHTML = `
            <select class="form-select" style="width:45%;padding:1.1rem;font-size:1.1rem;font-weight:600;flex-shrink:0" onchange="calcNewTotalStock()">
                <option value="">ì¥ì†Œ ì„ íƒ</option>
                ${receivingLocations.map(loc => 
                    `<option value="${loc.floor}-${loc.name}">${loc.floor}-${loc.name}</option>`
                ).join('')}
            </select>
            <input type="number" class="form-input" placeholder="ìˆ˜ëŸ‰" min="0" step="1" 
                style="width:35%;padding:1.1rem;font-size:1.4rem;font-weight:700;text-align:center;flex-shrink:0" oninput="calcNewTotalStock()">
            <button type="button" class="btn btn-secondary" onclick="removeNewLocationRow('${rowId}')" 
                style="width:15%;padding:.5rem;font-size:.75rem;white-space:nowrap;flex-shrink:0">ì‚­ì œ</button>
        `;
        container.appendChild(row);
        calcNewTotalStock();
    }
    
    // ì‹ ê·œ í’ˆëª© - ì¥ì†Œ í–‰ ì‚­ì œ
    function removeNewLocationRow(rowId){
        const row = document.getElementById(rowId);
        if(row) row.remove();
        calcNewTotalStock();
    }
    
    // ì‹ ê·œ í’ˆëª© - ì´ ì¬ê³  ê³„ì‚°
    function calcNewTotalStock(){
        const container = document.getElementById('newLocationsList');
        const rows = container.querySelectorAll('div[id^="newLoc_"]');
        let total = 0;
        
        rows.forEach(row => {
            const qtyInput = row.querySelector('input[type="number"]');
            const qty = parseFloat(qtyInput?.value || 0);
            if(qty > 0) total += qty;
        });
        
        document.getElementById('newTotalStockDisplay').textContent = total;
    }

    function calcNewItemUnit(){
        const total=parseFloat(document.getElementById('newItemTotalPrice').value)||0;
        const boxes=parseFloat(document.getElementById('newItemBoxes').value)||1;
        const perBox=parseFloat(document.getElementById('newItemPerBox').value)||1;
        const el=document.getElementById('newItemUnitCalc');
        if(total>0&&boxes>0&&perBox>0){
            const unitPrice=Math.round(total/(boxes*perBox));
            el.textContent='ë‚±ê°œë‹¹ ë‹¨ê°€: '+unitPrice.toLocaleString()+'ì›';
            el.style.color='var(--green)';
        }else{
            el.textContent='ë‚±ê°œë‹¹ ë‹¨ê°€: -';
            el.style.color='var(--primary)';
        }
    }

    async function saveNewItem(){
        const name=document.getElementById('newItemName').value.trim();
        if(!name){alert('í’ˆëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');return;}
        
        // ì¥ì†Œë³„ ì¬ê³  ìˆ˜ì§‘
        const container = document.getElementById('newLocationsList');
        const rows = container.querySelectorAll('div[id^="newLoc_"]');
        const locations = {};
        let totalStock = 0;
        
        rows.forEach(row => {
            const locSelect = row.querySelector('select');
            const qtyInput = row.querySelector('input[type="number"]');
            const loc = locSelect?.value;
            const qty = parseFloat(qtyInput?.value || 0);
            
            if(loc && qty > 0){
                locations[loc] = qty;
                totalStock += qty;
            }
        });
        
        const totalPrice=parseFloat(document.getElementById('newItemTotalPrice').value)||0;
        const boxes=parseFloat(document.getElementById('newItemBoxes').value)||1;
        const perBox=parseFloat(document.getElementById('newItemPerBox').value)||1;
        const totalQty=boxes*perBox;
        const unitPrice=totalPrice>0&&totalQty>0?Math.round(totalPrice/totalQty):0;
        
        const data={
            name:name,
            type:document.getElementById('newItemType').value,
            category:document.getElementById('newItemCategory').value,
            unit:'ê°œ',
            locations:locations, // ë‹¤ì¤‘ ì¥ì†Œ
            currentStock:totalStock, // ì´ ì¬ê³ 
            safetyStock:parseFloat(document.getElementById('newItemSafety').value)||0,
            purchasePrice:totalPrice,
            purchaseQty:totalQty,
            unitPrice:unitPrice,
            expiryDate:document.getElementById('newItemExpiry').value||null,
            purchaseLink:document.getElementById('newItemPurchaseLink')?.value?.trim()||'',
            createdAt:new Date().toISOString(),
            updatedAt:new Date().toISOString(),
            createdBy:currentUser?.name||'staff'
        };
        try{
            await db.collection('inventory').add(data);
            closeModal('newItemModal');
            alert('âœ… "'+name+'" í’ˆëª©ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
            await loadInventoryForStaff();
            renderInvCatButtons();
            renderInvAuditList();
            renderLowStockAlert();
        }catch(e){alert('ë“±ë¡ ì‹¤íŒ¨: '+e.message);}
    }

    // ===== í’ˆëª© ìˆ˜ì • ê¸°ëŠ¥ =====

    // ===== ğŸ“¥ ì…ê³  ëª¨ë‹¬ =====
    function openReceiveItemModal(itemId){
        const item = invItems.find(i => i.id === itemId);
        if(!item){ alert('í’ˆëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }

        document.getElementById('receiveItemId').value = itemId;
        document.getElementById('receiveItemName').value = item.name || '';

        // ê¸°ë³¸ê°’: ì˜¤ëŠ˜ ë‚ ì§œ
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('receiveDate').value = today;
        document.getElementById('receiveExpiry').value = item.expiryDate || '';

        // êµ¬ë§¤ì •ë³´ ì´ˆê¸°í™”
        document.getElementById('receivePrice').value = '';
        document.getElementById('receiveBoxes').value = 1;
        document.getElementById('receivePerBox').value = 1;
        document.getElementById('receiveUnitCalc').textContent = 'ë‚±ê°œë‹¹ ë‹¨ê°€: -';
        document.getElementById('receiveUnitCalc').style.color = 'var(--primary)';

        // í˜„ì¬ ì¥ì†Œë³„ ì¬ê³  ë¯¸ë¦¬ë³´ê¸°
        const stockDiv = document.getElementById('receiveCurrentStock');
        if(item.locations && Object.keys(item.locations).length > 0){
            const locLines = Object.entries(item.locations)
                .filter(([,q]) => q > 0)
                .map(([loc,q]) => `ğŸ“ ${loc}: ${q}${item.unit||'ê°œ'}`)
                .join('  |  ');
            stockDiv.innerHTML = `<strong>í˜„ì¬ ì¬ê³ </strong> â€” ${locLines || 'ì—†ìŒ'}`;
        } else {
            stockDiv.innerHTML = `<strong>í˜„ì¬ ì¬ê³ </strong> â€” ${item.currentStock||0}${item.unit||'ê°œ'}`;
        }

        // ì¥ì†Œ í–‰ ì´ˆê¸°í™” â€” ê¸°ì¡´ ì¥ì†Œë“¤ë¡œ ì‹œì‘ (ìˆ˜ëŸ‰ 0)
        const container = document.getElementById('receiveLocationsList');
        container.innerHTML = '';
        if(item.locations && Object.keys(item.locations).length > 0){
            Object.keys(item.locations).filter(loc => item.locations[loc] > 0).forEach(loc => {
                addReceiveLocationRow(loc, 0);
            });
        } else {
            addReceiveLocationRow();
        }
        calcReceiveTotal();

        openModal('receiveItemModal');
    }

    function addReceiveLocationRow(location='', quantity=0){
        const container = document.getElementById('receiveLocationsList');
        const rowId = 'recvLoc_' + Date.now() + '_' + Math.random().toString(36).slice(2,6);
        const row = document.createElement('div');
        row.id = rowId;
        row.style.cssText = 'display:flex;gap:.5rem;margin-bottom:.5rem;align-items:stretch;width:100%';
        row.innerHTML = `
            <select class="form-select" style="width:45%;padding:1.1rem;font-size:1rem;font-weight:600;flex-shrink:0" onchange="calcReceiveTotal()">
                <option value="">ì¥ì†Œ ì„ íƒ</option>
                ${receivingLocations.map(loc => {
                    const v = loc.floor + '-' + loc.name;
                    return '<option value="' + v + '"' + (v === location ? ' selected' : '') + '>' + v + '</option>';
                }).join('')}
            </select>
            <input type="number" class="form-input" placeholder="ì…ê³  ìˆ˜ëŸ‰" min="0" step="1" value="${quantity}"
                style="width:35%;padding:1.1rem;font-size:1.4rem;font-weight:700;text-align:center;flex-shrink:0" oninput="calcReceiveTotal()">
            <button type="button" class="btn btn-secondary" onclick="this.closest('div[id]').remove();calcReceiveTotal();"
                style="width:15%;padding:.5rem;font-size:.75rem;white-space:nowrap;flex-shrink:0">ì‚­ì œ</button>
        `;
        container.appendChild(row);
    }

    function calcReceiveTotal(){
        const container = document.getElementById('receiveLocationsList');
        let total = 0;
        container.querySelectorAll('input[type="number"]').forEach(inp => {
            total += parseFloat(inp.value || 0);
        });
        document.getElementById('receiveTotalDisplay').textContent = total;
    }

    function calcReceiveUnit(){
        const total = parseFloat(document.getElementById('receivePrice').value) || 0;
        const boxes = parseFloat(document.getElementById('receiveBoxes').value) || 1;
        const perBox = parseFloat(document.getElementById('receivePerBox').value) || 1;
        const el = document.getElementById('receiveUnitCalc');
        if(total > 0 && boxes > 0 && perBox > 0){
            const unit = Math.round(total / (boxes * perBox));
            el.textContent = 'ë‚±ê°œë‹¹ ë‹¨ê°€: ' + unit.toLocaleString() + 'ì›';
            el.style.color = 'var(--green)';
        } else {
            el.textContent = 'ë‚±ê°œë‹¹ ë‹¨ê°€: -';
            el.style.color = 'var(--primary)';
        }
    }

    async function saveReceiveItem(){
        const id = document.getElementById('receiveItemId').value;
        const receiveDate = document.getElementById('receiveDate').value;
        const receiveExpiry = document.getElementById('receiveExpiry').value;
        if(!id || !receiveDate){ alert('ì…ê³ ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

        const container = document.getElementById('receiveLocationsList');
        const rows = container.querySelectorAll('div[id^="recvLoc_"]');
        const addMap = {}; // { ì¥ì†Œ: ì¶”ê°€ìˆ˜ëŸ‰ }
        let totalAdd = 0;

        rows.forEach(row => {
            const locSel = row.querySelector('select');
            const qtyInp = row.querySelector('input[type="number"]');
            const loc = locSel?.value;
            const qty = parseFloat(qtyInp?.value || 0);
            if(loc && qty > 0){
                addMap[loc] = (addMap[loc] || 0) + qty;
                totalAdd += qty;
            }
        });

        if(totalAdd <= 0){ alert('ì…ê³  ìˆ˜ëŸ‰ì„ 1ê°œ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

        const item = invItems.find(i => i.id === id);
        if(!item){ alert('í’ˆëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }

        // ê¸°ì¡´ locationsì— ë”í•˜ê¸°
        const newLocations = Object.assign({}, item.locations || {});
        Object.entries(addMap).forEach(([loc, qty]) => {
            newLocations[loc] = (newLocations[loc] || 0) + qty;
        });
        const newTotal = Object.values(newLocations).reduce((s,q) => s + q, 0);

        // êµ¬ë§¤ì •ë³´ ì—…ë°ì´íŠ¸ (ì…ë ¥ëœ ê²½ìš°ë§Œ)
        const totalPrice = parseFloat(document.getElementById('receivePrice').value) || 0;
        const boxes = parseFloat(document.getElementById('receiveBoxes').value) || 1;
        const perBox = parseFloat(document.getElementById('receivePerBox').value) || 1;
        const totalQty = boxes * perBox;

        const updateData = {
            locations: newLocations,
            currentStock: newTotal,
            updatedAt: new Date().toISOString(),
            updatedBy: currentUser?.name || 'staff',
            lastReceiveDate: receiveDate,
        };
        if(receiveExpiry) updateData.expiryDate = receiveExpiry;
        if(totalPrice > 0){
            updateData.purchasePrice = totalPrice;
            updateData.purchaseQty = totalQty;
            updateData.unitPrice = Math.round(totalPrice / totalQty);
        }

        try{
            await db.collection('inventory').doc(id).update(updateData);

            // ì…ê³  ì´ë ¥ ê¸°ë¡
            await db.collection('receiveHistory').add({
                itemId: id,
                itemName: item.name,
                receiveDate: receiveDate,
                expiryDate: receiveExpiry || null,
                locations: addMap,
                totalQty: totalAdd,
                purchasePrice: totalPrice || null,
                receivedBy: currentUser?.name || 'staff',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            closeModal('receiveItemModal');
            alert('âœ… ì…ê³  ì™„ë£Œ!\n' + item.name + ' ' + totalAdd + 'ê°œ ì…ê³ ë˜ì—ˆìŠµë‹ˆë‹¤.');
            await loadInventoryForStaff();
            renderInvCatButtons();
            renderInvAuditList();
            renderLowStockAlert();
        }catch(e){ alert('ì…ê³  ì‹¤íŒ¨: ' + e.message); }
    }

    function openEditItemModal(itemId){
        const item=invItems.find(i=>i.id===itemId);
        if(!item){alert('í’ˆëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');return;}
        
        console.log('ğŸ“¦ í’ˆëª© ì •ë³´:', item);
        console.log('ğŸ“ locations ê°ì²´:', item.locations);
        console.log('ğŸ“ ë‹¨ì¼ location:', item.location);
        
        document.getElementById('editItemId').value=itemId;
        document.getElementById('editItemName').value=item.name||'';
        document.getElementById('editItemCategory').value=item.category||'common';
        document.getElementById('editItemSafety').value=item.safetyStock||0;
        document.getElementById('editItemExpiry').value=item.expiryDate||'';
        document.getElementById('editItemPurchaseLink').value=item.purchaseLink||'';
        
        // ì¥ì†Œë³„ ì¬ê³  ë¡œë“œ
        const container = document.getElementById('editLocationsList');
        container.innerHTML = '';
        
        if(item.locations && Object.keys(item.locations).length > 0){
            Object.entries(item.locations).forEach(([loc, qty]) => {
                console.log('ğŸ” ì¥ì†Œ ë¡œë“œ:', loc, 'ìˆ˜ëŸ‰:', qty);
                if(qty > 0){
                    addEditLocationRow(loc, qty);
                }
            });
        }else if(item.location){
            // ê¸°ì¡´ ë‹¨ì¼ location í•„ë“œ ì²˜ë¦¬
            console.log('ğŸ” ë‹¨ì¼ ì¥ì†Œ ë¡œë“œ:', item.location);
            addEditLocationRow(item.location, item.currentStock || 0);
        }else{
            // ë¹ˆ í–‰ 1ê°œ ì¶”ê°€
            addEditLocationRow();
        }
        
        calcEditTotalStock();
        
        // êµ¬ë§¤ ì •ë³´ ì—­ì‚°
        const totalPrice=item.purchasePrice||0;
        const totalQty=item.purchaseQty||1;
        document.getElementById('editItemTotalPrice').value=totalPrice||'';
        document.getElementById('editItemBoxes').value=1;
        document.getElementById('editItemPerBox').value=totalQty||1;
        calcEditItemUnit();
        openModal('editItemModal');
    }
    
    // ìˆ˜ì • ëª¨ë‹¬ - ì¥ì†Œ í–‰ ì¶”ê°€
    function addEditLocationRow(location='', quantity=0){
        const container = document.getElementById('editLocationsList');
        const rowId = 'editLoc_' + Date.now();
        
        console.log('â• ì¥ì†Œ í–‰ ì¶”ê°€:', location, 'ìˆ˜ëŸ‰:', quantity);
        console.log('ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ ì¥ì†Œ:', receivingLocations.map(l => `${l.floor}-${l.name}`));
        
        const row = document.createElement('div');
        row.id = rowId;
        row.style.cssText = 'display:flex;gap:.5rem;margin-bottom:.5rem;align-items:stretch;width:100%';
        row.innerHTML = `
            <select class="form-select" style="width:45%;padding:1.1rem;font-size:1.1rem;font-weight:600;flex-shrink:0" onchange="calcEditTotalStock()">
                <option value="">ì¥ì†Œ ì„ íƒ</option>
                ${receivingLocations.map(loc => {
                    const locValue = `${loc.floor}-${loc.name}`;
                    const selected = locValue === location ? 'selected' : '';
                    console.log('ğŸ” ë¹„êµ:', locValue, '===', location, 'â†’', selected);
                    return `<option value="${locValue}" ${selected}>${locValue}</option>`;
                }).join('')}
            </select>
            <input type="number" class="form-input" placeholder="ìˆ˜ëŸ‰" min="0" step="1" value="${quantity}" 
                style="width:35%;padding:1.1rem;font-size:1.4rem;font-weight:700;text-align:center;flex-shrink:0" oninput="calcEditTotalStock()">
            <button type="button" class="btn btn-secondary" onclick="removeEditLocationRow('${rowId}')" 
                style="width:15%;padding:.5rem;font-size:.75rem;white-space:nowrap;flex-shrink:0">ì‚­ì œ</button>
        `;
        container.appendChild(row);
    }
    
    // ìˆ˜ì • ëª¨ë‹¬ - ì¥ì†Œ í–‰ ì‚­ì œ
    function removeEditLocationRow(rowId){
        const row = document.getElementById(rowId);
        if(row) row.remove();
        calcEditTotalStock();
    }
    
    // ìˆ˜ì • ëª¨ë‹¬ - ì´ ì¬ê³  ê³„ì‚°
    function calcEditTotalStock(){
        const container = document.getElementById('editLocationsList');
        const rows = container.querySelectorAll('div[id^="editLoc_"]');
        let total = 0;
        
        rows.forEach(row => {
            const qtyInput = row.querySelector('input[type="number"]');
            const qty = parseFloat(qtyInput?.value || 0);
            if(qty > 0) total += qty;
        });
        
        document.getElementById('editTotalStockDisplay').textContent = total;
    }

    function calcEditItemUnit(){
        const total=parseFloat(document.getElementById('editItemTotalPrice').value)||0;
        const boxes=parseFloat(document.getElementById('editItemBoxes').value)||1;
        const perBox=parseFloat(document.getElementById('editItemPerBox').value)||1;
        const el=document.getElementById('editItemUnitCalc');
        if(total>0&&boxes>0&&perBox>0){
            const unitPrice=Math.round(total/(boxes*perBox));
            el.textContent='ë‚±ê°œë‹¹ ë‹¨ê°€: '+unitPrice.toLocaleString()+'ì›';
            el.style.color='var(--green)';
        }else{
            el.textContent='ë‚±ê°œë‹¹ ë‹¨ê°€: -';
            el.style.color='var(--primary)';
        }
    }

    async function saveEditItem(){
        const id=document.getElementById('editItemId').value;
        if(!id)return;
        
        // ì¥ì†Œë³„ ì¬ê³  ìˆ˜ì§‘
        const container = document.getElementById('editLocationsList');
        const rows = container.querySelectorAll('div[id^="editLoc_"]');
        const locations = {};
        let totalStock = 0;
        
        rows.forEach(row => {
            const locSelect = row.querySelector('select');
            const qtyInput = row.querySelector('input[type="number"]');
            const loc = locSelect?.value;
            const qty = parseFloat(qtyInput?.value || 0);
            
            if(loc && qty > 0){
                locations[loc] = qty;
                totalStock += qty;
            }
        });
        
        const totalPrice=parseFloat(document.getElementById('editItemTotalPrice').value)||0;
        const boxes=parseFloat(document.getElementById('editItemBoxes').value)||1;
        const perBox=parseFloat(document.getElementById('editItemPerBox').value)||1;
        const totalQty=boxes*perBox;
        
        const data={
            category:document.getElementById('editItemCategory').value,
            locations:locations, // ë‹¤ì¤‘ ì¥ì†Œ
            currentStock:totalStock, // ì´ ì¬ê³ 
            safetyStock:parseFloat(document.getElementById('editItemSafety').value)||0,
            expiryDate:document.getElementById('editItemExpiry').value||null,
            purchasePrice:totalPrice,
            purchaseQty:totalQty,
            unitPrice:totalPrice>0&&totalQty>0?Math.round(totalPrice/totalQty):0,
            purchaseLink:document.getElementById('editItemPurchaseLink').value.trim(),
            updatedAt:new Date().toISOString(),
            updatedBy:currentUser?.name||'staff'
        };
        try{
            await db.collection('inventory').doc(id).update(data);
            closeModal('editItemModal');
            alert('âœ… í’ˆëª© ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            await loadInventoryForStaff();
            renderInvCatButtons();
            renderInvAuditList();
            renderLowStockAlert();
        }catch(e){alert('ìˆ˜ì • ì‹¤íŒ¨: '+e.message);}
    }

    // ===== ì¬ê³  í•­ëª© ì‚­ì œ =====
    async function deleteInventoryItem(itemId,itemName){
        if(!confirm(`"${itemName}" í’ˆëª©ì„ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìœ¼ë©°, ë‹¤ìŒ ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤:\nâ€¢ í’ˆëª© ì •ë³´\nâ€¢ ì¬ê³  ì‹¤ì‚¬ ê¸°ë¡\nâ€¢ ê´€ë ¨ëœ ëª¨ë“  ë°ì´í„°`))return;
        
        if(typeof db==='undefined'){alert('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘ì…ë‹ˆë‹¤.');return;}
        
        try{
            // ì¬ê³  ë¬¸ì„œ ì‚­ì œ
            await db.collection('inventory').doc(itemId).delete();
            
            // ë¡œì»¬ ë°°ì—´ì—ì„œë„ ì œê±°
            const idx=invItems.findIndex(i=>i.id===itemId);
            if(idx>-1)invItems.splice(idx,1);
            
            // ì‹¤ì‚¬ ì…ë ¥ê°’ë„ ì œê±°
            delete auditInputs[itemId];
            
            // UI ë¦¬ë Œë”ë§
            renderInvCatButtons();
            renderInvAuditList();
            renderLowStockAlert();
            
            alert('âœ… ì‚­ì œ ì™„ë£Œ');
        }catch(e){
            alert('ì‚­ì œ ì‹¤íŒ¨: '+e.message);
        }
    }

    // ===== ë¹„í’ˆ êµ¬ë§¤ ìš”ì²­(Wishlist) =====
    function openWishlistModal(){
        ['wishItemName','wishItemLink','wishItemReason'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
        document.getElementById('wishItemQty').value='1';
        document.getElementById('wishItemPrice').value='';
        openModal('wishlistModal');
    }

    async function submitWishlistItem(){
        const name=document.getElementById('wishItemName').value.trim();
        if(!name){alert('í’ˆëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');return;}
        if(typeof db==='undefined'){alert('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘ì…ë‹ˆë‹¤.');return;}
        const data={
            name:name,
            qty:parseInt(document.getElementById('wishItemQty').value)||1,
            estimatedPrice:parseFloat(document.getElementById('wishItemPrice').value)||0,
            purchaseLink:document.getElementById('wishItemLink').value.trim(),
            reason:document.getElementById('wishItemReason').value.trim(),
            requestedBy:currentUser?.name||'ì§ì›',
            requestedById:currentUser?.id||'',
            status:'pending',
            createdAt:new Date().toISOString()
        };
        try{
            await db.collection('purchaseRequests').add(data);
            closeModal('wishlistModal');
            alert('âœ… êµ¬ë§¤ ìš”ì²­ì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.\nê´€ë¦¬ì ìŠ¹ì¸ í›„ êµ¬ë§¤ê°€ ì§„í–‰ë©ë‹ˆë‹¤.');
            loadStaffWishlist(); // UI ë¦¬ë Œë”ë§
        }catch(e){alert('ìš”ì²­ ì‹¤íŒ¨: '+e.message);}
    }

    // ===== ë¹„í’ˆ ìš”ì²­ ë‚´ì—­ (ì§ì›ìš©) =====
    async function loadStaffWishlist(){
        const container=document.getElementById('staffWishlistHistory');
        if(!container)return;
        if(typeof db==='undefined'){container.innerHTML='ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...';return;}
        try{
            const snap=await db.collection('purchaseRequests').orderBy('createdAt','desc').limit(30).get();
            const items=snap.docs.map(d=>({id:d.id,...d.data()}));
            if(!items.length){
                container.innerHTML='<div style="text-align:center;color:var(--text-muted);padding:1.5rem">ì•„ì§ ìš”ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            container.innerHTML=items.map(r=>{
                const statusMap={pending:'â³ ëŒ€ê¸°ì¤‘',approved:'âœ… ìŠ¹ì¸ë¨',rejected:'âŒ ê±°ì ˆë¨'};
                const statusColor={pending:'#f57f17',approved:'#2e7d32',rejected:'#c62828'};
                const st=r.status||'pending';
                const linkBtn=r.purchaseLink?`<a href="${r.purchaseLink}" target="_blank" style="font-size:.7rem;color:#1976d2;text-decoration:none;margin-left:4px">ğŸ”— ë§í¬</a>`:'';
                const dateStr=r.createdAt?new Date(r.createdAt).toLocaleDateString('ko'):'-';
                return `<div style="padding:10px;border:1px solid var(--border);border-radius:8px;margin-bottom:6px;background:#fff">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <strong>${r.name}</strong> <span style="font-size:.75rem;color:#999">Ã—${r.qty||1}</span>
                        <span style="font-size:.75rem;color:${statusColor[st]};font-weight:600">${statusMap[st]||st}</span>
                    </div>
                    <div style="font-size:.75rem;color:#888;margin-top:3px">
                        ${r.estimatedPrice?'ì˜ˆìƒ '+r.estimatedPrice.toLocaleString()+'ì›':''}
                        ${linkBtn}
                        Â· ${r.requestedBy||'-'} Â· ${dateStr}
                    </div>
                    ${r.reason?`<div style="font-size:.75rem;color:#666;margin-top:2px">${r.reason}</div>`:''}
                </div>`;
            }).join('');
        }catch(e){container.innerHTML='ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: '+e.message;}
    }

    // ===== ì…ê³  ì‹œìŠ¤í…œ =====
    let receivingLocations=[]; // ì¥ì†Œ ëª©ë¡
    
    // ì¥ì†Œ ëª©ë¡ ë¡œë“œ
    async function loadReceivingLocations(){
        if(typeof db==='undefined')return;
        try{
            const snap=await db.collection('locations').orderBy('order','asc').get();
            receivingLocations=snap.docs.map(d=>({id:d.id,...d.data()}));
            updateLocationSelect();
        }catch(e){
            receivingLocations=[];
            console.error('ì¥ì†Œ ë¡œë“œ ì‹¤íŒ¨:',e);
        }
    }
    
    function updateLocationSelect(){
        const sel=document.getElementById('receivingLocation');
        if(!sel)return;
        sel.innerHTML='<option value="">ì¥ì†Œ ì„ íƒ</option>';
        
        // DBì—ì„œ ë¡œë“œëœ ì¥ì†Œê°€ ìˆìœ¼ë©´ ì‚¬ìš©
        if(receivingLocations.length>0){
            receivingLocations.forEach(loc=>{
                const opt=document.createElement('option');
                opt.value=`${loc.floor}-${loc.name}`;
                opt.textContent=`${loc.floor}-${loc.name}`;
                sel.appendChild(opt);
            });
        }else{
            // ê¸°ë³¸ ì¥ì†Œ (DB ë¡œë“œ ì‹¤íŒ¨ ì‹œ fallback)
            const defaults=[
                '5ì¸µ-ì²˜ì¹˜ì‹¤','5ì¸µ-ëƒ‰ì¥ê³ ',
                '6ì¸µ-ì‹œìˆ ì‹¤','6ì¸µ-ìˆ˜ì•¡ì‹¤','6ì¸µ-ì¤„ê¸°ì„¸í¬ì„¼í„°','6ì¸µ-ìˆ˜ìˆ ì‹¤',
                '6ì¸µ-ì¤€ë¹„ì‹¤','6ì¸µ-ì¤€ë¹„ì‹¤ì˜†ë³´ê´€ì‹¤','6ì¸µ-ì¤€ë¹„ì‹¤ ëƒ‰ì¥ê³ ',
                '6ì¸µ-ì–´ë¸€ì‹¤','6ì¸µ-ë ˆì´ì €ì‹¤','6ì¸µ-ë¦¬íŒŸì‹¤'
            ];
            defaults.forEach(loc=>{
                const opt=document.createElement('option');
                opt.value=loc;
                opt.textContent=loc;
                sel.appendChild(opt);
            });
        }
    }
    
    // ì¥ì†Œ ì˜µì…˜ì„ íŠ¹ì • selectì— ë¡œë“œí•˜ëŠ” ë²”ìš© í•¨ìˆ˜
    function loadLocationOptions(selectId, currentValue = '') {
        const sel = document.getElementById(selectId);
        if (!sel) return;
        
        sel.innerHTML = '<option value="">ì„ íƒ</option>';
        
        // DBì—ì„œ ë¡œë“œëœ ì¥ì†Œ ì‚¬ìš©
        if (receivingLocations.length > 0) {
            receivingLocations.forEach(loc => {
                const opt = document.createElement('option');
                const locationValue = `${loc.floor}-${loc.name}`;
                opt.value = locationValue;
                opt.textContent = locationValue;
                if (locationValue === currentValue) {
                    opt.selected = true;
                }
                sel.appendChild(opt);
            });
        } else {
            // ê¸°ë³¸ ì¥ì†Œ
            const defaults = [
                '5ì¸µ-ì²˜ì¹˜ì‹¤', '5ì¸µ-ëƒ‰ì¥ê³ ',
                '6ì¸µ-ì‹œìˆ ì‹¤', '6ì¸µ-ìˆ˜ì•¡ì‹¤', '6ì¸µ-ì¤„ê¸°ì„¸í¬ì„¼í„°', '6ì¸µ-ìˆ˜ìˆ ì‹¤',
                '6ì¸µ-ì¤€ë¹„ì‹¤', '6ì¸µ-ì¤€ë¹„ì‹¤ì˜†ë³´ê´€ì‹¤', '6ì¸µ-ì¤€ë¹„ì‹¤ ëƒ‰ì¥ê³ ',
                '6ì¸µ-ì–´ë¸€ì‹¤', '6ì¸µ-ë ˆì´ì €ì‹¤', '6ì¸µ-ë¦¬íŒŸì‹¤'
            ];
            defaults.forEach(loc => {
                const opt = document.createElement('option');
                opt.value = loc;
                opt.textContent = loc;
                if (loc === currentValue) {
                    opt.selected = true;
                }
                sel.appendChild(opt);
            });
        }
    }
    
    // í’ˆëª© ê²€ìƒ‰
    function searchItemsForReceiving(keyword){
        const container=document.getElementById('receivingSearchResults');
        if(!container)return;
        
        if(!keyword||keyword.length<1){
            container.innerHTML='';
            return;
        }
        
        const kw=keyword.toLowerCase();
        const results=invItems.filter(item=>(item.name||'').toLowerCase().includes(kw));
        
        if(!results.length){
            container.innerHTML='<div style="text-align:center;color:var(--text-muted);padding:.75rem;font-size:.85rem">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
            return;
        }
        
        container.innerHTML=results.map(item=>{
            const catLabel=INV_CATEGORIES[item.category]||'';
            const stock=item.totalStock||0;
            return `<div onclick="selectItemForReceiving('${item.id}')" 
                style="padding:.6rem .75rem;border:1px solid var(--border);border-radius:6px;margin-bottom:4px;cursor:pointer;background:#fff;display:flex;justify-content:space-between;align-items:center"
                onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background='#fff'">
                <div>
                    <strong style="font-size:.9rem">${item.name}</strong>
                    <div style="font-size:.75rem;color:var(--text-muted);margin-top:2px">${catLabel} Â· í˜„ì¬ê³  ${stock} ${item.unit||'ê°œ'}</div>
                </div>
                <span style="color:var(--primary);font-size:.75rem">ì„ íƒ â†’</span>
            </div>`;
        }).join('');
    }
    
    function selectItemForReceiving(itemId){
        const item=invItems.find(i=>i.id===itemId);
        if(!item)return;
        
        // ê²€ìƒ‰ì°½ ìˆ¨ê¸°ê¸°
        document.getElementById('receivingSearch').value=item.name;
        document.getElementById('receivingSearchResults').innerHTML='';
        
        // í¼ í‘œì‹œ
        document.getElementById('receivingForm').style.display='block';
        document.getElementById('receivingItemId').value=itemId;
        document.getElementById('receivingItemName').textContent=item.name;
        document.getElementById('receivingCurrentStock').textContent=(item.totalStock||0)+' '+(item.unit||'ê°œ');
        document.getElementById('receivingItemUnit').textContent=item.unit||'ê°œ';
        
        // ì…ë ¥ ì´ˆê¸°í™”
        document.getElementById('receivingQty').value='';
        document.getElementById('receivingExpiry').value='';
        document.getElementById('receivingPrice').value='';
        document.getElementById('receivingLocation').value='';
        document.getElementById('receivingMemo').value='';
    }
    
    function cancelReceiving(){
        document.getElementById('receivingForm').style.display='none';
        document.getElementById('receivingSearch').value='';
        document.getElementById('receivingSearchResults').innerHTML='';
    }
    
    async function submitReceiving(){
        const itemId=document.getElementById('receivingItemId').value;
        const qty=parseFloat(document.getElementById('receivingQty').value)||0;
        const expiry=document.getElementById('receivingExpiry').value;
        const price=parseFloat(document.getElementById('receivingPrice').value)||0;
        const location=document.getElementById('receivingLocation').value;
        const memo=document.getElementById('receivingMemo').value.trim();
        
        if(!itemId||!qty||!expiry||!location){
            alert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(ì…ê³  ìˆ˜ëŸ‰, ìœ í†µê¸°í•œ, ë³´ê´€ ì¥ì†Œ)');
            return;
        }
        
        if(qty<=0){alert('ì…ê³  ìˆ˜ëŸ‰ì€ 0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.');return;}
        if(typeof db==='undefined'){alert('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘ì…ë‹ˆë‹¤.');return;}
        
        const item=invItems.find(i=>i.id===itemId);
        if(!item){alert('í’ˆëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');return;}
        
        try{
            // ë°°ì¹˜ ë²ˆí˜¸ ìƒì„± (Bë‚ ì§œ-ìˆœë²ˆ)
            const today=new Date().toISOString().split('T')[0].replace(/-/g,'');
            const batchNo=`B${today}-${Date.now().toString(36).toUpperCase().substr(-3)}`;
            
            // ìƒˆ ë°°ì¹˜ ê°ì²´
            const newBatch={
                batchNo:batchNo,
                expiryDate:expiry,
                location:location,
                qty:qty,
                purchasePrice:price,
                purchaseDate:new Date().toISOString().split('T')[0],
                memo:memo,
                createdBy:currentUser?.name||currentUser?.id||'ì§ì›',
                createdAt:new Date().toISOString()
            };
            
            // Firestore íŠ¸ëœì­ì…˜
            await db.runTransaction(async tx=>{
                const docRef=db.collection('inventory').doc(itemId);
                const doc=await tx.get(docRef);
                if(!doc.exists)throw new Error('í’ˆëª©ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
                
                const data=doc.data();
                const batches=data.batches||[];
                const itemLocations=data.locations||{};
                
                // ë°°ì¹˜ ì¶”ê°€
                batches.push(newBatch);
                
                // ì¥ì†Œë³„ ì¬ê³  ì—…ë°ì´íŠ¸
                itemLocations[location]=(itemLocations[location]||0)+qty;
                
                // ì´ì¬ê³  ê³„ì‚°
                const totalStock=Object.values(itemLocations).reduce((sum,v)=>sum+v,0);
                
                tx.update(docRef,{
                    batches:batches,
                    locations:itemLocations,
                    totalStock:totalStock,
                    updatedAt:new Date().toISOString()
                });
            });
            
            // ì…ê³  ê¸°ë¡ ì €ì¥ (receivingHistory ì»¬ë ‰ì…˜)
            await db.collection('receivingHistory').add({
                itemId:itemId,
                itemName:item.name,
                batchNo:batchNo,
                qty:qty,
                expiryDate:expiry,
                location:location,
                price:price,
                memo:memo,
                receivedBy:currentUser?.name||currentUser?.id||'ì§ì›',
                receivedAt:new Date().toISOString()
            });
            
            alert(`âœ… ì…ê³  ì™„ë£Œ!\n\ní’ˆëª©: ${item.name}\nìˆ˜ëŸ‰: ${qty} ${item.unit||'ê°œ'}\në°°ì¹˜ë²ˆí˜¸: ${batchNo}\në³´ê´€ ì¥ì†Œ: ${location}`);
            
            // UI ì´ˆê¸°í™”
            cancelReceiving();
            
            // ì¬ê³  ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            await loadInventoryItems();
            renderInvCatButtons();
            renderInvAuditList();
            renderLowStockAlert();
            
            // ìµœê·¼ ì…ê³  ë‚´ì—­ ìƒˆë¡œê³ ì¹¨
            loadRecentReceiving();
        }catch(e){
            alert('ì…ê³  ì‹¤íŒ¨: '+e.message);
        }
    }
    
    // ìµœê·¼ ì…ê³  ë‚´ì—­ ë¡œë“œ
    async function loadRecentReceiving(){
        const container=document.getElementById('recentReceivingList');
        if(!container)return;
        if(typeof db==='undefined'){container.innerHTML='ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...';return;}
        
        try{
            const snap=await db.collection('receivingHistory')
                .orderBy('receivedAt','desc')
                .limit(10)
                .get();
            const items=snap.docs.map(d=>({id:d.id,...d.data()}));
            
            if(!items.length){
                container.innerHTML='<div style="text-align:center;color:var(--text-muted);padding:1.5rem">ì…ê³  ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }
            
            container.innerHTML=items.map(r=>{
                const date=new Date(r.receivedAt).toLocaleString('ko',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
                return `<div style="padding:10px;border:1px solid var(--border);border-radius:8px;margin-bottom:6px;background:#fff">
                    <div style="display:flex;justify-content:space-between;align-items:start">
                        <div style="flex:1">
                            <strong style="font-size:.9rem">${r.itemName}</strong>
                            <div style="font-size:.75rem;color:#666;margin-top:3px">
                                ìˆ˜ëŸ‰: ${r.qty} Â· ë°°ì¹˜: ${r.batchNo} Â· ${r.location}
                            </div>
                            <div style="font-size:.7rem;color:#999;margin-top:2px">
                                ìœ í†µê¸°í•œ: ${r.expiryDate} Â· ${r.receivedBy} Â· ${date}
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }catch(e){
            container.innerHTML='ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: '+e.message;
        }
    }

    // Tab Navigation
    document.querySelectorAll('.nav-item').forEach(item=>{
        item.addEventListener('click',function(){
            document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
            this.classList.add('active');
            document.getElementById('tab-'+this.dataset.tab).classList.add('active');
            // ì¬ê³  íƒ­ ì§„ì… ì‹œ ë°ì´í„° ë¡œë“œ
            if(this.dataset.tab==='inventory'&&!invItems.length){
                initInventoryTab();
            }
            // ì…ê³  íƒ­ ì§„ì… ì‹œ ì´ˆê¸°í™”
            if(this.dataset.tab==='receiving'){
                loadReceivingLocations();
                loadRecentReceiving();
            }
            // ë¹„í’ˆìš”ì²­ íƒ­ ì§„ì… ì‹œ ë‚´ì—­ ë¡œë“œ
            if(this.dataset.tab==='wishlist'){
                loadStaffWishlist();
            }
        });
    });
    
    // Init
    checkAuth();
</script>
```

</body>
</html>